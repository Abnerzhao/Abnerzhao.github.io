<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Abnerzhao</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-03-31T15:23:24.205Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Abnerzhao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>高并发设计40问摘要</title>
    <link href="http://yoursite.com/2020/03/31/high-concurrency/"/>
    <id>http://yoursite.com/2020/03/31/high-concurrency/</id>
    <published>2020-03-31T15:19:57.000Z</published>
    <updated>2020-03-31T15:23:24.205Z</updated>
    
    <content type="html"><![CDATA[<h2 id="通用设计方案"><a href="#通用设计方案" class="headerlink" title="通用设计方案"></a>通用设计方案</h2><ul>
<li>扩展</li>
<li>缓存</li>
<li>异步</li>
</ul>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p>横向扩展：采用分治的思想，采用分布式部署将流量分摊到后端服务器。横向扩展就是增加后端服务器的数量。</p>
<p>纵向扩展：提高机器配置，加内存扩充CPU</p>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p>缓存可以提升系统性能，在高并发场景下支撑更多用户同时访问。</p>
<p>一般数据放在持久化存储中，持久化存储都是使用硬盘作为存储介质。普通磁盘的寻道时间是 10 毫秒(ms)，即使是固态硬盘也是毫秒级，而 CPU 执行指令和内存寻址都是纳秒(ns)级别，从千兆网卡上读取数据是微妙(us)级<br>。伴随速度提升的同时是感人的价格。</p>
<p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/notes/cache-time.png" alt=""></p>
<p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/notes/cache_time.png" alt=""></p>
<p>整个计算机体系中磁盘是最慢的，通过使用内存作为存储介质的缓存以提升性能。</p>
<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>同步调用是指调用方要阻塞等待被调用方执行完成。异步调用则不需要等待被调用方执行完成，发起调用之后能立即得到返回。异步调用的结果可以通过调用方主动轮询或被调用方回调机制来返回。</p>
<h2 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h2><p>高并发系统三大目标：<strong>高性能、高可用、可扩展</strong></p>
<h3 id="高性能"><a href="#高性能" class="headerlink" title="高性能"></a>高性能</h3><h4 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h4><p>主要分为三个部分：</p>
<ul>
<li>应用程序角度：响应时间、并发数、在线用户数、请求错误率等</li>
<li>系统角度：资源使用情况，CPU、内存、网络带宽、流量等</li>
<li>用户角度：首屏时间、白屏时间、完全加载时间等，用户能感知的加载延迟</li>
</ul>
<p>性能优化有明确的可量化的指标</p>
<ul>
<li>平均响应时间、最大响应时间</li>
<li>TP99、TP90分位值</li>
<li>错误率</li>
</ul>
<blockquote>
<p>参考：<a href="https://tech.meituan.com/2014/03/03/performance-metric.html" target="_blank" rel="external">美团性能优化之路——性能指标体系</a></p>
</blockquote>
<h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><h4 id="高可用度量指标"><a href="#高可用度量指标" class="headerlink" title="高可用度量指标"></a>高可用度量指标</h4><ul>
<li>MTBF(Mean Time Between Failuer)平均故障间隔，两次故障间隔时间。时间越长系统稳定性越高。</li>
<li>MTTR(Mean Time To Repair)故障平均恢复时间。值越小故障对于用户影响越小。</li>
</ul>
<blockquote>
<p>Availability = MTBF / (MTBF + MTTR)</p>
</blockquote>
<p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/notes/avail-time.png" alt=""></p>
<p>系统设计：故障转移、超时控制、限流降级</p>
<p>运维层面：灰度发布、故障演练</p>
<h3 id="可扩展"><a href="#可扩展" class="headerlink" title="可扩展"></a>可扩展</h3><p>将服务进行拆分，独立的模块更容易扩展</p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="1-主从复制"><a href="#1-主从复制" class="headerlink" title="1.主从复制"></a>1.主从复制</h3><p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/notes/mysql-master-slave.png" alt=""></p>
<ul>
<li>Master 将变更记录到二进制日志中</li>
<li>Slave 将 Master 的二进制日志事件拷贝到自己的中继日志中</li>
<li>Slave 重做中继日志中的事件，将改变反映它自己的数据</li>
</ul>
<p>主从复制缺点：1.部署复杂性 2.同步延迟</p>
<p>实现了主从复制，那么可以读从库，写主库实现读写分离，即使写请求会锁表或锁记录也不会影响到读请求。</p>
<blockquote>
<p>主从同步延时需要监控告警，正常毫秒级别，超过秒级别就需要告警</p>
</blockquote>
<h3 id="2-读数据库"><a href="#2-读数据库" class="headerlink" title="2.读数据库"></a>2.读数据库</h3><p>读写分离之后可能需要配置一个主库和多个从库地址。为了降低实现复杂度，一般都会使用数据库中间件来解决数据库的访问问题。</p>
<p>有两类中间件：</p>
<ul>
<li>以淘宝的TDDL为代表，以代码形式内嵌运行在应用程序内部</li>
<li>单独部署的代理层方案：Cobar、Mycat、Atlas、DBProxy等</li>
</ul>
<p>第一种方式简单易用，不用额外部署，维护成本低，但是缺乏多语言支持。第二种需要独立部署服务，应用程序如同使用单一数据库，它会对 SQL 语句进行重写然后发送到指定数据源，性能会有所损耗。</p>
<h3 id="3-分表分库"><a href="#3-分表分库" class="headerlink" title="3.分表分库"></a>3.分表分库</h3><blockquote>
<p>对数据库进行水平和垂直拆分</p>
</blockquote>
<ul>
<li>垂直拆分</li>
</ul>
<p>垂直拆分就是将数据库的表分到多个不同的数据库中。垂直拆分的原则一般是按照业务类型来拆分，核心思想是专库专用。将业务耦合度比较高的表拆分到单独的库中。</p>
<p>比如有和用户相关的表、和内容相关的表、和关系相关的表，这些都是存在主库中，拆分之后将变成用户库、内容库、关系库。</p>
<ul>
<li>水平拆分</li>
</ul>
<p>水平拆分就是将单一数据库表按照某种规则拆分到多个数据库或多个数据表中。</p>
<p>拆分规则有两种：</p>
<p>1.按照某个字段的哈希值进行拆分。比如将ID字段进行哈希，然后拆分对应的多个库中</p>
<p>2.按照某一个字段的区间来拆分。比如时间字段把一个月的数据放入一张表。</p>
<h4 id="分库分表引入的问题："><a href="#分库分表引入的问题：" class="headerlink" title="分库分表引入的问题："></a>分库分表引入的问题：</h4><p>1.引入了分库分表键，也叫分区键，这是分库分表所依据的字段。这样会导致查询性能下降。</p>
<p>2.数据库的特性实现变得困难。如连表查询join，记录统计count等</p>
<p>3.分库分表之后如何保证ID的全局唯一。通过发号器服务来生成全局唯一ID</p>
<h3 id="4-NoSQL和关系型数据库互补"><a href="#4-NoSQL和关系型数据库互补" class="headerlink" title="4.NoSQL和关系型数据库互补"></a>4.NoSQL和关系型数据库互补</h3><p>NoSQL 有优秀的扩展性和读写性能，适合高并发大数据的场景。</p>
<h2 id="缓存-1"><a href="#缓存-1" class="headerlink" title="缓存"></a>缓存</h2><p>缓存是一种常见的空间换时间的性能优化手段。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>缓存适合读多写少的业务场景</li>
<li>给系统带来复杂度，会有数据不一致的风险</li>
<li>使用内存作为缓存，内存空间有限</li>
<li>缓存会带来一定的运维成本</li>
</ul>
<h3 id="缓存读写策略"><a href="#缓存读写策略" class="headerlink" title="缓存读写策略"></a>缓存读写策略</h3><ul>
<li>Cache Aside：旁路缓存策略。更新数据库不更新缓存，直接删除缓存中数据。读取数据时缓存没有命中则从数据库读取数据并更新到缓存。</li>
<li>Read/Write Through：读穿/写穿策略。用户只和缓存打交道，由缓存和数据库通信写入或读取数据。</li>
<li>Write Back：写回策略。</li>
</ul>
<h3 id="缓存高可用"><a href="#缓存高可用" class="headerlink" title="缓存高可用"></a>缓存高可用</h3><ul>
<li>客户端方案：客户端配置多个缓存节点，通过缓存写入和读取算法策略来实现分布式，从而提高可用性</li>
<li>中间代理层方案：客户端所有写入和读取请求都通过代理层，代理层内置高可用策略。Facebook的 Mcrouter,Twitter 的 Twemproxy,豌豆荚的Codis等</li>
<li>服务端方案：Redis Sentinal（哨兵）</li>
</ul>
<h3 id="缓存穿透问题"><a href="#缓存穿透问题" class="headerlink" title="缓存穿透问题"></a>缓存穿透问题</h3><ul>
<li>回种空值：回种空值并设置过期时间。可以阻挡异常和不存在数据的穿透。空值也会占用缓存空间，所以需要评估一下缓存容量。</li>
<li>布隆过滤器：使用布隆过滤器可以判断一个元素是否在一个集合中。</li>
</ul>
<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><blockquote>
<p>消息队列可以起到异步处理、解耦合和削峰填谷的作用</p>
</blockquote>
<h3 id="消息丢失"><a href="#消息丢失" class="headerlink" title="消息丢失"></a>消息丢失</h3><ul>
<li>消息丢失可以通过生产端的重试、消息队列配置机器模式以及消费端合理处理消费进度三种方式来解决</li>
<li>为了解决消息丢失通常会造成性能上的问题以及消息重复的问题</li>
<li>通过保证消息处理的幂等性可以解决消息的重复问题</li>
</ul>
<h3 id="消息延迟堆积"><a href="#消息延迟堆积" class="headerlink" title="消息延迟堆积"></a>消息延迟堆积</h3><h4 id="减少消息处理延迟"><a href="#减少消息处理延迟" class="headerlink" title="减少消息处理延迟"></a>减少消息处理延迟</h4><ul>
<li>消费端：优化消费代码提升性能、增加消费者的数量</li>
<li>消息队列层面：消息存储（本地存储–&gt;Page Cache + 本地存储）、零拷贝技术（减少数据拷贝次数，sendfile 函数）</li>
</ul>
<h2 id="分布式服务"><a href="#分布式服务" class="headerlink" title="分布式服务"></a>分布式服务</h2><h3 id="架构分层"><a href="#架构分层" class="headerlink" title="架构分层"></a>架构分层</h3><p>分层随处可见：</p>
<ul>
<li>MVC(Model-View-Controller)模型-视图-控制器</li>
<li>表现层、逻辑层、数据访问层</li>
<li>OSI网络模型、TCP/IP 网络模型</li>
<li>文件系统</li>
</ul>
<p>优点：解耦、复用、易于扩展</p>
<p>缺点：增加复杂度、多层交互性能损耗</p>
<p>池化技术：用连接池预先建立连接，减少频繁建立连接的损耗。通过空间换时间。比如数据库连接池、线程池等。缺点就是 1.有些对象不会被频繁使用，浪费内存空间；2.系统启动要预先创建完成，增加系统启动时间。</p>
<h3 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h3><p>单体应用的痛点：</p>
<ul>
<li>功能耦合严重，多人开发代码冲突</li>
<li>功能修改需要整体回归测试降低效率，一个功能又问题会影响到整体功能</li>
<li>构建、单元测试、打包、部署时间长</li>
</ul>
<h3 id="服务拆分"><a href="#服务拆分" class="headerlink" title="服务拆分"></a>服务拆分</h3><h4 id="拆分原则"><a href="#拆分原则" class="headerlink" title="拆分原则"></a>拆分原则</h4><ol>
<li>单一服务内部功能的高内聚和低耦合</li>
<li>拆分粒度，先粗略拆分后细化</li>
<li>拆分过程避免影响产品的日常功能迭代（优先剥离独立边界的服务，优先拆分被依赖的服务）</li>
<li>服务接口定义要具备可扩展性</li>
</ol>
<h4 id="微服务化的问题"><a href="#微服务化的问题" class="headerlink" title="微服务化的问题"></a>微服务化的问题</h4><ol>
<li>服务复杂度、内部依赖关系</li>
<li>性能损耗</li>
</ol>
<p>解决方案：</p>
<ul>
<li>服务注册中心：通过服务注册中心管理服务完整的生命周期，包括对服务存活状态的检测</li>
<li>服务治理体系：针对出现问题的服务采用熔断、降级、限流、超时控制等方法，使问题被限制在单一服务中保护服务网络中其他服务不受影响</li>
<li>分布式链路追踪分析工具，以及服务端监控报表</li>
</ul>
<h3 id="RPC-框架"><a href="#RPC-框架" class="headerlink" title="RPC 框架"></a>RPC 框架</h3><p>远程过程调用(Remote Procedure Call)是一个计算机通信协议。该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序无须额外地为这个交互作用编程。</p>
<p>RPC屏蔽了底层的网络通信细节，使得开发人员无须关注网络编程的细节，而将更多的时间和精力放在业务逻辑本身的实现上，从而提高开发效率。</p>
<p>常用的RPC框架有Dubbo、Grpc、Thrift等，使用RPC 需要提高网络传输性能、选择合适的序列化方式。</p>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><blockquote>
<p>Zookeeper、ETCD、Nacos、Eureka等</p>
</blockquote>
<p>注册中心提供以下两个基本功能：</p>
<ul>
<li>提供子服务地址的存储</li>
<li>当存储内容发生改变时，可以将变更的内容推送给客户端</li>
</ul>
<p>有了注册中心当需要对服务进行扩容、故障摘除就很方便，不用手动修改客户端配置和重启服务。服务节点的增加和减少对于客户端就是透明的。</p>
<h4 id="服务状态管理"><a href="#服务状态管理" class="headerlink" title="服务状态管理"></a>服务状态管理</h4><ul>
<li>主动探测：注册中心每隔一段时间探测服务端口是否可用</li>
<li>心跳模式：服务每隔一段时间向注册中心发送心跳包</li>
</ul>
<blockquote>
<p>服务注册和发现、监控、熔断和引流、分布式追踪、负载均衡</p>
</blockquote>
<h4 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h4><p>服务追踪有两点需求：</p>
<ol>
<li>对代码无侵入，使用面向切面编程可解决</li>
<li>降低性能损耗</li>
</ol>
<p>为了便于问题排查，需要在日志中增加 requestID 用来将日志串联。通过 traceId(requestID) + spanId 的方式可以记录rpc调用关系</p>
<h3 id="API-网关"><a href="#API-网关" class="headerlink" title="API 网关"></a>API 网关</h3><p>API网关是一种架构模式，将服务共有的功能整合到一起，可以出入系统的流量做统一的管控。</p>
<p>API网关的主要作用：</p>
<ul>
<li>统一入口，屏蔽服务器部署地址以及协议细节</li>
<li>提供通用能力，如认证授权、日志等</li>
<li>方便进行服务治理。如熔断、降级、流量控制、分流、黑白名单等</li>
</ul>
<p>目前广泛使用的API网关有：</p>
<ul>
<li>Kong：Openresty + Lua 性能优异</li>
<li>Zuul：Java 技术栈 Spring Cloud全家桶成员</li>
<li>Tyk：Go实现的轻量级 API 网关，丰富的插件</li>
</ul>
<blockquote>
<p>性能、高可用、可扩展、方便进行策略配置变更</p>
</blockquote>
<h3 id="分布式监控"><a href="#分布式监控" class="headerlink" title="分布式监控"></a>分布式监控</h3><p>分布式监控四个黄金信号：<strong>延迟、通信量(吞吐量)、错误和饱和度(服务和资源的利用率)</strong></p>
<p>RED指标体系：R(Request rate)请求量、E(Error)错误、D(Duration)响应时间</p>
<h4 id="监控数据来源"><a href="#监控数据来源" class="headerlink" title="监控数据来源"></a>监控数据来源</h4><ul>
<li>Agent</li>
<li>埋点</li>
<li>日志</li>
</ul>
<h3 id="应用性能管理"><a href="#应用性能管理" class="headerlink" title="应用性能管理"></a>应用性能管理</h3><p>应用性能管理(Application Performance Management 简称APM)：对应用各个层面做全方位的监测，期望及时发现可能存在的问题并加以解决，从而提升系统的性能和可用性。</p>
<h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h3><p>压力测试是指在高并发大流量下进行的测试，测试人员可以通过观察系统在峰值负载下的表现，从而找到系统中存在的性能隐患。</p>
<blockquote>
<p>流量拷贝工具：goreplay，tcpcopy</p>
</blockquote>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>配置管理两种方式：</p>
<ul>
<li>通过配置文件来管理</li>
<li>通过配置中心来管理</li>
</ul>
<h4 id="通过配置文件管理"><a href="#通过配置文件管理" class="headerlink" title="通过配置文件管理"></a>通过配置文件管理</h4><p>问题：</p>
<ol>
<li>更改配置需要重新编译(解决方案：从代码里拆分出来为独立文件)</li>
<li>更改配置需要重新打包(解决方案：配置存储到标准化固定目录，从git仓库拉取配置)</li>
<li>更改配置重启服务(无法解决，只能通过配置中心实现)</li>
</ol>
<h4 id="配置中心管理"><a href="#配置中心管理" class="headerlink" title="配置中心管理"></a>配置中心管理</h4><p>配置中心算是微服务架构中的标配组件。业界开源方案：</p>
<ul>
<li>携程Apollo</li>
<li>百度Disconf</li>
<li>360开源QConf</li>
<li>Spring Cloud组件Spring Cloud Config</li>
</ul>
<blockquote>
<p>配置存储</p>
</blockquote>
<p>配置中心的核心功能是配置项的存储和读取。</p>
<p>Disconf 和 Apollo 使用的MySQL；QConf 使用的是 Zookeeper；微博使用的 Redis 等</p>
<blockquote>
<p>配置变更通知，实现热更新</p>
</blockquote>
<ul>
<li>轮询方式</li>
<li>长连接推送</li>
</ul>
<p><strong>轮询方式</strong></p>
<p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/notes/config.png" alt=""></p>
<p>客户端定期轮询，比对MD5，MD5变化则拉取最新配置</p>
<p><strong>长连接推送</strong></p>
<p>客户端和服务端保持长连接，服务端还需要保存连接和配置的对应关系，当配置中心感知到配置变化之后，通过这个连接把变更的配置推送给客户端。时效性比轮询方式好。</p>
<blockquote>
<p>配置中心高可用</p>
</blockquote>
<p>配置中心客户端缓存(内存+文件)</p>
<p>内存缓存作用是降低客户端和配置中心交互频率，提升配置获取性能；文件缓存的作用是灾备。</p>
<h3 id="降级熔断"><a href="#降级熔断" class="headerlink" title="降级熔断"></a>降级熔断</h3><p><code>雪崩</code>是指服务调用方等待提供方的响应时间过长，资源被耗尽(一直被阻塞)引起的级联反应。</p>
<ul>
<li>熔断机制</li>
</ul>
<p>熔断就像电路中保险丝，一旦电路超负荷工作就会断开电路，保证整体电路不受影响。服务治理中的熔断机制是指发起服务调用时，返回错误或超时次数超过一定阀值，则后续不再发送请求而是暂时返回错误。</p>
<p><code>断路器</code>模式，服务调用方为每一个调用的服务维护一个有限状态机，状态机有三种状态：关闭、半打开和打开</p>
<p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/notes/rongduan.png" alt=""></p>
<ul>
<li>降级机制</li>
</ul>
<p>降级一般有：限流降级、开关降级等</p>
<p>开关降级在是代码里预先埋设一些「开关」，用来控制服务调用返回值。开关的值可以存储在配置中心，系统出现问题修改配置动态更改开关的值，执行降级策略。降级主要是一些非核心功能，如商品评论等。降级策略执行可以返回空的评论信息、返回降级数据或直接返回服务繁忙。</p>
<blockquote>
<p>开关降级实现策略主要有：返回降级数据、降率和异步。</p>
</blockquote>
<h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><p>限流指的是到达系统的并发请求数量，保证系统能够正常响应部分用户请求，而对超出限制的流量直接拒绝服务，保证整体系统的可用性。</p>
<h4 id="限流算法"><a href="#限流算法" class="headerlink" title="限流算法"></a>限流算法</h4><ul>
<li>固定窗口</li>
</ul>
<p>固定窗口算法简单粗暴，记录单位时间的访问次数超出则返回请求失败，下一个单位时间重置请求量计数再统计请求量。</p>
<p>缺点：无法限制短时间内的集中流量，两个单位时间相邻区间可能会超出限制。</p>
<ul>
<li>滑动窗口</li>
</ul>
<p>将时间窗口划分为多个小窗口，每个小窗口有单独的请求计数。可以得到每个区间的请求统计。滑动窗口算法能解决临界时间点上突发流量无法控制的问题。但是需要存储每个小的时间窗口内的计数，空间复杂度有所增加。</p>
<p>滑动窗口依旧无法控制流量让其更平滑。</p>
<ul>
<li>漏桶算法</li>
</ul>
<p>漏桶算法就是在流量产生端和接收端之间增加一个漏桶，流量进入和暂存到漏桶里，漏桶出口处会按照一个固定速率将流量漏出到接收端。当流量超出漏桶承受极限多余流量就会触发限流策略。</p>
<ul>
<li>令牌桶算法</li>
</ul>
<p>每次请求都需要从桶中获取令牌，如果桶中没有令牌就需要等待新令牌或直接拒绝服务。令牌的数量有限制，超过了限制桶中就不会新增令牌。这样可以一定程度上避免瞬时流量高峰。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;通用设计方案&quot;&gt;&lt;a href=&quot;#通用设计方案&quot; class=&quot;headerlink&quot; title=&quot;通用设计方案&quot;&gt;&lt;/a&gt;通用设计方案&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;扩展&lt;/li&gt;
&lt;li&gt;缓存&lt;/li&gt;
&lt;li&gt;异步&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;扩展
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>MySQL 中 utf8 和 utf8mb4 编码</title>
    <link href="http://yoursite.com/2020/02/25/mysql-utf8/"/>
    <id>http://yoursite.com/2020/02/25/mysql-utf8/</id>
    <published>2020-02-25T15:11:27.000Z</published>
    <updated>2020-02-25T15:13:37.853Z</updated>
    
    <content type="html"><![CDATA[<p>最近在开发过程中碰到数据库写入失败的情况。</p>
<blockquote>
<p>“Incorrect string value: ‘\xF0\x9F\x91\x91M\xE3…” for column ‘nick_name’ at row 1”</p>
</blockquote>
<p>排查发现是由于该用户的昵称含有 <code>emoji</code> 表情包导致的，含有表情包和普通字符串有什么区别呢？</p>
<p>原来 MySQL 的默认 <code>utf8</code> (也称 <code>utf8mb3</code>) 只支持三个字节的字符。而 <code>emoji</code> 表情包需要四个字节表示。所以存储就会报错。不过 MySQL 在 5.5.3 之后增加了这个 <code>utf8mb4</code> 的编码，用来兼容四字节的 Unicode。</p>
<p>为了解决这个问题，需要修改数据库的字符编码。</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt; show variables like &apos;%char%&apos;;</div><div class="line">+---------------------------+----------------------------+</div><div class="line">| Variable_name             | Value                      |</div><div class="line">+---------------------------+----------------------------+</div><div class="line">| character_set_client      | utf8                       |</div><div class="line">| character_set_connection  | utf8                       |</div><div class="line">| character_set_database    | utf8mb4                    |</div><div class="line">| character_set_filesystem  | binary                     |</div><div class="line">| character_set_results     | utf8                       |</div><div class="line">| character_set_server      | utf8mb4                    |</div><div class="line">| character_set_system      | utf8                       |</div><div class="line">| character_sets_dir        | /opt/mysql/share/charsets/ |</div><div class="line">| ft_query_extra_word_chars | OFF                        |</div><div class="line">+---------------------------+----------------------------+</div><div class="line"></div><div class="line">&gt; show create database xxx;</div><div class="line">+-------------------------+----------------------------------------------------------------------------------------------------------------+</div><div class="line">| Database                | Create Database                                                                                                |</div><div class="line">+-------------------------+----------------------------------------------------------------------------------------------------------------+</div><div class="line">| xxx | CREATE DATABASE `xxx` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */ |</div><div class="line">+-------------------------+----------------------------------------------------------------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">&gt; show create table user;</div><div class="line">| user  | CREATE TABLE `user` (</div><div class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</div><div class="line">  `user_id` varchar(80) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT &apos;用户ID&apos;,</div><div class="line">  `nick_name` varchar(120) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT &apos;昵称&apos;,</div><div class="line">  `avatar` varchar(300) COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT &apos;头像数据&apos;,</div><div class="line">  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;记录更新时间&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  UNIQUE KEY `user_id` (`user_id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=157 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci</div></pre></td></tr></table></figure>
<p>通过查看数据库、表的字符编码发现已经是 <code>utf8mb4</code>，那么问题可能出在客户端。查看 Flask 项目的配置文件，发现客户端配置的编码为 <code>utf8</code>。将编码格式修改为 <code>utf8mb4</code> 即可解决问题。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class devConfig(baseConfig):</div><div class="line">    SQLALCHEMY_DATABASE_URI = &apos;mysql+pymysql://root:xxxx@localhost/ncov?charset=utf8mb4&apos;</div></pre></td></tr></table></figure>
<blockquote>
<p>UTF-8 is a variable-length encoding. In the case of UTF-8, this means that storing one code point requires one to four bytes. However, MySQL’s encoding called “utf8” (alias of “utf8mb3”) only stores a maximum of three bytes per code point.</p>
<p>So the character set “utf8”/“utf8mb3” cannot store all Unicode code points: it only supports the range 0x000 to 0xFFFF, which is called the “Basic Multilingual Plane”. See also Comparison of Unicode encodings.</p>
</blockquote>
<p>参考：<a href="https://stackoverflow.com/questions/30074492/what-is-the-difference-between-utf8mb4-and-utf8-charsets-in-mysql" target="_blank" rel="external">What is the difference between utf8mb4 and utf8 charsets in MySQL?
</a></p>
<p>三个字节的 uft8 支持编码的 Unicode 字符范围是 0x000-0xffff，称之为 Unicode 的基本多文种平面(BMP)，不在基本多文种平面的 Unicode 字符都无法使用 MySQL 中的 utf8 字符集存储。</p>
<p>通过以下命令可直接将数据库字符集变更为 <code>utf8mb4</code> 编码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 修改数据库:  </div><div class="line">ALTER DATABASE database_name CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci;  </div><div class="line"># 修改表:  </div><div class="line">ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;  </div><div class="line"># 修改表字段:  </div><div class="line">ALTER TABLE table_name CHANGE column_name column_name VARCHAR(191) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在开发过程中碰到数据库写入失败的情况。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“Incorrect string value: ‘\xF0\x9F\x91\x91M\xE3…” for column ‘nick_name’ at row 1”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;排查发现是由于该用户的昵称含有 &lt;code&gt;emoji&lt;/code&gt; 表情包导致的，含有表情包和普通字符串有什么区别呢？&lt;/p&gt;
&lt;p&gt;原来 MySQL 的默认 &lt;code&gt;utf8&lt;/code&gt; (也称 &lt;code&gt;utf8mb3&lt;/code&gt;) 只支持三个字节的字符。而 &lt;code&gt;emoji&lt;/code&gt; 表情包需要四个字节表示。所以存储就会报错。不过 MySQL 在 5.5.3 之后增加了这个 &lt;code&gt;utf8mb4&lt;/code&gt; 的编码，用来兼容四字节的 Unicode。&lt;/p&gt;
&lt;p&gt;为了解决这个问题，需要修改数据库的字符编码。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>2019 小结</title>
    <link href="http://yoursite.com/2020/01/05/my2019/"/>
    <id>http://yoursite.com/2020/01/05/my2019/</id>
    <published>2020-01-05T08:25:55.000Z</published>
    <updated>2020-02-19T16:57:41.463Z</updated>
    
    <content type="html"><![CDATA[<h3 id="加班和宅"><a href="#加班和宅" class="headerlink" title="加班和宅"></a>加班和宅</h3><p>2019 年总结起来就两个关键字：<code>加班</code>和<code>宅</code>，在肥宅的道路上越走越远。</p>
<p>由于加班较多，锻炼的时间相对减少，运动量直线下降。2019 年总共跑步 147 公里，相较于 2018 年 400 公里的运动量直接被腰斩。伴随着运动量地降低，体重也随着飙升。长胖了 10 斤，算是 2019 年的小小收获吧(囧)。不过唯一值得庆幸的是羽毛球一直坚持了下来，有一群自律的球友还是很幸福的。还是要通过外部条件去督促和约束自己，人一旦散漫下来过日便会失去些许活力。生命在于运动，希望新的一年运动量不要再创新低。</p>
<a id="more"></a>
<p>这一年也是自闭的一年，出去玩得也少了，周末更喜欢宅在家里。总共看了 20 本书，38 部电影，3 部剧集。技术类的书看得比较少，文学类杂书稍多些。印象比较深刻的书是阎连科的「我与父辈」，之前看过他的「日光流年」，故事比较沉重，有点余华的味道，我个人更喜欢阎连科的文笔。这本书是在他的新书签售会上买的，一位智慧有趣的老头。</p>
<blockquote>
<p>终于就在某一瞬间里，明白了父辈们在他们的一生里，所有的辛劳和努力，所有的不幸和温暖，原来都是为了活着和活着中的柴米与油盐，生老和病死；是为了柴米油盐中的甘甘苦苦与生老病死中的挣扎和苦痛。     —— 阎连科「我与父辈」</p>
</blockquote>
<p>这一年看过的好电影有不少，李安曾说过「没有一个真心诚意的交流，生活是很空虚的，人生是荒谬的。而深层交流不能明讲，只有靠艺术、靠电影，靠这些虚幻的东西、假设的东西，在里面交流，然后你感觉上没有那么孤单，没有那么无助。」或许这就是为什么电影在生活中不可或缺的原因吧。</p>
<blockquote>
<p>世界上有太多孤独的人害怕先踏出第一步。    ——「绿皮书」</p>
</blockquote>
<p>19 年清明假期去了一趟大西北，庄严的塔尔寺里虔诚信徒和匆匆游客交织在一起，冰雪还未消融的青海湖与蓝天相连，淡季的青海湖少了油菜花却多了一份静谧，喜欢西北的空旷苍凉。西北的美食性价比超高，分量扎实的炕锅羊排也就五六十元。端午节和朋友去了一趟黄山木梨硔村，很早之前从「了不起村落」这部纪录片中了解到高山村落木梨硔，山上的风景真的很美，在雨雾缭绕的山顶吃饭闲聊看云卷云舒，让你可以短暂逃离城市的喧嚣。七月份团建去了青岛，九月份中秋去了嵊泗枸杞岛，枸杞岛的水很蓝，可玩性一般。十二月份出去爬了一次山，太久没有户外徒步爬山，轻虐线对于我来说也有点够呛了。</p>
<p>要说这一年还有什么记忆犹新的时刻，那就是追星成功。六月份去听了许巍的演唱会，八月份听了丢火车和万青的现场。虽然都是一个人去的，但现场的气氛不会让你有一丝的孤单，许巍的现场简直要听哭了。我已经不再是那个第一次在收音机里听到许巍的少年了。</p>
<h3 id="展望-2020"><a href="#展望-2020" class="headerlink" title="展望 2020"></a>展望 2020</h3><h4 id="职业规划"><a href="#职业规划" class="headerlink" title="职业规划"></a>职业规划</h4><p>年初老大问我三五年的职业规划是什么，说实话我答不上来。2020 年是步入职场的第五个年头，之前都是随遇而安并没有什么清晰的目标，只有一个大而空洞的想法就是技术实力要提升(真是一句废话)。这样导致一个显著的问题就是永远找不到自己的定位，因为没有目标所以看不到差距。或许很多人的目标是升职加薪往上爬，无可厚非。但是要想想推动你前进的原动力是什么，是对金钱和权利的渴望还是个人价值的实现。技术人的路线很清晰，技术专家或管理。当然也有其他门路，转行创业等等。无论是什么样的路线，只要是自己喜欢的方式就行了。对于自己的职业发展，只有两点要求：1.脚踏实地，踏实做好本分工作，提升软硬实力。2.仰望星空，关注行业发展，抓住机遇。嗯…好像什么也没说。</p>
<h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><p>19 年的目标可以说是全军覆没，没有什么成绩，有种蹉跎岁月的感觉。技能树点亮的比较少，即没有挖掘深度也没有拓展广度，而是在业务逻辑里挣扎。总结原因有以下两点：</p>
<p>1.重要性和紧急程度不高：学或不学并不会对目前的工作和生活有实质性地改变，并不需要急迫地掌握这项技能。这样学习的压力会比较小，但需要花费意志力会更多。学习很多东西并不会有立竿见影的效果，但它给你带来的提升是潜移默化的。</p>
<p>2.热情减退：热度衰减之后，再次进入状态的成本就会较高。所以趁着三分钟热度分配出连续的时间去学习实践要比在零碎的时间中断断续续去学习的效果要好。</p>
<p>学习新的东西要有应用场景，然后以项目或者其他形式去实践和验收。以视频剪辑为例，每次出去玩我都会留意拍些素材然后剪辑成片。通过看书和在B站学习剪辑思路和技巧。每一次剪辑成片就是一个小项目，虽然水平依旧很烂，但在这些项目中对工具和流程愈加熟悉，会更明确想要达到什么样的效果。当然兴趣也是不可或缺的。学习新的技能是为了利用技能去解决问题。</p>
<p><img src="https://hk-abner.oss-cn-hongkong.aliyuncs.com/blog/IMG_3251.JPG" alt=""></p>
<p>「只管去做」这本书讲到了人生目标九宫格，人脚下踩着三个根基，健康、财务和社交，左右手分别握着工作和生活，头顶上是三种享受，学习过程的成长享受，体验突破的愉悦享受和休闲娱乐的放松享受。比较形象易懂，不用过多解释。最好的状态就是根基牢固，工作和生活的平衡以及适当的享受。这些是宏观的角度，具体如何去践行，那么就需要有明确的目标和执行计划，这里就不展开了。</p>
<p>围绕这个九宫格，查漏补缺，说说 2020 年需要去做的：</p>
<ul>
<li>将体重控制在 130 左右。</li>
<li>财务知识比较欠缺，需要补补课。大环境经济不景气的情况下，开源节流理性消费很有必要。</li>
<li>努力追求工作和生活的平衡，摆脱繁杂工作地奴役。没有了生活，努力工作也谈不上有什么意义。在生活方便，希望丰富自己的兴趣爱好，吉他、相机毕竟不是什么收蔵品，还是要多玩玩。</li>
<li>输入输出，输出这方面做得实在是太差了，希望新的一年能多多更新博客、多拍照拍视频。一个月至少两篇文章，包括技术和生活方面。</li>
<li>成为一名全栈工程师。脑子里其实有很多想法，无奈前端技术有点菜，无法将其具象化。</li>
<li>去一趟新疆和日本。</li>
<li>没有你，良辰美景更与何人说。</li>
</ul>
<h3 id="尾"><a href="#尾" class="headerlink" title="尾"></a>尾</h3><p>回想 2010 年到 2020 年这十年，经历了高考、读大学、就业、买房。按照正常同龄人的轨迹，或许还应该包括结婚、生子。高考成绩并不理想，无奈只能留在省内，大学努力学了点技能。毕业时赶上了移动互动网的大潮，享受到了技术带来的红利。这十年间很多重大抉择大多并非深思熟虑的结果，而是靠着感觉懵懵懂懂地前行。下一个十年或许就不会这样了。</p>
<blockquote>
<p>不必太纠结于当下，也不必太忧虑未来，当你经历过一些事情的时候，眼前的风景已经和从前不一样了。    —— 村上春树「1Q84」</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;加班和宅&quot;&gt;&lt;a href=&quot;#加班和宅&quot; class=&quot;headerlink&quot; title=&quot;加班和宅&quot;&gt;&lt;/a&gt;加班和宅&lt;/h3&gt;&lt;p&gt;2019 年总结起来就两个关键字：&lt;code&gt;加班&lt;/code&gt;和&lt;code&gt;宅&lt;/code&gt;，在肥宅的道路上越走越远。&lt;/p&gt;
&lt;p&gt;由于加班较多，锻炼的时间相对减少，运动量直线下降。2019 年总共跑步 147 公里，相较于 2018 年 400 公里的运动量直接被腰斩。伴随着运动量地降低，体重也随着飙升。长胖了 10 斤，算是 2019 年的小小收获吧(囧)。不过唯一值得庆幸的是羽毛球一直坚持了下来，有一群自律的球友还是很幸福的。还是要通过外部条件去督促和约束自己，人一旦散漫下来过日便会失去些许活力。生命在于运动，希望新的一年运动量不要再创新低。&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>API 网关 Kong 实践</title>
    <link href="http://yoursite.com/2019/08/12/kong-api-gateway/"/>
    <id>http://yoursite.com/2019/08/12/kong-api-gateway/</id>
    <published>2019-08-12T13:35:38.000Z</published>
    <updated>2019-08-12T13:39:25.494Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Kong is a cloud-native, fast, scalable, and distributed Microservice Abstraction Layer (also known as an API Gateway, API Middleware or in some cases Service Mesh). Made available as an open-source project in 2015, its core values are high performance and extensibility.</p>
</blockquote>
<ul>
<li><a href="https://docs.konghq.com/" target="_blank" rel="external">官方文档</a></li>
<li><a href="https://github.com/Kong/kong" target="_blank" rel="external">GitHub</a></li>
</ul>
<blockquote>
<h4 id="实体对象"><a href="#实体对象" class="headerlink" title="实体对象"></a>实体对象</h4></blockquote>
<ul>
<li>Router：请求转发规则，将请求转发给 Service</li>
<li>Services：多个 Upstream 集合，Router 的转发目标</li>
<li>Consumers：消费者</li>
<li>Plugin：插件，可以是全局的也可以配置到特定的 Router、Services、Consumers</li>
<li>Certificate：https 证书</li>
<li>Sni：域名与 Certificate 的绑定</li>
<li>Upstream：负载均衡策略</li>
<li>Target：最终处理请求的后端服务</li>
</ul>
<a id="more"></a>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li><a href="https://docs.konghq.com/install/centos/?_ga=2.213911703.1402138674.1565577491-1519282909.1548232294" target="_blank" rel="external">CentOS Installation</a></li>
<li><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="external">PostgreSQL Installation</a></li>
</ul>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># Admin api 对 Kong 的所有操作</div><div class="line">$ curl localhost:8001</div><div class="line"></div><div class="line"># Proxy api 提供给客户端或者消费者对上游 service 的消费接口</div><div class="line">$ curl localhost:8000</div><div class="line">$ curl localhost:8443 （SSL）</div></pre></td></tr></table></figure>
<blockquote>
<p>具体操作请参考： <a href="https://docs.konghq.com/0.14.x/admin-api/" target="_blank" rel="external">Admin API  操作手册</a></p>
</blockquote>
<h3 id="核心实体"><a href="#核心实体" class="headerlink" title="核心实体"></a>核心实体</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl localhost:8001/apis  //service apis</div><div class="line">$ curl localhost:8001/consumers  //消费者</div><div class="line">$ curl localhost:8001/plugins  //插件</div></pre></td></tr></table></figure>
<h3 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h3><ul>
<li><a href="https://github.com/pantsel/konga" target="_blank" rel="external">konga</a></li>
<li><a href="https://github.com/PGBI/kong-dashboard" target="_blank" rel="external">kong-dashboard</a></li>
</ul>
<h3 id="简单的接入配置"><a href="#简单的接入配置" class="headerlink" title="简单的接入配置"></a>简单的接入配置</h3><p>添加 API 到 Kong 中，首先添加 Service, 这个服务就是Kong 管理的微服务或者 Upstream 上游的服务。</p>
<p>本地测试使用 Flask 部署一个最简单的 Web 应用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat web.py</div><div class="line">from flask import Flask</div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line">@app.route(&apos;/&apos;)</div><div class="line">def hello_world():</div><div class="line">    return &apos;Hello, World!&apos;</div><div class="line">    </div><div class="line">$ export FLASK_APP=web.py</div><div class="line">$ flask run</div><div class="line"> * Serving Flask app &quot;web.py&quot;</div><div class="line"> * Environment: production</div><div class="line">   WARNING: This is a development server. Do not use it in a production deployment.</div><div class="line">   Use a production WSGI server instead.</div><div class="line"> * Debug mode: off</div><div class="line"> * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)</div></pre></td></tr></table></figure>
<h4 id="添加-Service"><a href="#添加-Service" class="headerlink" title="添加 Service"></a>添加 Service</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X POST \</div><div class="line">  --url http://localhost:8001/services/ \</div><div class="line">  --data &apos;name=example-service&apos; \ </div><div class="line">  --data &apos;url=http://localhost:5000&apos;</div><div class="line"></div><div class="line">HTTP/1.1 201 Created</div><div class="line">Date: Mon, 12 Aug 2019 06:28:29 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Connection: keep-alive</div><div class="line">Access-Control-Allow-Origin: *</div><div class="line">Server: kong/1.2.1</div><div class="line">Content-Length: 270</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;host&quot;:&quot;localhost&quot;,</div><div class="line">    &quot;created_at&quot;:1565591309,</div><div class="line">    &quot;connect_timeout&quot;:60000,</div><div class="line">    &quot;id&quot;:&quot;00100765-1bb9-45d8-bb38-afb853f6fa37&quot;,</div><div class="line">    &quot;protocol&quot;:&quot;http&quot;,</div><div class="line">    &quot;name&quot;:&quot;example-service&quot;,</div><div class="line">    &quot;read_timeout&quot;:60000,</div><div class="line">    &quot;port&quot;:5000,</div><div class="line">    &quot;path&quot;:null,</div><div class="line">    &quot;updated_at&quot;:1565591309,</div><div class="line">    &quot;retries&quot;:5,</div><div class="line">    &quot;write_timeout&quot;:60000,</div><div class="line">    &quot;tags&quot;:null</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="给-Service-添加-Router"><a href="#给-Service-添加-Router" class="headerlink" title="给 Service 添加 Router"></a>给 Service 添加 Router</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X POST \</div><div class="line">  --url http://localhost:8001/services/example-service/routes \</div><div class="line">  --data &apos;hosts[]=example.com&apos;</div><div class="line"> </div><div class="line">HTTP/1.1 201 Created</div><div class="line">Date: Mon, 12 Aug 2019 06:35:36 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Connection: keep-alive</div><div class="line">Access-Control-Allow-Origin: *</div><div class="line">Server: kong/1.2.1</div><div class="line">Content-Length: 393</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;id&quot;:&quot;3daac1d8-7570-414a-b1a9-606cda10d2f1&quot;,</div><div class="line">    &quot;tags&quot;:null,</div><div class="line">    &quot;paths&quot;:null,</div><div class="line">    &quot;destinations&quot;:null,</div><div class="line">    &quot;protocols&quot;:[</div><div class="line">        &quot;http&quot;,</div><div class="line">        &quot;https&quot;</div><div class="line">    ],</div><div class="line">    &quot;created_at&quot;:1565591736,</div><div class="line">    &quot;snis&quot;:null,</div><div class="line">    &quot;hosts&quot;:[</div><div class="line">        &quot;example.com&quot;</div><div class="line">    ],</div><div class="line">    &quot;name&quot;:null,</div><div class="line">    &quot;preserve_host&quot;:false,</div><div class="line">    &quot;regex_priority&quot;:0,</div><div class="line">    &quot;strip_path&quot;:true,</div><div class="line">    &quot;sources&quot;:null,</div><div class="line">    &quot;updated_at&quot;:1565591736,</div><div class="line">    &quot;https_redirect_status_code&quot;:426,</div><div class="line">    &quot;service&quot;:&#123;</div><div class="line">        &quot;id&quot;:&quot;00100765-1bb9-45d8-bb38-afb853f6fa37&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;methods&quot;:null</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="通过-Kong-转发请求"><a href="#通过-Kong-转发请求" class="headerlink" title="通过 Kong 转发请求"></a>通过 Kong 转发请求</h4><p>直接访问 Kong 的 Proxy api 即可访问到 Flask 应用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X GET \</div><div class="line">  --url http://localhost:8000/ \</div><div class="line">  --header &apos;Host: example.com&apos;</div><div class="line">  </div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: text/html; charset=utf-8</div><div class="line">Content-Length: 13</div><div class="line">Connection: keep-alive</div><div class="line">Server: Werkzeug/0.15.5 Python/2.7.11</div><div class="line">Date: Mon, 12 Aug 2019 06:37:10 GMT</div><div class="line">X-Kong-Upstream-Latency: 2</div><div class="line">X-Kong-Proxy-Latency: 1</div><div class="line">Via: kong/1.2.1</div><div class="line"></div><div class="line">Hello, World!</div></pre></td></tr></table></figure>
<h4 id="添加插件"><a href="#添加插件" class="headerlink" title="添加插件"></a>添加插件</h4><p>添加一个接口验证 <code>key-auth</code> 插件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X POST \</div><div class="line">  --url http://localhost:8001/services/example-service/plugins/ \</div><div class="line">  --data &apos;name=key-auth&apos;</div><div class="line">  </div><div class="line">HTTP/1.1 201 Created</div><div class="line">Date: Mon, 12 Aug 2019 06:43:47 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Connection: keep-alive</div><div class="line">Access-Control-Allow-Origin: *</div><div class="line">Server: kong/1.2.1</div><div class="line">Content-Length: 365</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;created_at&quot;:1565592227,</div><div class="line">    &quot;config&quot;:&#123;</div><div class="line">        &quot;key_names&quot;:[</div><div class="line">            &quot;apikey&quot;</div><div class="line">        ],</div><div class="line">        &quot;run_on_preflight&quot;:true,</div><div class="line">        &quot;anonymous&quot;:null,</div><div class="line">        &quot;hide_credentials&quot;:false,</div><div class="line">        &quot;key_in_body&quot;:false</div><div class="line">    &#125;,</div><div class="line">    &quot;id&quot;:&quot;54ca5f58-975a-49b4-8c14-d6b4e5add330&quot;,</div><div class="line">    &quot;service&quot;:&#123;</div><div class="line">        &quot;id&quot;:&quot;00100765-1bb9-45d8-bb38-afb853f6fa37&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;name&quot;:&quot;key-auth&quot;,</div><div class="line">    &quot;protocols&quot;:[</div><div class="line">        &quot;http&quot;,</div><div class="line">        &quot;https&quot;</div><div class="line">    ],</div><div class="line">    &quot;enabled&quot;:true,</div><div class="line">    &quot;run_on&quot;:&quot;first&quot;,</div><div class="line">    &quot;consumer&quot;:null,</div><div class="line">    &quot;route&quot;:null,</div><div class="line">    &quot;tags&quot;:null</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再次访问则提示 <code>401 Unauthorized</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X GET \</div><div class="line">  --url http://localhost:8000/ \</div><div class="line">  --header &apos;Host: example.com&apos;</div><div class="line">  </div><div class="line">HTTP/1.1 401 Unauthorized</div><div class="line">Date: Mon, 12 Aug 2019 06:45:24 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Connection: keep-alive</div><div class="line">WWW-Authenticate: Key realm=&quot;kong&quot;</div><div class="line">Content-Length: 41</div><div class="line">Server: kong/1.2.1</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;message&quot;:&quot;No API key found in request&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="添加消费者"><a href="#添加消费者" class="headerlink" title="添加消费者"></a>添加消费者</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X POST \</div><div class="line">  --url http://localhost:8001/consumers/ \</div><div class="line">  --data &quot;username=Abner&quot;</div><div class="line">  </div><div class="line">HTTP/1.1 201 Created</div><div class="line">Date: Mon, 12 Aug 2019 06:51:54 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Connection: keep-alive</div><div class="line">Access-Control-Allow-Origin: *</div><div class="line">Server: kong/1.2.1</div><div class="line">Content-Length: 117</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;custom_id&quot;:null,</div><div class="line">    &quot;created_at&quot;:1565592714,</div><div class="line">    &quot;id&quot;:&quot;c3d8a745-5d6f-4966-8678-e6644139e0b7&quot;,</div><div class="line">    &quot;tags&quot;:null,</div><div class="line">    &quot;username&quot;:&quot;Abner&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="给消费者添加-key"><a href="#给消费者添加-key" class="headerlink" title="给消费者添加 key"></a>给消费者添加 key</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -i -X POST \</div><div class="line">  --url http://localhost:8001/consumers/Abner/key-auth/ \</div><div class="line">  --data &apos;key=test&apos;</div><div class="line">  </div><div class="line">HTTP/1.1 201 Created</div><div class="line">Date: Mon, 12 Aug 2019 06:53:42 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Connection: keep-alive</div><div class="line">Access-Control-Allow-Origin: *</div><div class="line">Server: kong/1.2.1</div><div class="line">Content-Length: 139</div><div class="line"></div><div class="line">&#123;</div><div class="line">    &quot;key&quot;:&quot;test&quot;,</div><div class="line">    &quot;created_at&quot;:1565592822,</div><div class="line">    &quot;consumer&quot;:&#123;</div><div class="line">        &quot;id&quot;:&quot;c3d8a745-5d6f-4966-8678-e6644139e0b7&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;id&quot;:&quot;d71b6d4d-3f74-489f-a036-d340f4bcc991&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 验证</div><div class="line">$ curl -i -X GET \</div><div class="line">  --url http://localhost:8000 \</div><div class="line">  --header &quot;Host: example.com&quot; \</div><div class="line">  --header &quot;apikey: test&quot;</div><div class="line">  </div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Type: text/html; charset=utf-8</div><div class="line">Content-Length: 13</div><div class="line">Connection: keep-alive</div><div class="line">Server: Werkzeug/0.15.5 Python/2.7.11</div><div class="line">Date: Mon, 12 Aug 2019 06:55:51 GMT</div><div class="line">X-Kong-Upstream-Latency: 2</div><div class="line">X-Kong-Proxy-Latency: 2</div><div class="line">Via: kong/1.2.1</div><div class="line"></div><div class="line">Hello, World!</div></pre></td></tr></table></figure>
<h3 id="负载均衡配置"><a href="#负载均衡配置" class="headerlink" title="负载均衡配置"></a>负载均衡配置</h3><p>我们可以通过 Kong 配置如下的负载均衡效果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">upstream example &#123;</div><div class="line">    server localhost:5000 weight=100;</div><div class="line">    server localhost:5001 weight=50;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen  80;</div><div class="line">    location /example &#123;</div><div class="line">        proxy_pass http://example;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要涉及到的 Kong 的几个核心东西：</p>
<ul>
<li>upstream：和 nginx upstream 相同，对上游服务器进行抽象</li>
<li>target：具体的主机或者微服务实例，<code>IP + PORT</code> 的形式</li>
<li>service：服务层面抽象，可以映射到具体服务，也可以指向 upstream 来实现负载均衡</li>
<li>router：路由的抽象，将请求映射到 service</li>
</ul>
<p>首先我用 Flask 启动两个 web 应用，分别监听 5000 和 5001 端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl 0.0.0.0:5000</div><div class="line">server 5000</div><div class="line">$ curl 0.0.0.0:5001</div><div class="line">server 5001</div></pre></td></tr></table></figure>
<h4 id="配置-upstream-和-target"><a href="#配置-upstream-和-target" class="headerlink" title="配置 upstream 和 target"></a>配置 upstream 和 target</h4><p>添加 example upstream</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -X POST http://localhost:8001/upstreams \</div><div class="line">  --data &quot;name=example&quot;</div></pre></td></tr></table></figure>
<p>添加两个负载均衡节点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -X POST http://localhost:8001/upstreams/example/targets \</div><div class="line">  --data &quot;target=localhost:5000&quot; \</div><div class="line">  --data &quot;weight=100&quot;</div><div class="line">$ curl -X POST http://localhost:8001/upstreams/example/targets \</div><div class="line">  --data &quot;target=localhost:5001&quot; \</div><div class="line">  --data &quot;weight=50&quot;</div></pre></td></tr></table></figure>
<h4 id="配置-service-和-route"><a href="#配置-service-和-route" class="headerlink" title="配置 service 和 route"></a>配置 service 和 route</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ curl -X POST http://localhost:8001/services\</div><div class="line">  --data &quot;name=example&quot; \</div><div class="line">  --data &quot;host=example&quot;</div><div class="line">&#123;</div><div class="line">    &quot;host&quot;:&quot;example&quot;,</div><div class="line">    &quot;created_at&quot;:1565595520,</div><div class="line">    &quot;connect_timeout&quot;:60000,</div><div class="line">    &quot;id&quot;:&quot;d9873e6e-6dd5-4a5a-accb-40f96865d0a2&quot;,</div><div class="line">    &quot;protocol&quot;:&quot;http&quot;,</div><div class="line">    &quot;name&quot;:&quot;example&quot;,</div><div class="line">    &quot;read_timeout&quot;:60000,</div><div class="line">    &quot;port&quot;:80,</div><div class="line">    &quot;path&quot;:null,</div><div class="line">    &quot;updated_at&quot;:1565595520,</div><div class="line">    &quot;retries&quot;:5,</div><div class="line">    &quot;write_timeout&quot;:60000,</div><div class="line">    &quot;tags&quot;:null</div><div class="line">&#125;</div><div class="line">$ curl -X POST http://localhost:8001/routes \</div><div class="line">  --data &quot;paths[]=/example&quot; \</div><div class="line">  --data &quot;service.id=d9873e6e-6dd5-4a5a-accb-40f96865d0a2&quot;</div></pre></td></tr></table></figure>
<p>至此一个典型的负载均衡已经配置完成，实测有效。</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Kong is a cloud-native, fast, scalable, and distributed Microservice Abstraction Layer (also known as an API Gateway, API Middleware or in some cases Service Mesh). Made available as an open-source project in 2015, its core values are high performance and extensibility.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.konghq.com/&quot;&gt;官方文档&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/Kong/kong&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;h4 id=&quot;实体对象&quot;&gt;&lt;a href=&quot;#实体对象&quot; class=&quot;headerlink&quot; title=&quot;实体对象&quot;&gt;&lt;/a&gt;实体对象&lt;/h4&gt;&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Router：请求转发规则，将请求转发给 Service&lt;/li&gt;
&lt;li&gt;Services：多个 Upstream 集合，Router 的转发目标&lt;/li&gt;
&lt;li&gt;Consumers：消费者&lt;/li&gt;
&lt;li&gt;Plugin：插件，可以是全局的也可以配置到特定的 Router、Services、Consumers&lt;/li&gt;
&lt;li&gt;Certificate：https 证书&lt;/li&gt;
&lt;li&gt;Sni：域名与 Certificate 的绑定&lt;/li&gt;
&lt;li&gt;Upstream：负载均衡策略&lt;/li&gt;
&lt;li&gt;Target：最终处理请求的后端服务&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Django REST framework 缓存</title>
    <link href="http://yoursite.com/2019/08/06/django-rest-framework-cache/"/>
    <id>http://yoursite.com/2019/08/06/django-rest-framework-cache/</id>
    <published>2019-08-06T12:30:05.000Z</published>
    <updated>2019-08-06T14:47:32.944Z</updated>
    
    <content type="html"><![CDATA[<p>最近对 DRF 的接口进行监控，发现部分高频访问的接口性能不佳，响应比较慢，于是想通过缓存将接口性能优化。</p>
<p>常用的解决方案如下：</p>
<ul>
<li><a href="http://chibisov.github.io/drf-extensions/docs/#caching" target="_blank" rel="external">drf-extensions</a></li>
<li><a href="https://drf-cached-instances.readthedocs.io/en/latest/" target="_blank" rel="external">drf-cached-instances</a></li>
<li><a href="https://github.com/Onyo/django-rest-framework-cache" target="_blank" rel="external">django-rest-framework-cache</a></li>
<li><a href="https://www.django-rest-framework.org/api-guide/caching/#using-cache-with-apiview-and-viewsets" target="_blank" rel="external">django cache decorators</a></li>
</ul>
<blockquote>
<p>参考：<a href="https://stackoverflow.com/questions/38320008/how-to-cache-django-rest-framework-api-calls" target="_blank" rel="external">How to cache Django Rest Framework API calls</a></p>
</blockquote>
<a id="more"></a>
<p>可行的方案有很多，可以通过组件实现也可以通过 django 内置的装饰器来实现。这里以 <code>django-rest-framework-cache</code> 为例。</p>
<h3 id="django-rest-framework-cache"><a href="#django-rest-framework-cache" class="headerlink" title="django-rest-framework-cache"></a>django-rest-framework-cache</h3><p><code>django-rest-framework-cache</code> 是通过重写 <code>Serializer</code> 的 <code>to_representation</code> 方法来实现缓存的，所以它是一个嵌入到序列化层缓存数据的工具。<code>django-rest-framework-cache</code> 安装配置比较简单，能够快速上手。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pip install rest-framework-cache</div></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>缓存配置可以参考 <a href="https://docs.djangoproject.com/en/1.11/topics/cache/#setting-up-the-cache" target="_blank" rel="external">Django 官方文档</a>，Django 原生默认支持 Memcached，不过我们需要先安装 <code>python-memcached</code> 和 <code>memcached</code> 等软件包。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pip install python-memcached</div><div class="line">$ sudo yum install -y memcached </div><div class="line">$ cat /etc/sysconfig/memcached</div><div class="line">PORT=&quot;11211&quot;</div><div class="line">USER=&quot;memcached&quot;</div><div class="line">MAXCONN=&quot;2000&quot;</div><div class="line">CACHESIZE=&quot;1024&quot;</div><div class="line">OPTIONS=&quot;&quot;</div><div class="line">$ systemctl start memcached</div><div class="line">$ systemctl enable memcached</div></pre></td></tr></table></figure>
<p><strong>settings.py</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">INSTALLED_APPS = (</div><div class="line">    ...</div><div class="line">    &apos;rest_framework_cache&apos;,</div><div class="line">)</div><div class="line"></div><div class="line"># 缓存源</div><div class="line">CACHES = &#123;</div><div class="line">    &apos;default&apos;: &#123;</div><div class="line">        &apos;BACKEND&apos;: &apos;django.core.cache.backends.memcached.MemcachedCache&apos;,</div><div class="line">        &apos;LOCATION&apos;: &apos;127.0.0.1:11211&apos;,</div><div class="line">    &#125;,</div><div class="line">    &apos;rest_backend&apos;: &#123;</div><div class="line">        &apos;BACKEND&apos;: &apos;django.core.cache.backends.locmem.LocMemCache&apos;,</div><div class="line">        &apos;LOCATION&apos;: &apos;unique-snowflake&apos;,</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">REST_FRAMEWORK_CACHE = &#123;</div><div class="line">    &apos;DEFAULT_CACHE_BACKEND&apos;: &apos;rest_backend&apos;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 全局超时时间</div><div class="line">REST_FRAMEWORK_CACHE = &#123;</div><div class="line">    &apos;DEFAULT_CACHE_TIMEOUT&apos;: 86400, # Default is 1 day</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>urls.py</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">from rest_framework_cache.registry import cache_registry</div><div class="line"></div><div class="line">cache_registry.autodiscover()</div></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p><code>django-rest-framework-cache</code> 是在序列化层进行缓存，所以将要缓存的序列化类注册到缓存中，同时需要使序列化类继承于 <code>CachedSerializerMixin</code>。</p>
<p>官方使用示例如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">from rest_framework import serializers</div><div class="line"></div><div class="line"># You must import the CachedSerializerMixin and cache_registry</div><div class="line">from rest_framework_cache.serializers import CachedSerializerMixin</div><div class="line">from rest_framework_cache.registry import cache_registry</div><div class="line"></div><div class="line">from .models import Comment</div><div class="line"></div><div class="line"></div><div class="line">class CommentSerializer(serializers.ModelSerializer, CachedSerializerMixin):</div><div class="line"></div><div class="line">    class Meta:</div><div class="line">        model = Comment</div><div class="line"></div><div class="line"></div><div class="line">cache_registry.register(CommentSerializer)</div></pre></td></tr></table></figure>
<p>按照官方配置会报错：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">TypeError: Error when calling the metaclass bases</div><div class="line">    Cannot create a consistent method resolution</div><div class="line">order (MRO) for bases CachedSerializerMixin, ModelSerializer</div></pre></td></tr></table></figure>
<p>stackoverflow 上给的解答是因为 Python 类继承的 MRO 算法导致。 由于 <code>CachedSerializerMixin</code> 是继承于 <code>serializers.ModelSerializer</code>, 必须先继承底层的类，再继承高层的类。这里因为 <code>serializers.ModelSerializer</code> 出现在 <code>CachedSerializerMixin</code> 之前导致报错。有兴趣可以了解一下 Python 多重继承的 <code>C3 线性化算法与 MRO</code>。</p>
<blockquote>
<p>参考：<a href="https://stackoverflow.com/questions/29214888/typeerror-cannot-create-a-consistent-method-resolution-order-mro" target="_blank" rel="external">TypeError: Cannot create a consistent method resolution order (MRO) </a></p>
</blockquote>
<p>将两者交换顺序即可：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class CommentSerializer(CachedSerializerMixin, serializers.ModelSerializer):</div></pre></td></tr></table></figure>
<p><code>django-rest-framework-cache</code> 存在一个问题就是对于嵌套的外键和多对多的模型，数据修改之后不会生效，因为缓存的是 <code>Serializer</code> 信息，只在该 <code>Serializer</code> 对应的 <code>Model</code> 实例被修改后才会刷新。不过这个问题已经有人改写了插件 <a href="https://github.com/yinkh/django-rest-framework-cache" target="_blank" rel="external">django-rest-framework-cache</a>。</p>
<blockquote>
<p>参考：<a href="https://www.yinkh.top/article/62/" target="_blank" rel="external">rest_framework_cache 优化接口访问速度</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近对 DRF 的接口进行监控，发现部分高频访问的接口性能不佳，响应比较慢，于是想通过缓存将接口性能优化。&lt;/p&gt;
&lt;p&gt;常用的解决方案如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://chibisov.github.io/drf-extensions/docs/#caching&quot;&gt;drf-extensions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://drf-cached-instances.readthedocs.io/en/latest/&quot;&gt;drf-cached-instances&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/Onyo/django-rest-framework-cache&quot;&gt;django-rest-framework-cache&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.django-rest-framework.org/api-guide/caching/#using-cache-with-apiview-and-viewsets&quot;&gt;django cache decorators&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://stackoverflow.com/questions/38320008/how-to-cache-django-rest-framework-api-calls&quot;&gt;How to cache Django Rest Framework API calls&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
  </entry>
  
  <entry>
    <title>使用 Vue CLI 快速创建 Vue 项目</title>
    <link href="http://yoursite.com/2019/01/19/vue-cli-create-project/"/>
    <id>http://yoursite.com/2019/01/19/vue-cli-create-project/</id>
    <published>2019-01-19T12:49:05.000Z</published>
    <updated>2019-01-20T01:42:51.965Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://cli.vuejs.org/zh/guide/" target="_blank" rel="external">Vue CLI</a> 是一个基于 Vue.js 进行快速开发的完整系统，提供：</p>
<ul>
<li>通过 @vue/cli 搭建交互式的项目脚手架</li>
<li>通过 @vue/cli + @vue/cli-service-global 快速开始零配置原型开发</li>
<li>一个运行时依赖 (@vue/cli-service)，该依赖<ul>
<li>可升级</li>
<li>基于 webpack 构建，并带有合理的默认配置</li>
<li>可以通过项目内的配置文件进行配置</li>
<li>可以通过插件进行扩展</li>
</ul>
</li>
<li>一个丰富的官方插件集合，集成了前端生态中最好的工具</li>
<li>一套完全图形化的创建和管理 Vue.js 项目的用户界面</li>
</ul>
<a id="more"></a>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Vue CLI 需要 Node 环境，确保已经安装 Node 环境和 npm 包管理工具<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ npm install -g @vue/cli</div></pre></td></tr></table></figure></p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ vue create hello-world</div><div class="line">Vue CLI v3.3.0</div><div class="line">? Please pick a preset: (Use arrow keys)</div><div class="line">❯ default (babel, eslint)  //默认选项提供 babel 和 eslint 支持，适合快速创建一个新项目的原型</div><div class="line">  Manually select features //手动选择特性，提供了更多的选项，它们是面向生产的项目更加需要的</div></pre></td></tr></table></figure>
<p>上下键选择、Enter 选中，我们选择第二项手动选择特性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Vue CLI v3.3.0</div><div class="line">? Please pick a preset: Manually select features</div><div class="line">? Check the features needed for your project: (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)</div><div class="line">❯◉ Babel  //支持babel</div><div class="line"> ◯ TypeScript  //支持使用 TypeScript 书写源码</div><div class="line"> ◯ Progressive Web App (PWA) Support</div><div class="line"> ◯ Router //支持 vue-router </div><div class="line"> ◯ Vuex  //支持 vuex </div><div class="line"> ◯ CSS Pre-processors  //支持 CSS 预处理器</div><div class="line"> ◉ Linter / Formatter  //支持代码风格检查和格式化</div><div class="line"> ◯ Unit Testing  //支持单元测试</div><div class="line"> ◯ E2E Testing  //支持 E2E 测试</div></pre></td></tr></table></figure>
<p>基于开发常见的项目，同时兼顾项目健壮性的原则，选择如下选项：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Vue CLI v3.3.0</div><div class="line">? Please pick a preset: Manually select features</div><div class="line">? Check the features needed for your project:</div><div class="line"> ◉ Babel</div><div class="line"> ◉ TypeScript</div><div class="line"> ◯ Progressive Web App (PWA) Support</div><div class="line"> ◉ Router</div><div class="line"> ◉ Vuex</div><div class="line"> ◉ CSS Pre-processors</div><div class="line"> ◉ Linter / Formatter</div><div class="line">❯◉ Unit Testing</div><div class="line"> ◯ E2E Testing</div></pre></td></tr></table></figure>
<p>开发 Vue 组件时是否使用 class 风格的写法 （是）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Vue CLI v3.3.0</div><div class="line">? Please pick a preset: Manually select features</div><div class="line">? Check the features needed for your project: Babel, TS, Router, Vuex, CSS Pre-processors, Linter, Unit</div><div class="line">? Use class-style component syntax? (Y/n) Y</div></pre></td></tr></table></figure></p>
<p>是否使用 babel 工具自动为转换后的 TypeScript 代码注入 polyfiills （是）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Use Babel alongside TypeScript for auto-detected polyfills? (Y/n) Y</div></pre></td></tr></table></figure></p>
<p>vue-router 是否使用 history 模式 （否，使用默认 hash 模式）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Use history mode for router? (Requires proper server setup for index fallback in production) (Y/n) n</div></pre></td></tr></table></figure></p>
<p>项目里面使用哪种 CSS 预处理语言（选择  LESS ）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Pick a CSS pre-processor (PostCSS, Autoprefixer and CSS Modules are supported by default): (Use arrow keys)</div><div class="line">  Sass/SCSS</div><div class="line">❯ Less</div><div class="line">  Stylus</div></pre></td></tr></table></figure></p>
<p>选择哪个自动化代码格式化检测（选择 ESLint + Prettier ）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Pick a linter / formatter config: (Use arrow keys)</div><div class="line">  TSLint</div><div class="line">  ESLint with error prevention only</div><div class="line">  ESLint + Airbnb config</div><div class="line">  ESLint + Standard config</div><div class="line">❯ ESLint + Prettier</div></pre></td></tr></table></figure></p>
<p>选择什么时候进行代码规则检查<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Pick additional lint features: (Press &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)</div><div class="line">❯◉ Lint on save //保存就检查</div><div class="line"> ◯ Lint and fix on commit // fix 和 commit 的时候检查</div></pre></td></tr></table></figure></p>
<p>选择单元测试工具 （ 选择 Mocha ）</p>
<p>Mocha 是流行的 JavaScript 测试框架之一，通过它添加和运行测试，Chai 是断言库<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Pick a unit testing solution: (Use arrow keys)</div><div class="line">❯ Mocha + Chai</div><div class="line">  Jest</div></pre></td></tr></table></figure></p>
<p>选择配置文件的位置 （ 选择独立文件存放 ）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Where do you prefer placing config for Babel, PostCSS, ESLint, etc.?</div><div class="line">❯ In dedicated config files  //配置存放独立文件</div><div class="line">  In package.json  //配置存放 package.json</div></pre></td></tr></table></figure></p>
<p>是否将以上这些将此保存为未来项目的预配置，对于 MAC 保存的配置信息会放在 ~/.vuerc 里面 （否）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">? Save this as a preset for future projects? (y/N)</div></pre></td></tr></table></figure>
<p>下一步初始化 CLI 插件<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Vue CLI v3.3.0</div><div class="line">✨  Creating project in /Users/abner/work_space/projects/vue-project/hello-world.</div><div class="line">🗃  Initializing git repository...</div><div class="line">⚙  Installing CLI plugins. This might take a while...</div><div class="line">......</div></pre></td></tr></table></figure></p>
<h3 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cd hello-world</div><div class="line">$ npm run serve</div></pre></td></tr></table></figure>
<p>浏览器看到的页面如下：</p>
<p><img src="/img/vue-cli-01.png" alt=""></p>
<p>代码结构：</p>
<p><img src="/img/vue-cli-02.png" alt=""></p>
<h3 id="打包上线"><a href="#打包上线" class="headerlink" title="打包上线"></a>打包上线</h3><p>项目开发完成之后需要打包上线，vue-cli 也提供了打包的命令<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ npm run build</div></pre></td></tr></table></figure></p>
<p>打包好的静态资源会保存在 dist 目录，直接部署到静态资源服务器即可。</p>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ npm run test</div></pre></td></tr></table></figure>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>这里使用的是 vue-cli 3.0，相比 vue-cli 2.X 有些许不同</p>
<ul>
<li>启动命令行有变化</li>
<li>配置可以保存</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://cli.vuejs.org/zh/guide/&quot;&gt;Vue CLI&lt;/a&gt; 是一个基于 Vue.js 进行快速开发的完整系统，提供：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通过 @vue/cli 搭建交互式的项目脚手架&lt;/li&gt;
&lt;li&gt;通过 @vue/cli + @vue/cli-service-global 快速开始零配置原型开发&lt;/li&gt;
&lt;li&gt;一个运行时依赖 (@vue/cli-service)，该依赖&lt;ul&gt;
&lt;li&gt;可升级&lt;/li&gt;
&lt;li&gt;基于 webpack 构建，并带有合理的默认配置&lt;/li&gt;
&lt;li&gt;可以通过项目内的配置文件进行配置&lt;/li&gt;
&lt;li&gt;可以通过插件进行扩展&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;一个丰富的官方插件集合，集成了前端生态中最好的工具&lt;/li&gt;
&lt;li&gt;一套完全图形化的创建和管理 Vue.js 项目的用户界面&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="http://yoursite.com/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Pipenv 快速上手</title>
    <link href="http://yoursite.com/2019/01/18/pipenv-quick-start/"/>
    <id>http://yoursite.com/2019/01/18/pipenv-quick-start/</id>
    <published>2019-01-18T09:26:22.000Z</published>
    <updated>2019-01-19T12:51:02.110Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://pipenv.readthedocs.io/en/latest/" target="_blank" rel="external">Pipenv</a> 是 Python 官方推荐的的包管理工具，它集成了 virtualenv、pyenv 和 pip 三者的功能。 Pipenv 是 requests 的作者 Kenneth Reitz 大神开发了用于创建和管理 Python 虚拟环境的工具。</p>
<p>Pipenv 主要解决了以下问题：</p>
<ul>
<li>不用再单独使用 virtualenv 和 pip，而是将两者结合</li>
<li>不用再维护 requirements.txt，使用 Pipfile 和 Pipfile.lock 来代替</li>
<li>可以在开发环境使用多个 Python 版本</li>
<li>在安装的 pyenv 条件下，可以自动安装需要的 Python 版本</li>
<li>随时查看图形化的依赖关系</li>
</ul>
<a id="more"></a>
<h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>和普通的第三方包安装相同，直接使用 pip 命令进行安装。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pip install pipenv</div></pre></td></tr></table></figure>
<h4 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h4><p>虚拟环境是每个 Python 项目的独立执行环境。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cd mytest</div><div class="line">$ pipenv  install</div><div class="line">Creating a virtualenv for this project...</div><div class="line">Pipfile: /root/deploys/mytest/Pipfile</div><div class="line">Using /usr/bin/python (2.7.15) to create virtualenv...</div><div class="line">⠋ Creating virtual environment...Already using interpreter /usr/bin/python</div><div class="line">New python executable in /root/.local/share/virtualenvs/mytest-2D3nqn7b/bin/python</div><div class="line">Installing setuptools, pip, wheel...</div><div class="line">done.</div><div class="line"></div><div class="line">✔ Successfully created virtual environment!</div><div class="line">Virtualenv location: /root/.local/share/virtualenvs/mytest-2D3nqn7b</div><div class="line">Creating a Pipfile for this project...</div><div class="line">Pipfile.lock not found, creating...</div><div class="line">Locking [dev-packages] dependencies...</div><div class="line">Locking [packages] dependencies...</div><div class="line">Updated Pipfile.lock (dfae9f)!</div><div class="line">Installing dependencies from Pipfile.lock (dfae9f)...</div><div class="line">  🐍   ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉ 0/0 — 00:00:00</div><div class="line">To activate this project&apos;s virtualenv, run pipenv shell.</div><div class="line">Alternatively, run a command inside the virtualenv with pipenv run.</div><div class="line">$ ls</div><div class="line">Pipfile  Pipfile.lock</div></pre></td></tr></table></figure>
<p>我们在一个新项目的目录中创建了虚拟环境，默认使用的是系统的 Python2 版本，当然也可以指定 Python 版本。Pipenv 也自动为我们选择虚拟环境的存储位置，创建完成之后目录下出现了 <code>Pipfile</code> 和 <code>Pipfile.lock</code> 两个文件。 </p>
<h4 id="激活和退出虚拟环境"><a href="#激活和退出虚拟环境" class="headerlink" title="激活和退出虚拟环境"></a>激活和退出虚拟环境</h4><p>激活虚拟环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv shell</div></pre></td></tr></table></figure>
<p>退出虚拟环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ exit //或者 ctrl+d</div></pre></td></tr></table></figure>
<h4 id="安装第三方包"><a href="#安装第三方包" class="headerlink" title="安装第三方包"></a>安装第三方包</h4><p>既然 Pipenv 能够替代 pip，那么我们就直接使用 Pipenv 命令来安装软件包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv install requests</div><div class="line">Installing requests...</div><div class="line">Adding requests to Pipfile&apos;s [packages]...</div><div class="line">✔ Installation Succeeded</div><div class="line">Pipfile.lock (ab273c) out of date, updating to (dfae9f)...</div><div class="line">Locking [dev-packages] dependencies...</div><div class="line">Locking [packages] dependencies...</div><div class="line">✔ Success!</div><div class="line">Updated Pipfile.lock (ab273c)!</div><div class="line">Installing dependencies from Pipfile.lock (ab273c)...</div><div class="line">  🐍   ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉ 5/5 — 00:00:02</div><div class="line">To activate this project&apos;s virtualenv, run pipenv shell.</div><div class="line">Alternatively, run a command inside the virtualenv with pipenv run.</div></pre></td></tr></table></figure>
<p>使用 Pipenv 安装第三方包不需要激活虚拟环境，会直接下载到虚拟环境中。如果使用 pip 安装，我们需要先激活项目的虚拟环境才能保证软件包的正确安装。安装完包之后，Pipfile 和 Pipfile.lock 两个文件会被更新。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat Pipfile</div><div class="line">[[source]]</div><div class="line">name = &quot;pypi&quot;</div><div class="line">url = &quot;https://pypi.org/simple&quot;</div><div class="line">verify_ssl = true</div><div class="line"></div><div class="line">[dev-packages]</div><div class="line"></div><div class="line">[packages]</div><div class="line">requests = &quot;*&quot;</div><div class="line"></div><div class="line">[requires]</div><div class="line">python_version = &quot;2.7&quot;</div><div class="line">$ cat Pipfile.lock</div><div class="line">&#123;</div><div class="line">    &quot;_meta&quot;: &#123;</div><div class="line">        &quot;hash&quot;: &#123;</div><div class="line">            &quot;sha256&quot;: &quot;9838c8bf3aa442453b393e09e534ba7e1666aab4da1b9b408ecdf3ae58ab273c&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;pipfile-spec&quot;: 6,</div><div class="line">        &quot;requires&quot;: &#123;</div><div class="line">            &quot;python_version&quot;: &quot;2.7&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;sources&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;name&quot;: &quot;pypi&quot;,</div><div class="line">                &quot;url&quot;: &quot;https://pypi.org/simple&quot;,</div><div class="line">                &quot;verify_ssl&quot;: true</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">    &quot;default&quot;: &#123;</div><div class="line">        &quot;certifi&quot;: &#123;</div><div class="line">            &quot;hashes&quot;: [</div><div class="line">                &quot;sha256:47f9c83ef4c0c621eaef743f133f09fa8a74a9b75f037e8624f83bd1b6626cb7&quot;,</div><div class="line">                &quot;sha256:993f830721089fef441cdfeb4b2c8c9df86f0c63239f06bd025a76a7daddb033&quot;</div><div class="line">            ],</div><div class="line">            &quot;version&quot;: &quot;==2018.11.29&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;chardet&quot;: &#123;</div><div class="line">            &quot;hashes&quot;: [</div><div class="line">                &quot;sha256:84ab92ed1c4d4f16916e05906b6b75a6c0fb5db821cc65e70cbd64a3e2a5eaae&quot;,</div><div class="line">                &quot;sha256:fc323ffcaeaed0e0a02bf4d117757b98aed530d9ed4531e3e15460124c106691&quot;</div><div class="line">            ],</div><div class="line">            &quot;version&quot;: &quot;==3.0.4&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;idna&quot;: &#123;</div><div class="line">            &quot;hashes&quot;: [</div><div class="line">                &quot;sha256:c357b3f628cf53ae2c4c05627ecc484553142ca23264e593d327bcde5e9c3407&quot;,</div><div class="line">                &quot;sha256:ea8b7f6188e6fa117537c3df7da9fc686d485087abf6ac197f9c46432f7e4a3c&quot;</div><div class="line">            ],</div><div class="line">            &quot;version&quot;: &quot;==2.8&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;requests&quot;: &#123;</div><div class="line">            &quot;hashes&quot;: [</div><div class="line">                &quot;sha256:502a824f31acdacb3a35b6690b5fbf0bc41d63a24a45c4004352b0242707598e&quot;,</div><div class="line">                &quot;sha256:7bf2a778576d825600030a110f3c0e3e8edc51dfaafe1c146e39a2027784957b&quot;</div><div class="line">            ],</div><div class="line">            &quot;index&quot;: &quot;pypi&quot;,</div><div class="line">            &quot;version&quot;: &quot;==2.21.0&quot;</div><div class="line">        &#125;,</div><div class="line">        &quot;urllib3&quot;: &#123;</div><div class="line">            &quot;hashes&quot;: [</div><div class="line">                &quot;sha256:61bf29cada3fc2fbefad4fdf059ea4bd1b4a86d2b6d15e1c7c0b582b9752fe39&quot;,</div><div class="line">                &quot;sha256:de9529817c93f27c8ccbfead6985011db27bd0ddfcdb2d86f3f663385c6a9c22&quot;</div><div class="line">            ],</div><div class="line">            &quot;version&quot;: &quot;==1.24.1&quot;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;develop&quot;: &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Pipfile 文件中记录了如下信息：</p>
<ul>
<li>pip 仓库地址</li>
<li>需要下载哪些包， * 表示始终下载最新版本，dev-packages 表示专用于开发阶段使用的包</li>
<li>Python 版本</li>
</ul>
<p>Pipfile.lock 文件中记录了包的详细信息：</p>
<ul>
<li>hash 值</li>
<li>依赖关系</li>
</ul>
<p>有了 Pipfile 文件当我们把项目部署到生产环境时，直接 pipenv install 就自动创建虚拟环境并把包安装好。</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="pipenv-选项"><a href="#pipenv-选项" class="headerlink" title="pipenv 选项"></a>pipenv 选项</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Options:</div><div class="line">  --where             Output project home information. </div><div class="line">  --venv              Output virtualenv information.</div><div class="line">  --py                Output Python interpreter information. </div><div class="line">  --envs              Output Environment Variable options.</div><div class="line">  --rm                Remove the virtualenv.</div><div class="line">  --bare              Minimal output.</div><div class="line">  --completion        Output completion (to be eval&apos;d).</div><div class="line">  --man               Display manpage.</div><div class="line">  --support           Output diagnostic information for use in GitHub issues.</div><div class="line">  --site-packages     Enable site-packages for the virtualenv.  [env var:</div><div class="line">                      PIPENV_SITE_PACKAGES]</div><div class="line">  --python TEXT       Specify which version of Python virtualenv should use.</div><div class="line">  --three / --two     Use Python 3/2 when creating virtualenv.</div><div class="line">  --clear             Clears caches (pipenv, pip, and pip-tools).  [env var:</div><div class="line">                      PIPENV_CLEAR]</div><div class="line">  -v, --verbose       Verbose mode.</div><div class="line">  --pypi-mirror TEXT  Specify a PyPI mirror.</div><div class="line">  --version           Show the version and exit.</div><div class="line">  -h, --help          Show this message and exit.</div></pre></td></tr></table></figure>
<h4 id="pipenv-命令参数"><a href="#pipenv-命令参数" class="headerlink" title="pipenv 命令参数"></a>pipenv 命令参数</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Commands:</div><div class="line">  check      Checks for security vulnerabilities and against PEP 508 markers</div><div class="line">             provided in Pipfile.</div><div class="line">  clean      Uninstalls all packages not specified in Pipfile.lock.</div><div class="line">  graph      Displays currently-installed dependency graph information.</div><div class="line">  install    Installs provided packages and adds them to Pipfile, or (if no</div><div class="line">             packages are given), installs all packages from Pipfile.</div><div class="line">  lock       Generates Pipfile.lock.</div><div class="line">  open       View a given module in your editor.</div><div class="line">  run        Spawns a command installed into the virtualenv.</div><div class="line">  shell      Spawns a shell within the virtualenv.</div><div class="line">  sync       Installs all packages specified in Pipfile.lock.</div><div class="line">  uninstall  Un-installs a provided package and removes it from Pipfile.</div><div class="line">  update     Runs lock, then sync.</div></pre></td></tr></table></figure>
<h4 id="pipenv-常用命令示例"><a href="#pipenv-常用命令示例" class="headerlink" title="pipenv 常用命令示例"></a>pipenv 常用命令示例</h4><p>创建项目虚拟环境指定 Python 版本<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv --python 3.7</div><div class="line">$ pipenv --python 2.7.15</div></pre></td></tr></table></figure></p>
<p>不必显式激活虚拟环境，用虚拟机环境执行命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv run python -m http.server</div><div class="line">$ pipenv run python test.py</div></pre></td></tr></table></figure>
<p>软件包只安装到开发环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv install pytest --dev</div></pre></td></tr></table></figure>
<p>删除虚拟环境，该操作会把虚拟环境目录和里面所有的依赖包删除，但是 Pipfile 和 Pipfile.lock 文件会保留</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv --rm</div></pre></td></tr></table></figure>
<p>删除软件包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv uninstall requests</div></pre></td></tr></table></figure>
<p>生成 requirements.txt 格式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv lock -r</div><div class="line">$ pipenv lock -r -d //生成 dev-packages 的 requirements.txt</div></pre></td></tr></table></figure>
<p>导入 requirements.txt </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv install -r requirements.txt</div></pre></td></tr></table></figure>
<p>显示依赖树</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv graph</div></pre></td></tr></table></figure>
<p>安全检查</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pipenv check</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;a href=&quot;https://pipenv.readthedocs.io/en/latest/&quot;&gt;Pipenv&lt;/a&gt; 是 Python 官方推荐的的包管理工具，它集成了 virtualenv、pyenv 和 pip 三者的功能。 Pipenv 是 requests 的作者 Kenneth Reitz 大神开发了用于创建和管理 Python 虚拟环境的工具。&lt;/p&gt;
&lt;p&gt;Pipenv 主要解决了以下问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不用再单独使用 virtualenv 和 pip，而是将两者结合&lt;/li&gt;
&lt;li&gt;不用再维护 requirements.txt，使用 Pipfile 和 Pipfile.lock 来代替&lt;/li&gt;
&lt;li&gt;可以在开发环境使用多个 Python 版本&lt;/li&gt;
&lt;li&gt;在安装的 pyenv 条件下，可以自动安装需要的 Python 版本&lt;/li&gt;
&lt;li&gt;随时查看图形化的依赖关系&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>摄影知识快速入门</title>
    <link href="http://yoursite.com/2018/12/23/%E6%91%84%E5%BD%B1%E7%9F%A5%E8%AF%86%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>http://yoursite.com/2018/12/23/摄影知识快速入门/</id>
    <published>2018-12-23T13:40:17.000Z</published>
    <updated>2018-12-23T13:43:27.468Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>三流的摄影师比器材，二流的摄影师比技术，一流的摄影师比思想。</p>
<blockquote>
<p>“照片从来不能解决问题，它总是在不断的提出问题：为什么会这样？如果你能不断的提出问题，你就会不断的按下快门，把你的思想和疑问传达出来。如果观众看过你的照片后也良久驻足，思考着你的思考，疑问着你的疑问，那您就快接近摄影的最高境界了”        《论摄影》</p>
</blockquote>
<h2 id="摄影名词"><a href="#摄影名词" class="headerlink" title="摄影名词"></a>摄影名词</h2><h3 id="ISO"><a href="#ISO" class="headerlink" title="ISO"></a>ISO</h3><p>ISO（感光度）是CCD（Charge Coupled Device，电子感光芯片）或是胶卷对光线的敏感程度。<br><a id="more"></a><br>数码相机的主菜单里都有ISO选择，100，200，400或者800等，数字越大越敏感（感光度越高）。如果用ISO100的胶卷，相机2秒可以正确曝光的话，同样光线条件下用ISO200的胶卷只需要1秒即可，用ISO400则只要0.5秒。高ISO虽然速度快但图像颗粒粗，经不起精细放大。高ISO一般在万不得已的时候才用，<code>高ISO图片质量是数码相机最重要的指标之一。</code></p>
<p>简单的来说，提高ISO就是提高电子放大倍数，微弱的光线只能产生微弱的电子信号，这个时候数码相机的放大电路工作，把信号放大来得到正确的曝光照片，但噪点多，细节丢失，颜色失真。</p>
<p>同样像素的普通数码相机和单反相机的高ISO图片质量差别很大，主要原因是普通相机和单反相机的感光芯片大小（面积）不同。感光芯片CCD就是一个光电转换器，把光照转变为可记录的电子信号。假如CCD为1000万像素，要正确曝光，每个像素点必须要有一定的光照强度。同样的曝光时间，面积大的CCD接受的阳光多，分配到每个像素点的光照充分，这样图片的细节会更丰富，噪点少，颜色准确。<code>在同等技术条件下，如像素相等，CCD面积越大，高ISO的成像质量越好。</code></p>
<h3 id="快门"><a href="#快门" class="headerlink" title="快门"></a>快门</h3><p><code>快门是能够准确的控制曝光时间的装置。</code></p>
<p>快门有机械快门、电子快门以及电子机械联合快门。</p>
<h4 id="安全快门速度"><a href="#安全快门速度" class="headerlink" title="安全快门速度"></a>安全快门速度</h4><p>安全速度是焦距的倒数，如果用50mm镜头，快门速度不要低于1/50秒，使用200mm镜头速度不低于1/200秒，以此类推，否则照片会糊。</p>
<h3 id="光圈"><a href="#光圈" class="headerlink" title="光圈"></a>光圈</h3><p><code>光圈就是镜头里调节进光孔大小的装置。</code></p>
<p>所有相机都是基于小孔成像原理：拿一个密封箱子，在任何一面钻个小圆孔，窗外的景象比如一棵树什么的，就会在圆孔对面的箱内壁生成此树的倒影。假如在箱子小孔对面的内壁涂上感光材料，这个有孔的箱子就是一台针孔相机。</p>
<p>既然一台照相机可以不需要镜头，为什么现在的相机前面不是一个小圆孔而是几块玻璃呢？而且这几块玻璃还卖得那么贵。这是因为小孔要成像的话，孔必须很小，如果孔开得和门一样大，这个孔就成不了像。孔小进光量就小，针孔摄影一张照片曝光几小时到几十个小时都常见。我们要想办法加大进光量。凸镜有聚光功能。把玻璃凸镜装到大孔上，问题不就解决了？</p>
<p>确实如此。镜头就是这样诞生的。今天的各种镜头都是几块凹凸镜的排列组合，然后用塑料或铁皮一包。有了镜头，小孔成像的这个孔（光圈）就不再是针孔了，它变成了洞。</p>
<p>并不是任何时候都需要大洞。夏日沙滩上烈日当头，四处白花花一片，为了分清到底是人肉还是白沙，我们需要眯着眼睛仔细观察。镜头是照相机的眼睛，这时候相机也需要眯起眼睛。<code>为了应付不同的光线强度，我们还需要给镜头装上能够调节这个洞大小的装置，以便在强光时缩小为针孔，弱光时开成大洞。这个装置就是光圈（Aperture）。一组凹凸镜再加上光圈就诞生了完整的镜头。</code></p>
<p>常见的光圈值如下：F1，F1.4，F2，F2.8，F4，F5.6，F8，F11，F16，F22，F32，F44，F64。<code>每两挡相邻光圈值之间进光量相差一倍。例如光圈从F4调到F2.8，进光量便多一倍；从F2.8到F2又多一倍。光圈值和光圈实际大小是相反的，进光量最大时光圈为F1，最小时为F64。</code></p>
<p><img src="/img/aperture.png" alt=""></p>
<h3 id="曝光"><a href="#曝光" class="headerlink" title="曝光"></a>曝光</h3><blockquote>
<p>假设一个黑乎乎的密闭房间，一面墙壁上开了个小圆窗户，在窗对面的内壁上安上感光材料就是一台大型房式照相机。在没有打开小窗之前，房间里是黑乎乎的。上帝说：要有光。我们打开小窗，光线从小孔而入，射到对面墙壁的胶卷上，产生光化反应（或CCD光电反应），图像就诞生了。此过程就叫曝光。要正确曝光必须精确决定曝光量，也就是让多少光进入房间。光圈和快门都可以控制曝光量。曝光就是光圈和快门的组合。光圈大小其实就是小圆窗户开多大，快门（速度）就是窗户开多久。若窗户开1/4，时间4秒能正确曝光，很显然窗户打开1/2，时间2秒钟也能正确曝光。如果窗户全开，曝光时间就只要1秒了。</p>
</blockquote>
<p>一张正确曝光的图片可以有N种不同的光圈和快门组合。</p>
<p>有三个因素能影响一张图片是否正确曝光：<code>光圈，快门速度，ISO。</code>其中光圈和速度联合决定进光量，ISO决定CCD感光速度。进光量不够则可开大光圈或者增加曝光时间，还不够就提高ISO。大光圈的解像度不好，快门速度低则图片可能会糊，高ISO图片质量也差。</p>
<h3 id="测光与测光模式"><a href="#测光与测光模式" class="headerlink" title="测光与测光模式"></a>测光与测光模式</h3><p>曝光和测光是一对双胞胎，不测定光照强度正确曝光就无从谈起。所有的数码相机都内置测光表，它能测量光线的强度，自动给出正确曝光的光圈和快门。数码相机里都有一个光敏电阻（光照不同时电阻不同），相机内根据电阻的变化就能确定光线强度，进而确定曝光值。</p>
<p>测光模式主要有<code>点测光，中央重点测光，区域（平均）测光三种。</code></p>
<p>点测光只测取景框内中央小点的光线强度。区域（平均）测光则把取景框分为很多小块，分别对每块测光再加权平均得到光照强度。中央重点测光只把取景框分为中央圆圈和四周两块分别测光。大多数情况下用区域平均测光即可，在明暗反差很大时多采用点测光。</p>
<h3 id="曝光补偿"><a href="#曝光补偿" class="headerlink" title="曝光补偿"></a>曝光补偿</h3><p>曝光是否准确是根据经验判断的。总原则：<code>照片要真实反映拍摄时的环境亮度。</code>如果正午阳光户外被拍得昏暗如夜，这就是曝光不足；夜景拍得跟白天一样则是曝光过度。相机自动确定的曝光值90%以上是正确的，但也有不准的，如雪景应该纯白拍出来却是灰色，或纯黑的煤球拍出来却是灰煤。</p>
<p>假设两个极端，纯黑物体反射率为零，纯白物体反射率是100%。在这两个极端取中间值就是不黑也不白的灰色，称柯达灰，也称18度中间灰。</p>
<p>以客厅为例，墙壁又白又亮，电视机屏幕又黑又暗，家具等亮度居中。要以谁的亮度来确定曝光？相机自动测光就是取平均数，最后给出一个让图片达到中间灰的曝光值。</p>
<p>相机的自动测光是个死脑筋，它认为全世界所有场景的平均亮度都是18度中间灰。好在大部分生活场景平均起来差不多也是灰色。但在雪景或者煤球等纯色场景，相机依然给出中间灰的曝光值，拍出来就会白雪成灰雪，煤球成灰球。<code>此时我们就要对自动曝光予以修正，对雪景增加曝光，煤球减少曝光，这样才能拍出亮度正确的照片。增减曝光值就叫曝光补偿。</code></p>
<p><strong>曝光补偿原则：白加黑减。如果有大片白色物体或有强灯等特别明亮的物体就要增加曝光量；有大片黑色物体则要减少曝光量。</strong></p>
<h3 id="焦距与焦距转换系数"><a href="#焦距与焦距转换系数" class="headerlink" title="焦距与焦距转换系数"></a>焦距与焦距转换系数</h3><p>镜头的焦距就是从镜片（或镜片组）的中心到底片(CCD)的距离，单位毫米（mm）。对全幅135数码单反来说，50mm镜头为标准镜头，简称标头。<code>标头严格的定义：焦距等于底片（或CCD）对角线长度的镜头。</code>单张135底片对角线长度为43mm，我们把焦距40-60mm的都称为标头。</p>
<p>请注意：一个镜头是不是标头不是看焦距而是看视角，视角45度左右就是标准镜头。对120相机来说80-110mm焦距的镜头才是标头。对Nikon D5000等非全幅数码单反，35mm才是标头。</p>
<p><code>广角镜头（焦距小于35mm）</code>能够让照相机“看得更宽广”，因为它视角大；<code>长焦镜头（焦距大于70mm）</code>能让照相机“看得更远”，但视角窄。长焦镜头也称远摄镜头或望远镜头。广角镜头都身材矮小，长焦镜头都高大威猛。</p>
<h3 id="光学变焦与数码变焦"><a href="#光学变焦与数码变焦" class="headerlink" title="光学变焦与数码变焦"></a>光学变焦与数码变焦</h3><p>数码相机上都写着XX倍光学变焦（Optical Zoom）。<code>变焦倍数＝最大焦距/最小焦距。</code>一个28-280mm镜头的光学变焦倍数是280mm/28mm=10倍。倍数越大镜片越多，体积相应较大，画质相对较低，光圈相对较小。如Nikon P90光学变焦为26-624mm（24倍），但实测镜头边缘解像度差，看来24倍已经接近光学变焦目前的技术极限了。</p>
<p>数码变焦只是电子放大，软件稍作改动就可以从一倍到一万倍变焦任君自取。光学变焦才是真正的变焦。</p>
<p><img src="/img/zoom.png" alt=""></p>
<h3 id="景深与光圈优先"><a href="#景深与光圈优先" class="headerlink" title="景深与光圈优先"></a>景深与光圈优先</h3><p><code>景深就是照片焦点前后延伸出来的“可接受清晰区域”。</code>它只是一个概念，相机上并没有一个开关叫景深。清晰与否也没有绝对标准。一张合影若人脸很清晰，前面的鲜花和后面建筑物都模糊，清晰区域只限于人，我们就称此照片景深较浅（小）。若人鲜花和建筑物都清晰，照片的清晰区域很广，就称景深很大。风光摄影一般需要大景深，前后景物都要清楚。</p>
<p>有三个因素决定景深：</p>
<ul>
<li>光圈大小</li>
<li>焦距长短</li>
<li>被摄物体的远近</li>
</ul>
<p>景深的确定原则：</p>
<ul>
<li>光圈越大，景深越小</li>
<li>焦距越长，景深越小</li>
<li>离被摄物体越近，景深越小</li>
</ul>
<p>若镜头的最小光圈为F22，这时候景深最大，在F2.8的时候景深最小（如果此镜头最大光圈是F2.8）。焦距越长景深越小这个好理解，广角镜头景深大，长焦镜头景深小。实际上17mm的超广角镜头如果使用F11以下的中小光圈，随便你朝何处对焦，前后景物都清晰。200mm或更长的镜头景深很小，一定要仔细小心对焦，最好在三角架上拍。离被摄物体越近，景深越小。所以在超近距离拍摄时要特别小心对焦，例如用微距镜头拍花花草草或小狗脸部特写。</p>
<h4 id="光圈的三个作用"><a href="#光圈的三个作用" class="headerlink" title="光圈的三个作用"></a>光圈的三个作用</h4><ul>
<li><p>控制进光量</p>
</li>
<li><p>控制景深。光圈越小，景深越大。虽然焦距和拍摄远近都影响景深，但焦距和被摄物远近的改变同时也会改变构图。当构图确定，能控制景深的武器就只剩下光圈了。</p>
</li>
<li><p>光圈影响图片的清晰度。任何一个镜头都是中等光圈时成像最好（最清晰），最大光圈和最小光圈时解像度差。</p>
</li>
</ul>
<h4 id="光圈优先"><a href="#光圈优先" class="headerlink" title="光圈优先"></a>光圈优先</h4><p>光圈优先（Aperture Priority）：手动确定光圈的大小，相机会根据这个光圈值确定能正确曝光的快门速度。大写的A或者Av就代表光圈优先模式。</p>
<p>曝光是光圈和快门的组合，光圈优先对应的概念是<code>快门优先或速度优先：手动确定快门速度，相机会根据这个快门速度确定能正确曝光的光圈大小。简写为T或Tv。</code>在某些时候快门速度很重要，要定格运动员冲刺撞线，快门速度最好在1/500秒甚至更快；如果要把流水拍得如丝般柔滑，快门速度要在0.5秒或者更慢。</p>
<h3 id="白平衡与RAW"><a href="#白平衡与RAW" class="headerlink" title="白平衡与RAW"></a>白平衡与RAW</h3><p>要了解白平衡white balance就必须先了解另一个概念：色温color temperaturet。所谓色温就是以开尔文温度表示光线的色彩，单位是K。物体被加热到一定的温度时就会发出光线，此光线不仅含有亮度的成份，也含有颜色的成份。温度越高，蓝色的成份越多，图像就会偏蓝；温度越低，红色的成份就越多，图像就会偏红。</p>
<p><img src="/img/color_temperaturet.png" alt=""></p>
<h4 id="光线色温"><a href="#光线色温" class="headerlink" title="光线色温"></a>光线色温</h4><p>不同色温的光源下物体会呈现不同的色调，在日光灯下整体偏白，在普通白炽灯下整体偏黄。<code>白平衡就是相机在不同光源下对白色的还原。</code>有时候相机对色温判断错误，严重偏蓝或发黄。这时我们就要手动设置白平衡。万一人脑也判断错误怎么办？要彻底解决白平衡和色温准确性只有一个方案：选择RAW存储格式。</p>
<p>常用的图片压缩存储格式为JPEG或JPG。但JPEG是一种有损压缩，某些细节丢失。大部分相机都有图片质量选择，也就是JPEG压缩比选择，压缩得越厉害，文件越小，一张卡能存储更多照片，但细节丢失更多。</p>
<blockquote>
<p>数码相机CCD经曝光产生电子信号，相机把电子信号进行处理，再传给存储卡。这些处理包括白平衡配置，颜色饱和度的增减，锐度和对比度增减，降噪等，最后压缩为JPEG格式存储。</p>
</blockquote>
<p>RAW英文是原始的意思，这很好地说明了RAW图片的特点：<code>它是原始的，CCD产生的电子信号直接传给存储卡，没有经过相机的任何处理，没有一点细节丢失。</code>我们回家后在电脑上可以给RAW图片任意配置色温（彻底解决白平衡问题），调整颜色，锐度，对比度，曝光等等。桌面电脑比相机内的小电脑强大得多，后期精心处理RAW转换成的JPEG图片肯定漂亮。</p>
<p>RAW的问题还是文件太大，而且处理费时间。如果旅行十天拍了上千张RAW，后期处理会让人头变得巨大。还好很多相机可以同时存储JPEG和RAW，如果JPEG图片还不错就不用处理RAW了。重要的拍摄存JPEG+RAW，一般图片存JPEG。</p>
<h2 id="基本摄影思想"><a href="#基本摄影思想" class="headerlink" title="基本摄影思想"></a>基本摄影思想</h2><p>一张好照片必须有一个鲜明的主题，并且能正确的表达主题。</p>
<p>主要需从两方面努力：</p>
<ul>
<li><p>精心构图</p>
</li>
<li><p>熟练掌握光圈快门等技术活</p>
</li>
</ul>
<h3 id="构图的原则和方法"><a href="#构图的原则和方法" class="headerlink" title="构图的原则和方法"></a>构图的原则和方法</h3><p>摄影最重要的是：和主题无关的事物一律排除在取景框之外。在按下快门前一定要想想：能否继续减少取景框内的事物？如果再排除一个那我想表达的意思就不完整了，这时才可以按下快门。<code>摄影是做减法。</code></p>
<p>综上所述，<code>简洁二字是摄影构图最基本的原则。</code>只有在完全贯彻了这个原则，确定一张图片里绝对不能缺少的事物之后，才谈得上如何在取景框里如何摆放这些事物。</p>
<h4 id="构图法"><a href="#构图法" class="headerlink" title="构图法"></a>构图法</h4><p>最重要的有三个：</p>
<ul>
<li>黄金分割法</li>
<li>对称法</li>
<li>满框法</li>
</ul>
<h5 id="黄金分割法"><a href="#黄金分割法" class="headerlink" title="黄金分割法"></a>黄金分割法</h5><p>把一条线分割为两部分，使其中一部分与全长之比等于另一部分与这部分之比，其比值是0.618，这个分割点就是黄金分割点。黄金分割在所有的构图原则里是最重要的一个，很多数码相机在菜单里都有是否打开构图线的选择，打开后液晶屏就会出现九宫格，四条线把取景框长宽各作三等分。<code>构图时我们应该把照片中的主体（视觉焦点）摆在三等分线上或者三等分线的交点上。</code>通俗的说，不要把主体放在正中间，那样照片显得很呆板，要靠左右/上下一些才好看。实际拍摄中并没有必要严格遵守0.618比1或者1比3，多一点少一点均可，只要看起来舒服就好。</p>
<p><code>图片的视觉焦点:</code>视觉焦点就是一张图片最吸引人的地方。在看一张有明显视觉焦点的照片时，第一眼我们肯定会被图片最醒目的点所吸引，然后我们会看看图片的四周有些什么，最后目光还是会集中到视觉焦点上。这就是我们看图片的视觉习惯：集中-分散-再集中。</p>
<h4 id="对称法"><a href="#对称法" class="headerlink" title="对称法"></a>对称法</h4><p>一般来说，70%以上的图片可以用黄金分割构图法，但对有些图片黄金分割并不是最佳选择。典型的例子是建筑。大多数建筑都是对称结构，强行按照黄金分割来构图反而破坏了原有的美感。水面倒影也是一例。对倒影和建筑等本来对称的景物显然我们应该顺其自然采用对称构图法，一半对一半。对称可以是左右，上下，也可以斜着对称。</p>
<blockquote>
<p>对称并不一定要是同一类型物体（建筑或倒影），不同的事物也可以对称，或称之为对比。</p>
</blockquote>
<h4 id="满框与留白"><a href="#满框与留白" class="headerlink" title="满框与留白"></a>满框与留白</h4><p>黄金分割加上对称构图能搞定85%以上的图片，但还是有一些图片让人左右为难。那就干脆把主体充满取景框，排除任何其他物体（简洁到极限）。这就是满框构图原则。</p>
<p>满框往往意味着构图只取局部，并不一定要把主体拍全，观众能根据局部想象全局。这是一种极端构图，它最大限度地突出主题。它的优点也是它的缺点：太满了，让人感觉堵得慌。大多数情况下还是要给画面留点空出气，这就是构图时的留白。留多少合适？一般来说留1/4或者1/5。留在图片的什么地方？可以是任何位置。留白四分之一原则也要灵活掌握，多一点少一点看具体需要。</p>
<p>留白也可以走极端，这就是与满框相反的留白构图法：主体只在取景框内占一个小角落，其他地方大量空白。这是一种反向衬托，大量空白把观众的注意力吸引到非空白处-照片角落的主体上。 留白另外一个好处是方便编辑排版，空白处可供写字。如果你的照片日后要给杂志社，大量留白需要重点考虑。</p>
<h4 id="其他构图注意事项"><a href="#其他构图注意事项" class="headerlink" title="其他构图注意事项"></a>其他构图注意事项</h4><p>1.寻找有趣的形状</p>
<blockquote>
<p>这可以从宏观和微观两方面去找。宏观就是从大场景找。通常这意味着在一大片景观中取局部。摄影就要充分发挥这种宏观想象力。</p>
<p>微观找形状就是要视力好，眼光毒，从几英寸几厘米的小面积上发现有趣的形状。这通常也是物体的微小局部。寻找有趣形状还是意味着追求简洁，不要贪多是构图的总原则。</p>
</blockquote>
<p>2.前景与背景</p>
<blockquote>
<p>前景指照片中位于主体前面、靠近镜头的任何景物。它的作用是增强画面的空间感，提高画面的感染力，也能起到交待拍摄地点（环境）的作用。这一点很重要，它使照片能传达尽可能多的信息。好的前景还兼有引导视线的作用。</p>
</blockquote>
<p>3.包围构图</p>
<blockquote>
<p>构图简洁第一重要，但凡事没有绝对，如果全景与局部难以决定，或不能确定是否应该包含某一物体，那就包含与否都拍，回家再仔细分析哪张效果好。反正数码片子不用花钱买胶卷。分析多了就知道以后如何取舍了。包围构图这个词是我自己发明的，和包围曝光相对应。</p>
</blockquote>
<p>4.横拍与竖拍</p>
<p><strong>总之，规则是死的，人是活的，局限于条条框框没有必要。一张照片可能毫无构图法则可言，也可能是好几条构图法的综合。</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.midphoto.com/chinese/essays/essays.htm" target="_blank" rel="external">数码时代旅游摄影快速指南</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;三流的摄影师比器材，二流的摄影师比技术，一流的摄影师比思想。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“照片从来不能解决问题，它总是在不断的提出问题：为什么会这样？如果你能不断的提出问题，你就会不断的按下快门，把你的思想和疑问传达出来。如果观众看过你的照片后也良久驻足，思考着你的思考，疑问着你的疑问，那您就快接近摄影的最高境界了”        《论摄影》&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;摄影名词&quot;&gt;&lt;a href=&quot;#摄影名词&quot; class=&quot;headerlink&quot; title=&quot;摄影名词&quot;&gt;&lt;/a&gt;摄影名词&lt;/h2&gt;&lt;h3 id=&quot;ISO&quot;&gt;&lt;a href=&quot;#ISO&quot; class=&quot;headerlink&quot; title=&quot;ISO&quot;&gt;&lt;/a&gt;ISO&lt;/h3&gt;&lt;p&gt;ISO（感光度）是CCD（Charge Coupled Device，电子感光芯片）或是胶卷对光线的敏感程度。&lt;br&gt;
    
    </summary>
    
    
      <category term="photo" scheme="http://yoursite.com/tags/photo/"/>
    
  </entry>
  
  <entry>
    <title>Django 最佳实践(译)</title>
    <link href="http://yoursite.com/2018/12/19/django-best-practices/"/>
    <id>http://yoursite.com/2018/12/19/django-best-practices/</id>
    <published>2018-12-19T14:59:08.000Z</published>
    <updated>2018-12-20T00:39:45.695Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><ul>
<li>使用 <a href="https://pipenv.readthedocs.io" target="_blank" rel="external">Pipenv</a> 管理虚拟环境</li>
<li>使用 <a href="https://docs.djangoproject.com/en/dev/topics/auth/customizing/#using-a-custom-user-model-when-starting-a-project" target="_blank" rel="external">自定义用户模型</a></li>
<li>尽可能地使用<a href="https://docs.djangoproject.com/en/dev/topics/class-based-views/generic-display/" target="_blank" rel="external">通用类视图 GCBV</a>，然后才是<a href="https://docs.djangoproject.com/en/dev/topics/class-based-views/" target="_blank" rel="external">类视图</a>而不是函数视图</li>
<li>使用<a href="https://github.com/joke2k/django-environ" target="_blank" rel="external">环境变量</a>来管理像 <code>SECRET_KET</code> 这样的变量</li>
<li>使用<a href="https://simpleisbetterthancomplex.com/tips/2017/07/03/django-tip-20-working-with-multiple-settings-modules.html" target="_blank" rel="external">多 setting 文件</a>，DEBUG 模式不允许出现在生产环境中</li>
<li>本地使用基于 <a href="https://wsvincent.com/django-docker-postgresql/" target="_blank" rel="external">Docker</a> 的 Postgres 数据库</li>
<li>进行单元测试和集成测试，越多越好</li>
</ul>
<a id="more"></a>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><ul>
<li>使用 <a href="https://www.ponycheckup.com/" target="_blank" rel="external">Pony Checkup</a> 检查网站的安全</li>
<li>始终使用最新版 Django</li>
<li>用 <a href="https://docs.djangoproject.com/en/2.0/topics/security/#ssl-https" target="_blank" rel="external">SSL/HTTPS</a> 部署</li>
<li>修改 admin 的 url，不要使用默认的 <code>/admin/</code></li>
</ul>
<h2 id="第三方包"><a href="#第三方包" class="headerlink" title="第三方包"></a>第三方包</h2><ul>
<li><a href="https://github.com/jazzband/django-debug-toolbar" target="_blank" rel="external">django-debug-toolbar</a> 调试消息和数据库查询</li>
<li><a href="https://github.com/django-extensions/django-extensions" target="_blank" rel="external">django-extensions</a> 收集了很多扩展库，尤其是 <code>runserver_plus</code></li>
<li><a href="https://github.com/pennersr/django-allauth" target="_blank" rel="external">django-allauth</a> 提供社交认证和用户email确认</li>
<li><a href="https://whitenoise.readthedocs.io" target="_blank" rel="external">Whitenoise</a> 用于静态文件（也可以使用S3）</li>
<li><a href="https://sentry.io" target="_blank" rel="external">Sentry</a> 记录错误日志</li>
</ul>
<h2 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h2><ul>
<li>最流行的 Django 项目目录结构 <a href="https://github.com/pydanny/cookiecutter-django" target="_blank" rel="external">cookiecutter-django</a></li>
<li>使用 <a href="https://www.django-rest-framework.org/" target="_blank" rel="external">Django Rest Framework</a>来构建 Result API</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://wsvincent.com/django-best-practices/" target="_blank" rel="external">Django Best Practices</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;基础&quot;&gt;&lt;a href=&quot;#基础&quot; class=&quot;headerlink&quot; title=&quot;基础&quot;&gt;&lt;/a&gt;基础&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;使用 &lt;a href=&quot;https://pipenv.readthedocs.io&quot;&gt;Pipenv&lt;/a&gt; 管理虚拟环境&lt;/li&gt;
&lt;li&gt;使用 &lt;a href=&quot;https://docs.djangoproject.com/en/dev/topics/auth/customizing/#using-a-custom-user-model-when-starting-a-project&quot;&gt;自定义用户模型&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;尽可能地使用&lt;a href=&quot;https://docs.djangoproject.com/en/dev/topics/class-based-views/generic-display/&quot;&gt;通用类视图 GCBV&lt;/a&gt;，然后才是&lt;a href=&quot;https://docs.djangoproject.com/en/dev/topics/class-based-views/&quot;&gt;类视图&lt;/a&gt;而不是函数视图&lt;/li&gt;
&lt;li&gt;使用&lt;a href=&quot;https://github.com/joke2k/django-environ&quot;&gt;环境变量&lt;/a&gt;来管理像 &lt;code&gt;SECRET_KET&lt;/code&gt; 这样的变量&lt;/li&gt;
&lt;li&gt;使用&lt;a href=&quot;https://simpleisbetterthancomplex.com/tips/2017/07/03/django-tip-20-working-with-multiple-settings-modules.html&quot;&gt;多 setting 文件&lt;/a&gt;，DEBUG 模式不允许出现在生产环境中&lt;/li&gt;
&lt;li&gt;本地使用基于 &lt;a href=&quot;https://wsvincent.com/django-docker-postgresql/&quot;&gt;Docker&lt;/a&gt; 的 Postgres 数据库&lt;/li&gt;
&lt;li&gt;进行单元测试和集成测试，越多越好&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
  </entry>
  
  <entry>
    <title>QuerySet API 学习笔记</title>
    <link href="http://yoursite.com/2018/08/19/QuerySet-API-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    <id>http://yoursite.com/2018/08/19/QuerySet-API-学习笔记/</id>
    <published>2018-08-19T04:51:03.000Z</published>
    <updated>2018-08-19T04:52:12.089Z</updated>
    
    <content type="html"><![CDATA[<h3 id="QuerySets-evaluated"><a href="#QuerySets-evaluated" class="headerlink" title="QuerySets evaluated"></a>QuerySets evaluated</h3><p>可以创建、过滤、切片和传递查询集而不用真实操作数据库。在你对查询集做求值之前，不会发生任何实际的数据库操作。</p>
<p>对于查询集我们使用以下方法进行求值：</p>
<ul>
<li>Iteration</li>
<li>Slicing</li>
<li>Pickling/Caching</li>
<li>repr()</li>
<li>len()</li>
<li>list()</li>
<li>bool()</li>
</ul>
<h3 id="QuerySet-API"><a href="#QuerySet-API" class="headerlink" title="QuerySet API"></a>QuerySet API</h3><h4 id="返回新的查询集方法"><a href="#返回新的查询集方法" class="headerlink" title="返回新的查询集方法"></a>返回新的查询集方法</h4><ul>
<li>filter</li>
</ul>
<p>返回一个新的 QuerySet 包含给定参数的查询匹配对象，更复杂的查询可以使用 Q 对象。</p>
<ul>
<li>exclude</li>
</ul>
<p>返回一个新的 QuerySet，它包含不满足给定的查找参数的对象，更复杂的查询同样可以使用 Q 对象。</p>
<a id="more"></a>
<ul>
<li>annotate</li>
</ul>
<p>使用提供的查询表达式给 QuerySet 的每个对象增加注释，可以理解为增加一个新的属性。</p>
<p>查询表达式可以是一个简单的值、模型（或关联模型）字段的一个引用或对查询集中的对象一个聚合函数（平均值、和等）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; from django.db.models import Count</div><div class="line">&gt;&gt;&gt; q = Blog.objects.annotate(Count(&apos;entry&apos;))</div><div class="line">&gt;&gt;&gt; q[0].name</div><div class="line">&apos;Blogasaurus&apos;</div><div class="line">&gt;&gt;&gt; q[0].entry__count # 新增的 entry__count 属性</div><div class="line">42</div><div class="line"></div><div class="line"># 指定注释名称</div><div class="line">&gt;&gt;&gt; q = Blog.objects.annotate(number_of_entries=Count(&apos;entry&apos;))</div><div class="line">&gt;&gt;&gt; q[0].number_of_entries</div><div class="line">42</div></pre></td></tr></table></figure>
<p>使用 annotate 需要用 django.db.models 的统计方法。除了 Count 统计方法之外，还有 Max、Min、Sum、Avg 等方法。</p>
<ul>
<li>order_by</li>
</ul>
<p>指定 QuerySet 排序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 升序</div><div class="line">&gt;&gt;&gt; Author.objects.filter().order_by(&apos;name&apos;)</div><div class="line">&lt;QuerySet [&lt;Author: abner&gt;, &lt;Author: mike&gt;]&gt;</div><div class="line"> </div><div class="line"># 降序</div><div class="line">&gt;&gt;&gt; Author.objects.filter().order_by(&apos;-name&apos;)</div><div class="line">&lt;QuerySet [&lt;Author: mike&gt;, &lt;Author: abner&gt;]&gt;</div><div class="line"></div><div class="line"># 随机排序，不推荐使用(速度慢、查询昂贵)</div><div class="line">&gt;&gt;&gt; Author.objects.order_by(&apos;?&apos;)</div></pre></td></tr></table></figure>
<ul>
<li>reverse</li>
</ul>
<p>反向排序 QuerySet 中返回的元素</p>
<ul>
<li>distinct</li>
</ul>
<p>返回一个新的 QuerySet 并去除查询结果中的重复的行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; CompileRules.objects.values(&apos;business__name&apos;).distinct()</div><div class="line">&lt;QuerySet [&#123;&apos;business__name&apos;: &apos;img.ppdai.com&apos;&#125;, &#123;&apos;business__name&apos;: &apos;api.alert.risk.ppdaicorp.com&apos;&#125;, &#123;&apos;business__name&apos;: &apos;api.antifraud.risk.ppdaicorp.com&apos;&#125;, &#123;&apos;business__name&apos;: &apos;chargingjob.ppdapi.com&apos;&#125;]&gt;</div><div class="line"></div><div class="line">&gt;&gt;&gt; rules = CompileRules.objects.distinct().values_list(&apos;business__name&apos;)</div><div class="line">&gt;&gt;&gt; [i[0] for i in rules]</div><div class="line">[&apos;img.ppdai.com&apos;,&apos;api.alert.risk.ppdaicorp.com&apos;,&apos;api.antifraud.risk.ppdaicorp.com&apos;,&apos;chargingjob.ppdapi.com&apos;]</div></pre></td></tr></table></figure>
<ul>
<li>values</li>
</ul>
<p>把 QuerySets 当作迭代器使用，返回一个字典，而不是模型实例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; Author.objects.filter(name=&apos;abner&apos;).values()</div><div class="line">&lt;QuerySet [&#123;&apos;id&apos;: 2, &apos;name&apos;: &apos;abner&apos;, &apos;email&apos;: &apos;abner@163.com&apos;&#125;, &#123;&apos;id&apos;: 3, &apos;name&apos;: &apos;abner&apos;, &apos;email&apos;: &apos;abner@qq.com&apos;&#125;]&gt;</div><div class="line"></div><div class="line"></div><div class="line"># 指定字段</div><div class="line">&gt;&gt;&gt; Author.objects.values(&apos;name&apos;)</div><div class="line">&lt;QuerySet [&#123;&apos;name&apos;: &apos;abner&apos;&#125;,&#123;&apos;name&apos;: &apos;abner&apos;&#125;,v&#123;&apos;name&apos;: &apos;mike&apos;&#125;]&gt;</div><div class="line"></div><div class="line"></div><div class="line"># 数据库函数，Lower 返回小写形式</div><div class="line">&gt;&gt;&gt; from django.db.models.functions import Lower</div><div class="line">&gt;&gt;&gt; Author.objects.values(lower=Lower(&apos;name&apos;))</div><div class="line">&lt;QuerySet [&#123;&apos;lower&apos;: &apos;dkey&apos;&#125;, &#123;&apos;lower&apos;: &apos;jerry&apos;&#125;, &#123;&apos;lower&apos;: &apos;jerry&apos;&#125;]&gt;</div></pre></td></tr></table></figure>
<ul>
<li>values_list</li>
</ul>
<p>以元组的形式返回查询集，可以返回特定字段的值，也可以是列表的形式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; Business.objects.filter(level=1).values_list(&apos;id&apos;, &apos;name&apos;)</div><div class="line">&lt;TreeQuerySet [(3, &apos;借入运营&apos;), (106, &apos;借入借贷&apos;), (219, &apos;数据决策平台&apos;), (225, &apos;数据架构&apos;), (234, &apos;测试&apos;)]&gt;</div><div class="line"></div><div class="line">&gt;&gt;&gt; Business.objects.filter(level=1).values_list(&apos;name&apos;, flat=True)</div><div class="line">&lt;TreeQuerySet [&apos;借入运营&apos;, &apos;借入借贷&apos;, &apos;数据决策平台&apos;, &apos;数据架构&apos;, &apos;测试&apos;]&gt;</div></pre></td></tr></table></figure>
<ul>
<li>dates</li>
</ul>
<blockquote>
<p>dates(field, kind, order=’ASC’)</p>
</blockquote>
<p>返回 datetime.date 对象列表，查询的字段应该是 DateField 模型，kind应为”year”、”month”或”day”。隐式的是升序排序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">1.year:返回字段不同年份值列表</div><div class="line">2.month:返回字段所有不同年/月值列表</div><div class="line">3.day:返回字段所有不同年/月/日值列表</div></pre></td></tr></table></figure>
<ul>
<li>datetimes</li>
</ul>
<blockquote>
<p>datetimes(field_name, kind, order=’ASC’, tzinfo=None)</p>
</blockquote>
<p>返回 datetime.datetimes 对象列表，查询的字段应该是 DateField 模型，kind应为”year”、”month”或”day”。隐式的是升序排序</p>
<ul>
<li>none</li>
</ul>
<p>创建一个不返回任何对象的查询集，访问结果时不会执行任何查询。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; Entry.objects.none()</div><div class="line">[]</div><div class="line">&gt;&gt;&gt; from django.db.models.query import EmptyQuerySet</div><div class="line">&gt;&gt;&gt; isinstance(Entry.objects.none(), EmptyQuerySet)</div><div class="line">True</div></pre></td></tr></table></figure>
<ul>
<li>all</li>
</ul>
<p>所有查询集</p>
<ul>
<li>select_related</li>
</ul>
<blockquote>
<p>对于 ForeignKey 和 OneToOneField 等字段，通过添加 select_related，可以把相关的对象在一次查询中查出，之后使用时就不需要再次查数据库</p>
</blockquote>
<p>返回一个新的查询集，沿着外键查询关联对象的数据。它会生成一个复杂的查询并引起性能的损耗，但是在以后使用外键关系时将不需要数据库查询。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 普通查询</div><div class="line"># Hits the database.</div><div class="line">e = Entry.objects.get(id=5)</div><div class="line"># Hits the database again to get the related Blog object.</div><div class="line">b = e.blog</div><div class="line"></div><div class="line">#select_related 查询 </div><div class="line"># Hits the database.</div><div class="line">e = Entry.objects.select_related(&apos;blog&apos;).get(id=5)</div><div class="line"># Doesn&apos;t hit the database, because e.blog has been prepopulated</div><div class="line"># in the previous query.</div><div class="line">b = e.blog</div></pre></td></tr></table></figure>
<ul>
<li>prefetch_related</li>
</ul>
<blockquote>
<p>prefetch_related 对于相关对象会进行一次独立的查询，然后在 Python 中把对象关联起来。所以prefetch_related可以用于many-to-many and many-to-one关系</p>
</blockquote>
<ul>
<li>extra</li>
</ul>
<blockquote>
<p>extra(select=None, where=None, params=None, tables=None, order_by=None, select_params=None)</p>
</blockquote>
<p>有些情况下，Django的查询语法难以简单的表达复杂的 WHERE 子句，对于这种情况, Django 提供了 extra() QuerySet 修改机制 — 它能在 QuerySet生成的SQL从句中注入新子句</p>
<p>extra可以指定一个或多个参数,例如 select, where or tables。 这些参数都不是必须的，但是你至少要使用一个</p>
<ul>
<li>defer</li>
</ul>
<p>排除不需要的字段，降低性能损耗</p>
<ul>
<li>only</li>
</ul>
<p>仅选择需要的字段</p>
<ul>
<li>using</li>
</ul>
<blockquote>
<p>using(alias) // alias 数据库别名</p>
</blockquote>
<p>如果使用多个数据库，改方法可以控制从哪个数据库上求值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># queries the database with the &apos;default&apos; alias.</div><div class="line">&gt;&gt;&gt; Entry.objects.all()</div><div class="line"></div><div class="line"># queries the database with the &apos;backup&apos; alias</div><div class="line">&gt;&gt;&gt; Entry.objects.using(&apos;backup&apos;)</div></pre></td></tr></table></figure>
<ul>
<li>select_for_update</li>
</ul>
<p>返回一个 queryset ，会锁定相关行直到事务结束</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">entries = Entry.objects.select_for_update().filter(author=request.user)</div></pre></td></tr></table></figure>
<p>所有匹配的行将被锁定，直到事务结束。这意味着可以通过锁防止数据被其它事务修改。</p>
<ul>
<li>raw</li>
</ul>
<p>接收一个原始的SQL 查询，执行它并返回一个django.db.models.query.RawQuerySet 实例</p>
<p>Django提供两种方法使用原始SQL进行查询：一种是使用Manager.raw()方法，进行原始查询并返回模型实例；另一种是完全避开模型层，直接执行自定义的SQL语句。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; raw = Author.objects.raw(&apos;select * from polls_author&apos;)</div><div class="line">&gt;&gt;&gt; type(raw)</div><div class="line">&lt;class &apos;django.db.models.query.RawQuerySet&apos;&gt;</div></pre></td></tr></table></figure>
<h4 id="不返回新的查询集"><a href="#不返回新的查询集" class="headerlink" title="不返回新的查询集"></a>不返回新的查询集</h4><ul>
<li>get</li>
</ul>
<p>返回按照参数匹配的对象</p>
<ul>
<li>create</li>
</ul>
<p>创建并保存对象</p>
<ul>
<li>get_or_create</li>
</ul>
<p>通过给定参数来查询对象，如果对象不存在则会创建一个新的对象</p>
<p>返回一个由(object, created)组成的元组，元组中的object 是一个查询到的或者是被创建的对象， created 是一个表示是否创建了新的对象的布尔值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">try:</div><div class="line">    obj = Person.objects.get(first_name=&apos;John&apos;, last_name=&apos;Lennon&apos;)</div><div class="line">except Person.DoesNotExist:</div><div class="line">    obj = Person(first_name=&apos;John&apos;, last_name=&apos;Lennon&apos;, birthday=date(1940, 10, 9))</div><div class="line">    obj.save()</div><div class="line">    </div><div class="line"># use get_or_create</div><div class="line">obj, created = Person.objects.get_or_create(first_name=&apos;John&apos;, last_name=&apos;Lennon&apos;,</div><div class="line">                  defaults=&#123;&apos;birthday&apos;: date(1940, 10, 9)&#125;)</div></pre></td></tr></table></figure>
<p>任何传递给 get_or_create() 的关键字参数，除了一个可选的defaults，都将传递给get() 调用</p>
<blockquote>
<p>get_or_create() 在Django 视图中的使用。请确保只在POST 请求中使用，除非你有充分的理由。GET 请求不应该对数据有任何影响。而POST 则用于对数据产生影响的请求</p>
</blockquote>
<ul>
<li>update_or_create</li>
</ul>
<p>通过给定参数来更新对象，如果对象不存在则会创建一个新的对象</p>
<p>一个通过给出的kwargs 来更新对象的便捷方法， 如果需要的话创建一个新的对象。defaults 是一个由 (field, value) 对组成的字典，用于更新对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">try:</div><div class="line">    obj = Person.objects.get(first_name=&apos;John&apos;, last_name=&apos;Lennon&apos;)</div><div class="line">    for key, value in updated_values.iteritems():</div><div class="line">        setattr(obj, key, value)</div><div class="line">    obj.save()</div><div class="line">except Person.DoesNotExist:</div><div class="line">    updated_values.update(&#123;&apos;first_name&apos;: &apos;John&apos;, &apos;last_name&apos;: &apos;Lennon&apos;&#125;)</div><div class="line">    obj = Person(**updated_values)</div><div class="line">    obj.save()</div><div class="line">    </div><div class="line"></div><div class="line"># use update_or_create</div><div class="line">obj, created = Person.objects.update_or_create(</div><div class="line">    first_name=&apos;John&apos;, last_name=&apos;Lennon&apos;, defaults=updated_values)</div></pre></td></tr></table></figure>
<blockquote>
<p>和上文描述的get_or_create() 一样，这个方式容易导致竞态条件，如果数据库层级没有前置唯一性它会让多行同时插入。</p>
</blockquote>
<ul>
<li>bulk_create</li>
</ul>
<p>批量写入数据</p>
<ul>
<li>count</li>
</ul>
<p>返回 QuerySet 对象个数</p>
<ul>
<li>in_bulk</li>
</ul>
<p>获取主键值的列表，并返回将每个主键值映射到具有给定ID的对象的实例的字典。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; Blog.objects.in_bulk([1])</div><div class="line">&#123;1: &lt;Blog: Beatles Blog&gt;&#125;</div><div class="line">&gt;&gt;&gt; Blog.objects.in_bulk([1, 2])</div><div class="line">&#123;1: &lt;Blog: Beatles Blog&gt;, 2: &lt;Blog: Cheddar Talk&gt;&#125;</div><div class="line">&gt;&gt;&gt; Blog.objects.in_bulk([])</div><div class="line">&#123;&#125;</div></pre></td></tr></table></figure>
<ul>
<li>iterator</li>
<li>latest:使用作为日期字段提供的field_name，按日期返回表中的最新对象</li>
<li>earliest</li>
<li>first</li>
<li>last</li>
<li>aggregate:聚合查询</li>
</ul>
<p>返回一个字典，包含根据QuerySet 计算得到的聚合值（平均数、和等等）。aggregate() 的每个参数指定返回的字典中将要包含的值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; from django.db.models import Count</div><div class="line">&gt;&gt;&gt; q = Blog.objects.aggregate(Count(&apos;entry&apos;))</div><div class="line">&#123;&apos;entry__count&apos;: 16&#125;</div><div class="line"></div><div class="line">&gt;&gt;&gt; q = Blog.objects.aggregate(number_of_entries=Count(&apos;entry&apos;))</div><div class="line">&#123;&apos;number_of_entries&apos;: 16&#125;</div></pre></td></tr></table></figure>
<ul>
<li>exists</li>
</ul>
<p>exists() 用于搜寻对象是否在QuerySet 中以及QuerySet 是否存在任何对象，特别是QuerySet 比较大的时候。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># exists 方法比普通方法快</div><div class="line">entry = Entry.objects.get(pk=123)</div><div class="line">if some_queryset.filter(pk=entry.pk).exists():</div><div class="line">    print(&quot;Entry contained in queryset&quot;)</div><div class="line">    </div><div class="line"># 普通方法</div><div class="line">if entry in some_queryset:</div><div class="line">   print(&quot;Entry contained in QuerySet&quot;)    </div><div class="line">   </div><div class="line"># 判断 queryset 是否含有对象，exists 比普通判断快特别是查询集比较大的情况下   </div><div class="line">if some_queryset.exists():</div><div class="line">    print(&quot;There is at least one object in some_queryset&quot;)</div><div class="line">    </div><div class="line">if some_queryset:</div><div class="line">    print(&quot;There is at least one object in some_queryset&quot;)</div></pre></td></tr></table></figure>
<ul>
<li>update</li>
</ul>
<p>对指定的字段执行SQL更新查询，并返回匹配的行数</p>
<ul>
<li>delete</li>
</ul>
<p>对QuerySet中的所有行执行SQL删除查询</p>
<ul>
<li>as_manager</li>
</ul>
<h4 id="字段查找"><a href="#字段查找" class="headerlink" title="字段查找"></a>字段查找</h4><table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">exact</td>
<td style="text-align:left">精确匹配</td>
</tr>
<tr>
<td style="text-align:left">iexact</td>
<td style="text-align:left">忽略大小写精确匹配</td>
</tr>
<tr>
<td style="text-align:left">contains</td>
<td style="text-align:left">包含关系</td>
</tr>
<tr>
<td style="text-align:left">icontains</td>
<td style="text-align:left">忽略大小写包含关系</td>
</tr>
<tr>
<td style="text-align:left">in</td>
<td style="text-align:left">在给定的列表</td>
</tr>
<tr>
<td style="text-align:left">gt</td>
<td style="text-align:left">大于</td>
</tr>
<tr>
<td style="text-align:left">gte</td>
<td style="text-align:left">大于等于</td>
</tr>
<tr>
<td style="text-align:left">lt</td>
<td style="text-align:left">小于</td>
</tr>
<tr>
<td style="text-align:left">lte</td>
<td style="text-align:left">小于等于</td>
</tr>
<tr>
<td style="text-align:left">startswith</td>
<td style="text-align:left">区分大小写，从开始位置匹配</td>
</tr>
<tr>
<td style="text-align:left">istartswith</td>
<td style="text-align:left">不区分大小写，从开始位置匹配</td>
</tr>
<tr>
<td style="text-align:left">endswith</td>
<td style="text-align:left">区分大小写，从结束位置匹</td>
</tr>
<tr>
<td style="text-align:left">iendswith</td>
<td style="text-align:left">不区分大小写，从结束位置匹配</td>
</tr>
<tr>
<td style="text-align:left">range</td>
<td style="text-align:left">范围测试（包含于之中）</td>
</tr>
<tr>
<td style="text-align:left">year</td>
<td style="text-align:left">对于日期和日期时间字段，年份匹配</td>
</tr>
<tr>
<td style="text-align:left">month</td>
<td style="text-align:left">对于日期和日期时间字段，月份匹配</td>
</tr>
<tr>
<td style="text-align:left">day</td>
<td style="text-align:left">对于日期和日期时间字段，天数匹配</td>
</tr>
<tr>
<td style="text-align:left">week_day</td>
<td style="text-align:left">星期匹配</td>
</tr>
<tr>
<td style="text-align:left">hour</td>
<td style="text-align:left">对于日期时间字段，精确的小时匹配</td>
</tr>
<tr>
<td style="text-align:left">minute</td>
<td style="text-align:left">对于日期时间字段，精确的分钟匹配</td>
</tr>
<tr>
<td style="text-align:left">second</td>
<td style="text-align:left">对于datetime字段，精确的秒匹配</td>
</tr>
<tr>
<td style="text-align:left">isnull</td>
<td style="text-align:left">判断字段值为 True 或 False</td>
</tr>
<tr>
<td style="text-align:left">search</td>
<td style="text-align:left">一个Boolean类型的全文搜索，以全文搜索的优势</td>
</tr>
<tr>
<td style="text-align:left">regex</td>
<td style="text-align:left">正则表达式</td>
</tr>
<tr>
<td style="text-align:left">iregex</td>
<td style="text-align:left">不区分大小写的正则表达式匹配</td>
</tr>
</tbody>
</table>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://docs.djangoproject.com/en/1.11/ref/models/querysets/" target="_blank" rel="external">官方文档</a></p>
<p><a href="https://wizardforcel.gitbooks.io/django-chinese-docs-18/content/2_2_2_QuerySet%20method%20reference.html" target="_blank" rel="external">Django 1.8 中文文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;QuerySets-evaluated&quot;&gt;&lt;a href=&quot;#QuerySets-evaluated&quot; class=&quot;headerlink&quot; title=&quot;QuerySets evaluated&quot;&gt;&lt;/a&gt;QuerySets evaluated&lt;/h3&gt;&lt;p&gt;可以创建、过滤、切片和传递查询集而不用真实操作数据库。在你对查询集做求值之前，不会发生任何实际的数据库操作。&lt;/p&gt;
&lt;p&gt;对于查询集我们使用以下方法进行求值：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Iteration&lt;/li&gt;
&lt;li&gt;Slicing&lt;/li&gt;
&lt;li&gt;Pickling/Caching&lt;/li&gt;
&lt;li&gt;repr()&lt;/li&gt;
&lt;li&gt;len()&lt;/li&gt;
&lt;li&gt;list()&lt;/li&gt;
&lt;li&gt;bool()&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;QuerySet-API&quot;&gt;&lt;a href=&quot;#QuerySet-API&quot; class=&quot;headerlink&quot; title=&quot;QuerySet API&quot;&gt;&lt;/a&gt;QuerySet API&lt;/h3&gt;&lt;h4 id=&quot;返回新的查询集方法&quot;&gt;&lt;a href=&quot;#返回新的查询集方法&quot; class=&quot;headerlink&quot; title=&quot;返回新的查询集方法&quot;&gt;&lt;/a&gt;返回新的查询集方法&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;filter&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;返回一个新的 QuerySet 包含给定参数的查询匹配对象，更复杂的查询可以使用 Q 对象。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;exclude&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;返回一个新的 QuerySet，它包含不满足给定的查找参数的对象，更复杂的查询同样可以使用 Q 对象。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Django" scheme="http://yoursite.com/tags/Django/"/>
    
  </entry>
  
  <entry>
    <title>豆瓣房源爬虫小记</title>
    <link href="http://yoursite.com/2018/04/05/douban-spider/"/>
    <id>http://yoursite.com/2018/04/05/douban-spider/</id>
    <published>2018-04-05T06:03:55.000Z</published>
    <updated>2018-11-14T15:51:00.816Z</updated>
    
    <content type="html"><![CDATA[<p>最近又要开始找房，来上海三年不到已经是第三次搬家，真是居大不易。现在住的房子是在豆瓣小组上找的，豆瓣上个人房源较多，但是豆瓣小组没有对房源信息进行分类，找起来比较费时，索性写了个简单的爬虫，根据关键字来找房。网上也有一些现成的代码实现，想着还是自己实践一下。</p>
<p>Python 新手上路…</p>
<h3 id="获取豆瓣房源小组链接"><a href="#获取豆瓣房源小组链接" class="headerlink" title="获取豆瓣房源小组链接"></a>获取豆瓣房源小组链接</h3><p>先搜索一下上海的租房小组</p>
<p><img src="/img/270B4257-2781-4F04-A000001F-A539B7F1791D.png" alt=""></p>
<p>找几个人数较多和活跃度高的小组，进入小组讨论页面，观察 URL 的规律。<br><a id="more"></a><br><img src="/img/1D40CBE0-36C5-45E4-9B42-0E7823ADF269.png" alt=""><br><img src="/img/7BD30596-ABF6-428C-BF7B-D232B1C6605D.png" alt=""></p>
<p>由此可知我们可以通过 <code>https://www.douban.com/group/&lt;组名&gt;/disscussion</code> 来获取不同组的房源帖子信息，我选取了五个小组进行爬取。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">In [1]: import os</div><div class="line">In [2]: group_list = [&apos;shanghaizufang&apos;, &apos;homeatshanghai&apos;, &apos;383972&apos;, &apos;shzf&apos;, &apos;251101&apos;]</div><div class="line">In [3]: index_url = [os.path.join(&apos;https://www.douban.com/group&apos;, i, &apos;discussion&apos;) for i in group_list]</div><div class="line">In [4]: index_url</div><div class="line">Out[4]:</div><div class="line">[&apos;https://www.douban.com/group/shanghaizufang/discussion&apos;,</div><div class="line"> &apos;https://www.douban.com/group/homeatshanghai/discussion&apos;,</div><div class="line"> &apos;https://www.douban.com/group/383972/discussion&apos;,</div><div class="line"> &apos;https://www.douban.com/group/shzf/discussion&apos;,</div><div class="line"> &apos;https://www.douban.com/group/251101/discussion&apos;]</div></pre></td></tr></table></figure>
<h3 id="资源定位"><a href="#资源定位" class="headerlink" title="资源定位"></a>资源定位</h3><p>通过查看页面元素信息，找到每个帖子标题所对应的网页代码。我们可以发现每个房源标题对应的是一个 <code>class</code> 属性为 <code>title</code> 的 <code>td</code> 标记。</p>
<p><img src="/img/59E824C2-AC6A-45F4-86D4-2582065E92A5.png" alt=""></p>
<p>使用 <code>BeautifulSoup</code> 尝试获取一下小组讨论中帖子标题网页代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">In [1]: import requests</div><div class="line">In [2]: from bs4 import BeautifulSoup</div><div class="line">In [3]: url = &apos;https://www.douban.com/group/shanghaizufang/discussion&apos;</div><div class="line">In [4]: headers = &#123;&apos;User-Agent&apos;: &apos;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/537.36 &apos;</div><div class="line">   ...:                                  &apos;(KHTML, like Gecko) Chrome/47.0.2526.80 Safari/537.36&apos;&#125;</div><div class="line">In [5]: res = requests.get(url, headers=headers)</div><div class="line">In [6]: soup = BeautifulSoup(res.text, &apos;html.parser&apos;)</div><div class="line">In [7]: title_list = soup.find_all(&apos;td&apos;, class_=&apos;title&apos;)</div><div class="line">In [8]: for tl in title_list:</div><div class="line">    ...:     print(tl)</div><div class="line">    ...:</div><div class="line">&lt;td class=&quot;title&quot;&gt;</div><div class="line">&lt;a class=&quot;&quot; href=&quot;https://www.douban.com/group/topic/114471599/&quot; title=&quot;黄浦区临地铁4号13号线单间出租。2300！无中介，可月租！&quot;&gt;</div><div class="line">                       黄浦区临地铁4号13号线单间出租。2300！无中介，可...</div><div class="line">                    &lt;/a&gt;</div><div class="line">&lt;/td&gt;</div><div class="line">&lt;td class=&quot;title&quot;&gt;</div><div class="line">&lt;a class=&quot;&quot; href=&quot;https://www.douban.com/group/topic/113810667/&quot; title=&quot;——有阳台·房间空间大·低价出租·2260元·正南·电梯房·步行6分钟到7号线·《盒马生鲜·DFC影院·大华锦绣国际》隔壁·锦绣华城2街区&quot;&gt;</div><div class="line">                       ——有阳台·房间空间大·低价出租·2260元·正南...</div><div class="line">                    &lt;/a&gt;</div><div class="line">&lt;/td&gt;</div><div class="line">&lt;td class=&quot;title&quot;&gt;</div><div class="line">&lt;a class=&quot;&quot; href=&quot;https://www.douban.com/group/topic/111282163/&quot; title=&quot;7号线杨高南路___北艾路1200弄超大1室_正南_大飘窗_2790元&quot;&gt;</div><div class="line">                       7号线杨高南路___北艾路1200弄超大1室_正南_大飘窗...</div><div class="line">                    &lt;/a&gt;</div><div class="line">&lt;/td&gt;</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="关键字过滤"><a href="#关键字过滤" class="headerlink" title="关键字过滤"></a>关键字过滤</h3><p>通过 <code>BeautifulSoup</code> 我们已经成功获取到帖子标题相关网页代码信息，接下来就是匹配我们的关键字并把对应标题的 url 保存下来，这样我们就不用一页页去找房源信息。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">In [9]: for tl in title_list:</div><div class="line">    ...:     print(tl.a[&apos;title&apos;], tl.a[&apos;href&apos;])</div><div class="line">    ...:</div><div class="line">紧靠漕河泾地铁12号线虹梅路站古美小区精装一室户随时看房 https://www.douban.com/group/topic/114690388/</div><div class="line">【性价比最高】【2/4/6/9】世纪大道地铁站口200米内，2018.4.5起三天内【出租】有效 https://www.douban.com/group/topic/114031302/</div><div class="line">陆家嘴，2号线东昌路站，精装南北两房一厅，5400元可谈，乳山四村 https://www.douban.com/group/topic/114838496/</div><div class="line">7号线30秒___高科西路2111弄（独立阳台_洗漱）2890 https://www.douban.com/group/topic/111749919/</div><div class="line">1号线外环路站______主卧朝南、近地铁 https://www.douban.com/group/topic/115006334/</div><div class="line">7号线__成山路2388弄(高档小区）__环境美_2090元 https://www.douban.com/group/topic/111343989/</div><div class="line">1500元就能租到社区一居室/复式低价火热出租ING https://www.douban.com/group/topic/114031502/</div><div class="line">1号线❤️莲花路站❤️朝南+落地窗（4分钟到地铁）___2200¥ https://www.douban.com/group/topic/115010633/</div><div class="line">工作调动2469号线德平路地铁站两房！价格可刀 https://www.douban.com/group/topic/114668639/</div><div class="line">2号线 淞虹路站 通协小区 朝南主卧带飘窗 随时入住 精装全配 可做饭 凌空首选随时入住先到先得 2700/月 https://www.douban.com/group/topic/114638949/</div><div class="line">3号线铁力路站，实体墙一室带独立卫生间，可以做饭，出租1900元。 https://www.douban.com/group/topic/115000070/</div><div class="line">1号线莲花路站_____步行2分钟（西班牙名园小区） https://www.douban.com/group/topic/115009200/</div><div class="line">—落地大阳台·2780元·豪装—海归首选房—敞亮的大房子《陆家嘴·锦绣里》高档小区—电梯房 https://www.douban.com/group/topic/113808306/</div><div class="line">静安高荣小区朝南带阳台主卧出租&lt;限女生&gt;3100/月，直接和房东签合同 https://www.douban.com/group/topic/114799989/</div><div class="line">1号线❤️外环路站【主卧独卫】地铁口__ 上海阳城小区 https://www.douban.com/group/topic/115008659/</div><div class="line">五角场附近主卧出租，市光路70弄小区，限女生 https://www.douban.com/group/topic/113345605/</div><div class="line">7号线_北艾路1200弄__正南温馨_干净安静：1690元（租女生） https://www.douban.com/group/topic/112014980/</div><div class="line">7号线锦绣路站【山姆会员店】旁边  朝南精装大1室 带飘窗__2490元 https://www.douban.com/group/topic/111243092/</div><div class="line">一三四八号线上海火车站附近 （2400）限一个女生 （实图个图）有厨房 朝南主卧 https://www.douban.com/group/topic/114856540/</div><div class="line">一室一厅一厨一卫整租！7号线，上海大学地铁站！6分钟！ https://www.douban.com/group/topic/114814137/</div><div class="line">【无中介】2号线 中山公园和8号线翔殷路（靠近10号线五角广场）及9号线松江大学城站一室户 https://www.douban.com/group/topic/114031377/</div><div class="line">七号线南陈路，整租两房两厅，便宜出租！ https://www.douban.com/group/topic/113826619/</div><div class="line">7号线__北艾路1200弄__超大一室，非常温馨：2490元 https://www.douban.com/group/topic/112276783/</div><div class="line">2/4/6/9号线世纪大道站，精装双南两房一厅，6600元可谈，梅园五街坊 https://www.douban.com/group/topic/114883174/</div><div class="line">这应该是徐家汇最好的公寓 https://www.douban.com/group/topic/113839494/</div><div class="line"></div><div class="line">In [10]: keyword = &apos;1号线&apos;</div><div class="line">In [11]: for tl in title_list:</div><div class="line">    ...:     if keyword in tl.a[&apos;title&apos;]:</div><div class="line">    ...:         print(tl.a[&apos;title&apos;], tl.a[&apos;href&apos;])</div><div class="line">    ...:</div><div class="line">1号线外环路站______主卧朝南、近地铁 https://www.douban.com/group/topic/115006334/</div><div class="line">1号线❤️莲花路站❤️朝南+落地窗（4分钟到地铁）___2200¥ https://www.douban.com/group/topic/115010633/</div><div class="line">1号线莲花路站_____步行2分钟（西班牙名园小区） https://www.douban.com/group/topic/115009200/</div><div class="line">1号线❤️外环路站【主卧独卫】地铁口__ 上海阳城小区 https://www.douban.com/group/topic/115008659/</div></pre></td></tr></table></figure>
<h3 id="页码控制"><a href="#页码控制" class="headerlink" title="页码控制"></a>页码控制</h3><p>以上海租房小组为例，之前测试爬取的路径是 <code>https://www.douban.com/group/shanghaizufang/discussion</code> 默认只会爬取第一页的 25 条信息，那么我们想爬取更多的信息，如何控制爬取的页码呢？</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/40E19CBD-E356-4CFA-B635-A430631C84D0.png" alt=""></p>
<p>通过　<code>class</code> 属性为 <code>next</code> 的 <code>span</code>　标记可以获取到下一页的链接地址，<code>https://www.douban.com/group/shanghaizufang/discussion?start=25</code> 表示第二页从第 25 条记录开始展示，我们可以通过这个控制要爬取的信息条数。</p>
<h3 id="代码概览"><a href="#代码概览" class="headerlink" title="代码概览"></a>代码概览</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># -*- coding:utf-8 -*-</div><div class="line"></div><div class="line">import os</div><div class="line">import requests</div><div class="line">import time</div><div class="line">from bs4 import BeautifulSoup</div><div class="line"></div><div class="line"></div><div class="line">class DouBanHouseSpider(object):</div><div class="line"></div><div class="line">    &quot;&quot;&quot;</div><div class="line">    抓取豆瓣小组房源信息</div><div class="line"></div><div class="line">     Attributes:</div><div class="line">        key_word: 房源标题关键字</div><div class="line">        page_num: 每个小组的抓取页数</div><div class="line">        group_list: 豆瓣小组列表</div><div class="line">        index_url: 豆瓣小组列表链接</div><div class="line">        data: 存放抓取结果</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    def __init__(self, key_word, page_num):</div><div class="line">        self.key_word = key_word</div><div class="line">        self.page_num = page_num</div><div class="line">        self.group_list = [&apos;shanghaizufang&apos;, &apos;homeatshanghai&apos;, &apos;383972&apos;, &apos;shzf&apos;, &apos;251101&apos;]</div><div class="line">        self.index_url = [os.path.join(&apos;https://www.douban.com/group&apos;, i, &apos;discussion&apos;) for i in self.group_list]</div><div class="line">        self.data = &#123;&#125;</div><div class="line">        print(&apos;豆瓣房源爬虫准备就绪, 开始爬取数据...&apos;)</div><div class="line"></div><div class="line">    def get_url_content(self, url):</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        根据 url 抓取页面数据</div><div class="line"></div><div class="line">        Args:</div><div class="line">            url: 豆瓣小组链接</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        try:</div><div class="line">            time.sleep(1)</div><div class="line">            headers = &#123;&apos;User-Agent&apos;: &apos;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/537.36 &apos;</div><div class="line">                                     &apos;(KHTML, like Gecko) Chrome/47.0.2526.80 Safari/537.36&apos;&#125;</div><div class="line">            res = requests.get(url, headers=headers)</div><div class="line">            soup = BeautifulSoup(res.text, &apos;html.parser&apos;)</div><div class="line">            title_list = soup(&apos;td&apos;, class_=&apos;title&apos;)</div><div class="line">            for tl in title_list:</div><div class="line">                if self.key_word in tl.a.attrs[&apos;title&apos;]:</div><div class="line">                    self.data[tl.a.attrs[&apos;title&apos;]] = tl.a.attrs[&apos;href&apos;]</div><div class="line">            next_page = soup(&apos;span&apos;, class_=&apos;next&apos;)</div><div class="line">            if next_page:</div><div class="line">                next_url = next_page[0].link.attrs[&apos;href&apos;]</div><div class="line">                end_title = next_url.split(&apos;=&apos;)[1]</div><div class="line">                if int(end_title) &lt; (self.page_num * 25):</div><div class="line">                    self.get_url_content(next_url)</div><div class="line">        except Exception as e:</div><div class="line">            print(&apos;抓取过程报错：%s&apos; % e)</div><div class="line"></div><div class="line">    def start_spider(self):</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        爬虫入口</div><div class="line">        &quot;&quot;&quot;</div><div class="line">        for i in self.index_url:</div><div class="line">            self.get_url_content(i)</div><div class="line">        for k, v in self.data.items():</div><div class="line">            print(&apos;标题：%s, 链接地址：%s&apos;%(k,v))</div><div class="line"></div><div class="line"></div><div class="line">def main():</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    主函数</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    print(&quot;&quot;&quot;</div><div class="line">            ###############################</div><div class="line">                豆瓣房源小组爬虫</div><div class="line">                Author: Abnerzhao</div><div class="line">                Version: 0.0.1</div><div class="line">                Date: 2018-04-04</div><div class="line">            ###############################</div><div class="line">        &quot;&quot;&quot;)</div><div class="line">    key_word = input(&apos;请输入找房关键字：&apos;)</div><div class="line">    page_num = input(&apos;请输入抓取页面数：&apos;)</div><div class="line">    if not key_word:</div><div class="line">        key_word = &apos;1号线&apos;</div><div class="line">    if not page_num:</div><div class="line">        page_num = 5</div><div class="line">    house_spider = DouBanHouseSpider(key_word, int(page_num))</div><div class="line">    house_spider.start_spider()</div><div class="line">    print(&apos;豆瓣房源爬虫爬取结束...&apos;)</div><div class="line"></div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<blockquote>
<p>请使用 Python3，<a href="https://github.com/Abnerzhao/spider/blob/master/douban/douban_spider_exp1.py" target="_blank" rel="external">爬虫源码地址</a></p>
</blockquote>
<p>执行效果：</p>
<p><img src="/img/BAFCA92D-6F56-478A-B94E-8D18830BB546.png" alt=""></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这个爬虫很简单，没有进行模拟登陆也能抓取，当抓取页面数较大时会耗时较长。同一个房源信息可能在不同的小组中都有，所以通过一个字典来保存抓取的标题和链接，避免重复的标题。</p>
<p>后续待优化的地方:</p>
<ul>
<li>模拟登陆</li>
<li>支持多个关键字</li>
<li>多线程</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近又要开始找房，来上海三年不到已经是第三次搬家，真是居大不易。现在住的房子是在豆瓣小组上找的，豆瓣上个人房源较多，但是豆瓣小组没有对房源信息进行分类，找起来比较费时，索性写了个简单的爬虫，根据关键字来找房。网上也有一些现成的代码实现，想着还是自己实践一下。&lt;/p&gt;
&lt;p&gt;Python 新手上路…&lt;/p&gt;
&lt;h3 id=&quot;获取豆瓣房源小组链接&quot;&gt;&lt;a href=&quot;#获取豆瓣房源小组链接&quot; class=&quot;headerlink&quot; title=&quot;获取豆瓣房源小组链接&quot;&gt;&lt;/a&gt;获取豆瓣房源小组链接&lt;/h3&gt;&lt;p&gt;先搜索一下上海的租房小组&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/img/270B4257-2781-4F04-A000001F-A539B7F1791D.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;找几个人数较多和活跃度高的小组，进入小组讨论页面，观察 URL 的规律。&lt;br&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Celery 后台执行方法</title>
    <link href="http://yoursite.com/2018/03/25/celery-background/"/>
    <id>http://yoursite.com/2018/03/25/celery-background/</id>
    <published>2018-03-25T06:40:10.000Z</published>
    <updated>2018-03-25T06:44:18.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="init-script"><a href="#init-script" class="headerlink" title="init-script"></a>init-script</h3><p>1.先下载两个脚本文件 <a href="https://github.com/celery/celery/tree/3.1/extra/generic-init.d/" target="_blank" rel="external">generic-init.d</a>，我的项目里有定时任务，所以两个都需要用到</p>
<p>2.创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/default/celeryd</div><div class="line"># Names of nodes to start</div><div class="line">#   most people will only start one node:</div><div class="line"></div><div class="line">CELERYD_NODES=&quot;worker1&quot; # work 任务节点</div><div class="line"></div><div class="line">#   but you can also start multiple and configure settings</div><div class="line">#   for each in CELERYD_OPTS</div><div class="line">#CELERYD_NODES=&quot;worker1 worker2 worker3&quot;</div><div class="line">#   alternatively, you can specify the number of nodes to start:</div><div class="line">#CELERYD_NODES=10</div><div class="line"></div><div class="line"># Absolute or relative path to the &apos;celery&apos; command:</div><div class="line"></div><div class="line">CELERY_BIN=&quot;/home/prod/softwares/python/bin/celery&quot; # celery 命令的绝对路径</div><div class="line"></div><div class="line"># App instance to use</div><div class="line"># comment out this line if you don&apos;t use an app</div><div class="line"></div><div class="line">CELERY_APP=&quot;wfstar&quot; # 应用实例</div><div class="line"></div><div class="line"># or fully qualified:</div><div class="line">#CELERY_APP=&quot;proj.tasks:app&quot;</div><div class="line"></div><div class="line"># Where to chdir at start.</div><div class="line">CELERYD_CHDIR=&quot;/home/prod/deploys/wfstar&quot; # 项目目录</div><div class="line"></div><div class="line"># Extra command-line arguments to the worker</div><div class="line"></div><div class="line">CELERYD_OPTS=&quot;--time-limit=300 --concurrency=8&quot; # 命令行参数，更多请参考 man 手册 </div><div class="line"></div><div class="line"># Configure node-specific settings by appending node name to arguments:</div><div class="line">#CELERYD_OPTS=&quot;--time-limit=300 -c 8 -c:worker2 4 -c:worker3 2 -Ofair:worker1&quot;</div><div class="line"># Set logging level to DEBUG</div><div class="line">#CELERYD_LOG_LEVEL=&quot;DEBUG&quot;</div><div class="line"></div><div class="line"># %n will be replaced with the first part of the nodename</div><div class="line"></div><div class="line">CELERYD_LOG_FILE=&quot;/var/log/celery/%n%I.log&quot;</div><div class="line">CELERYD_PID_FILE=&quot;/var/run/celery/%n.pid&quot;</div><div class="line"></div><div class="line"># Workers should run as an unprivileged user.</div><div class="line">#   You need to create this user manually (or you can choose</div><div class="line">#   a user/group combination that already exists (e.g., nobody).</div><div class="line"></div><div class="line">CELERYD_USER=&quot;prod&quot;</div><div class="line">CELERYD_GROUP=&quot;prod&quot;</div><div class="line"></div><div class="line"># If enabled pid and log directories will be created if missing,</div><div class="line"># and owned by the userid/group configured.</div><div class="line">CELERY_CREATE_DIRS=1  # 自动创建日志和 pid 文件</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>3.将下载的 <code>celeryd</code> 和 <code>celerybeat</code> 拷贝到 /etc/init.d 目录并赋予可执行权限</p>
<blockquote>
<p>注意部分内容的修改，如执行用户</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/init.d/celeryd</div><div class="line">...</div><div class="line">DEFAULT_USER=&quot;prod&quot;</div><div class="line">DEFAULT_PID_FILE=&quot;/var/run/celery/%n.pid&quot;</div><div class="line">DEFAULT_LOG_FILE=&quot;/var/log/celery/%n.log&quot;</div><div class="line">DEFAULT_LOG_LEVEL=&quot;INFO&quot;</div><div class="line">DEFAULT_NODES=&quot;celery&quot;</div><div class="line">DEFAULT_CELERYD=&quot;-m celery worker --detach&quot;</div><div class="line">...</div><div class="line">$ cat /etc/init.d/celerybeat</div><div class="line">...</div><div class="line">CELERY_BIN=$&#123;CELERY_BIN:-&quot;celery&quot;&#125;</div><div class="line">DEFAULT_USER=&quot;prod&quot;</div><div class="line">DEFAULT_PID_FILE=&quot;/var/run/celery/beat.pid&quot;</div><div class="line">DEFAULT_LOG_FILE=&quot;/var/log/celery/beat.log&quot;</div><div class="line">DEFAULT_LOG_LEVEL=&quot;INFO&quot;</div><div class="line">DEFAULT_CELERYBEAT=&quot;$CELERY_BIN beat&quot;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>4.启动 work 和 beat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo /etc/init.d/celeryd start</div><div class="line">$ sudo /etc/init.d/celerybeat start</div></pre></td></tr></table></figure>
<h3 id="supervisord"><a href="#supervisord" class="headerlink" title="supervisord"></a>supervisord</h3><p>1.安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo apt-get install supervisor # 因为我这里的项目用的是 Python3，所以没有使用 pip 安装</div></pre></td></tr></table></figure>
<p>2.配置</p>
<p>在 <code>/etc/supervisor/conf.d</code> 新建配置文件 <code>celery_wfstar_worker.conf</code> 和 <code>celery_wfstar_beat.conf</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/supervisor/conf.d/celery_wfstar_worker.conf</div><div class="line">[program:wfstar_worker] </div><div class="line">command=/home/prod/deploys/wfstart_env/bin/celery -A wfstar worker -l info # 执行命令</div><div class="line">directory=/home/prod/deploys/wfstar  # 运行目录</div><div class="line">user=prod  # 执行用户</div><div class="line">numprocs=1 # 启动进程数</div><div class="line">stdout_logfile=/home/prod/deploys/wfstar/logs/celery.log # 标准输出日志</div><div class="line">redirect_stderr=true # 将 stderr 的日志会写入 stdout 日志文件中</div><div class="line">autostart=true # supervisor 启动，程序自动启动</div><div class="line">autorestart=true # 自动重启</div><div class="line">startsecs=10 # 进程启动 10s 后，状态为 running 则为启动成功</div><div class="line">stopwaitsecs = 600 </div><div class="line">killasgroup=true</div><div class="line">priority=998 # 优先级</div><div class="line">stopsignal=QUIT # 停止信号</div><div class="line"></div><div class="line">$ cat /etc/supervisor/conf.d/celery_wfstar_beat.conf</div><div class="line">[program:wfstar_beat]</div><div class="line">command=/home/prod/deploys/wfstart_env/bin/celery -A wfstar beat -l info</div><div class="line">directory=/home/prod/deploys/wfstar</div><div class="line">user=prod</div><div class="line">numprocs=1</div><div class="line">stdout_logfile=/home/prod/deploys/wfstar/logs/celerybeat.log</div><div class="line">redirect_stderr=true</div><div class="line">autostart=true</div><div class="line">autorestart=true</div><div class="line">startsecs=10</div><div class="line">stopwaitsecs = 600</div><div class="line">killasgroup=true</div><div class="line">priority=999</div><div class="line">stopsignal=QUIT</div></pre></td></tr></table></figure>
<p>配置文件可参考 <a href="https://github.com/celery/celery/tree/master/extra/supervisord" target="_blank" rel="external">github celery supervisord configure</a></p>
<p>3.启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo supervisorctl reread</div><div class="line">$ sudo supervisorctl update</div><div class="line">$ sudo supervisorctl start all</div><div class="line">$ sudo supervisorctl status</div><div class="line">wfstar_beat                      RUNNING   pid 16752, uptime 0:00:34</div><div class="line">wfstar_worker                    RUNNING   pid 16751, uptime 0:00:34</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://pythad.github.io/articles/2016-12/how-to-run-celery-as-a-daemon-in-production" target="_blank" rel="external">How to run celery as a daemon</a></p>
<p><a href="https://yangchy.com/2018/01/17/Celery-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C/" target="_blank" rel="external">Celery 后台运行</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;init-script&quot;&gt;&lt;a href=&quot;#init-script&quot; class=&quot;headerlink&quot; title=&quot;init-script&quot;&gt;&lt;/a&gt;init-script&lt;/h3&gt;&lt;p&gt;1.先下载两个脚本文件 &lt;a href=&quot;https://github.com/celery/celery/tree/3.1/extra/generic-init.d/&quot;&gt;generic-init.d&lt;/a&gt;，我的项目里有定时任务，所以两个都需要用到&lt;/p&gt;
&lt;p&gt;2.创建配置文件&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ cat /etc/default/celeryd&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Names of nodes to start&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#   most people will only start one node:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_NODES=&amp;quot;worker1&amp;quot; # work 任务节点&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#   but you can also start multiple and configure settings&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#   for each in CELERYD_OPTS&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#CELERYD_NODES=&amp;quot;worker1 worker2 worker3&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#   alternatively, you can specify the number of nodes to start:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#CELERYD_NODES=10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Absolute or relative path to the &amp;apos;celery&amp;apos; command:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERY_BIN=&amp;quot;/home/prod/softwares/python/bin/celery&amp;quot; # celery 命令的绝对路径&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# App instance to use&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# comment out this line if you don&amp;apos;t use an app&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERY_APP=&amp;quot;wfstar&amp;quot; # 应用实例&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# or fully qualified:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#CELERY_APP=&amp;quot;proj.tasks:app&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Where to chdir at start.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_CHDIR=&amp;quot;/home/prod/deploys/wfstar&amp;quot; # 项目目录&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Extra command-line arguments to the worker&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_OPTS=&amp;quot;--time-limit=300 --concurrency=8&amp;quot; # 命令行参数，更多请参考 man 手册 &lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Configure node-specific settings by appending node name to arguments:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#CELERYD_OPTS=&amp;quot;--time-limit=300 -c 8 -c:worker2 4 -c:worker3 2 -Ofair:worker1&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Set logging level to DEBUG&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#CELERYD_LOG_LEVEL=&amp;quot;DEBUG&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# %n will be replaced with the first part of the nodename&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_LOG_FILE=&amp;quot;/var/log/celery/%n%I.log&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_PID_FILE=&amp;quot;/var/run/celery/%n.pid&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# Workers should run as an unprivileged user.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#   You need to create this user manually (or you can choose&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;#   a user/group combination that already exists (e.g., nobody).&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_USER=&amp;quot;prod&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERYD_GROUP=&amp;quot;prod&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# If enabled pid and log directories will be created if missing,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;# and owned by the userid/group configured.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;CELERY_CREATE_DIRS=1  # 自动创建日志和 pid 文件&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="celery" scheme="http://yoursite.com/tags/celery/"/>
    
  </entry>
  
  <entry>
    <title>Django Celery 定时任务笔记</title>
    <link href="http://yoursite.com/2018/02/25/django-celery-notes/"/>
    <id>http://yoursite.com/2018/02/25/django-celery-notes/</id>
    <published>2018-02-25T09:49:43.000Z</published>
    <updated>2018-03-25T09:53:17.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>Python 2.7</li>
<li>Djang 1.10</li>
<li>celery 4.1.0</li>
<li>RabbitMQ 3.2.4</li>
</ul>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><h4 id="创建虚拟环境，构建-Django-项目"><a href="#创建虚拟环境，构建-Django-项目" class="headerlink" title="创建虚拟环境，构建 Django 项目"></a>创建虚拟环境，构建 Django 项目</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ virtualenv django-exp</div><div class="line">$ source django-exp/bin/activate</div><div class="line">$ pip intall django==1.10</div><div class="line">$ django-admin startproject myproject</div><div class="line">$ cd myproject/</div><div class="line">$ django-admin startapp myapp</div><div class="line">$ tree</div><div class="line">.</div><div class="line">├── manage.py</div><div class="line">├── myapp</div><div class="line">│   ├── admin.py</div><div class="line">│   ├── apps.py</div><div class="line">│   ├── __init__.py</div><div class="line">│   ├── migrations</div><div class="line">│   │   └── __init__.py</div><div class="line">│   ├── models.py</div><div class="line">│   ├── tests.py</div><div class="line">│   └── views.py</div><div class="line">└── myproject</div><div class="line">    ├── __init__.py</div><div class="line">    ├── settings.py</div><div class="line">    ├── urls.py</div><div class="line">    └── wsgi.py</div><div class="line">$ pip install celery</div><div class="line">$ pip install pysqlite</div><div class="line">$ sudo apt-get install rabbitmq-server</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="配置-Celery"><a href="#配置-Celery" class="headerlink" title="配置 Celery"></a>配置 Celery</h4><ul>
<li><code>myproject/celery.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myproject/celery.py</div><div class="line">from __future__ import absolute_import, unicode_literals</div><div class="line">import os</div><div class="line">from celery import Celery</div><div class="line">from django.conf import settings</div><div class="line"></div><div class="line"># set the default Django settings module for the &apos;celery&apos; program.</div><div class="line">os.environ.setdefault(&apos;DJANGO_SETTINGS_MODULE&apos;, &apos;myproject.settings&apos;)</div><div class="line"></div><div class="line">app = Celery(&apos;myproject&apos;)</div><div class="line"></div><div class="line"># Using a string here means the worker don&apos;t have to serialize</div><div class="line"># the configuration object to child processes.</div><div class="line"># - namespace=&apos;CELERY&apos; means all celery-related configuration keys</div><div class="line">#   should have a `CELERY_` prefix.</div><div class="line">app.config_from_object(&apos;django.conf:settings&apos;)</div><div class="line"></div><div class="line"># Load task modules from all registered Django app configs.</div><div class="line">app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</div><div class="line"></div><div class="line"></div><div class="line">@app.task(bind=True)</div><div class="line">def debug_task(self):</div><div class="line">    print(&apos;Request: &#123;0!r&#125;&apos;.format(self.request))</div></pre></td></tr></table></figure>
<ul>
<li><code>myproject/__init__.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myproject/__init__.py</div><div class="line">from __future__ import absolute_import, unicode_literals</div><div class="line"></div><div class="line"># This will make sure the app is always imported when</div><div class="line"># Django starts so that shared_task will use this app.</div><div class="line">from .celery import app as celery_app</div><div class="line"></div><div class="line">__all__ = [&apos;celery_app&apos;]</div></pre></td></tr></table></figure>
<ul>
<li><code>myapp/tasks.py</code> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myapp/tasks.py</div><div class="line">from __future__ import absolute_import, unicode_literals</div><div class="line">from celery.task.schedules import crontab</div><div class="line">from celery.decorators import periodic_task</div><div class="line"></div><div class="line">@periodic_task(run_every=(crontab(minute=&quot;*/1&quot;))) # 每隔一分钟写入 hello world</div><div class="line">def hello_world():</div><div class="line">    with open(&quot;/tmp/output.txt&quot;, &quot;a&quot;) as f:</div><div class="line">        f.write(&quot;hello world&quot;)</div><div class="line">        f.write(&quot;\n&quot;)</div></pre></td></tr></table></figure>
<ul>
<li><code>myproject/setting.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myproject/setting.py</div><div class="line">...</div><div class="line">CELERY_BROKER_URL = &apos;amqp://localhost&apos;</div><div class="line">CELERY_ACCEPT_CONTENT = [&apos;application/json&apos;]</div><div class="line">CELERY_RESULT_SERIALIZER = &apos;json&apos;</div><div class="line">CELERY_TASK_SERIALIZER = &apos;json&apos;</div><div class="line"></div><div class="line">INSTALLED_APPS = [</div><div class="line">    &apos;django.contrib.admin&apos;,</div><div class="line">    &apos;django.contrib.auth&apos;,</div><div class="line">    &apos;django.contrib.contenttypes&apos;,</div><div class="line">    &apos;django.contrib.sessions&apos;,</div><div class="line">    &apos;django.contrib.messages&apos;,</div><div class="line">    &apos;django.contrib.staticfiles&apos;,</div><div class="line">    &apos;myapp&apos;,</div><div class="line">]</div><div class="line">...</div><div class="line">LANGUAGE_CODE = &apos;en-us&apos;</div><div class="line">TIME_ZONE = &apos;Asia/Shanghai&apos;</div><div class="line">USE_I18N = True</div><div class="line">USE_L10N = True</div><div class="line">USE_TZ = False</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="同步数据库"><a href="#同步数据库" class="headerlink" title="同步数据库"></a>同步数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ python manage.py makemigrations</div><div class="line">$ python manage.py migrate</div></pre></td></tr></table></figure>
<h4 id="启动-worker-和-beat"><a href="#启动-worker-和-beat" class="headerlink" title="启动 worker 和 beat"></a>启动 worker 和 beat</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ celery -A myproject worker -l info -B</div><div class="line">...</div><div class="line">[2018-02-25 16:59:00,000: INFO/Beat] Scheduler: Sending due task myapp.tasks.hello_world (myapp.tasks.hello_world)</div><div class="line">[2018-02-25 16:59:00,008: INFO/MainProcess] Received task: myapp.tasks.hello_world[e1aa8b70-586d-4a2b-b598-64c322b211a7]</div><div class="line">[2018-02-25 16:59:00,010: INFO/MainProcess] Task myapp.tasks.hello_world[e1aa8b70-586d-4a2b-b598-64c322b211a7] succeeded in 0.00109826028347s: None</div><div class="line">[2018-02-25 17:00:00,056: INFO/Beat] Scheduler: Sending due task myapp.tasks.hello_world (myapp.tasks.hello_world)</div><div class="line">[2018-02-25 17:00:00,058: INFO/MainProcess] Received task: myapp.tasks.hello_world[78ec725f-61b7-4fe6-a1c1-b2c60fb9ffed]</div><div class="line">[2018-02-25 17:00:00,060: INFO/MainProcess] Task myapp.tasks.hello_world[78ec725f-61b7-4fe6-a1c1-b2c60fb9ffed] succeeded in 0.000685669481754s: None</div><div class="line">$ tail /tmp/output.txt</div><div class="line">hello world</div><div class="line">hello world</div><div class="line">hello world</div><div class="line">hello world</div><div class="line">hello world</div></pre></td></tr></table></figure>
<p>除了使用该方法，我们还可以通过 admin 后台设置计划任务，不过需要安装 <code>django-celery</code> 并设置 Database-backed，具体请参考官方文档。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://docs.celeryproject.org/en/v4.0.2/django/first-steps-with-django.html" target="_blank" rel="external">Using Celery with Django</a></p>
<p><a href="http://www.marinamele.com/2014/02/how-to-install-celery-on-django-and.html" target="_blank" rel="external">How to install Celery on Django and Create a Periodic Task</a></p>
<p><a href="https://medium.com/@yehandjoe/celery-4-periodic-task-in-django-9f6b5a8c21c7" target="_blank" rel="external">Celery 4 Periodic Task in Django</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Python 2.7&lt;/li&gt;
&lt;li&gt;Djang 1.10&lt;/li&gt;
&lt;li&gt;celery 4.1.0&lt;/li&gt;
&lt;li&gt;RabbitMQ 3.2.4&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;开始&quot;&gt;&lt;a href=&quot;#开始&quot; class=&quot;headerlink&quot; title=&quot;开始&quot;&gt;&lt;/a&gt;开始&lt;/h3&gt;&lt;h4 id=&quot;创建虚拟环境，构建-Django-项目&quot;&gt;&lt;a href=&quot;#创建虚拟环境，构建-Django-项目&quot; class=&quot;headerlink&quot; title=&quot;创建虚拟环境，构建 Django 项目&quot;&gt;&lt;/a&gt;创建虚拟环境，构建 Django 项目&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ virtualenv django-exp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ source django-exp/bin/activate&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ pip intall django==1.10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ django-admin startproject myproject&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ cd myproject/&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ django-admin startapp myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ tree&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;.&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;├── manage.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;├── myapp&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   ├── admin.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   ├── apps.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   ├── __init__.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   ├── migrations&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   │   └── __init__.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   ├── models.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   ├── tests.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;│   └── views.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;└── myproject&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ├── __init__.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ├── settings.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    ├── urls.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    └── wsgi.py&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ pip install celery&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ pip install pysqlite&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ sudo apt-get install rabbitmq-server&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="celery" scheme="http://yoursite.com/tags/celery/"/>
    
  </entry>
  
  <entry>
    <title>使用Sphinx + GitHub + Read the Docs搭建wiki</title>
    <link href="http://yoursite.com/2017/10/14/quickstart-wiki/"/>
    <id>http://yoursite.com/2017/10/14/quickstart-wiki/</id>
    <published>2017-10-14T07:54:01.000Z</published>
    <updated>2018-11-14T15:49:08.127Z</updated>
    
    <content type="html"><![CDATA[<p>Sphinx 是一个基于 ReStructuredText 的文档生成工具，有很多开源工程都采用sphinx作为文档生成系统，最有名的就是 python 官方文档。</p>
<p>Read the Docs是一个在线文档托管服务，可以从各种版本控制系统中导入文档。支持 webhooks，当你提交代码时，文档将被自动构建。</p>
<p>Sphinx + GitHub + ReadtheDocs 作为一个文档写作工具， 用 Sphinx 生成文档，GitHub 托管文档，再导入到 ReadtheDocs。我们可以使用这个工具写文档、记笔记等。</p>
<h3 id="搭建过程"><a href="#搭建过程" class="headerlink" title="搭建过程"></a>搭建过程</h3><h4 id="安装-Sphinx"><a href="#安装-Sphinx" class="headerlink" title="安装 Sphinx"></a>安装 Sphinx</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo pip install sphinx</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="创建wiki目录"><a href="#创建wiki目录" class="headerlink" title="创建wiki目录"></a>创建wiki目录</h4><p>使用 sphinx 自带的配置工具 <code>sphinx-quickstart</code> 快速创建工程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ mkdir mywiki</div><div class="line">$ sphinx-quickstart  //大部分使用默认选项，直接按回车即可</div><div class="line">Welcome to the Sphinx 1.6.3 quickstart utility.</div><div class="line">...</div><div class="line"># 分离source和build目录，方便管理</div><div class="line">&gt; Separate source and build directories (y/n) [n]: y</div><div class="line"></div><div class="line"># 指定工程名、作者名、版本号、语言</div><div class="line">The project name will occur in several places in the built documentation.</div><div class="line">&gt; Project name: mywiki</div><div class="line">&gt; Author name(s): abnerzhao</div><div class="line">&gt; Project version []: 0.1</div><div class="line">&gt; Project release [0.1]:</div><div class="line">&gt; Project language [en]: zh_CN</div><div class="line">...</div><div class="line">Creating file ./source/conf.py.</div><div class="line">Creating file ./source/index.rst.</div><div class="line">Creating file ./Makefile.</div><div class="line">Creating file ./make.bat.</div><div class="line"></div><div class="line">Finished: An initial directory structure has been created.</div><div class="line">...</div><div class="line">$ ls</div><div class="line">Makefile build    make.bat source</div></pre></td></tr></table></figure>
<p>创建完成后，mywiki目录有以下文件：</p>
<ul>
<li>build目录：运行make命令后，生成的文件都在这个目录里面</li>
<li>source目录：放置文档的源文件</li>
<li>make.bat：批处理命令</li>
<li>Makefile</li>
</ul>
<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>conf.py 文件包含了 sphinx 工程的所有配置选项，包括一些无法在 sphinx-quickstart 中进行设置的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ vi source/conf.py</div><div class="line">...</div><div class="line">html_theme = &apos;sphinx_rtd_theme&apos; # 输出html的主题</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="使用-github-进行版本控制"><a href="#使用-github-进行版本控制" class="headerlink" title="使用 github 进行版本控制"></a>使用 github 进行版本控制</h4><p>首先在 github 创建新的仓库 mywiki，然后将本地的 mywiki/source 目录 push 到 mywiki 远程仓库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cd source</div><div class="line">$ echo &quot;# mywiki&quot; &gt;&gt; README.md</div><div class="line">$ git init</div><div class="line">$ git add .</div><div class="line">$ git commit -m &quot;first commit&quot;</div><div class="line">$ git remote add origin git@github.com:[yourusename]/mywiki.git</div><div class="line">$ git push -u origin master</div></pre></td></tr></table></figure>
<h4 id="导入到-ReadtheDocs"><a href="#导入到-ReadtheDocs" class="headerlink" title="导入到 ReadtheDocs"></a>导入到 ReadtheDocs</h4><p>首先到 github 中选择 mywiki 仓库，Settings / Services / Add ReadTheDocs</p>
<p><img src="/img/B18863C1-6A9F-4A72-95C0-2580B1E75983.png" alt=""></p>
<p>然后到 ReadtheDocs 网站 import mywiki 仓库，导入成功后可看到如下页面：</p>
<p><img src="/img/C1184CE3-2FA6-4898-ADAE-3072C6E8FF4E.png" alt=""></p>
<h4 id="构建文档"><a href="#构建文档" class="headerlink" title="构建文档"></a>构建文档</h4><p>现在 mywiki 目录只有默认内容，需要我们自己添加内容，然后构建。构建方式有两种：</p>
<ul>
<li>命令行执行 <code>make html</code> </li>
<li>ReadtheDocs 网站手动构建</li>
</ul>
<p>我们先看一下默认构建出来是什么样子，执行<code>make html</code> 成功后，即可到 ReadtheDocs 网站阅读文档。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cd /Users/Mr-zhao/mywiki</div><div class="line">$ ls</div><div class="line">Makefile build    make.bat source</div><div class="line">$ make html</div></pre></td></tr></table></figure>
<p><img src="/img/4CE490E0-C3D4-448A-9A69-0BC2FFF95A1D.png" alt=""></p>
<p>简单的 wiki 就基本搭建完成了，后续我们需要添加内容。不过这玩意使用的 reStructureText 语法而不是我们熟悉的 Markdown，我们可以通过 <a href="http://pandoc.org/try/" target="_blank" rel="external">pandoc</a> 进行格式转换。reStructureText 的语法也比较简单。</p>
<h4 id="开始写-wiki"><a href="#开始写-wiki" class="headerlink" title="开始写 wiki"></a>开始写 wiki</h4><p>简单添加些内容，看看效果<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /Users/Mr-zhao/mywiki/index.rst</div><div class="line">.. mywiki documentation master file, created by</div><div class="line">   sphinx-quickstart on Sat Oct 14 14:26:23 2017.</div><div class="line">   You can adapt this file completely to your liking, but it should at least</div><div class="line">   contain the root `toctree` directive.</div><div class="line"></div><div class="line">Abnerzhao&apos;s Wiki</div><div class="line">=============================================</div><div class="line"></div><div class="line">.. toctree::</div><div class="line">   :maxdepth: 2</div><div class="line">   :glob:</div><div class="line"></div><div class="line">   programming/index</div><div class="line"></div><div class="line">$ cd /Users/Mr-zhao/mywiki/source/programming </div><div class="line">$ cat index.rst</div><div class="line">一、编程</div><div class="line">==================</div><div class="line"></div><div class="line">.. toctree::</div><div class="line">    :maxdepth: 2</div><div class="line">    :glob:</div><div class="line"></div><div class="line">    python.rst</div><div class="line">$ cat python.rst</div><div class="line"></div><div class="line">1. Python</div><div class="line">----------</div><div class="line"></div><div class="line">1.1 基础知识</div><div class="line">~~~~~~~~~~~~~~</div><div class="line"></div><div class="line">1.2 爬虫</div><div class="line">~~~~~~~~~~</div><div class="line"></div><div class="line">1.3 Web</div><div class="line">~~~~~~~~~</div><div class="line">$ cd /Users/Mr-zhao/mywiki</div><div class="line">$ make html</div></pre></td></tr></table></figure></p>
<p>再次查看文档：</p>
<p><img src="/img/B35BA734-C452-44C1-AF8A-ACE9243D9D58.png" alt=""></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Sphinx + GitHub + ReadtheDocs 总体的使用感受比 GitBook 要好，GitBook 使用起来总感觉很慢。平时写博客记点东西都比较琐碎，使用 Sphinx 更规范系统些。</p>
<p>工具倒是搭建好，能否坚持系统地总结梳理知识，Emm….这是个问题！</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://zh-sphinx-doc.readthedocs.io/en/latest/contents.html" target="_blank" rel="external">Sphinx使用手册</a><br><a href="http://jwch.sdut.edu.cn/book/tool/UseSphinx.html#id5" target="_blank" rel="external">使用sphinx记笔记</a><br><a href="http://www.jianshu.com/p/78e9e1b8553a" target="_blank" rel="external">如何用 ReadtheDocs、Sphinx 快速搭建写书环境</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Sphinx 是一个基于 ReStructuredText 的文档生成工具，有很多开源工程都采用sphinx作为文档生成系统，最有名的就是 python 官方文档。&lt;/p&gt;
&lt;p&gt;Read the Docs是一个在线文档托管服务，可以从各种版本控制系统中导入文档。支持 webhooks，当你提交代码时，文档将被自动构建。&lt;/p&gt;
&lt;p&gt;Sphinx + GitHub + ReadtheDocs 作为一个文档写作工具， 用 Sphinx 生成文档，GitHub 托管文档，再导入到 ReadtheDocs。我们可以使用这个工具写文档、记笔记等。&lt;/p&gt;
&lt;h3 id=&quot;搭建过程&quot;&gt;&lt;a href=&quot;#搭建过程&quot; class=&quot;headerlink&quot; title=&quot;搭建过程&quot;&gt;&lt;/a&gt;搭建过程&lt;/h3&gt;&lt;h4 id=&quot;安装-Sphinx&quot;&gt;&lt;a href=&quot;#安装-Sphinx&quot; class=&quot;headerlink&quot; title=&quot;安装 Sphinx&quot;&gt;&lt;/a&gt;安装 Sphinx&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;$ sudo pip install sphinx&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="wiki" scheme="http://yoursite.com/tags/wiki/"/>
    
  </entry>
  
  <entry>
    <title>Ansible 回调插件简单使用</title>
    <link href="http://yoursite.com/2017/04/11/ansible-callback-plugins/"/>
    <id>http://yoursite.com/2017/04/11/ansible-callback-plugins/</id>
    <published>2017-04-11T12:20:44.000Z</published>
    <updated>2018-11-14T15:47:08.759Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Developing-Plugins"><a href="#Developing-Plugins" class="headerlink" title="Developing Plugins"></a>Developing Plugins</h2><p>插件是增强ansible核心功能的代码片段，我们可以很方便的使用插件，编写插件代码。如果我们想要对ansible的执行结果进行分析，根据返回结果发送邮件，写入日志等都可以通过插件实现。</p>
<h3 id="插件列表"><a href="#插件列表" class="headerlink" title="插件列表"></a>插件列表</h3><ul>
<li><strong>Action plugins</strong> are front ends to modules and can execute actions on the controller before calling the modules themselves.（操作插件，调用模块之前执行操作）</li>
<li><strong>Cache plugins</strong> are used to keep a cache of ‘facts’ to avoid costly fact-gathering operations.（缓存插件，缓存主机facts变量）</li>
<li><strong>Callback plugins</strong> enable you to hook into Ansible events for display or logging purposes.（回调插件，对事件进行显示和记录，这个常用）<a id="more"></a></li>
<li><strong>Connection plugins</strong> define how to communicate with inventory hosts.（连接插件，定义如何与节点主机通信）</li>
<li><strong>Filters plugins</strong> allow you to manipulate data inside Ansible plays and/or templates. This is a Jinja2 feature; Ansible ships extra filter plugins.（过滤插件，Jinja2功能）</li>
<li><strong>Lookup plugins</strong> are used to pull data from an external source. These are implemented using a custom Jinja2 function.（查找插件用于从外部源提取数据）</li>
<li><strong>Strategy plugins</strong> control the flow of a play and execution logic.（策略插件）</li>
<li><strong>Shell plugins</strong> deal with low-level commands and formatting for the different shells Ansible can encounter on remote hosts.（shell插件处理低级别命令和格式化）</li>
<li><strong>Test plugins</strong> allow you to validate data inside Ansible plays and/or templates. This is a Jinja2 feature; Ansible ships extra test plugins.（测试插件）</li>
<li><strong>Vars plugins</strong> inject additional variable data into Ansible runs that did not come from an inventory, playbook, or the command line.（Vars插件）</li>
</ul>
<h2 id="Callback-plugins"><a href="#Callback-plugins" class="headerlink" title="Callback plugins"></a>Callback plugins</h2><p>在日常开发中使用回调插件比较多一点，通过callback插件，可以实现回调功能，里面定义了若干场景，如主机不可达，执行任务失败，执行任务成功等，分别对应不同的方法，这样就可以实现在不同的场景触发不同的操作。</p>
<h3 id="设置回调功能参数"><a href="#设置回调功能参数" class="headerlink" title="设置回调功能参数"></a>设置回调功能参数</h3><p>该功能ansible默认是关闭的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line">$ cat /etc/ansible/ansible.cfg </div><div class="line">...</div><div class="line">bin_ansible_callbacks = <span class="keyword">True</span> <span class="comment">#加载功能</span></div><div class="line"></div><div class="line"><span class="comment"># set plugin path directories here, separate with colons 定义插件位置</span></div><div class="line">action_plugins     = /usr/share/ansible_plugins/action_plugins</div><div class="line">callback_plugins   = /usr/share/ansible_plugins/callback_plugins</div><div class="line">connection_plugins = /usr/share/ansible_plugins/connection_plugins</div><div class="line">lookup_plugins     = /usr/share/ansible_plugins/lookup_plugins</div><div class="line">vars_plugins       = /usr/share/ansible_plugins/vars_plugins</div><div class="line">filter_plugins     = /usr/share/ansible_plugins/filter_plugins</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="编写回调脚本"><a href="#编写回调脚本" class="headerlink" title="编写回调脚本"></a>编写回调脚本</h3><p>编写回调脚本放到配置文件中定义的目录中，并赋予可执行权限。我们可以将执行结果写入本地文件、数据库或发邮件等等。在日常开发中我们会将结果写入日志或跟踪记录执行的进度和异常。</p>
<h4 id="写入本地文件"><a href="#写入本地文件" class="headerlink" title="写入本地文件"></a>写入本地文件</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">result_file = <span class="string">'/tmp/result'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackModule</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_ok</span><span class="params">(self, host, res)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(result_file,<span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(<span class="string">'success\n'</span>)</div><div class="line">            f.write(str(host))</div><div class="line">            f.write(json.dumps(res, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)))</div><div class="line">            f.write(<span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_failed</span><span class="params">(self, host, res, ignore_errors=False)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(result_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(<span class="string">'failed\n'</span>)</div><div class="line">            f.write(str(host))</div><div class="line">            f.write(json.dumps(res, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)))</div><div class="line">            f.write(<span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_unreachable</span><span class="params">(self,host,res)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(result_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(<span class="string">'unreachable\n'</span>)</div><div class="line">            f.write(str(host))</div><div class="line">            f.write(json.dumps(res, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)))</div><div class="line">            f.write(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure>
<p>测试<br><figure class="highlight"><table><tr><td class="code"><pre><div class="line">$ ansible-playbook  -i hosts test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | cp test auto install script] ************************************</div><div class="line">ok: [172.31.30.178]</div><div class="line"></div><div class="line">TASK: [test | install test] ***************************************************</div><div class="line">changed: [172.31.30.178]</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">172.31.30.178              : ok=2    changed=1    unreachable=0    failed=0</div><div class="line"></div><div class="line">#制造一个unreachable错误</div><div class="line">$ ansible-playbook  -i hosts  test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | cp test auto install script] ************************************</div><div class="line">fatal: [172.31.30.178] =&gt; SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue</div><div class="line"></div><div class="line">FATAL: all hosts have already failed -- aborting</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">           to retry, use: --limit @/root/startoftwares.retry</div><div class="line"></div><div class="line">172.31.30.178              : ok=0    changed=0    unreachable=1    failed=0</div><div class="line"></div><div class="line">#查看结果</div><div class="line">$ cat /tmp/result</div><div class="line">success</div><div class="line">172.31.30.178&#123;</div><div class="line">    "changed": false,</div><div class="line">    "dest": "/tmp/test.sh",</div><div class="line">    "gid": 1000,</div><div class="line">    "group": "ubuntu",</div><div class="line">    "invocation": &#123;</div><div class="line">        "module_args": "src=test.sh dest=/tmp/test.sh owner=ubuntu group=ubuntu mode=0755",</div><div class="line">        "module_name": "copy"</div><div class="line">    &#125;,</div><div class="line">    "md5sum": "da1bd2e811a9909b96b09c3988deaec6",</div><div class="line">    "mode": "0755",</div><div class="line">    "owner": "ubuntu",</div><div class="line">    "path": "/tmp/test.sh",</div><div class="line">    "size": 58,</div><div class="line">    "state": "file",</div><div class="line">    "uid": 1000</div><div class="line">&#125;</div><div class="line">success</div><div class="line">172.31.30.178&#123;</div><div class="line">    "changed": true,</div><div class="line">    "cmd": "bash /tmp/test.sh",</div><div class="line">    "delta": "0:00:03.004104",</div><div class="line">    "end": "2017-04-11 10:48:20.429600",</div><div class="line">    "invocation": &#123;</div><div class="line">        "module_args": "bash /tmp/test.sh",</div><div class="line">        "module_name": "shell"</div><div class="line">    &#125;,</div><div class="line">    "rc": 0,</div><div class="line">    "start": "2017-04-11 10:48:17.425496",</div><div class="line">    "stderr": "",</div><div class="line">    "stdout": ""</div><div class="line">&#125;</div><div class="line">unreachable</div><div class="line">172.31.30.178"SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue"</div></pre></td></tr></table></figure></p>
<h4 id="发邮件"><a href="#发邮件" class="headerlink" title="发邮件"></a>发邮件</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> smtplib</div><div class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">mail_host=<span class="string">"smtp.xxx.com"</span></div><div class="line">mail_user=<span class="string">"xxxxx@xxx.com"</span></div><div class="line">mail_pass=<span class="string">"xxxxxxx"</span></div><div class="line">user_to = <span class="string">"xxxxx@xxx.com"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(context)</span>:</span></div><div class="line">    msg = MIMEText(context, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>)</div><div class="line">    msg[<span class="string">'From'</span>] = mail_user</div><div class="line">    msg[<span class="string">'To'</span>] = user_to</div><div class="line">    msg[<span class="string">'Subject'</span>] = <span class="string">'Ansible error mail'</span></div><div class="line">    server = smtplib.SMTP(mail_host, <span class="number">25</span>)</div><div class="line">    server.login(mail_user, mail_pass)</div><div class="line">    server.sendmail(mail_user, user_to, msg.as_string())</div><div class="line">    server.quit()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackModule</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_ok</span><span class="params">(self, host, res)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_failed</span><span class="params">(self, host, res, ignore_errors=False)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_unreachable</span><span class="params">(self,host,res)</span>:</span></div><div class="line">        <span class="keyword">if</span> isinstance(res,basestring):</div><div class="line">            context = <span class="string">'An error occured for host '</span> + host + <span class="string">' with the following message:\n\n'</span> + res</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            context = <span class="string">'An error occured for host'</span> + host + <span class="string">' with the following message:\n\n'</span> + str(res)</div><div class="line">        send_mail(context)</div></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">$ ansible-playbook  -i hosts  test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | cp test auto install script] ************************************</div><div class="line">fatal: [172.31.30.178] =&gt; SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue</div><div class="line"></div><div class="line">FATAL: all hosts have already failed -- aborting</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">           to retry, use: --limit @/root/startoftwares.retry</div><div class="line"></div><div class="line">172.31.30.178              : ok=0    changed=0    unreachable=1    failed=0</div></pre></td></tr></table></figure>
<p>查收邮件</p>
<p><img src="/img/B028FB3F-50E6-4B04-8969-BDCFD20ECAEB.png" alt=""></p>
<p>以上脚本都写的比较简单，建议参考:<a href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins" target="_blank" rel="external">官方插件代码样例</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://docs.ansible.com/ansible/dev_guide/developing_plugins.html" target="_blank" rel="external">官方文档</a><br><a href="http://ansible-tran.readthedocs.io/en/latest/docs/intro_configuration.html#bin-ansible-callbacks" target="_blank" rel="external">中文文档配置文件参数详解</a><br><a href="http://rfyiamcool.blog.51cto.com/1030776/1440624" target="_blank" rel="external">ansible调用callbacks插件实现结果nosql输出回调</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Developing-Plugins&quot;&gt;&lt;a href=&quot;#Developing-Plugins&quot; class=&quot;headerlink&quot; title=&quot;Developing Plugins&quot;&gt;&lt;/a&gt;Developing Plugins&lt;/h2&gt;&lt;p&gt;插件是增强ansible核心功能的代码片段，我们可以很方便的使用插件，编写插件代码。如果我们想要对ansible的执行结果进行分析，根据返回结果发送邮件，写入日志等都可以通过插件实现。&lt;/p&gt;
&lt;h3 id=&quot;插件列表&quot;&gt;&lt;a href=&quot;#插件列表&quot; class=&quot;headerlink&quot; title=&quot;插件列表&quot;&gt;&lt;/a&gt;插件列表&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Action plugins&lt;/strong&gt; are front ends to modules and can execute actions on the controller before calling the modules themselves.（操作插件，调用模块之前执行操作）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cache plugins&lt;/strong&gt; are used to keep a cache of ‘facts’ to avoid costly fact-gathering operations.（缓存插件，缓存主机facts变量）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Callback plugins&lt;/strong&gt; enable you to hook into Ansible events for display or logging purposes.（回调插件，对事件进行显示和记录，这个常用）
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Python正则表达式</title>
    <link href="http://yoursite.com/2017/03/05/Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>http://yoursite.com/2017/03/05/Python正则表达式/</id>
    <published>2017-03-05T09:13:36.000Z</published>
    <updated>2017-06-23T15:30:28.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>正则表达式是一些由字符和特殊符号组成的字符串，它们描􏰀述了这些字符和字符的某种重复方式，因此能按某种模式匹配一个有相似特征的字符串的集合。</strong>正则表达式为高级文本模式匹配，以及搜索-替代等功能􏰁供了基础。</p>
<h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2><p>元字符是正则表达式中规定的特殊代码，有特定的含义和匹配效果</p>
<p><strong>常用的元字符</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">.</td>
<td style="text-align:left">匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td style="text-align:left">\w</td>
<td style="text-align:left">匹配字母或数字或下划线或汉字</td>
</tr>
<tr>
<td style="text-align:left">\s</td>
<td style="text-align:left">匹配任意的空白符(包括空格，制表符(Tab)，换行符，中文全角空格等)</td>
</tr>
<tr>
<td style="text-align:left">\d</td>
<td style="text-align:left">匹配数字</td>
</tr>
<tr>
<td style="text-align:left">\b</td>
<td style="text-align:left">匹配单词的开始或结束(空格、标点、换行都算是单词的分割)</td>
</tr>
<tr>
<td style="text-align:left">^</td>
<td style="text-align:left">匹配字符串的开始</td>
</tr>
<tr>
<td style="text-align:left">$</td>
<td style="text-align:left">匹配字符串的结束</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<p><strong>示例：</strong></p>
<p><code>\ba\w*\b</code>: 匹配以字母a开头的单词——先是某个单词开始处(\b)，然后是字母a,然后是任意数量的字母或数字(\w*)，最后是单词结束处(\b)</p>
<p><code>\d+</code>: 匹配1个或更多连续的数字。这里的+是和<em>类似的元字符，不同的是\</em>匹配重复任意次(可能是0次)，而+则匹配重复1次或更多次</p>
<p><code>\b\w{6}\b</code>: 匹配刚好6个字符的单词</p>
<p><code>^\d{5,12}$</code>: 匹配5位到12位数字</p>
<h3 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h3><p><strong>常用的限定符(指定数量的代码)</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">*</td>
<td style="text-align:left">重复零次或更多次</td>
</tr>
<tr>
<td style="text-align:left">+</td>
<td style="text-align:left">重复一次或更多次</td>
</tr>
<tr>
<td style="text-align:left">?</td>
<td style="text-align:left">重复零次或一次</td>
</tr>
<tr>
<td style="text-align:left">{n}</td>
<td style="text-align:left">重复n次</td>
</tr>
<tr>
<td style="text-align:left">{n,}</td>
<td style="text-align:left">重复n次或更多次</td>
</tr>
<tr>
<td style="text-align:left">{n,m}</td>
<td style="text-align:left">重复n到m次</td>
</tr>
</tbody>
</table>
<p><strong>示例：</strong><br>Windows\d+: 匹配Windows后面跟1个或更多数字<br>^\w+: 匹配一行的第一个单词</p>
<h3 id="反义"><a href="#反义" class="headerlink" title="反义"></a>反义</h3><p><strong>常用的反义代码</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">\W</td>
<td style="text-align:left">匹配任意不是字母，数字，下划线，汉字的字符</td>
</tr>
<tr>
<td style="text-align:left">\S</td>
<td style="text-align:left">匹配任意不是空白符的字符</td>
</tr>
<tr>
<td style="text-align:left">\D</td>
<td style="text-align:left">匹配任意非数字的字符</td>
</tr>
<tr>
<td style="text-align:left">\B</td>
<td style="text-align:left">匹配不是单词开头或结束的位置</td>
</tr>
<tr>
<td style="text-align:left">[^x]</td>
<td style="text-align:left">匹配除了x以外的任意字符</td>
</tr>
<tr>
<td style="text-align:left">[^aeiou]</td>
<td style="text-align:left">匹配除了aeiou这几个字母以外的任意字符</td>
</tr>
</tbody>
</table>
<h2 id="字符类"><a href="#字符类" class="headerlink" title="字符类"></a>字符类</h2><p>我们要想查找数字，字母或数字，空白这些很简单，直接使用元字符对应的字符集合即可实现。但是如果想要匹配没有预定义元字符的字符集合(比如元音字母a,e,i,o,u),应该怎么办？</p>
<p>这时我们需要在方括号<code>[]</code>中列出想要匹配的字符集合。如[aeiou]就匹配任何一个英文元音字母，[.?!]匹配标点符号(.或?或!)。</p>
<p>[0-9]代表的含意与\d就是完全一致的：一位数字；同理[a-z0-9A-Z_]也完全等同于\w（如果只考虑英文的话）</p>
<p>\(?0\d{2}[) -]?\d{8}:匹配几种格式的电话号码，像(010)88886666，或022-22334455，或02912345678等</p>
<h3 id="分枝条件"><a href="#分枝条件" class="headerlink" title="分枝条件"></a>分枝条件</h3><p>正则表达式里的分枝条件指的是有几种规则，如果满足其中任意一种规则都应该当成匹配，具体方法是用<code>|</code>把不同的规则分隔开，匹配分枝条件时，将会从左到右地测试每个条件，如果满足了某个分枝的话，就不会去再管其它的条件了</p>
<p><code>0\d{2}-\d{8}|0\d{3}-\d{7}</code>这个表达式能匹配两种以连字号分隔的电话号码：一种是三位区号，8位本地号(如010-12345678)，一种是4位区号，7位本地号(0376-2233445)</p>
<p><code>\\(?0\d{2}\)?[- ]?\d{8}|0\d{2}[-]?\d{8}</code>这个表达式匹配3位区号的电话号码，其中区号可以用小括号括起来，也可以不用，区号与本地号间可以用连字号或空格间隔，也可以没有间隔</p>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>重复单个字符在后面加上限定符就行了，如果想要重复多个字符那么就需要用<code>小括号</code>来指定子表达式(也叫做分组)，然后你就可以指定这个子表达式的重复次数了，你也可以对子表达式进行其它一些操作。</p>
<p>(\d{1,3}.){3}：\d{1,3}匹配1到3位的数字，(\d{1,3}.){3}匹配三位数字加上一个英文句号(这个整体也就是这个分组)重复3次</p>
<h3 id="字符转义"><a href="#字符转义" class="headerlink" title="字符转义"></a>字符转义</h3><p>使用反斜杠<code>\</code>来取消元字符的特殊含义</p>
<p>例如：deerchao\.net匹配deerchao.net，C:\\Windows匹配C:\Windows</p>
<h2 id="re模块"><a href="#re模块" class="headerlink" title="re模块"></a>re模块</h2><p>Python 通过标准库的 re 模块支持正则表达式。</p>
<p><strong>常见的正则表达式函数与方法</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">函数/方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">re 模块的函数</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">compile(pattern,flags=0)</td>
<td style="text-align:left">对正则表达式模式 pattern 进行编译,flags是可选标志符,并返回一个 regex 对象</td>
</tr>
<tr>
<td style="text-align:left">re 模块的函数和 regex 对象的方法</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">match(pattern,string, flags=0)</td>
<td style="text-align:left">尝试用正则表达式模式 pattern 匹配字符串 string,flags 是可选标志符,如果匹配成功,则返回一个匹配对象;否则返回 None</td>
</tr>
<tr>
<td style="text-align:left">search(pattern,string, flags=0)</td>
<td style="text-align:left">在字符串 string 中查找正则表达式模式 pattern 的第一次出现,flags 是可选标志符,如果匹配成功,则返回一个匹配对象;否则返回 None</td>
</tr>
<tr>
<td style="text-align:left">findall(pattern,string[,flags])</td>
<td style="text-align:left">在字符串 string 中查找正则表达式模式 pattern 的所有出现;返回一个匹配对象的列表</td>
</tr>
<tr>
<td style="text-align:left">finditer(pattern,string[, flags])</td>
<td style="text-align:left">和 findall()相同,但返回的不是列表而是迭代器;对 于每个匹配,该迭代器返回一个匹配对象</td>
</tr>
<tr>
<td style="text-align:left">匹配对象的方法</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">split(pattern,string, max=0)</td>
<td style="text-align:left">根据正则表达式 pattern 中的分隔符把字符 string 分割为一个列表,返回成功匹配的列表,最多分割 max 次(默认是分割所有匹配的地方)</td>
</tr>
<tr>
<td style="text-align:left">sub(pattern, repl, string, max=0)</td>
<td style="text-align:left">把字符串 string 中所有匹配正则表达式 pattern 的地方替换成字符串 repl,如果 max 的值没有给出,则对所有匹配的地方进行替换</td>
</tr>
<tr>
<td style="text-align:left">group(num=0)</td>
<td style="text-align:left">返回全部匹配对象(或指定编号是 num 的子组)</td>
</tr>
<tr>
<td style="text-align:left">groups()</td>
<td style="text-align:left">返回一个包含全部匹配的子组的元组(如果没有成功匹配,就返回一个空元组)</td>
</tr>
</tbody>
</table>
<p>将一个正则表达式的样式编译为Python中正则表达式对象。由于正则表达式在执行过程中被多次用于比较，通过re.compile()进行预编译可以提升性能。􏰁</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; import re</div><div class="line">&gt;&gt;&gt; p = re.compile(&apos;[a-z]+&apos;)</div><div class="line">&gt;&gt;&gt; p</div><div class="line">&lt;_sre.SRE_Pattern object at 0x108174df0&gt;</div><div class="line">&gt;&gt;&gt; a = p.match(&apos;abc&apos;)</div><div class="line">&gt;&gt;&gt; a</div><div class="line">&lt;_sre.SRE_Match object at 0x10823c9f0&gt;</div><div class="line">&gt;&gt;&gt; re.match(p,&apos;abc&apos;)</div><div class="line">&lt;_sre.SRE_Match object at 0x10823ca58&gt;</div><div class="line">&gt;&gt;&gt; re.match(p,&apos;123&apos;)  #匹配失败返回None</div><div class="line">&gt;&gt;&gt;</div><div class="line">#不使用compile同样可以</div><div class="line">&gt;&gt;&gt; re.match(r&apos;[a-z]+&apos;,&apos;abc&apos;)</div><div class="line">&lt;_sre.SRE_Match object at 0x10823c988&gt;</div><div class="line">&gt;&gt;&gt; re.match(r&apos;[a-z]+&apos;,&apos;123&apos;)</div></pre></td></tr></table></figure>
<h3 id="匹配对象和方法"><a href="#匹配对象和方法" class="headerlink" title="匹配对象和方法"></a>匹配对象和方法</h3><p>在处理正则表达式时，除regex对象外，还有另一种对象类型-匹配对象。这些对象是在match() 或 search()被成功调用之后所返回的结果。匹配对象有两个主要方法:<strong>group() 和 groups()</strong></p>
<p>group()方法返回所有匹配对象或是根据要求返回某个特定子组。<br>groups()返回一个包含唯一或所有子组的元组。如果正则表达式中没有子组的话, groups() 将返回一个空元组,而 group()仍会返回全部匹配对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r'^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$'</span>, <span class="string">'010-12345'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m</div><div class="line">&lt;_sre.SRE_Match object at <span class="number">0x1082483e8</span>&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group() <span class="comment">#返回所有匹配结果</span></div><div class="line"><span class="string">'010-12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">0</span>) <span class="comment">#原始字符串 </span></div><div class="line"><span class="string">'010-12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>) </div><div class="line"><span class="string">'010'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)</div><div class="line"><span class="string">'12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.groups() <span class="comment">#返回包含子组的元组</span></div><div class="line">(<span class="string">'010'</span>, <span class="string">'12345'</span>)</div></pre></td></tr></table></figure>
<h3 id="re-match和re-search"><a href="#re-match和re-search" class="headerlink" title="re.match和re.search"></a>re.match和re.search</h3><p><strong>re.match和re.search的区别：</strong><br>re.match只匹配字符串的开始，如果字符串开始不符合正则表达式，则匹配失败，函数返回None；而re.search匹配整个字符串，直到找到一个匹配</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.match(<span class="string">'foo'</span>, <span class="string">'seafood'</span>) <span class="comment">#匹配失败返回None</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.search(<span class="string">'foo'</span>, <span class="string">'seafood'</span>) <span class="comment">#匹配成功</span></div><div class="line">&lt;_sre.SRE_Match object at <span class="number">0x10823ca58</span>&gt;</div></pre></td></tr></table></figure>
<p><strong>findall():</strong>根据正则表达式搜索字符串，返回所有符合的子字符串列表<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.findall(<span class="string">'foo'</span>, <span class="string">'fooseafood'</span>)</div><div class="line">[<span class="string">'foo'</span>, <span class="string">'foo'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.findall(<span class="string">'foo'</span>, <span class="string">'foofooseafood'</span>)</div><div class="line">[<span class="string">'foo'</span>, <span class="string">'foo'</span>, <span class="string">'foo'</span>]</div></pre></td></tr></table></figure></p>
<p>findall()和 search()相似之处在于二者都执行字符串搜索，但 findall()和 match()与 search()不同之处是,findall()总返回一个列表。</p>
<h3 id="切分和替换"><a href="#切分和替换" class="headerlink" title="切分和替换"></a>切分和替换</h3><p><strong>re.split()</strong>:根据正则表达式分割字符串，返回分割后的所有子字符串列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s = re.split(<span class="string">r'\s+'</span>, <span class="string">'a b   c'</span>) </div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'\s+'</span>, <span class="string">'a b   c'</span>)</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'[\s\,\;]'</span>,<span class="string">'a,b,c d;e'</span>)</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>]</div></pre></td></tr></table></figure>
<p><strong>re.subn()和re.sub()</strong><br>将某字符串中所有匹配正则表达式模式的部分进行替换，用来替换的部分通常是一个字符串,但也可能是一个函数,该函数返回一个用来替换的字符串。subn()和sub()一样,但它还返回一个表示替换次 数的数字,替换后的字符串和表示替换次数的数字作为一个元组的元素返回。<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"> &gt;&gt;&gt; re.sub(&apos;[ae]&apos;, &apos;X&apos;, &apos;abcdef&apos;)</div><div class="line">&apos;XbcdXf&apos;</div><div class="line">&gt;&gt;&gt; re.subn(&apos;[ae]&apos;, &apos;X&apos;, &apos;abcdef&apos;)</div><div class="line">(&apos;XbcdXf&apos;, 2)</div></pre></td></tr></table></figure></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="external">正则表达式30分钟入门教程</a><br><a href="https://docs.python.org/2/library/re.html" target="_blank" rel="external">Python官方文档</a><br><a href="https://book.douban.com/subject/3112503/" target="_blank" rel="external">Python核心编程</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;正则表达式是一些由字符和特殊符号组成的字符串，它们描􏰀述了这些字符和字符的某种重复方式，因此能按某种模式匹配一个有相似特征的字符串的集合。&lt;/strong&gt;正则表达式为高级文本模式匹配，以及搜索-替代等功能􏰁供了基础。&lt;/p&gt;
&lt;h2 id=&quot;元字符&quot;&gt;&lt;a href=&quot;#元字符&quot; class=&quot;headerlink&quot; title=&quot;元字符&quot;&gt;&lt;/a&gt;元字符&lt;/h2&gt;&lt;p&gt;元字符是正则表达式中规定的特殊代码，有特定的含义和匹配效果&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;常用的元字符&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;代码&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;.&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配除换行符以外的任意字符&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\w&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配字母或数字或下划线或汉字&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\s&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配任意的空白符(包括空格，制表符(Tab)，换行符，中文全角空格等)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\d&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配数字&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\b&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配单词的开始或结束(空格、标点、换行都算是单词的分割)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;^&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配字符串的开始&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;$&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配字符串的结束&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
      <category term="Dev" scheme="http://yoursite.com/categories/Dev/"/>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix Low-level discovery</title>
    <link href="http://yoursite.com/2017/01/21/low-level-discovery/"/>
    <id>http://yoursite.com/2017/01/21/low-level-discovery/</id>
    <published>2017-01-21T14:13:32.000Z</published>
    <updated>2018-11-14T15:46:33.071Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Low-level discovery provides a way to automatically create items, triggers, and graphs for different entities on a computer. For instance, Zabbix can automatically start monitoring file systems or network interfaces on your machine, without the need to create items for each file system or network interface manually. </p>
<p>In Zabbix, four types of item discovery are supported out of the box:</p>
<ul>
<li>discovery of file systems;</li>
<li>discovery of network interfaces;</li>
<li>discovery of CPUs and CPU cores;</li>
<li>discovery of SNMP OIDs.</li>
</ul>
<p>A user can define their own types of discovery, provided they follow a particular JSON protocol.</p>
</blockquote>
<a id="more"></a>
<p>简而言之，zabbix的低水平发现就是减少我们的重复操作，能够根据不同的监控实例自动添加监控项、触发器和图形。<br><code>vfs.fs.discovery</code>和<code>net.if.discovery</code>就是zabbix自带的自动发现键值，能够自动识别agent端的文件挂载情况和网卡信息。还有基于SNMP OID的自动发现键值，能够自动识别交换机的所有端口信息。<br>当我们的一个服务有多个端口需要监控时，我通常是先在agent端写好监控脚本，定义键值，然后再为每个端口新建监控项、触发器和图形（当然你可以直接克隆），但还是免不了一些重复操作。下面就通过一个例子看一下Low-level discovery是如何工作的：</p>
<h3 id="监控需求："><a href="#监控需求：" class="headerlink" title="监控需求："></a>监控需求：</h3><p>监控udp端口12222-12229的端口状态</p>
<h3 id="实现步骤："><a href="#实现步骤：" class="headerlink" title="实现步骤："></a>实现步骤：</h3><h4 id="1-以json格式自定义发现类型"><a href="#1-以json格式自定义发现类型" class="headerlink" title="1.以json格式自定义发现类型"></a>1.以json格式自定义发现类型</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line">$ cat udpport_discovery.py</div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> sys,datetime,socket</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    zbxkey = sys.argv[<span class="number">1</span>]</div><div class="line">    zbx_d = &#123;&#125;</div><div class="line">    zbx_d[<span class="string">"data"</span>] = []</div><div class="line">    host_name = socket.gethostname().lower()</div><div class="line"></div><div class="line">    res = [<span class="string">'12222'</span>, <span class="string">'12223'</span>, <span class="string">'12224'</span>, <span class="string">'12225'</span>, <span class="string">'12226'</span>, <span class="string">'12227'</span>, <span class="string">'12228'</span>, <span class="string">'12229'</span>]</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> res:</div><div class="line">        d = &#123;&#125;</div><div class="line">        d[<span class="string">"&#123;#%s&#125;"</span> % zbxkey] = line</div><div class="line">        zbx_d[<span class="string">"data"</span>].append(d)</div><div class="line">    <span class="keyword">print</span> str(zbx_d).replace(<span class="string">"'"</span>,<span class="string">'"'</span>)</div></pre></td></tr></table></figure>
<h4 id="2-定义配置文件"><a href="#2-定义配置文件" class="headerlink" title="2.定义配置文件"></a>2.定义配置文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udp_port.conf</div><div class="line">#############Template_Udp#############</div><div class="line">UserParameter=status[*],/home/prod/softwares/zabbix/etc/zabbix_agentd.conf.d/udp_port.sh $1</div><div class="line">UserParameter=discovery.udpport,/home/prod/softwares/zabbix/etc/zabbix_agentd.conf.d/udpport_discovery.py PORT</div></pre></td></tr></table></figure>
<h4 id="3-检测自定义键值"><a href="#3-检测自定义键值" class="headerlink" title="3.检测自定义键值"></a>3.检测自定义键值</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ python udpport_discovery.py PORT</div><div class="line">&#123;&quot;data&quot;: [&#123;&quot;&#123;#PORT&#125;&quot;: &quot;12222&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12223&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12224&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12225&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12226&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12227&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12228&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12229&quot;&#125;]&#125;</div></pre></td></tr></table></figure>
<p>zabbix server端测试：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ./zabbix_get -s 10.0.0.206 -k discovery.udpport</div><div class="line">&#123;&quot;data&quot;: [&#123;&quot;&#123;#PORT&#125;&quot;: &quot;12222&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12223&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12224&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12225&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12226&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12227&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12228&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12229&quot;&#125;]&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-编写监控脚本"><a href="#4-编写监控脚本" class="headerlink" title="4.编写监控脚本"></a>4.编写监控脚本</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udp_port.sh</div><div class="line">Port=$1</div><div class="line">case $Port in</div><div class="line">        12222)   netstat -nupl | grep 12222 |wc -l;;</div><div class="line">        12223)   netstat -nupl | grep 12223 |wc -l;;</div><div class="line">        12224)   netstat -nupl | grep 12224 |wc -l;;</div><div class="line">        12225)   netstat -nupl | grep 12225 |wc -l;;</div><div class="line">        12226)   netstat -nupl | grep 12226 |wc -l;;</div><div class="line">        12227)   netstat -nupl | grep 12227 |wc -l;;</div><div class="line">        12228)   netstat -nupl | grep 12228 |wc -l;;</div><div class="line">        12229)   netstat -nupl | grep 12229 |wc -l;;</div><div class="line">        *) echo Error; exit 1;;</div><div class="line">esac</div></pre></td></tr></table></figure>
<h4 id="5-web添加模板"><a href="#5-web添加模板" class="headerlink" title="5.web添加模板"></a>5.web添加模板</h4><p><img src="/img/01256527-8987-40C4-9C65-2FC6D1D8610F.png" alt=""></p>
<p><img src="/img/E604037B-096A-4789-9AB3-A47B14020FB2.png" alt=""></p>
<h4 id="6-将模板关联对应机器"><a href="#6-将模板关联对应机器" class="headerlink" title="6.将模板关联对应机器"></a>6.将模板关联对应机器</h4><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.zabbix.com/documentation/2.4/manual/discovery/low_level_discovery" target="_blank" rel="external">LDD官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Low-level discovery provides a way to automatically create items, triggers, and graphs for different entities on a computer. For instance, Zabbix can automatically start monitoring file systems or network interfaces on your machine, without the need to create items for each file system or network interface manually. &lt;/p&gt;
&lt;p&gt;In Zabbix, four types of item discovery are supported out of the box:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;discovery of file systems;&lt;/li&gt;
&lt;li&gt;discovery of network interfaces;&lt;/li&gt;
&lt;li&gt;discovery of CPUs and CPU cores;&lt;/li&gt;
&lt;li&gt;discovery of SNMP OIDs.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A user can define their own types of discovery, provided they follow a particular JSON protocol.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="zabbix" scheme="http://yoursite.com/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>运维必备之Linux命令概览</title>
    <link href="http://yoursite.com/2017/01/01/command/"/>
    <id>http://yoursite.com/2017/01/01/command/</id>
    <published>2017-01-01T12:48:46.000Z</published>
    <updated>2020-01-04T14:44:18.635Z</updated>
    
    <content type="html"><![CDATA[<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p><img src="/img/C3EB9F70-7F51-4B46-8B14-825CD9B8C11B.png" alt=""></p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><img src="/img/BF852F66-2D8E-42D8-A4EB-2826A98C354C.png" alt=""></p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p><img src="/img/429014F3-442B-4115-A97D-32D62E6BEE7F.png" alt=""></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.brendangregg.com/linuxperf.html" target="_blank" rel="external">Linux Performance</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;监控&quot;&gt;&lt;a href=&quot;#监控&quot; class=&quot;headerlink&quot; title=&quot;监控&quot;&gt;&lt;/a&gt;监控&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;/img/C3EB9F70-7F51-4B46-8B14-825CD9B8C11B.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;
    
    </summary>
    
      <category term="Cmd" scheme="http://yoursite.com/categories/Cmd/"/>
    
    
      <category term="命令汇总" scheme="http://yoursite.com/tags/%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB/"/>
    
  </entry>
  
</feed>
