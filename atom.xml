<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Abner</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-04-12T02:13:31.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Abnerzhao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Ansible 回调插件简单使用</title>
    <link href="http://yoursite.com/2017/04/11/ansible-callback-plugins/"/>
    <id>http://yoursite.com/2017/04/11/ansible-callback-plugins/</id>
    <published>2017-04-11T12:20:44.000Z</published>
    <updated>2017-04-12T02:13:31.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Developing-Plugins"><a href="#Developing-Plugins" class="headerlink" title="Developing Plugins"></a>Developing Plugins</h2><p>插件是增强ansible核心功能的代码片段，我们可以很方便的使用插件，编写插件代码。如果我们想要对ansible的执行结果进行分析，根据返回结果发送邮件，写入日志等都可以通过插件实现。</p>
<h3 id="插件列表"><a href="#插件列表" class="headerlink" title="插件列表"></a>插件列表</h3><ul>
<li><strong>Action plugins</strong> are front ends to modules and can execute actions on the controller before calling the modules themselves.（操作插件，调用模块之前执行操作）</li>
<li><strong>Cache plugins</strong> are used to keep a cache of ‘facts’ to avoid costly fact-gathering operations.（缓存插件，缓存主机facts变量）</li>
<li><strong>Callback plugins</strong> enable you to hook into Ansible events for display or logging purposes.（回调插件，对事件进行显示和记录，这个常用）<a id="more"></a></li>
<li><strong>Connection plugins</strong> define how to communicate with inventory hosts.（连接插件，定义如何与节点主机通信）</li>
<li><strong>Filters plugins</strong> allow you to manipulate data inside Ansible plays and/or templates. This is a Jinja2 feature; Ansible ships extra filter plugins.（过滤插件，Jinja2功能）</li>
<li><strong>Lookup plugins</strong> are used to pull data from an external source. These are implemented using a custom Jinja2 function.（查找插件用于从外部源提取数据）</li>
<li><strong>Strategy plugins</strong> control the flow of a play and execution logic.（策略插件）</li>
<li><strong>Shell plugins</strong> deal with low-level commands and formatting for the different shells Ansible can encounter on remote hosts.（shell插件处理低级别命令和格式化）</li>
<li><strong>Test plugins</strong> allow you to validate data inside Ansible plays and/or templates. This is a Jinja2 feature; Ansible ships extra test plugins.（测试插件）</li>
<li><strong>Vars plugins</strong> inject additional variable data into Ansible runs that did not come from an inventory, playbook, or the command line.（Vars插件）</li>
</ul>
<h2 id="Callback-plugins"><a href="#Callback-plugins" class="headerlink" title="Callback plugins"></a>Callback plugins</h2><p>在日常开发中使用回调插件比较多一点，通过callback插件，可以实现回调功能，里面定义了若干场景，如主机不可达，执行任务失败，执行任务成功等，分别对应不同的方法，这样就可以实现在不同的场景触发不同的操作。</p>
<h3 id="设置回调功能参数"><a href="#设置回调功能参数" class="headerlink" title="设置回调功能参数"></a>设置回调功能参数</h3><p>该功能ansible默认是关闭的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line">$ cat /etc/ansible/ansible.cfg </div><div class="line">...</div><div class="line">bin_ansible_callbacks = <span class="keyword">True</span> <span class="comment">#加载功能</span></div><div class="line"></div><div class="line"><span class="comment"># set plugin path directories here, separate with colons 定义插件位置</span></div><div class="line">action_plugins     = /usr/share/ansible_plugins/action_plugins</div><div class="line">callback_plugins   = /usr/share/ansible_plugins/callback_plugins</div><div class="line">connection_plugins = /usr/share/ansible_plugins/connection_plugins</div><div class="line">lookup_plugins     = /usr/share/ansible_plugins/lookup_plugins</div><div class="line">vars_plugins       = /usr/share/ansible_plugins/vars_plugins</div><div class="line">filter_plugins     = /usr/share/ansible_plugins/filter_plugins</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="编写回调脚本"><a href="#编写回调脚本" class="headerlink" title="编写回调脚本"></a>编写回调脚本</h3><p>编写回调脚本放到配置文件中定义的目录中，并赋予可执行权限。我们可以将执行结果写入本地文件、数据库或发邮件等等。在日常开发中我们会将结果写入日志或跟踪记录执行的进度和异常。</p>
<h4 id="写入本地文件"><a href="#写入本地文件" class="headerlink" title="写入本地文件"></a>写入本地文件</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">result_file = <span class="string">'/tmp/result'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackModule</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_ok</span><span class="params">(self, host, res)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(result_file,<span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(<span class="string">'success\n'</span>)</div><div class="line">            f.write(str(host))</div><div class="line">            f.write(json.dumps(res, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)))</div><div class="line">            f.write(<span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_failed</span><span class="params">(self, host, res, ignore_errors=False)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(result_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(<span class="string">'failed\n'</span>)</div><div class="line">            f.write(str(host))</div><div class="line">            f.write(json.dumps(res, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)))</div><div class="line">            f.write(<span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_unreachable</span><span class="params">(self,host,res)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(result_file, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(<span class="string">'unreachable\n'</span>)</div><div class="line">            f.write(str(host))</div><div class="line">            f.write(json.dumps(res, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)))</div><div class="line">            f.write(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure>
<p>测试<br><figure class="highlight"><table><tr><td class="code"><pre><div class="line">$ ansible-playbook  -i hosts test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | cp test auto install script] ************************************</div><div class="line">ok: [172.31.30.178]</div><div class="line"></div><div class="line">TASK: [test | install test] ***************************************************</div><div class="line">changed: [172.31.30.178]</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">172.31.30.178              : ok=2    changed=1    unreachable=0    failed=0</div><div class="line"></div><div class="line">#制造一个unreachable错误</div><div class="line">$ ansible-playbook  -i hosts  test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | cp test auto install script] ************************************</div><div class="line">fatal: [172.31.30.178] =&gt; SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue</div><div class="line"></div><div class="line">FATAL: all hosts have already failed -- aborting</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">           to retry, use: --limit @/root/startoftwares.retry</div><div class="line"></div><div class="line">172.31.30.178              : ok=0    changed=0    unreachable=1    failed=0</div><div class="line"></div><div class="line">#查看结果</div><div class="line">$ cat /tmp/result</div><div class="line">success</div><div class="line">172.31.30.178&#123;</div><div class="line">    "changed": false,</div><div class="line">    "dest": "/tmp/test.sh",</div><div class="line">    "gid": 1000,</div><div class="line">    "group": "ubuntu",</div><div class="line">    "invocation": &#123;</div><div class="line">        "module_args": "src=test.sh dest=/tmp/test.sh owner=ubuntu group=ubuntu mode=0755",</div><div class="line">        "module_name": "copy"</div><div class="line">    &#125;,</div><div class="line">    "md5sum": "da1bd2e811a9909b96b09c3988deaec6",</div><div class="line">    "mode": "0755",</div><div class="line">    "owner": "ubuntu",</div><div class="line">    "path": "/tmp/test.sh",</div><div class="line">    "size": 58,</div><div class="line">    "state": "file",</div><div class="line">    "uid": 1000</div><div class="line">&#125;</div><div class="line">success</div><div class="line">172.31.30.178&#123;</div><div class="line">    "changed": true,</div><div class="line">    "cmd": "bash /tmp/test.sh",</div><div class="line">    "delta": "0:00:03.004104",</div><div class="line">    "end": "2017-04-11 10:48:20.429600",</div><div class="line">    "invocation": &#123;</div><div class="line">        "module_args": "bash /tmp/test.sh",</div><div class="line">        "module_name": "shell"</div><div class="line">    &#125;,</div><div class="line">    "rc": 0,</div><div class="line">    "start": "2017-04-11 10:48:17.425496",</div><div class="line">    "stderr": "",</div><div class="line">    "stdout": ""</div><div class="line">&#125;</div><div class="line">unreachable</div><div class="line">172.31.30.178"SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue"</div></pre></td></tr></table></figure></p>
<h4 id="发邮件"><a href="#发邮件" class="headerlink" title="发邮件"></a>发邮件</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> smtplib</div><div class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">mail_host=<span class="string">"smtp.xxx.com"</span></div><div class="line">mail_user=<span class="string">"xxxxx@xxx.com"</span></div><div class="line">mail_pass=<span class="string">"xxxxxxx"</span></div><div class="line">user_to = <span class="string">"xxxxx@xxx.com"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(context)</span>:</span></div><div class="line">    msg = MIMEText(context, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>)</div><div class="line">    msg[<span class="string">'From'</span>] = mail_user</div><div class="line">    msg[<span class="string">'To'</span>] = user_to</div><div class="line">    msg[<span class="string">'Subject'</span>] = <span class="string">'Ansible error mail'</span></div><div class="line">    server = smtplib.SMTP(mail_host, <span class="number">25</span>)</div><div class="line">    server.login(mail_user, mail_pass)</div><div class="line">    server.sendmail(mail_user, user_to, msg.as_string())</div><div class="line">    server.quit()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackModule</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_ok</span><span class="params">(self, host, res)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_failed</span><span class="params">(self, host, res, ignore_errors=False)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">runner_on_unreachable</span><span class="params">(self,host,res)</span>:</span></div><div class="line">        <span class="keyword">if</span> isinstance(res,basestring):</div><div class="line">            context = <span class="string">'An error occured for host '</span> + host + <span class="string">' with the following message:\n\n'</span> + res</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            context = <span class="string">'An error occured for host'</span> + host + <span class="string">' with the following message:\n\n'</span> + str(res)</div><div class="line">        send_mail(context)</div></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">$ ansible-playbook  -i hosts  test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | cp test auto install script] ************************************</div><div class="line">fatal: [172.31.30.178] =&gt; SSH encountered an unknown error during the connection. We recommend you re-run the command using -vvvv, which will enable SSH debugging output to help diagnose the issue</div><div class="line"></div><div class="line">FATAL: all hosts have already failed -- aborting</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">           to retry, use: --limit @/root/startoftwares.retry</div><div class="line"></div><div class="line">172.31.30.178              : ok=0    changed=0    unreachable=1    failed=0</div></pre></td></tr></table></figure>
<p>查收邮件</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/B028FB3F-50E6-4B04-8969-BDCFD20ECAEB.png" alt=""></p>
<p>以上脚本都写的比较简单，建议参考:<a href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins" target="_blank" rel="external">官方插件代码样例</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://docs.ansible.com/ansible/dev_guide/developing_plugins.html" target="_blank" rel="external">官方文档</a><br><a href="http://ansible-tran.readthedocs.io/en/latest/docs/intro_configuration.html#bin-ansible-callbacks" target="_blank" rel="external">中文文档配置文件参数详解</a><br><a href="http://rfyiamcool.blog.51cto.com/1030776/1440624" target="_blank" rel="external">ansible调用callbacks插件实现结果nosql输出回调</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Developing-Plugins&quot;&gt;&lt;a href=&quot;#Developing-Plugins&quot; class=&quot;headerlink&quot; title=&quot;Developing Plugins&quot;&gt;&lt;/a&gt;Developing Plugins&lt;/h2&gt;&lt;p&gt;插件是增强ansible核心功能的代码片段，我们可以很方便的使用插件，编写插件代码。如果我们想要对ansible的执行结果进行分析，根据返回结果发送邮件，写入日志等都可以通过插件实现。&lt;/p&gt;
&lt;h3 id=&quot;插件列表&quot;&gt;&lt;a href=&quot;#插件列表&quot; class=&quot;headerlink&quot; title=&quot;插件列表&quot;&gt;&lt;/a&gt;插件列表&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Action plugins&lt;/strong&gt; are front ends to modules and can execute actions on the controller before calling the modules themselves.（操作插件，调用模块之前执行操作）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cache plugins&lt;/strong&gt; are used to keep a cache of ‘facts’ to avoid costly fact-gathering operations.（缓存插件，缓存主机facts变量）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Callback plugins&lt;/strong&gt; enable you to hook into Ansible events for display or logging purposes.（回调插件，对事件进行显示和记录，这个常用）
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>Python正则表达式</title>
    <link href="http://yoursite.com/2017/03/05/Python%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>http://yoursite.com/2017/03/05/Python正则表达式/</id>
    <published>2017-03-05T09:13:36.000Z</published>
    <updated>2017-03-05T09:27:17.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>正则表达式是一些由字符和特殊符号组成的字符串，它们描􏰀述了这些字符和字符的某种重复方式，因此能按某种模式匹配一个有相似特征的字符串的集合。</strong>正则表达式为高级文本模式匹配，以及搜索-替代等功能􏰁供了基础。</p>
<h2 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h2><p>元字符是正则表达式中规定的特殊代码，有特定的含义和匹配效果</p>
<p><strong>常用的元字符</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">.</td>
<td style="text-align:left">匹配除换行符以外的任意字符</td>
</tr>
<tr>
<td style="text-align:left">\w</td>
<td style="text-align:left">匹配字母或数字或下划线或汉字</td>
</tr>
<tr>
<td style="text-align:left">\s</td>
<td style="text-align:left">匹配任意的空白符(包括空格，制表符(Tab)，换行符，中文全角空格等)</td>
</tr>
<tr>
<td style="text-align:left">\d</td>
<td style="text-align:left">匹配数字</td>
</tr>
<tr>
<td style="text-align:left">\b</td>
<td style="text-align:left">匹配单词的开始或结束(空格、标点、换行都算是单词的分割)</td>
</tr>
<tr>
<td style="text-align:left">^</td>
<td style="text-align:left">匹配字符串的开始</td>
</tr>
<tr>
<td style="text-align:left">$</td>
<td style="text-align:left">匹配字符串的结束</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<p><strong>示例：</strong></p>
<p><code>\ba\w*\b</code>: 匹配以字母a开头的单词——先是某个单词开始处(\b)，然后是字母a,然后是任意数量的字母或数字(\w*)，最后是单词结束处(\b)</p>
<p><code>\d+</code>: 匹配1个或更多连续的数字。这里的+是和<em>类似的元字符，不同的是\</em>匹配重复任意次(可能是0次)，而+则匹配重复1次或更多次</p>
<p><code>\b\w{6}\b</code>: 匹配刚好6个字符的单词</p>
<p><code>^\d{5,12}$</code>: 匹配5位到12位数字</p>
<h3 id="重复"><a href="#重复" class="headerlink" title="重复"></a>重复</h3><p><strong>常用的限定符(指定数量的代码)</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">*</td>
<td style="text-align:left">重复零次或更多次</td>
</tr>
<tr>
<td style="text-align:left">+</td>
<td style="text-align:left">重复一次或更多次</td>
</tr>
<tr>
<td style="text-align:left">?</td>
<td style="text-align:left">重复零次或一次</td>
</tr>
<tr>
<td style="text-align:left">{n}</td>
<td style="text-align:left">重复n次</td>
</tr>
<tr>
<td style="text-align:left">{n,}</td>
<td style="text-align:left">重复n次或更多次</td>
</tr>
<tr>
<td style="text-align:left">{n,m}</td>
<td style="text-align:left">重复n到m次</td>
</tr>
</tbody>
</table>
<p><strong>示例：</strong><br>Windows\d+: 匹配Windows后面跟1个或更多数字<br>^\w+: 匹配一行的第一个单词</p>
<h3 id="反义"><a href="#反义" class="headerlink" title="反义"></a>反义</h3><p><strong>常用的反义代码</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">代码</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">\W</td>
<td style="text-align:left">匹配任意不是字母，数字，下划线，汉字的字符</td>
</tr>
<tr>
<td style="text-align:left">\S</td>
<td style="text-align:left">匹配任意不是空白符的字符</td>
</tr>
<tr>
<td style="text-align:left">\D</td>
<td style="text-align:left">匹配任意非数字的字符</td>
</tr>
<tr>
<td style="text-align:left">\B</td>
<td style="text-align:left">匹配不是单词开头或结束的位置</td>
</tr>
<tr>
<td style="text-align:left">[^x]</td>
<td style="text-align:left">匹配除了x以外的任意字符</td>
</tr>
<tr>
<td style="text-align:left">[^aeiou]</td>
<td style="text-align:left">匹配除了aeiou这几个字母以外的任意字符</td>
</tr>
</tbody>
</table>
<h2 id="字符类"><a href="#字符类" class="headerlink" title="字符类"></a>字符类</h2><p>我们要想查找数字，字母或数字，空白这些很简单，直接使用元字符对应的字符集合即可实现。但是如果想要匹配没有预定义元字符的字符集合(比如元音字母a,e,i,o,u),应该怎么办？</p>
<p>这时我们需要在方括号<code>[]</code>中列出想要匹配的字符集合。如[aeiou]就匹配任何一个英文元音字母，[.?!]匹配标点符号(.或?或!)。</p>
<p>[0-9]代表的含意与\d就是完全一致的：一位数字；同理[a-z0-9A-Z_]也完全等同于\w（如果只考虑英文的话）</p>
<p>\(?0\d{2}[) -]?\d{8}:匹配几种格式的电话号码，像(010)88886666，或022-22334455，或02912345678等</p>
<h3 id="分枝条件"><a href="#分枝条件" class="headerlink" title="分枝条件"></a>分枝条件</h3><p>正则表达式里的分枝条件指的是有几种规则，如果满足其中任意一种规则都应该当成匹配，具体方法是用<code>|</code>把不同的规则分隔开，匹配分枝条件时，将会从左到右地测试每个条件，如果满足了某个分枝的话，就不会去再管其它的条件了</p>
<p><code>0\d{2}-\d{8}|0\d{3}-\d{7}</code>这个表达式能匹配两种以连字号分隔的电话号码：一种是三位区号，8位本地号(如010-12345678)，一种是4位区号，7位本地号(0376-2233445)</p>
<p><code>\\(?0\d{2}\)?[- ]?\d{8}|0\d{2}[-]?\d{8}</code>这个表达式匹配3位区号的电话号码，其中区号可以用小括号括起来，也可以不用，区号与本地号间可以用连字号或空格间隔，也可以没有间隔</p>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>重复单个字符在后面加上限定符就行了，如果想要重复多个字符那么就需要用<code>小括号</code>来指定子表达式(也叫做分组)，然后你就可以指定这个子表达式的重复次数了，你也可以对子表达式进行其它一些操作。</p>
<p>(\d{1,3}.){3}：\d{1,3}匹配1到3位的数字，(\d{1,3}.){3}匹配三位数字加上一个英文句号(这个整体也就是这个分组)重复3次</p>
<h3 id="字符转义"><a href="#字符转义" class="headerlink" title="字符转义"></a>字符转义</h3><p>使用反斜杠<code>\</code>来取消元字符的特殊含义</p>
<p>例如：deerchao\.net匹配deerchao.net，C:\\Windows匹配C:\Windows</p>
<h2 id="re模块"><a href="#re模块" class="headerlink" title="re模块"></a>re模块</h2><p>Python 通过标准库的 re 模块支持正则表达式。</p>
<p><strong>常见的正则表达式函数与方法</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">函数/方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">re 模块的函数</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">compile(pattern,flags=0)</td>
<td style="text-align:left">对正则表达式模式 pattern 进行编译,flags是可选标志符,并返回一个 regex 对象</td>
</tr>
<tr>
<td style="text-align:left">re 模块的函数和 regex 对象的方法</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">match(pattern,string, flags=0)</td>
<td style="text-align:left">尝试用正则表达式模式 pattern 匹配字符串 string,flags 是可选标志符,如果匹配成功,则返回一个匹配对象;否则返回 None</td>
</tr>
<tr>
<td style="text-align:left">search(pattern,string, flags=0)</td>
<td style="text-align:left">在字符串 string 中查找正则表达式模式 pattern 的第一次出现,flags 是可选标志符,如果匹配成功,则返回一个匹配对象;否则返回 None</td>
</tr>
<tr>
<td style="text-align:left">findall(pattern,string[,flags])</td>
<td style="text-align:left">在字符串 string 中查找正则表达式模式 pattern 的所有出现;返回一个匹配对象的列表</td>
</tr>
<tr>
<td style="text-align:left">finditer(pattern,string[, flags])</td>
<td style="text-align:left">和 findall()相同,但返回的不是列表而是迭代器;对 于每个匹配,该迭代器返回一个匹配对象</td>
</tr>
<tr>
<td style="text-align:left">匹配对象的方法</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">split(pattern,string, max=0)</td>
<td style="text-align:left">根据正则表达式 pattern 中的分隔符把字符 string 分割为一个列表,返回成功匹配的列表,最多分割 max 次(默认是分割所有匹配的地方)</td>
</tr>
<tr>
<td style="text-align:left">sub(pattern, repl, string, max=0)</td>
<td style="text-align:left">把字符串 string 中所有匹配正则表达式 pattern 的地方替换成字符串 repl,如果 max 的值没有给出,则对所有匹配的地方进行替换</td>
</tr>
<tr>
<td style="text-align:left">group(num=0)</td>
<td style="text-align:left">返回全部匹配对象(或指定编号是 num 的子组)</td>
</tr>
<tr>
<td style="text-align:left">groups()</td>
<td style="text-align:left">返回一个包含全部匹配的子组的元组(如果没有成功匹配,就返回一个空元组)</td>
</tr>
</tbody>
</table>
<p>将一个正则表达式的样式编译为Python中正则表达式对象。由于正则表达式在执行过程中被多次用于比较，通过re.compile()进行预编译可以提升性能。􏰁</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&gt;&gt;&gt; import re</div><div class="line">&gt;&gt;&gt; p = re.compile(&apos;[a-z]+&apos;)</div><div class="line">&gt;&gt;&gt; p</div><div class="line">&lt;_sre.SRE_Pattern object at 0x108174df0&gt;</div><div class="line">&gt;&gt;&gt; a = p.match(&apos;abc&apos;)</div><div class="line">&gt;&gt;&gt; a</div><div class="line">&lt;_sre.SRE_Match object at 0x10823c9f0&gt;</div><div class="line">&gt;&gt;&gt; re.match(p,&apos;abc&apos;)</div><div class="line">&lt;_sre.SRE_Match object at 0x10823ca58&gt;</div><div class="line">&gt;&gt;&gt; re.match(p,&apos;123&apos;)  #匹配失败返回None</div><div class="line">&gt;&gt;&gt;</div><div class="line">#不使用compile同样可以</div><div class="line">&gt;&gt;&gt; re.match(r&apos;[a-z]+&apos;,&apos;abc&apos;)</div><div class="line">&lt;_sre.SRE_Match object at 0x10823c988&gt;</div><div class="line">&gt;&gt;&gt; re.match(r&apos;[a-z]+&apos;,&apos;123&apos;)</div></pre></td></tr></table></figure>
<h3 id="匹配对象和方法"><a href="#匹配对象和方法" class="headerlink" title="匹配对象和方法"></a>匹配对象和方法</h3><p>在处理正则表达式时，除regex对象外，还有另一种对象类型-匹配对象。这些对象是在match() 或 search()被成功调用之后所返回的结果。匹配对象有两个主要方法:<strong>group() 和 groups()</strong></p>
<p>group()方法返回所有匹配对象或是根据要求返回某个特定子组。<br>groups()返回一个包含唯一或所有子组的元组。如果正则表达式中没有子组的话, groups() 将返回一个空元组,而 group()仍会返回全部匹配对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r'^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$'</span>, <span class="string">'010-12345'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m</div><div class="line">&lt;_sre.SRE_Match object at <span class="number">0x1082483e8</span>&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group() <span class="comment">#返回所有匹配结果</span></div><div class="line"><span class="string">'010-12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">0</span>) <span class="comment">#原始字符串 </span></div><div class="line"><span class="string">'010-12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>) </div><div class="line"><span class="string">'010'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)</div><div class="line"><span class="string">'12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.groups() <span class="comment">#返回包含子组的元组</span></div><div class="line">(<span class="string">'010'</span>, <span class="string">'12345'</span>)</div></pre></td></tr></table></figure>
<h3 id="re-match和re-search"><a href="#re-match和re-search" class="headerlink" title="re.match和re.search"></a>re.match和re.search</h3><p><strong>re.match和re.search的区别：</strong><br>re.match只匹配字符串的开始，如果字符串开始不符合正则表达式，则匹配失败，函数返回None；而re.search匹配整个字符串，直到找到一个匹配</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.match(<span class="string">'foo'</span>, <span class="string">'seafood'</span>) <span class="comment">#匹配失败返回None</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.search(<span class="string">'foo'</span>, <span class="string">'seafood'</span>) <span class="comment">#匹配成功</span></div><div class="line">&lt;_sre.SRE_Match object at <span class="number">0x10823ca58</span>&gt;</div></pre></td></tr></table></figure>
<p><strong>findall():</strong>根据正则表达式搜索字符串，返回所有符合的子字符串列表<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.findall(<span class="string">'foo'</span>, <span class="string">'fooseafood'</span>)</div><div class="line">[<span class="string">'foo'</span>, <span class="string">'foo'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.findall(<span class="string">'foo'</span>, <span class="string">'foofooseafood'</span>)</div><div class="line">[<span class="string">'foo'</span>, <span class="string">'foo'</span>, <span class="string">'foo'</span>]</div></pre></td></tr></table></figure></p>
<p>findall()和 search()相似之处在于二者都执行字符串搜索，但 findall()和 match()与 search()不同之处是,findall()总返回一个列表。</p>
<h3 id="切分和替换"><a href="#切分和替换" class="headerlink" title="切分和替换"></a>切分和替换</h3><p><strong>re.split()</strong>:根据正则表达式分割字符串，返回分割后的所有子字符串列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s = re.split(<span class="string">r'\s+'</span>, <span class="string">'a b   c'</span>) </div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'\s+'</span>, <span class="string">'a b   c'</span>)</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'[\s\,\;]'</span>,<span class="string">'a,b,c d;e'</span>)</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>]</div></pre></td></tr></table></figure>
<p><strong>re.subn()和re.sub()</strong><br>将某字符串中所有匹配正则表达式模式的部分进行替换，用来替换的部分通常是一个字符串,但也可能是一个函数,该函数返回一个用来替换的字符串。subn()和sub()一样,但它还返回一个表示替换次 数的数字,替换后的字符串和表示替换次数的数字作为一个元组的元素返回。<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"> &gt;&gt;&gt; re.sub(&apos;[ae]&apos;, &apos;X&apos;, &apos;abcdef&apos;)</div><div class="line">&apos;XbcdXf&apos;</div><div class="line">&gt;&gt;&gt; re.subn(&apos;[ae]&apos;, &apos;X&apos;, &apos;abcdef&apos;)</div><div class="line">(&apos;XbcdXf&apos;, 2)</div></pre></td></tr></table></figure></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="external">正则表达式30分钟入门教程</a><br><a href="https://docs.python.org/2/library/re.html" target="_blank" rel="external">Python官方文档</a><br><a href="https://book.douban.com/subject/3112503/" target="_blank" rel="external">Python核心编程</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;正则表达式是一些由字符和特殊符号组成的字符串，它们描􏰀述了这些字符和字符的某种重复方式，因此能按某种模式匹配一个有相似特征的字符串的集合。&lt;/strong&gt;正则表达式为高级文本模式匹配，以及搜索-替代等功能􏰁供了基础。&lt;/p&gt;
&lt;h2 id=&quot;元字符&quot;&gt;&lt;a href=&quot;#元字符&quot; class=&quot;headerlink&quot; title=&quot;元字符&quot;&gt;&lt;/a&gt;元字符&lt;/h2&gt;&lt;p&gt;元字符是正则表达式中规定的特殊代码，有特定的含义和匹配效果&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;常用的元字符&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;&gt;代码&lt;/th&gt;
&lt;th style=&quot;text-align:left&quot;&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;.&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配除换行符以外的任意字符&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\w&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配字母或数字或下划线或汉字&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\s&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配任意的空白符(包括空格，制表符(Tab)，换行符，中文全角空格等)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\d&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配数字&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;\b&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配单词的开始或结束(空格、标点、换行都算是单词的分割)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;^&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配字符串的开始&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;text-align:left&quot;&gt;$&lt;/td&gt;
&lt;td style=&quot;text-align:left&quot;&gt;匹配字符串的结束&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
      <category term="Dev" scheme="http://yoursite.com/categories/Dev/"/>
    
    
      <category term="Python" scheme="http://yoursite.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>ansible vars变量和templates jinja2渲染</title>
    <link href="http://yoursite.com/2017/02/16/ansilbe-vars-and-template/"/>
    <id>http://yoursite.com/2017/02/16/ansilbe-vars-and-template/</id>
    <published>2017-02-16T09:38:10.000Z</published>
    <updated>2017-04-16T09:46:04.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Ansible-roles"><a href="#Ansible-roles" class="headerlink" title="Ansible roles"></a>Ansible roles</h3><p>Ansible roles用于层次性、结构化地组织playbook，简单介绍一下ansible playbook中关于变量的两个roles目录。</p>
<ul>
<li>vars目录：用于定义此角色用到的变量</li>
<li>templates目录：template模块会自动在此目录中寻找Jinja2模板文件</li>
</ul>
<a id="more"></a>
<h3 id="vars目录"><a href="#vars目录" class="headerlink" title="vars目录"></a>vars目录</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line">$ cat vars/main.yml</div><div class="line">---</div><div class="line">filepath: /tmp</div><div class="line">user: ubuntu</div><div class="line">group: ubuntu</div><div class="line"></div><div class="line">$ cat task/main.yml</div><div class="line">- name: copy test script</div><div class="line">  copy: src=test.sh dest=&#123;&#123;filepath&#125;&#125;/test.sh owner=&#123;&#123;user&#125;&#125; group=&#123;&#123;group&#125;&#125; mode=<span class="number">0755</span></div><div class="line"></div><div class="line">$ ansible-playbook  -i hosts  test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | copy test script] ***********************************************</div><div class="line">changed: [<span class="number">172.31</span><span class="number">.30</span><span class="number">.178</span>]</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line"><span class="number">172.31</span><span class="number">.30</span><span class="number">.178</span>              : ok=<span class="number">1</span>    changed=<span class="number">1</span>    unreachable=<span class="number">0</span>    failed=<span class="number">0</span></div><div class="line"></div><div class="line">$ ll  /tmp/mytest.sh</div><div class="line">-rwxr-xr-x <span class="number">1</span> ubuntu ubuntu <span class="number">58</span> Apr <span class="number">14</span> <span class="number">12</span>:<span class="number">21</span> /tmp/mytest.sh</div></pre></td></tr></table></figure>
<h3 id="templates目录"><a href="#templates目录" class="headerlink" title="templates目录"></a>templates目录</h3><p>单个变量值</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">$ cat templates/test.j2</div><div class="line">&#123;&#123; item &#125;&#125;</div><div class="line"></div><div class="line">$ cat vars/main.yml</div><div class="line">---</div><div class="line">var_a: a</div><div class="line">var_b: b</div><div class="line"></div><div class="line">$ cat tasks/main.yml</div><div class="line">- name: parametrized template - a</div><div class="line">  template: src=test.j2 dest=/tmp/template_A</div><div class="line">  with_items: var_a</div><div class="line"></div><div class="line">- name: parametrized template - b</div><div class="line">  template: src=test.j2 dest=/tmp/template_B</div><div class="line">  with_items: var_b</div><div class="line"></div><div class="line">$ ansible-playbook  -i hosts  startoftwares.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | parametrized template - a] **************************************</div><div class="line">changed: [172.31.30.178] =&gt; (item=a)</div><div class="line"></div><div class="line">TASK: [test | parametrized template - b] **************************************</div><div class="line">changed: [172.31.30.178] =&gt; (item=b)</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">172.31.30.178              : ok=2    changed=2    unreachable=0    failed=0</div><div class="line"></div><div class="line">$ cat /tmp/template_A</div><div class="line">a</div><div class="line">$ cat /tmp/template_B</div><div class="line">b</div></pre></td></tr></table></figure>
<p>一个变量对应多个值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat templates/test.conf.j2</div><div class="line">some_var_&#123;&#123; item.var_1 &#125;&#125; = &#123;&#123; item.var_1 &#125;&#125;</div><div class="line">some_var_&#123;&#123; item.var_2 &#125;&#125; = &#123;&#123; item.var_2 &#125;&#125;</div><div class="line"></div><div class="line">$ cat vars/main.yml</div><div class="line">---</div><div class="line">var_a:</div><div class="line">  -</div><div class="line">    var_1: a1</div><div class="line">    var_2: a2</div><div class="line">var_b:</div><div class="line">  -</div><div class="line">    var_1: b1</div><div class="line">    var_2: b2</div><div class="line"></div><div class="line">$ cat tasks/main.yml</div><div class="line">- name: parametrized template - a</div><div class="line">  template: src=test.conf.j2 dest=/tmp/template_A</div><div class="line">  with_items: var_a</div><div class="line"></div><div class="line">- name: parametrized template - b</div><div class="line">  template: src=test.conf.j2 dest=/tmp/template_B</div><div class="line">  with_items: var_b    </div><div class="line"></div><div class="line">$ ansible-playbook  -i hosts  test.yml</div><div class="line"></div><div class="line">PLAY [default_group] **********************************************************</div><div class="line"></div><div class="line">TASK: [test | parametrized template - a] **************************************</div><div class="line">changed: [172.31.30.178] =&gt; (item=&#123;&apos;var_2&apos;: &apos;a2&apos;, &apos;var_1&apos;: &apos;a1&apos;&#125;)</div><div class="line"></div><div class="line">TASK: [test | parametrized template - b] **************************************</div><div class="line">changed: [172.31.30.178] =&gt; (item=&#123;&apos;var_2&apos;: &apos;b2&apos;, &apos;var_1&apos;: &apos;b1&apos;&#125;)</div><div class="line"></div><div class="line">PLAY RECAP ********************************************************************</div><div class="line">172.31.30.178              : ok=2    changed=2    unreachable=0    failed=0</div><div class="line"></div><div class="line">$ cat /tmp/template_A</div><div class="line">some_var_a1 = a1</div><div class="line">some_var_a2 = a2</div><div class="line">$ cat /tmp/template_B</div><div class="line">some_var_b1 = b1</div><div class="line">some_var_b2 = b2</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://docs.ansible.com/ansible/template_module.html" target="_blank" rel="external">ansible template_module</a><br><a href="http://stackoverflow.com/questions/31142369/how-to-use-template-module-with-different-set-of-variables" target="_blank" rel="external">how-to-use-template-module-with-different-set-of-variables</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Ansible-roles&quot;&gt;&lt;a href=&quot;#Ansible-roles&quot; class=&quot;headerlink&quot; title=&quot;Ansible roles&quot;&gt;&lt;/a&gt;Ansible roles&lt;/h3&gt;&lt;p&gt;Ansible roles用于层次性、结构化地组织playbook，简单介绍一下ansible playbook中关于变量的两个roles目录。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;vars目录：用于定义此角色用到的变量&lt;/li&gt;
&lt;li&gt;templates目录：template模块会自动在此目录中寻找Jinja2模板文件&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix Low-level discovery</title>
    <link href="http://yoursite.com/2017/01/21/low-level-discovery/"/>
    <id>http://yoursite.com/2017/01/21/low-level-discovery/</id>
    <published>2017-01-21T14:13:32.000Z</published>
    <updated>2017-03-05T09:38:45.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Low-level discovery provides a way to automatically create items, triggers, and graphs for different entities on a computer. For instance, Zabbix can automatically start monitoring file systems or network interfaces on your machine, without the need to create items for each file system or network interface manually. </p>
<p>In Zabbix, four types of item discovery are supported out of the box:</p>
<ul>
<li>discovery of file systems;</li>
<li>discovery of network interfaces;</li>
<li>discovery of CPUs and CPU cores;</li>
<li>discovery of SNMP OIDs.</li>
</ul>
<p>A user can define their own types of discovery, provided they follow a particular JSON protocol.</p>
</blockquote>
<a id="more"></a>
<p>简而言之，zabbix的低水平发现就是减少我们的重复操作，能够根据不同的监控实例自动添加监控项、触发器和图形。<br><code>vfs.fs.discovery</code>和<code>net.if.discovery</code>就是zabbix自带的自动发现键值，能够自动识别agent端的文件挂载情况和网卡信息。还有基于SNMP OID的自动发现键值，能够自动识别交换机的所有端口信息。<br>当我们的一个服务有多个端口需要监控时，我通常是先在agent端写好监控脚本，定义键值，然后再为每个端口新建监控项、触发器和图形（当然你可以直接克隆），但还是免不了一些重复操作。下面就通过一个例子看一下Low-level discovery是如何工作的：</p>
<h3 id="监控需求："><a href="#监控需求：" class="headerlink" title="监控需求："></a>监控需求：</h3><p>监控udp端口12222-12229的端口状态</p>
<h3 id="实现步骤："><a href="#实现步骤：" class="headerlink" title="实现步骤："></a>实现步骤：</h3><h4 id="1-以json格式自定义发现类型"><a href="#1-以json格式自定义发现类型" class="headerlink" title="1.以json格式自定义发现类型"></a>1.以json格式自定义发现类型</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udpport_discovery.py</div><div class="line">#!/usr/bin/env python</div><div class="line">import sys,datetime,socket</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    zbxkey = sys.argv[1]</div><div class="line">    zbx_d = &#123;&#125;</div><div class="line">    zbx_d[&quot;data&quot;] = []</div><div class="line">    host_name = socket.gethostname().lower()</div><div class="line"></div><div class="line">    res = [&apos;12222&apos;, &apos;12223&apos;, &apos;12224&apos;, &apos;12225&apos;, &apos;12226&apos;, &apos;12227&apos;, &apos;12228&apos;, &apos;12229&apos;]</div><div class="line">    for line in res:</div><div class="line">        d = &#123;&#125;</div><div class="line">        d[&quot;&#123;#%s&#125;&quot; % zbxkey] = line</div><div class="line">        zbx_d[&quot;data&quot;].append(d)</div><div class="line">    print str(zbx_d).replace(&quot;&apos;&quot;,&apos;&quot;&apos;)</div></pre></td></tr></table></figure>
<h4 id="2-定义配置文件"><a href="#2-定义配置文件" class="headerlink" title="2.定义配置文件"></a>2.定义配置文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udp_port.conf</div><div class="line">#############Template_Udp#############</div><div class="line">UserParameter=status[*],/home/prod/softwares/zabbix/etc/zabbix_agentd.conf.d/udp_port.sh $1</div><div class="line">UserParameter=discovery.udpport,/home/prod/softwares/zabbix/etc/zabbix_agentd.conf.d/udpport_discovery.py PORT</div></pre></td></tr></table></figure>
<h4 id="3-检测自定义键值"><a href="#3-检测自定义键值" class="headerlink" title="3.检测自定义键值"></a>3.检测自定义键值</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ python udpport_discovery.py PORT</div><div class="line">&#123;&quot;data&quot;: [&#123;&quot;&#123;#PORT&#125;&quot;: &quot;12222&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12223&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12224&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12225&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12226&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12227&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12228&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12229&quot;&#125;]&#125;</div></pre></td></tr></table></figure>
<p>zabbix server端测试：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ./zabbix_get -s 10.0.0.206 -k discovery.udpport</div><div class="line">&#123;&quot;data&quot;: [&#123;&quot;&#123;#PORT&#125;&quot;: &quot;12222&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12223&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12224&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12225&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12226&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12227&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12228&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12229&quot;&#125;]&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-编写监控脚本"><a href="#4-编写监控脚本" class="headerlink" title="4.编写监控脚本"></a>4.编写监控脚本</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udp_port.sh</div><div class="line">Port=$1</div><div class="line">case $Port in</div><div class="line">        12222)   netstat -nupl | grep 12222 |wc -l;;</div><div class="line">        12223)   netstat -nupl | grep 12223 |wc -l;;</div><div class="line">        12224)   netstat -nupl | grep 12224 |wc -l;;</div><div class="line">        12225)   netstat -nupl | grep 12225 |wc -l;;</div><div class="line">        12226)   netstat -nupl | grep 12226 |wc -l;;</div><div class="line">        12227)   netstat -nupl | grep 12227 |wc -l;;</div><div class="line">        12228)   netstat -nupl | grep 12228 |wc -l;;</div><div class="line">        12229)   netstat -nupl | grep 12229 |wc -l;;</div><div class="line">        *) echo Error; exit 1;;</div><div class="line">esac</div></pre></td></tr></table></figure>
<h4 id="5-web添加模板"><a href="#5-web添加模板" class="headerlink" title="5.web添加模板"></a>5.web添加模板</h4><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/01256527-8987-40C4-9C65-2FC6D1D8610F.png" alt=""></p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/E604037B-096A-4789-9AB3-A47B14020FB2.png" alt=""></p>
<h4 id="6-将模板关联对应机器"><a href="#6-将模板关联对应机器" class="headerlink" title="6.将模板关联对应机器"></a>6.将模板关联对应机器</h4><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.zabbix.com/documentation/2.4/manual/discovery/low_level_discovery" target="_blank" rel="external">LDD官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Low-level discovery provides a way to automatically create items, triggers, and graphs for different entities on a computer. For instance, Zabbix can automatically start monitoring file systems or network interfaces on your machine, without the need to create items for each file system or network interface manually. &lt;/p&gt;
&lt;p&gt;In Zabbix, four types of item discovery are supported out of the box:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;discovery of file systems;&lt;/li&gt;
&lt;li&gt;discovery of network interfaces;&lt;/li&gt;
&lt;li&gt;discovery of CPUs and CPU cores;&lt;/li&gt;
&lt;li&gt;discovery of SNMP OIDs.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A user can define their own types of discovery, provided they follow a particular JSON protocol.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="zabbix" scheme="http://yoursite.com/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>Python xlrd和xlwt表格处理</title>
    <link href="http://yoursite.com/2016/11/27/python-excel/"/>
    <id>http://yoursite.com/2016/11/27/python-excel/</id>
    <published>2016-11-27T11:51:03.000Z</published>
    <updated>2017-02-15T12:53:55.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="表格处理模块"><a href="#表格处理模块" class="headerlink" title="表格处理模块"></a>表格处理模块</h2><ul>
<li>xlwt (writing xls files)</li>
<li>xlrd (reading xls/xlsx files)</li>
<li>openpyxl (reading/writing xlsx files)</li>
<li>xlsxwriter (writing xlsx files)</li>
</ul>
<h2 id="xlrd"><a href="#xlrd" class="headerlink" title="xlrd"></a>xlrd</h2><h3 id="excel表格示例"><a href="#excel表格示例" class="headerlink" title="excel表格示例"></a>excel表格示例</h3><p>示例表格2016-11-27.xlsx 内容如下：</p>
<a id="more"></a>
<p>Info工作表：<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/01522E0B-78EE-40A5-9217-DD68656485A0.png" alt=""></p>
<p>Grade工作表：<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/81E0B26F-2120-41BC-A268-B44903D76A55.png" alt=""></p>
<h3 id="显示工作表"><a href="#显示工作表" class="headerlink" title="显示工作表"></a>显示工作表</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlrd</div><div class="line"></div><div class="line">dir_path = os.path.dirname(os.path.dirname(__file__))</div><div class="line">file_path = os.path.join(dir_path,<span class="string">'2016-11-27.xlsx'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 打开excel</span></div><div class="line">data = xlrd.open_workbook(file_path)</div><div class="line"></div><div class="line"><span class="comment"># 显示工作表</span></div><div class="line">sheets = data.sheet_names()</div><div class="line"><span class="keyword">print</span> sheets </div><div class="line"></div><div class="line">//stdout</div><div class="line">[<span class="string">u'Info'</span>, <span class="string">u'Grade'</span>]</div></pre></td></tr></table></figure>
<h3 id="获取工作表的内容"><a href="#获取工作表的内容" class="headerlink" title="获取工作表的内容"></a>获取工作表的内容</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlrd</div><div class="line"></div><div class="line">dir_path = os.path.dirname(os.path.dirname(__file__))</div><div class="line">file_path = os.path.join(dir_path,<span class="string">'2016-11-27.xlsx'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 打开excel</span></div><div class="line">data = xlrd.open_workbook(file_path)</div><div class="line"></div><div class="line"><span class="comment">#获取工作表</span></div><div class="line">table = data.sheets()[<span class="number">0</span>] //list索引获取到Info工作表</div><div class="line"><span class="keyword">or</span></div><div class="line"><span class="comment">#table = data.sheet_by_index(1) //索引方法获取Grade工作表</span></div><div class="line"><span class="comment">#table = data.sheet_by_name('Info') //根据工作表名</span></div><div class="line"></div><div class="line"><span class="comment"># 获取行数和列数</span></div><div class="line">nrows = table.nrows <span class="comment">#行数</span></div><div class="line"><span class="keyword">print</span> nrows</div><div class="line">cols = table.ncols <span class="comment">#列数</span></div><div class="line"><span class="keyword">print</span> cols</div><div class="line"></div><div class="line"><span class="comment"># 获取整行或整列的值</span></div><div class="line">row_content = table.row_values(<span class="number">1</span>) <span class="comment">#获取第二行的值</span></div><div class="line"><span class="keyword">print</span> row_content</div><div class="line">col_content = table.col_values(<span class="number">1</span>) <span class="comment">#获取第二列的值</span></div><div class="line"><span class="keyword">print</span> col_content</div><div class="line"></div><div class="line">//stdout</div><div class="line"><span class="number">4</span></div><div class="line"><span class="number">4</span></div><div class="line">[<span class="string">u'mike'</span>, <span class="number">23.0</span>, <span class="string">u'male'</span>, <span class="string">u'shanghai'</span>]</div><div class="line">[<span class="string">u'Age'</span>, <span class="number">23.0</span>, <span class="number">20.0</span>, <span class="number">30.0</span>]</div></pre></td></tr></table></figure>
<h3 id="遍历表格数据"><a href="#遍历表格数据" class="headerlink" title="遍历表格数据"></a>遍历表格数据</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlrd</div><div class="line"></div><div class="line">dir_path = os.path.dirname(os.path.dirname(__file__))</div><div class="line">file_path = os.path.join(dir_path,<span class="string">'2016-11-27.xlsx'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 打开excel</span></div><div class="line">data = xlrd.open_workbook(file_path)</div><div class="line"></div><div class="line"><span class="comment">#获取工作表</span></div><div class="line">table = data.sheets()[<span class="number">0</span>] //list索引获取到Info工作表</div><div class="line"></div><div class="line"><span class="comment"># 获取行数和列数</span></div><div class="line">nrows = table.nrows <span class="comment">#行数</span></div><div class="line">cols = table.ncols <span class="comment">#列数</span></div><div class="line"></div><div class="line"><span class="comment"># 遍历行数据</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(nrows):</div><div class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</div><div class="line">        <span class="keyword">continue</span></div><div class="line">    row = table.row_values(i)</div><div class="line">    <span class="keyword">print</span> row</div><div class="line"></div><div class="line"><span class="comment">#遍历列数据</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(cols):</div><div class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</div><div class="line">        <span class="keyword">continue</span></div><div class="line">    col = table.col_values(i)</div><div class="line">    <span class="keyword">print</span> col</div><div class="line"></div><div class="line">//stdout</div><div class="line">[<span class="string">u'mike'</span>, <span class="number">23.0</span>, <span class="string">u'male'</span>, <span class="string">u'shanghai'</span>]</div><div class="line">[<span class="string">u'marry'</span>, <span class="number">20.0</span>, <span class="string">u'female'</span>, <span class="string">u'beijing'</span>]</div><div class="line">[<span class="string">u'abner'</span>, <span class="number">30.0</span>, <span class="string">u'male'</span>, <span class="string">u'changsha'</span>]</div><div class="line"></div><div class="line">[<span class="string">u'Age'</span>, <span class="number">23.0</span>, <span class="number">20.0</span>, <span class="number">30.0</span>]</div><div class="line">[<span class="string">u'Sex'</span>, <span class="string">u'male'</span>, <span class="string">u'female'</span>, <span class="string">u'male'</span>]</div><div class="line">[<span class="string">u'City'</span>, <span class="string">u'shanghai'</span>, <span class="string">u'beijing'</span>, <span class="string">u'changsha'</span>]</div></pre></td></tr></table></figure>
<h3 id="获取单元格数据"><a href="#获取单元格数据" class="headerlink" title="获取单元格数据"></a>获取单元格数据</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlrd</div><div class="line"></div><div class="line">dir_path = os.path.dirname(os.path.dirname(__file__))</div><div class="line">file_path = os.path.join(dir_path,<span class="string">'2016-11-27.xlsx'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 打开excel</span></div><div class="line">data = xlrd.open_workbook(file_path)</div><div class="line"></div><div class="line"><span class="comment">#获取工作表</span></div><div class="line">table = data.sheets()[<span class="number">0</span>] //list索引获取到Info工作表</div><div class="line"></div><div class="line"><span class="comment"># 通过单元格获取数据</span></div><div class="line">cell_A = table.row(<span class="number">0</span>)[<span class="number">0</span>].value //第一行的第一列的数据</div><div class="line">cell_B = table.col(<span class="number">1</span>)[<span class="number">1</span>].value //第二行第二列的数据</div><div class="line"><span class="keyword">print</span> cell_A</div><div class="line"><span class="keyword">print</span> cell_B</div><div class="line"></div><div class="line">//stdout</div><div class="line">Name</div><div class="line"><span class="number">23.0</span></div></pre></td></tr></table></figure>
<h2 id="xlwt"><a href="#xlwt" class="headerlink" title="xlwt"></a>xlwt</h2><h3 id="简单写入"><a href="#简单写入" class="headerlink" title="简单写入"></a>简单写入</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlwt</div><div class="line"></div><div class="line">dir_path = os.path.dirname(os.path.dirname(__file__))</div><div class="line">file_path = os.path.join(dir_path,<span class="string">'2016-11-27.xlsx'</span>)</div><div class="line"></div><div class="line">workbook = xlwt.Workbook(encoding = <span class="string">'utf-8'</span>)</div><div class="line">worksheet = workbook.add_sheet(<span class="string">'My sheet'</span>) //新建一个工作表,默认单元格不能被覆盖</div><div class="line"><span class="comment">#worksheet = workbook.add_sheet('My sheet',cell_overwrite_ok=True) //新建一个工作表,单元格可以被覆盖</span></div><div class="line"></div><div class="line"><span class="comment"># 简单写入</span></div><div class="line">worksheet.write(<span class="number">0</span>, <span class="number">0</span>, <span class="string">'foo'</span>) <span class="comment"># row, column, value</span></div><div class="line">workbook.save(file_path)</div></pre></td></tr></table></figure>
<h3 id="设置样式"><a href="#设置样式" class="headerlink" title="设置样式"></a>设置样式</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> xlwt</div><div class="line"></div><div class="line">dir_path = os.path.dirname(os.path.dirname(__file__))</div><div class="line">file_path = os.path.join(dir_path,<span class="string">'2016-11-27.xlsx'</span>)</div><div class="line"></div><div class="line">workbook = xlwt.Workbook(encoding = <span class="string">'utf-8'</span>)</div><div class="line">worksheet = workbook.add_sheet(<span class="string">'My sheet'</span>) //新建一个工作表,默认单元格不能被覆盖</div><div class="line"></div><div class="line"><span class="comment"># 设置样式</span></div><div class="line">style1 = xlwt.easyxf(<span class="string">'font: bold 1'</span>) //字体加粗</div><div class="line">style2 = xlwt.easyxf(<span class="string">'font:bold 1,color red;'</span>) //字体加粗,字体颜色为红色</div><div class="line"></div><div class="line"><span class="comment"># 写入并应用样式</span></div><div class="line">worksheet.write(<span class="number">0</span>,<span class="number">1</span>,<span class="string">'bar'</span>,style1)</div><div class="line">worksheet.write(<span class="number">0</span>,<span class="number">2</span>,<span class="string">'foobar'</span>,style2)</div><div class="line">worksheet.write(<span class="number">0</span>,<span class="number">3</span>,<span class="string">'中文'</span>,style2)</div><div class="line"></div><div class="line"><span class="comment"># 设置列的宽度</span></div><div class="line">worksheet.col(<span class="number">0</span>).width = <span class="number">256</span> * <span class="number">7</span>  //<span class="number">256</span> = <span class="number">1</span> width of <span class="number">0</span> character(<span class="number">256</span>可以理解为一个字符的宽度)</div><div class="line"></div><div class="line"><span class="comment"># 设置超链接</span></div><div class="line">worksheet.write(<span class="number">1</span>, <span class="number">0</span>, xlwt.Formula(<span class="string">'HYPERLINK("http://yujitomita.com"; "click me")'</span>)) //设置超链接</div><div class="line"></div><div class="line">workbook.save(file_path)</div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.python-excel.org/" target="_blank" rel="external">python-excel</a><br><a href="http://www.programering.com/a/MzN2QjMwATA.html" target="_blank" rel="external">python xlrd example</a><br><a href="http://www.lexicon.net/sjmachin/xlrd.html" target="_blank" rel="external">xlrd Module docs</a><br><a href="https://yuji.wordpress.com/2012/04/19/python-xlwt-writing-excel-files/" target="_blank" rel="external">python-xlwt-writing-excel-files</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;表格处理模块&quot;&gt;&lt;a href=&quot;#表格处理模块&quot; class=&quot;headerlink&quot; title=&quot;表格处理模块&quot;&gt;&lt;/a&gt;表格处理模块&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;xlwt (writing xls files)&lt;/li&gt;
&lt;li&gt;xlrd (reading xls/xlsx files)&lt;/li&gt;
&lt;li&gt;openpyxl (reading/writing xlsx files)&lt;/li&gt;
&lt;li&gt;xlsxwriter (writing xlsx files)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;xlrd&quot;&gt;&lt;a href=&quot;#xlrd&quot; class=&quot;headerlink&quot; title=&quot;xlrd&quot;&gt;&lt;/a&gt;xlrd&lt;/h2&gt;&lt;h3 id=&quot;excel表格示例&quot;&gt;&lt;a href=&quot;#excel表格示例&quot; class=&quot;headerlink&quot; title=&quot;excel表格示例&quot;&gt;&lt;/a&gt;excel表格示例&lt;/h3&gt;&lt;p&gt;示例表格2016-11-27.xlsx 内容如下：&lt;/p&gt;
    
    </summary>
    
      <category term="Dev" scheme="http://yoursite.com/categories/Dev/"/>
    
    
      <category term="xlrd" scheme="http://yoursite.com/tags/xlrd/"/>
    
      <category term="xlwt" scheme="http://yoursite.com/tags/xlwt/"/>
    
  </entry>
  
  <entry>
    <title>Python datetime那点事</title>
    <link href="http://yoursite.com/2016/11/16/python-datetime/"/>
    <id>http://yoursite.com/2016/11/16/python-datetime/</id>
    <published>2016-11-16T13:08:40.000Z</published>
    <updated>2017-02-15T12:54:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>关于datetime时间操作在日常工作中也没有经常用到，但是每次要用时却又想不起来，与其重复查文档不如总结一下备忘。本文只简单记录了常用的一些方法，不同类型格式之间的转换(如时间对象类型、字符串、timestamp、time tuple类型）以及时区问题等暂未深入了解。</p>
<h2 id="datetime模块"><a href="#datetime模块" class="headerlink" title="datetime模块"></a>datetime模块</h2><p>datetime 模块主要用来操作日期和时间</p>
<h3 id="date日期对象"><a href="#date日期对象" class="headerlink" title="date日期对象"></a>date日期对象</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="keyword">print</span> datetime.date.today()  //返回当前本地日期</div><div class="line"><span class="keyword">print</span> datetime.date(<span class="number">2016</span>,<span class="number">11</span>,<span class="number">16</span>) //生成日期对象</div><div class="line"></div><div class="line">//stdout</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="time时间对象"><a href="#time时间对象" class="headerlink" title="time时间对象"></a>time时间对象</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line">Time = datetime.time(<span class="number">12</span>,<span class="number">24</span>,<span class="number">50</span>) //生成时间对象</div><div class="line"><span class="keyword">print</span> Time</div><div class="line"><span class="keyword">print</span> Time.hour</div><div class="line"><span class="keyword">print</span> Time.minute</div><div class="line"><span class="keyword">print</span> Time.second</div><div class="line"></div><div class="line">//stdout</div><div class="line"><span class="number">12</span>:<span class="number">24</span>:<span class="number">50</span></div><div class="line"><span class="number">12</span></div><div class="line"><span class="number">24</span></div><div class="line"><span class="number">50</span></div></pre></td></tr></table></figure>
<h3 id="datetime日期时间对象"><a href="#datetime日期时间对象" class="headerlink" title="datetime日期时间对象"></a>datetime日期时间对象</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="keyword">print</span> datetime.datetime(<span class="number">2016</span>,<span class="number">11</span>,<span class="number">16</span>,<span class="number">12</span>,<span class="number">24</span>,<span class="number">50</span>) //生成datetime对象</div><div class="line"><span class="keyword">print</span> datetime.datetime.now() //返回当前日期时间</div><div class="line"><span class="keyword">print</span> datetime.datetime.now().strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>) //对当前时间格式化并返回字符串(将datetime对象转换为str)</div><div class="line"><span class="keyword">print</span> datetime.datetime.now().ctime() //返回当前时间字符串</div><div class="line"><span class="keyword">print</span> datetime.datetime.strptime(<span class="string">'2016-11-16 16:13:43'</span>,<span class="string">'%Y-%m-%d %H:%M:%S'</span>)//将字符串转换为datetime对象</div><div class="line"></div><div class="line">//stdout</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">12</span>:<span class="number">24</span>:<span class="number">50</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">58</span>:<span class="number">47.913755</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">58</span>:<span class="number">47</span></div><div class="line">Wed Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">58</span>:<span class="number">47</span> <span class="number">2016</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">43</span></div></pre></td></tr></table></figure>
<h3 id="timedelta对象"><a href="#timedelta对象" class="headerlink" title="timedelta对象"></a>timedelta对象</h3><p>timedelta对象表示一个时间段，即两个日期 (date) 或时间 (time) 之间的差。利用timedelta可实现时间的相加减，当然时间对象本身就能直接进行算术运算和比较运算。</p>
<blockquote>
<p>datetime.timedelta([days[, seconds[, microseconds[, milliseconds[, minutes[, hours[, weeks]]]]]]])</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="keyword">print</span> datetime.date.today() + datetime.timedelta(days=<span class="number">3</span>) //<span class="number">3</span>天后</div><div class="line"><span class="keyword">print</span> datetime.date.today() - datetime.timedelta(days=<span class="number">3</span>) //<span class="number">3</span>天前</div><div class="line"><span class="keyword">print</span> datetime.date.today() + datetime.timedelta(days=<span class="number">-3</span>) //<span class="number">3</span>天前(参数可为负)</div><div class="line"><span class="keyword">print</span> datetime.datetime.now() + datetime.timedelta(weeks=<span class="number">1</span>) //<span class="number">1</span>个星期后</div><div class="line"><span class="keyword">print</span> datetime.datetime.now() + datetime.timedelta(days=<span class="number">1</span>) //明天</div><div class="line"><span class="keyword">print</span> datetime.datetime.now() + datetime.timedelta(hours=<span class="number">3</span>) //<span class="number">3</span>小时后</div><div class="line"><span class="keyword">print</span> datetime.datetime.now() + datetime.timedelta(minutes=<span class="number">5</span>) //<span class="number">5</span>分钟后</div><div class="line"><span class="keyword">print</span> datetime.datetime.now() + datetime.timedelta(seconds=<span class="number">60</span>) //<span class="number">60</span>秒</div><div class="line"></div><div class="line">//stdout</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-19</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-13</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-13</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-23</span> <span class="number">17</span>:<span class="number">14</span>:<span class="number">26.311780</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-17</span> <span class="number">17</span>:<span class="number">14</span>:<span class="number">26.311797</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">20</span>:<span class="number">14</span>:<span class="number">26.311806</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">17</span>:<span class="number">19</span>:<span class="number">26.311815</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">17</span>:<span class="number">15</span>:<span class="number">26.311823</span></div></pre></td></tr></table></figure>
<h2 id="time模块"><a href="#time模块" class="headerlink" title="time模块"></a>time模块</h2><p>time模块提供时间相关的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="keyword">print</span> time.ctime() //返回当前时间字符串</div><div class="line"><span class="keyword">print</span> time.localtime() //返回当前时间timetuple</div><div class="line">time.sleep(<span class="number">10</span>) //睡眠<span class="number">10</span>秒</div><div class="line"><span class="keyword">print</span> time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>) //格式化并返回字符串</div><div class="line"></div><div class="line">//stdout</div><div class="line">Wed Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2016</span></div><div class="line">time.struct_time(tm_year=<span class="number">2016</span>, tm_mon=<span class="number">11</span>, tm_mday=<span class="number">16</span>, tm_hour=<span class="number">17</span>, tm_min=<span class="number">25</span>, tm_sec=<span class="number">50</span>, tm_wday=<span class="number">2</span>, tm_yday=<span class="number">321</span>, tm_isdst=<span class="number">0</span>)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span> <span class="number">17</span>:<span class="number">26</span>:<span class="number">00</span></div></pre></td></tr></table></figure>
<h2 id="strftime-格式化字符串含义"><a href="#strftime-格式化字符串含义" class="headerlink" title="strftime()格式化字符串含义"></a>strftime()格式化字符串含义</h2><table>
<thead>
<tr>
<th>Directive</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>%a</td>
<td>星期名称简写</td>
<td>Sun, Mon, …, Sat</td>
</tr>
<tr>
<td>%A</td>
<td>星期名称的全称</td>
<td>Sunday, Monday, …, Saturday</td>
</tr>
<tr>
<td>%w</td>
<td>十进制数表示的星期[0表示星期日]</td>
<td>0, 1, …, 6</td>
</tr>
<tr>
<td>%d</td>
<td>十进制数表示的一个月的第几天</td>
<td>01, 02, …, 31</td>
</tr>
<tr>
<td>%b</td>
<td>月份名称的简写</td>
<td>Jan, Feb, …, Dec</td>
</tr>
<tr>
<td>%B</td>
<td>月份名称的全称</td>
<td>January, February, …, December</td>
</tr>
<tr>
<td>%m</td>
<td>十进制数表示的月份</td>
<td>01, 02, …, 12</td>
</tr>
<tr>
<td>%y</td>
<td>十进制数表示的年份，不带有世纪</td>
<td>00, 01, …, 99</td>
</tr>
<tr>
<td>%Y</td>
<td>十进制数表示的年份，带有世纪</td>
<td>1970, 1988, 2001, 2013</td>
</tr>
<tr>
<td>%H</td>
<td>十进制数表示的小时（24小时制）</td>
<td>00, 01, …, 23</td>
</tr>
<tr>
<td>%I</td>
<td>十进制数表示的小时（12小时制）</td>
<td>01, 02, …, 12</td>
</tr>
<tr>
<td>%p</td>
<td>AM or PM</td>
<td>AM, PM</td>
</tr>
<tr>
<td>%M</td>
<td>十进制数表示的分钟</td>
<td>00, 01, …, 59</td>
</tr>
<tr>
<td>%S</td>
<td>十进制表示的秒数</td>
<td>00, 01, …, 59</td>
</tr>
</tbody>
</table>
<h2 id="数据类型转换"><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换</h2><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/C24469F5-B517-4D77-963E-37A6BC4B56AC.png" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://docs.python.org/2/library/datetime.html" target="_blank" rel="external">datetime官方文档</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;关于datetime时间操作在日常工作中也没有经常用到，但是每次要用时却又想不起来，与其重复查文档不如总结一下备忘。本文只简单记录了常用的一些方法，不同类型格式之间的转换(如时间对象类型、字符串、timestamp、time tuple类型）以及时区问题等暂未深入了解。&lt;/p&gt;
&lt;h2 id=&quot;datetime模块&quot;&gt;&lt;a href=&quot;#datetime模块&quot; class=&quot;headerlink&quot; title=&quot;datetime模块&quot;&gt;&lt;/a&gt;datetime模块&lt;/h2&gt;&lt;p&gt;datetime 模块主要用来操作日期和时间&lt;/p&gt;
&lt;h3 id=&quot;date日期对象&quot;&gt;&lt;a href=&quot;#date日期对象&quot; class=&quot;headerlink&quot; title=&quot;date日期对象&quot;&gt;&lt;/a&gt;date日期对象&lt;/h3&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; datetime&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; datetime.date.today()  //返回当前本地日期&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; datetime.date(&lt;span class=&quot;number&quot;&gt;2016&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;11&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;16&lt;/span&gt;) //生成日期对象&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;//stdout&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2016&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-11&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-16&lt;/span&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2016&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-11&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-16&lt;/span&gt;&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Dev" scheme="http://yoursite.com/categories/Dev/"/>
    
    
      <category term="datetime" scheme="http://yoursite.com/tags/datetime/"/>
    
  </entry>
  
  <entry>
    <title>小试Ansible Python API</title>
    <link href="http://yoursite.com/2016/11/04/ansible-python-api/"/>
    <id>http://yoursite.com/2016/11/04/ansible-python-api/</id>
    <published>2016-11-04T10:49:12.000Z</published>
    <updated>2016-11-07T06:35:33.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// ping 模块</div><div class="line">$ ansible localhost -m ping</div><div class="line">localhost | success &gt;&gt; &#123;</div><div class="line">    &quot;changed&quot;: false,</div><div class="line">    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">&#125;</div><div class="line">// shell 模块</div><div class="line">$ ansible localhost -m shell -a &apos;uptime&apos;</div><div class="line">localhost | success | rc=0 &gt;&gt;</div><div class="line">11:00:11 up 66 days, 23:34,  1 user,  load average: 0.00, 0.01, 0.05</div></pre></td></tr></table></figure>
<h3 id="Python-API"><a href="#Python-API" class="headerlink" title="Python API"></a>Python API</h3><p>通过ansible.runner模块来实现</p>
<a id="more"></a>
<h4 id="使用API实现ping模块功能："><a href="#使用API实现ping模块功能：" class="headerlink" title="使用API实现ping模块功能："></a>使用API实现ping模块功能：</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> ansible.runner</div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">runner = ansible.runner.Runner(</div><div class="line">    module_name=<span class="string">'ping'</span>,  //模块名</div><div class="line">    module_args=<span class="string">''</span>,  //模块参数</div><div class="line">    pattern=<span class="string">'localhost'</span>,  //匹配主机或主机组</div><div class="line">    forks=<span class="number">2</span> //多线程</div><div class="line">)</div><div class="line">data = runner.run()</div><div class="line"><span class="keyword">print</span> data  //打印输出结果默认json格式</div><div class="line"></div><div class="line">//stdout</div><div class="line">&#123;<span class="string">'dark'</span>: &#123;&#125;, <span class="string">'contacted'</span>: &#123;<span class="string">'localhost'</span>: &#123;<span class="string">'invocation'</span>: &#123;<span class="string">'module_name'</span>: <span class="string">'ping'</span>, <span class="string">'module_args'</span>: <span class="string">''</span>&#125;, <span class="string">u'changed'</span>: <span class="keyword">False</span>, <span class="string">u'ping'</span>: <span class="string">u'pong'</span>&#125;&#125;&#125;</div></pre></td></tr></table></figure>
<p>由于输出结果默认是json格式，那么我们可以格式化一下，让它更美观</p>
<blockquote>
<p>sort_keys  <code>按key排序</code><br>indent <code>缩进</code><br>separators <code>指定分隔符(默认分隔符&#39;, &#39;,使用&#39;,&#39;,&#39;: &#39; 避免尾部空格)</code></p>
</blockquote>
<p>上例中的输出格式化：<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">print</span> json.dumps(data, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>)) //对json格式化输出</div><div class="line">//stdout</div><div class="line">&#123;</div><div class="line">    <span class="string">"contacted"</span>: &#123;</div><div class="line">        <span class="string">"localhost"</span>: &#123;</div><div class="line">            <span class="string">"changed"</span>: false,</div><div class="line">            <span class="string">"invocation"</span>: &#123;</div><div class="line">                <span class="string">"module_args"</span>: <span class="string">""</span>,</div><div class="line">                <span class="string">"module_name"</span>: <span class="string">"ping"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"ping"</span>: <span class="string">"pong"</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"dark"</span>: &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="使用API实现shell模块功能"><a href="#使用API实现shell模块功能" class="headerlink" title="使用API实现shell模块功能"></a>使用API实现shell模块功能</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> ansible.runner</div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">runner = ansible.runner.Runner(</div><div class="line">   module_name=<span class="string">'shell'</span>,</div><div class="line">   module_args=<span class="string">'uptime'</span>,</div><div class="line">   pattern=<span class="string">'localhost'</span>,</div><div class="line">   forks=<span class="number">2</span></div><div class="line">)</div><div class="line">data = runner.run()</div><div class="line"><span class="keyword">print</span> json.dumps(data, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>))</div><div class="line"></div><div class="line">//stdout</div><div class="line">&#123;</div><div class="line">    <span class="string">"contacted"</span>: &#123;</div><div class="line">        <span class="string">"localhost"</span>: &#123;</div><div class="line">            <span class="string">"changed"</span>: true,</div><div class="line">            <span class="string">"cmd"</span>: <span class="string">"uptime"</span>,</div><div class="line">            <span class="string">"delta"</span>: <span class="string">"0:00:00.002573"</span>,</div><div class="line">            <span class="string">"end"</span>: <span class="string">"2016-11-04 14:57:26.549208"</span>,</div><div class="line">            <span class="string">"invocation"</span>: &#123;</div><div class="line">                <span class="string">"module_args"</span>: <span class="string">"uptime"</span>,</div><div class="line">                <span class="string">"module_name"</span>: <span class="string">"shell"</span></div><div class="line">            &#125;,</div><div class="line">            <span class="string">"rc"</span>: <span class="number">0</span>,</div><div class="line">            <span class="string">"start"</span>: <span class="string">"2016-11-04 14:57:26.546635"</span>,</div><div class="line">            <span class="string">"stderr"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"stdout"</span>: <span class="string">" 14:57:26 up 67 days,  3:31,  1 user,  load average: 0.00, 0.06, 0.07"</span></div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"dark"</span>: &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="打印stdout"><a href="#打印stdout" class="headerlink" title="打印stdout"></a>打印stdout</h4><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> ansible.runner</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(contacted)</span>:</span></div><div class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> contacted.items():</div><div class="line">        <span class="keyword">if</span> k == <span class="string">'stdout'</span>:</div><div class="line">            <span class="keyword">print</span> v</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping_module</span><span class="params">()</span>:</span></div><div class="line">    runner = ansible.runner.Runner(</div><div class="line">        module_name=<span class="string">'ping'</span>,</div><div class="line">        module_args=<span class="string">''</span>,</div><div class="line">        pattern=<span class="string">'localhost'</span>,</div><div class="line">        forks=<span class="number">2</span></div><div class="line">        )</div><div class="line">    data = runner.run()</div><div class="line">    <span class="keyword">print</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">shell_module</span><span class="params">()</span>:</span></div><div class="line">    runner = ansible.runner.Runner(</div><div class="line">        module_name=<span class="string">'shell'</span>,</div><div class="line">        module_args=<span class="string">'uptime'</span>,</div><div class="line">        pattern=<span class="string">'localhost'</span>,</div><div class="line">        forks=<span class="number">2</span></div><div class="line">        )</div><div class="line">    data = runner.run()</div><div class="line">    result(data[<span class="string">'contacted'</span>][<span class="string">'localhost'</span>])</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:  </div><div class="line">    shell_module()</div><div class="line">    </div><div class="line">//stdout</div><div class="line"><span class="number">15</span>:<span class="number">34</span>:<span class="number">09</span> up <span class="number">67</span> days,  <span class="number">4</span>:<span class="number">07</span>,  <span class="number">1</span> user,  load average: <span class="number">0.00</span>, <span class="number">0.01</span>, <span class="number">0.05</span></div></pre></td></tr></table></figure>
<h2 id="playbook"><a href="#playbook" class="headerlink" title="playbook"></a>playbook</h2><p>playbook描述了在远程主机上执行的策略或一组任务</p>
<p>一个playbook文件由一个或多个play组成，每个play定义了一系列的task，每个task通过ansible的模块来实现特定的功能</p>
<p>exp.yml (<code>playbook使用YAML语言编写，文件名以.yaml或.yml结尾</code>)</p>
<pre><code>- hosts: localhost_group   //主机组
   tasks:
    - name: kernel release info  //task1
      command: uname -a

    - name: memory info  //task2
      shell: free -m
</code></pre><p>这个playbook可以查看远程主机的内核版本信息和内存信息</p>
<h3 id="ansible-playbook命令"><a href="#ansible-playbook命令" class="headerlink" title="ansible-playbook命令"></a>ansible-playbook命令</h3><p>命令行执行playbook</p>
<pre><code>$ ansible-playbook  -i /etc/ansible/hosts  test.yml

PLAY [localhost_group] ********************************************************

GATHERING FACTS ***************************************************************
ok: [localhost]

TASK: [kernel info] ***********************************************************
changed: [localhost]

TASK: [memory info] ***********************************************************
changed: [localhost]

PLAY RECAP ********************************************************************
localhost                  : ok=3    changed=2    unreachable=0    failed=0
</code></pre><h3 id="Python-API-1"><a href="#Python-API-1" class="headerlink" title="Python API"></a>Python API</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># encoding=utf8</span></div><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="keyword">import</span> ansible.runner</div><div class="line"><span class="keyword">import</span> ansible.playbook</div><div class="line"><span class="keyword">import</span> ansible.inventory</div><div class="line"><span class="keyword">from</span> ansible <span class="keyword">import</span> callbacks</div><div class="line"><span class="keyword">from</span> ansible <span class="keyword">import</span> utils</div><div class="line"><span class="keyword">import</span> json</div><div class="line"></div><div class="line">playbook_path = <span class="string">"/home/ubuntu/scripts/exp.yml"</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">##添加主机信息</span></div><div class="line">host = ansible.inventory.host.Host(</div><div class="line">    name = <span class="string">'localhost'</span></div><div class="line">    )</div><div class="line"></div><div class="line"><span class="comment">##设置主机组并添加主机</span></div><div class="line">group = ansible.inventory.group.Group(</div><div class="line">    name = <span class="string">'localhost_group'</span></div><div class="line">    )</div><div class="line">group.add_host(host)</div><div class="line"></div><div class="line"><span class="comment">##主机列表</span></div><div class="line">example_inventory = ansible.inventory.Inventory()</div><div class="line">example_inventory.add_group(group)</div><div class="line"></div><div class="line"><span class="comment">#回调信息</span></div><div class="line">stats = callbacks.AggregateStats()</div><div class="line">playbook_cb = callbacks.PlaybookCallbacks(verbose=utils.VERBOSITY)</div><div class="line">runner_cb = callbacks.PlaybookRunnerCallbacks(stats, verbose=utils.VERBOSITY)</div><div class="line"></div><div class="line"><span class="comment">#创建实例，playbook位于playbook_path</span></div><div class="line">pb = ansible.playbook.PlayBook(</div><div class="line">    playbook = playbook_path,</div><div class="line">    stats = stats,</div><div class="line">    callbacks = playbook_cb,</div><div class="line">    runner_callbacks = runner_cb,</div><div class="line">    inventory = example_inventory,</div><div class="line">    subset = <span class="string">'all'</span>,</div><div class="line">    )</div><div class="line"></div><div class="line"><span class="comment">#运行playbook</span></div><div class="line">pr = pb.run()</div><div class="line"></div><div class="line"><span class="comment">#打印结果</span></div><div class="line"><span class="keyword">print</span> json.dumps(pr, sort_keys=<span class="keyword">True</span>, indent=<span class="number">4</span>, separators=(<span class="string">','</span>, <span class="string">': '</span>))</div></pre></td></tr></table></figure>
<p>//stdout</p>
<pre><code>PLAY [localhost_group] ********************************************************

GATHERING FACTS ***************************************************************
ok: [localhost]

TASK: [kernel info] ***********************************************************
changed: [localhost]

TASK: [memory info] ***********************************************************
changed: [localhost]
{
    &quot;localhost&quot;: {
    &quot;changed&quot;: 2,
    &quot;failures&quot;: 0,
    &quot;ok&quot;: 3,
    &quot;skipped&quot;: 0,
    &quot;unreachable&quot;: 0
    }
}
</code></pre><h4 id="ansible-runner更多信息"><a href="#ansible-runner更多信息" class="headerlink" title="ansible.runner更多信息"></a>ansible.runner更多信息</h4><pre><code>&gt;&gt;&gt; import ansible.runner
&gt;&gt;&gt; dir(ansible.runner)
[&apos;C&apos;, &apos;DefaultRunnerCallbacks&apos;, &apos;HAS_ATFORK&apos;, &apos;HostVars&apos;, &apos;ModuleReplacer&apos;, &apos;OUTPUT_LOCKFILE&apos;, &apos;PROCESS_LOCKFILE&apos;, &apos;Queue&apos;, &apos;ReturnData&apos;, &apos;Runner&apos;, &apos;__builtins__&apos;, &apos;__doc__&apos;, &apos;__file__&apos;, &apos;__name__&apos;, &apos;__package__&apos;, &apos;__path__&apos;, &apos;_executor_hook&apos;, &apos;ansible&apos;, &apos;atfork&apos;, &apos;base64&apos;, &apos;check_conditional&apos;, &apos;collections&apos;, &apos;connection&apos;, &apos;errors&apos;, &apos;getpass&apos;, &apos;jinja2&apos;, &apos;module_common&apos;, &apos;module_replacer&apos;, &apos;multiprocessing&apos;, &apos;multiprocessing_runner&apos;, &apos;os&apos;, &apos;pipes&apos;, &apos;poller&apos;, &apos;pwd&apos;, &apos;random&apos;, &apos;return_data&apos;, &apos;signal&apos;, &apos;socket&apos;, &apos;split_args&apos;, &apos;string_functions&apos;, &apos;subprocess&apos;, &apos;sys&apos;, &apos;tempfile&apos;, &apos;template&apos;, &apos;time&apos;, &apos;traceback&apos;, &apos;utils&apos;, &apos;vv&apos;]
&gt;&gt;&gt; help(ansible.runner.Runner)    
</code></pre><h4 id="Python-yaml-模块自定义playbook"><a href="#Python-yaml-模块自定义playbook" class="headerlink" title="Python yaml 模块自定义playbook"></a>Python yaml 模块自定义playbook</h4><p>define_yaml.py<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="keyword">import</span> yaml</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line">playbook_path = <span class="string">'/home/ubuntu/scripts'</span></div><div class="line"></div><div class="line">Yml_args = &#123;&#125;</div><div class="line">Yml = []</div><div class="line">Yml_args[<span class="string">"gather_facts"</span>] = <span class="keyword">False</span></div><div class="line">Yml_args[<span class="string">"hosts"</span>] = <span class="string">"localhost_group"</span></div><div class="line">Yml_args[<span class="string">"remote_user"</span>] = <span class="string">"ubuntu"</span></div><div class="line">Yml_task = []</div><div class="line">Yml_task.append(&#123;<span class="string">'shell'</span>: <span class="string">'uptime'</span>, <span class="string">'name'</span>: <span class="string">'uptime info'</span>&#125;)</div><div class="line">Yml_task.append(&#123;<span class="string">'shell'</span>: <span class="string">'free -m'</span>, <span class="string">'name'</span>: <span class="string">'memory info'</span>&#125;)</div><div class="line">Yml_args[<span class="string">"tasks"</span>] = Yml_task</div><div class="line">Yml.append(Yml_args)</div><div class="line">Yml = yaml.dump(Yml)</div><div class="line">Yml_path = os.path.join(playbook_path, <span class="string">"exp.yml"</span>)</div><div class="line"><span class="keyword">with</span> open(Yml_path, <span class="string">'w'</span>) <span class="keyword">as</span> f:</div><div class="line">    f.write(Yml)</div></pre></td></tr></table></figure></p>
<p>运行并检测：</p>
<pre><code>$ python define_yaml.py

$ ansible-playbook  -i /etc/ansible/hosts  exp.yml

PLAY [localhost_group] ********************************************************

TASK: [uptime info] ***********************************************************
changed: [localhost]

TASK: [memory info] ***********************************************************
changed: [localhost]

PLAY RECAP ********************************************************************
localhost                  : ok=2    changed=2    unreachable=0    failed=0

$ cat exp.yml
- gather_facts: false
  hosts: localhost_group
  remote_user: ubuntu
  tasks:
  - {name: uptime info, shell: uptime}
  - {name: memory info, shell: free -m}
</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://docs.ansible.com/ansible/dev_guide/developing_api.html" target="_blank" rel="external">Ansible Python API</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;模块&quot;&gt;&lt;a href=&quot;#模块&quot; class=&quot;headerlink&quot; title=&quot;模块&quot;&gt;&lt;/a&gt;模块&lt;/h2&gt;&lt;h3 id=&quot;命令行&quot;&gt;&lt;a href=&quot;#命令行&quot; class=&quot;headerlink&quot; title=&quot;命令行&quot;&gt;&lt;/a&gt;命令行&lt;/h3&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;// ping 模块&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ ansible localhost -m ping&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;localhost | success &amp;gt;&amp;gt; &amp;#123;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;changed&amp;quot;: false,&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    &amp;quot;ping&amp;quot;: &amp;quot;pong&amp;quot;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;// shell 模块&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;$ ansible localhost -m shell -a &amp;apos;uptime&amp;apos;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;localhost | success | rc=0 &amp;gt;&amp;gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11:00:11 up 66 days, 23:34,  1 user,  load average: 0.00, 0.01, 0.05&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;Python-API&quot;&gt;&lt;a href=&quot;#Python-API&quot; class=&quot;headerlink&quot; title=&quot;Python API&quot;&gt;&lt;/a&gt;Python API&lt;/h3&gt;&lt;p&gt;通过ansible.runner模块来实现&lt;/p&gt;
    
    </summary>
    
      <category term="Dev" scheme="http://yoursite.com/categories/Dev/"/>
    
    
      <category term="Ansible" scheme="http://yoursite.com/tags/Ansible/"/>
    
  </entry>
  
  <entry>
    <title>跨仓库转移SVN代码目录</title>
    <link href="http://yoursite.com/2016/11/01/svn-code-transfer/"/>
    <id>http://yoursite.com/2016/11/01/svn-code-transfer/</id>
    <published>2016-11-01T10:59:38.000Z</published>
    <updated>2016-11-07T08:41:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>由于公司先前代码管理比较混乱，不同部门之间的代码有放在同一个仓库的，抽空转移了部分并记录备忘。</p>
<p><strong>project项目位于dev仓库的主分支，现需要将他转移到ops仓库主分支</strong></p>
<blockquote>
<p>old svn: <a href="http://svnserver/svn/dev/trunk/project/" target="_blank" rel="external">http://svnserver/svn/dev/trunk/project/</a></p>
<p>new svn:<a href="http://svnserver/svn/ops/trunk/" target="_blank" rel="external">http://svnserver/svn/ops/trunk/</a></p>
</blockquote>
<p><strong>直接svn move 报错：</strong></p>
<pre><code>$ svn move  http://svnserver/svn/dev/trunk/project/  http://svnserver/svn/ops/trunk/
svn: E200007: Source and destination URLs appear not to point to the same repository.
</code></pre><blockquote>
<p>svn: E200007: Source and destination URLs appear not to point to the same repository. </p>
<p>不同的仓库之间无法直接move或cp项目代码</p>
</blockquote>
<a id="more"></a>
<h3 id="转移方法："><a href="#转移方法：" class="headerlink" title="转移方法："></a>转移方法：</h3><p><strong>方法一：</strong></p>
<p>先将old svn项目代码check到本地然后import到new svn中</p>
<ul>
<li><p>缺点：old svn的代码的历史记录都会清空</p>
</li>
<li><p>优点：在客户端本地就能完成</p>
</li>
</ul>
<p>操作如下：</p>
<pre><code>$ svn --username=abner.zhao checkout http://svnserver/svn/dev/trunk/project/ project
$ svn import project  svn:http://svnserver/svn/ops/trunk/  -m &apos;import project to trunk&apos;
</code></pre><p><strong>方法二：</strong></p>
<p>将old svn中要迁移的项目代码dump出来，然后load 到new svn中</p>
<ul>
<li><p>优点：保留历史记录</p>
</li>
<li><p>缺点：要到svn服务端上操作</p>
</li>
</ul>
<p>操作如下：</p>
<pre><code>$ svnadmin dump dev | svndumpfilter include /trunk/UDPServer/ --drop-empty-revs --renumber-revs --preserve-revprops &gt; /tmp/project.dump
$ svnadmin load ops &lt; /tmp/project.dump
</code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://falstaff.agner.ch/2011/11/12/subversion-move-folder-from-one-repository-to-another/" target="_blank" rel="external">subversion-move-folder-from-one-repository-to-another</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;由于公司先前代码管理比较混乱，不同部门之间的代码有放在同一个仓库的，抽空转移了部分并记录备忘。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;project项目位于dev仓库的主分支，现需要将他转移到ops仓库主分支&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;old svn: &lt;a href=&quot;http://svnserver/svn/dev/trunk/project/&quot;&gt;http://svnserver/svn/dev/trunk/project/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;new svn:&lt;a href=&quot;http://svnserver/svn/ops/trunk/&quot;&gt;http://svnserver/svn/ops/trunk/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;直接svn move 报错：&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ svn move  http://svnserver/svn/dev/trunk/project/  http://svnserver/svn/ops/trunk/
svn: E200007: Source and destination URLs appear not to point to the same repository.
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;svn: E200007: Source and destination URLs appear not to point to the same repository. &lt;/p&gt;
&lt;p&gt;不同的仓库之间无法直接move或cp项目代码&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Ops" scheme="http://yoursite.com/categories/Ops/"/>
    
    
      <category term="svn" scheme="http://yoursite.com/tags/svn/"/>
    
  </entry>
  
  <entry>
    <title>Python字典排序和列表去重</title>
    <link href="http://yoursite.com/2016/09/18/python-dict-list-sort/"/>
    <id>http://yoursite.com/2016/09/18/python-dict-list-sort/</id>
    <published>2016-09-18T03:31:26.000Z</published>
    <updated>2016-11-23T10:07:44.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="字典排序"><a href="#字典排序" class="headerlink" title="字典排序"></a>字典排序</h2><h3 id="字典key排序"><a href="#字典key排序" class="headerlink" title="字典key排序"></a>字典key排序</h3><p>方法一：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dict = &#123;&apos;b&apos;:3,&apos;a&apos;:1,&apos;d&apos;:7,&apos;c&apos;:5&#125;</div><div class="line">items = dict.items()</div><div class="line">items.sort()</div><div class="line"></div><div class="line">print [(k,v) for k,v in items] //[(&apos;a&apos;, 1), (&apos;b&apos;, 3), (&apos;c&apos;, 5), (&apos;d&apos;, 7)]</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>方法二：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dict = &#123;&apos;b&apos;:3,&apos;a&apos;:1,&apos;d&apos;:7,&apos;c&apos;:5&#125;</div><div class="line">print [(k,dict[k]) for k in sorted(dict.keys())] </div><div class="line"></div><div class="line">//stdout</div><div class="line">[(&apos;a&apos;, 1), (&apos;b&apos;, 3), (&apos;c&apos;, 5), (&apos;d&apos;, 7)]</div></pre></td></tr></table></figure>
<h3 id="字典value排序"><a href="#字典value排序" class="headerlink" title="字典value排序"></a>字典value排序</h3><p>方法一：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dict = &#123;&apos;b&apos;:3,&apos;a&apos;:1,&apos;d&apos;:7,&apos;c&apos;:5&#125;</div><div class="line">print [ v for v in sorted(dict.values())]</div><div class="line"></div><div class="line">//stdout</div><div class="line">[1, 3, 5, 7]</div></pre></td></tr></table></figure>
<p>方法二：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dict = &#123;&apos;b&apos;:3,&apos;a&apos;:1,&apos;d&apos;:7,&apos;c&apos;:5&#125;</div><div class="line">sorted(dict.items(), lambda x, y: cmp(x[1], y[1]))</div><div class="line">//[(&apos;a&apos;, 1), (&apos;b&apos;, 3), (&apos;c&apos;, 5), (&apos;d&apos;, 7)]</div><div class="line">sorted(dict.items(), lambda x, y: cmp(x[1], y[1]), reverse=True) //降序</div><div class="line">//[(&apos;d&apos;, 7), (&apos;c&apos;, 5), (&apos;b&apos;, 3), (&apos;a&apos;, 1)]</div></pre></td></tr></table></figure>
<h2 id="列表去重"><a href="#列表去重" class="headerlink" title="列表去重"></a>列表去重</h2><p>方法一：</p>
<p>set方法：类似dict但不存储value，且key不能重复</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">num_list = [1,1,2,3,4,4]</div><div class="line">list = list(set(num_list))</div><div class="line">print list</div><div class="line"></div><div class="line">//stdout</div><div class="line">[1, 2, 3, 4]</div></pre></td></tr></table></figure>
<p>方法二：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">num_list = [1,1,2,3,4,4]</div><div class="line">print &#123;&#125;.fromkeys(num_list).keys() //创建新的字典 list的值为key 然后取key</div><div class="line"></div><div class="line">//stdout</div><div class="line">[1, 2, 3, 4]</div></pre></td></tr></table></figure>
<p>方法三：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">ids = [1,1,2,3,4,4]</div><div class="line">func = lambda x,y: x if y in x else x + [y]</div><div class="line">print reduce(func, [[], ] + ids) //利用reduce函数</div><div class="line"></div><div class="line">//stdout</div><div class="line">[1, 2, 3, 4]</div></pre></td></tr></table></figure>
<h2 id="sort和sorted"><a href="#sort和sorted" class="headerlink" title="sort和sorted"></a>sort和sorted</h2><p><strong>sort在容器内部排序，sorted生成一个新排好序的容器</strong></p>
<blockquote>
<p>sorted(iterable[, cmp[, key[, reverse]]])<br>iterable:可迭代对象<br>cmp:比较函数，默认为None<br>key:比较的关键字，默认为None<br>reverse:布尔值，True则降序排列</p>
</blockquote>
<h3 id="利用sort和sorted实现列表排序"><a href="#利用sort和sorted实现列表排序" class="headerlink" title="利用sort和sorted实现列表排序"></a>利用sort和sorted实现列表排序</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#sort</div><div class="line">list = [1,3,5,2,7,4]</div><div class="line">list.sort(reverse = True)</div><div class="line">print list</div><div class="line"></div><div class="line">//stdout</div><div class="line">[7, 5, 4, 3, 2, 1]  </div><div class="line"></div><div class="line">#sorted</div><div class="line">list = [1,3,5,2,7,4]</div><div class="line">new_list = sorted(list)</div><div class="line">print list</div><div class="line">print new_list</div><div class="line"></div><div class="line">//stdout</div><div class="line">[1, 3, 5, 2, 7, 4]</div><div class="line">[1, 2, 3, 4, 5, 7]</div></pre></td></tr></table></figure>
<h3 id="sorted对字典排序"><a href="#sorted对字典排序" class="headerlink" title="sorted对字典排序"></a>sorted对字典排序</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dict = &#123;&apos;b&apos;:3,&apos;a&apos;:1,&apos;d&apos;:7,&apos;c&apos;:5&#125;</div><div class="line">print sorted(dict.items(), key=lambda d: d[0]) //key</div><div class="line">print sorted(dict.items(), key=lambda d: d[1]) //value</div></pre></td></tr></table></figure>
<h3 id="sorted-key示例"><a href="#sorted-key示例" class="headerlink" title="sorted key示例"></a>sorted key示例</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#exp1</div><div class="line">&gt;&gt;&gt; sorted(&quot;This is a test string from Andrew&quot;.split(), key=str.lower)</div><div class="line">[&apos;a&apos;, &apos;Andrew&apos;, &apos;from&apos;, &apos;is&apos;, &apos;string&apos;, &apos;test&apos;, &apos;This&apos;]</div><div class="line"></div><div class="line">#exp2</div><div class="line">&gt;&gt;&gt; student_tuples = [</div><div class="line">    (&apos;john&apos;, &apos;A&apos;, 15),</div><div class="line">    (&apos;jane&apos;, &apos;B&apos;, 12),</div><div class="line">    (&apos;dave&apos;, &apos;B&apos;, 10),</div><div class="line">]</div><div class="line">&gt;&gt;&gt; sorted(student_tuples, key=lambda student: student[2]) # sort by age</div><div class="line">[(&apos;dave&apos;, &apos;B&apos;, 10), (&apos;jane&apos;, &apos;B&apos;, 12), (&apos;john&apos;, &apos;A&apos;, 15)]</div></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://wiki.python.org/moin/HowTo/Sorting" target="_blank" rel="external">Sorting Mini-HOW TO</a><br><a href="https://docs.python.org/2/library/functions.html" target="_blank" rel="external">Built-in Functions</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;字典排序&quot;&gt;&lt;a href=&quot;#字典排序&quot; class=&quot;headerlink&quot; title=&quot;字典排序&quot;&gt;&lt;/a&gt;字典排序&lt;/h2&gt;&lt;h3 id=&quot;字典key排序&quot;&gt;&lt;a href=&quot;#字典key排序&quot; class=&quot;headerlink&quot; title=&quot;字典key排序&quot;&gt;&lt;/a&gt;字典key排序&lt;/h3&gt;&lt;p&gt;方法一：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;dict = &amp;#123;&amp;apos;b&amp;apos;:3,&amp;apos;a&amp;apos;:1,&amp;apos;d&amp;apos;:7,&amp;apos;c&amp;apos;:5&amp;#125;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;items = dict.items()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;items.sort()&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;print [(k,v) for k,v in items] //[(&amp;apos;a&amp;apos;, 1), (&amp;apos;b&amp;apos;, 3), (&amp;apos;c&amp;apos;, 5), (&amp;apos;d&amp;apos;, 7)]&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Dev" scheme="http://yoursite.com/categories/Dev/"/>
    
    
      <category term="sort" scheme="http://yoursite.com/tags/sort/"/>
    
  </entry>
  
  <entry>
    <title>cpuinfo</title>
    <link href="http://yoursite.com/2016/06/07/cpuinfo/"/>
    <id>http://yoursite.com/2016/06/07/cpuinfo/</id>
    <published>2016-06-07T12:39:35.000Z</published>
    <updated>2016-11-07T08:43:00.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="proc-cpuinfo"><a href="#proc-cpuinfo" class="headerlink" title="/proc/cpuinfo"></a>/proc/cpuinfo</h3><blockquote>
<p> Information about the processor, such as its type, make, model, and performance.</p>
</blockquote>
<h3 id="信息查看"><a href="#信息查看" class="headerlink" title="信息查看"></a>信息查看</h3><h4 id="CPU型号"><a href="#CPU型号" class="headerlink" title="CPU型号"></a>CPU型号</h4><pre><code># cat /proc/cpuinfo | grep vendor | uniq
vendor_id   : GenuineIntel
#  cat /proc/cpuinfo | grep &apos;model name&apos; | uniq
model name  : Intel(R) Xeon(R) CPU E5-2630 v3 @ 2.40GHz
</code></pre><h4 id="CPU-架构"><a href="#CPU-架构" class="headerlink" title="CPU 架构"></a>CPU 架构</h4><pre><code># lscpu
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
......
</code></pre><a id="more"></a>
<h4 id="物理CPU个数"><a href="#物理CPU个数" class="headerlink" title="物理CPU个数"></a>物理CPU个数</h4><pre><code># cat /proc/cpuinfo | grep &quot;physical id&quot; | sort -u | wc -l
2
</code></pre><h4 id="单个物理CPU中Core个数"><a href="#单个物理CPU中Core个数" class="headerlink" title="单个物理CPU中Core个数"></a>单个物理CPU中Core个数</h4><pre><code># cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq
cpu cores   : 8
</code></pre><h4 id="所有物理CPU上的Core个数（core-id-数量）"><a href="#所有物理CPU上的Core个数（core-id-数量）" class="headerlink" title="所有物理CPU上的Core个数（core id 数量）"></a>所有物理CPU上的Core个数（core id 数量）</h4><pre><code># cat /proc/cpuinfo | grep &quot;core id&quot; | uniq |  wc -l
32
</code></pre><h4 id="逻辑CPU个数"><a href="#逻辑CPU个数" class="headerlink" title="逻辑CPU个数"></a>逻辑CPU个数</h4><pre><code># cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l
32
</code></pre><h4 id="超线程（HT）技术"><a href="#超线程（HT）技术" class="headerlink" title="超线程（HT）技术"></a>超线程（HT）技术</h4><blockquote>
<p>number of processing units = number of cores [ no hyper threading ] </p>
<p>number of processing units = number of cores * 2 [ hyper threading present ]</p>
</blockquote>
<pre><code># cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq
cpu cores   : 8
# cat /proc/cpuinfo | grep &quot;siblings&quot; | sort -u
siblings    : 16
# lscpu | grep Thread
Thread(s) per core:    2
</code></pre><h4 id="重要字段含义"><a href="#重要字段含义" class="headerlink" title="重要字段含义"></a>重要字段含义</h4><ul>
<li>processor 逻辑处理器的唯一标识符</li>
<li>physical id 每个物理封装的唯一标识符</li>
<li>core id 每个内核的唯一标识符</li>
<li>siblings 位于相同物理封装中的逻辑处理器的数量</li>
<li>cpu cores 位于相同物理封装中的内核数量</li>
</ul>
<p>各字段关系如下图所示：</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/5793DDE2-40C0-4147-AD14-C85C1574C2DE.png" alt=""> </p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.binarytides.com/linux-check-processor/" target="_blank" rel="external">How to check processor and cpu details on Linux</a><br><a href="https://www.centos.org/docs/5/html/5.1/Deployment_Guide/s2-proc-cpuinfo.html" target="_blank" rel="external">Deployment_Guide/s2-proc-cpuinfo</a><br><a href="http://blog.csdn.net/sycflash/article/details/6643492" target="_blank" rel="external">CPU信息/proc/cpuinfo</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;proc-cpuinfo&quot;&gt;&lt;a href=&quot;#proc-cpuinfo&quot; class=&quot;headerlink&quot; title=&quot;/proc/cpuinfo&quot;&gt;&lt;/a&gt;/proc/cpuinfo&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt; Information about the processor, such as its type, make, model, and performance.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;信息查看&quot;&gt;&lt;a href=&quot;#信息查看&quot; class=&quot;headerlink&quot; title=&quot;信息查看&quot;&gt;&lt;/a&gt;信息查看&lt;/h3&gt;&lt;h4 id=&quot;CPU型号&quot;&gt;&lt;a href=&quot;#CPU型号&quot; class=&quot;headerlink&quot; title=&quot;CPU型号&quot;&gt;&lt;/a&gt;CPU型号&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;# cat /proc/cpuinfo | grep vendor | uniq
vendor_id   : GenuineIntel
#  cat /proc/cpuinfo | grep &amp;apos;model name&amp;apos; | uniq
model name  : Intel(R) Xeon(R) CPU E5-2630 v3 @ 2.40GHz
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;CPU-架构&quot;&gt;&lt;a href=&quot;#CPU-架构&quot; class=&quot;headerlink&quot; title=&quot;CPU 架构&quot;&gt;&lt;/a&gt;CPU 架构&lt;/h4&gt;&lt;pre&gt;&lt;code&gt;# lscpu
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
......
&lt;/code&gt;&lt;/pre&gt;
    
    </summary>
    
      <category term="Ops" scheme="http://yoursite.com/categories/Ops/"/>
    
    
      <category term="cpuinfo" scheme="http://yoursite.com/tags/cpuinfo/"/>
    
  </entry>
  
  <entry>
    <title>iostat查看磁盘IO信息</title>
    <link href="http://yoursite.com/2016/05/27/iostat/"/>
    <id>http://yoursite.com/2016/05/27/iostat/</id>
    <published>2016-05-27T03:19:17.000Z</published>
    <updated>2016-11-07T08:43:21.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、iostat简介"><a href="#一、iostat简介" class="headerlink" title="一、iostat简介"></a>一、iostat简介</h3><blockquote>
<p>iostat - Report Central Processing Unit (CPU) statistics and input/out-put statistics for devices and partitions.</p>
</blockquote>
<p>iostat 用于输出CPU和磁盘I/O相关的统计信息。</p>
<a id="more"></a>
<p>选项如下：</p>
<pre><code>-c     The  -c  option  is exclusive of the -d option and displays only
       the CPU usage report.  //仅显示CPU统计信息，与-d选项互斥

-d     The -d option is exclusive of the -c option  and  displays  only
       the device utilization report. //仅显示磁盘统计信息，与-c选项互斥

-k     Display statistics in kilobytes per second instead of blocks per
       second.  Data displayed are valid  only  with  kernels  2.4  and
       newer. // 以KB为单位显示每秒的磁盘请求数，默认单位块

 -p device | ALL
       The -p option is exclusive of the -x option and displays statis-
       tics for block devices and all their partitions that are used by
       the  system.   If  a device name is entered on the command line,
       then statistics for it and all  its  partitions  are  displayed.
       Last,  the ALL keyword indicates that statistics have to be dis-
       played for all the block devices and partitions defined  by  the
       system,  including  those  that have never been used.  Note that
       this option works only with post 2.5 kernels. 
       // 用于显示块设备及系统分区的统计信息，与-x选项互斥

-t     Print the time for each report displayed.

-V     Print version number and usage then exit.

-x     Display extended statistics.  This option is exclusive of the -p
       one,   and   works   with   post  2.5  kernels  since  it  needs
       /proc/diskstats file or a mounted sysfs to get  the  statistics.
       This  option may also work with older kernels (e.g. 2.4) only if
       extended statistics are available in /proc/partitions (the  ker-
       nel needs to be patched for that).
</code></pre><h3 id="二、iostat的简单使用"><a href="#二、iostat的简单使用" class="headerlink" title="二、iostat的简单使用"></a>二、iostat的简单使用</h3><pre><code># iostat  // 显示CPU和设备吞吐率的统计信息
Linux 2.6.32-573.el6.x86_64 (Mr-zhao)   05/26/2016  _x86_64_    (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
            0.05    0.00    0.07    0.01    0.00   99.87

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               0.76         3.69        12.60   60628026  206899224
</code></pre><p>输出项说明：</p>
<p>%user:  在用户级别运行所使用的 CPU 的百分比。</p>
<p>%nice:  nice 操作所使用的 CPU 的百分比。</p>
<p>%system:    在核心级别（kernel）运行所使用 CPU 的百分比。</p>
<p>%iowait:    CPU 等待硬件 I/O 所占用 CPU 的百分比。</p>
<p>%steal: 当管理程序（hypervisor）为另一个虚拟进程提供服务而等待虚拟 CPU 的百分比。</p>
<p>%idle:  CPU 空闲时间的百分比。</p>
<p>tps:    每秒钟物理设备的 I/O 传输总量。</p>
<p>[MB/KB/B]lk_read:   读入的数据总量，单位为MB/KB/块。</p>
<p>[MB/KB/B]lk_wrtn    :写入的数据总量，单位为MB/KB/块。</p>
<p>[MB/KB/B]lk_read/s: 每秒从驱动器读入的数据量，单位为MB/KB/块。</p>
<p>[MB/KB/B]lk_wrtn/s: 每秒向驱动器写入的数据量，单位为MB/KB/块。</p>
<pre><code># iostat -d 2  //每隔2秒显示一次设备吞吐率的统计信息（单位为 块/s）
# iostat -dk 2 //每隔2秒显示一次设备吞吐率的统计信息（单位为 KB/s）
# iostat -dk 2 3 // 每隔2秒显示一次，共显示3次

# iostat -x sda  //显示 sda 设备扩展统计信息
Linux 2.6.32-573.el6.x86_64 (Mr-zhao)   05/26/2016  _x86_64_    (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
            0.05    0.00    0.07    0.01    0.00   99.87

Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sda               0.00     0.86    0.05    0.72     3.69    12.60    21.36     0.00    1.83   0.75   0.06
# iostat -p sda  //显示sda 及上面所有分区的统计信息
Linux 2.6.32-573.el6.x86_64 (Mr-zhao)   05/26/2016  _x86_64_    (2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
            0.05    0.00    0.07    0.01    0.00   99.87

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               0.76         3.69        12.60   60628026  206904888
sda1              0.00         0.00         0.00       4994        512
sda2              0.04         3.52         2.22   57853834   36386304
sda3              0.72         0.17        10.38    2763066  170501848
sda4              0.00         0.00         0.00         20          0
sda5              0.00         0.00         0.00       4816      16224
</code></pre><p>输出项说明：</p>
<p>rrqm/s: 将读入请求合并后，每秒发送到设备的读入请求数。</p>
<p>wrqm/s: 将写入请求合并后，每秒发送到设备的写入请求数。</p>
<p>r/s:    每秒发送到设备的读入请求数。</p>
<p>w/s:    每秒发送到设备的写入请求数。</p>
<p>rsec/s: 每秒从设备读入的扇区数。</p>
<p>wsec/s: 每秒向设备写入的扇区数。</p>
<p>rkB/s:  每秒从设备读入的数据量，单位为 KB/s。</p>
<p>wkB/s:  每秒向设备写入的数据量，单位为 KB/s。</p>
<p>rMB/s:  每秒从设备读入的数据量，单位为 MB/s。</p>
<p>wMB/s:  每秒向设备写入的数据量，单位为 MB/s。</p>
<p>avgrq-sz:   发送到设备的请求的平均大小，单位为扇区。</p>
<p>avgqu-sz:   发送到设备的请求的平均队列长度。</p>
<p>await:  I/O请求平均执行时间。包括发送请求和执行的时间。单位为毫秒。</p>
<p>svctm:  发送到设备的I/O请求的平均执行时间。单位为毫秒。</p>
<p>%util:  在I/O请求发送到设备期间，占用CPU时间的百分比。用于显示设备的带宽利用率。当这个值接近100%时，表示设备带宽已经占满。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一、iostat简介&quot;&gt;&lt;a href=&quot;#一、iostat简介&quot; class=&quot;headerlink&quot; title=&quot;一、iostat简介&quot;&gt;&lt;/a&gt;一、iostat简介&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;iostat - Report Central Processing Unit (CPU) statistics and input/out-put statistics for devices and partitions.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;iostat 用于输出CPU和磁盘I/O相关的统计信息。&lt;/p&gt;
    
    </summary>
    
      <category term="Cmd" scheme="http://yoursite.com/categories/Cmd/"/>
    
    
      <category term="iostat" scheme="http://yoursite.com/tags/iostat/"/>
    
  </entry>
  
  <entry>
    <title>Screen会话管理</title>
    <link href="http://yoursite.com/2016/05/23/screen/"/>
    <id>http://yoursite.com/2016/05/23/screen/</id>
    <published>2016-05-23T12:47:12.000Z</published>
    <updated>2016-11-07T08:44:10.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h3><p>GNU Screen是一款由GNU计划开发的用于命令行终端切换的自由软件。用户可以通过该软件同时连接多个本地或远程的命令行会话，并在其间自由切换。</p>
<p><a href="http://www.gnu.org/software/screen/" target="_blank" rel="external">GNU’s Screen 官方站点</a></p>
<h3 id="二、功能"><a href="#二、功能" class="headerlink" title="二、功能"></a>二、功能</h3><h4 id="会话恢复"><a href="#会话恢复" class="headerlink" title="会话恢复"></a>会话恢复</h4><p>只要Screen本身没有终止，在其内部运行的会话都可以恢复。对于远程登录的用户即使网络连接中断，用户也不会失去对已经打开的命令行会话的控制。</p>
<h4 id="多窗口"><a href="#多窗口" class="headerlink" title="多窗口"></a>多窗口</h4><p>在Screen环境下，所有的会话都独立的运行，并拥有各自的编号、输入、输出和窗口缓存。用户可以通过快捷键在不同的窗口下切换，并可以自由的重定向各个窗口的输入和输出。</p>
<a id="more"></a>
<h4 id="会话共享"><a href="#会话共享" class="headerlink" title="会话共享"></a>会话共享</h4><p>Screen可以让一个或多个用户从不同终端多次登录一个会话，并共享会话的所有特性（比如可以看到完全相同的输出）。它同时提供了窗口访问权限的机制，可以对窗口进行密码保护。</p>
<h3 id="三、常用参数"><a href="#三、常用参数" class="headerlink" title="三、常用参数"></a>三、常用参数</h3><pre><code>screen -S yourname   //新建一个叫yourname的session
screen -ls（或者screen -list） //列出当前所有的session
screen -r yourname  //回到yourname这个session
screen -d yourname   //远程detach某个session，转移到当前终端
screen -d -r yourname  //结束当前session并回到yourname这个session

ctrl+a x -&gt; 锁住当前的 window，需用用户密码解锁
ctrl-a k -&gt; kill window，强行关闭当前的 window
ctrl+a d -&gt; detach，暂时离开当前session，将目前的 screen session (可能含有多个 windows) 丢到后台执行，并会回到还没进 screen 时的状态，此时在 screen session 里，每个 window 内运行的 process (无论是前台/后台)都在继续执行，即使 logout 也不影响
</code></pre><h3 id="四、使用实例"><a href="#四、使用实例" class="headerlink" title="四、使用实例"></a>四、使用实例</h3><h4 id="创建新窗口"><a href="#创建新窗口" class="headerlink" title="创建新窗口"></a>创建新窗口</h4><pre><code># screen  -S text   // 创建一个名字为text的会话，会打开一个默认的shell环境（一般都是bash shell）
# vi file.txt
</code></pre><p>或</p>
<pre><code># screen vi file.txt   //退出vi将退出该会话
</code></pre><h3 id="会话分离与恢复"><a href="#会话分离与恢复" class="headerlink" title="会话分离与恢复"></a>会话分离与恢复</h3><p>在screen窗口键入C-a d，Screen会给出detached，暂时中断会话。</p>
<p>找到并恢复会话：</p>
<pre><code># screen -ls    //查看当前会话
There is a screen on:
10526.test  (05/23/2016 07:48:58 PM)    (Detached)
1 Socket in /var/run/screen/S-root. 

# screen -r  test  // 进入被中断的会话，screen的名字和编号都行
</code></pre><h4 id="清除-dead会话"><a href="#清除-dead会话" class="headerlink" title="清除 dead会话"></a>清除 dead会话</h4><pre><code># screen -wipe
</code></pre><h4 id="关闭会话"><a href="#关闭会话" class="headerlink" title="关闭会话"></a>关闭会话</h4><pre><code>Ctrl-a k  // kill会话，同时kill会话里的进程
Ctrl-a :   // 然后输入quit命令退出Screen会话,会杀死所有窗口并退出其中运行的所有程序
</code></pre><h3 id="会话共享-1"><a href="#会话共享-1" class="headerlink" title="会话共享"></a>会话共享</h3><pre><code># screen -x  screenname

-x  Attach to a not detached screen. (Multi display mode).
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一、简介&quot;&gt;&lt;a href=&quot;#一、简介&quot; class=&quot;headerlink&quot; title=&quot;一、简介&quot;&gt;&lt;/a&gt;一、简介&lt;/h3&gt;&lt;p&gt;GNU Screen是一款由GNU计划开发的用于命令行终端切换的自由软件。用户可以通过该软件同时连接多个本地或远程的命令行会话，并在其间自由切换。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.gnu.org/software/screen/&quot;&gt;GNU’s Screen 官方站点&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;二、功能&quot;&gt;&lt;a href=&quot;#二、功能&quot; class=&quot;headerlink&quot; title=&quot;二、功能&quot;&gt;&lt;/a&gt;二、功能&lt;/h3&gt;&lt;h4 id=&quot;会话恢复&quot;&gt;&lt;a href=&quot;#会话恢复&quot; class=&quot;headerlink&quot; title=&quot;会话恢复&quot;&gt;&lt;/a&gt;会话恢复&lt;/h4&gt;&lt;p&gt;只要Screen本身没有终止，在其内部运行的会话都可以恢复。对于远程登录的用户即使网络连接中断，用户也不会失去对已经打开的命令行会话的控制。&lt;/p&gt;
&lt;h4 id=&quot;多窗口&quot;&gt;&lt;a href=&quot;#多窗口&quot; class=&quot;headerlink&quot; title=&quot;多窗口&quot;&gt;&lt;/a&gt;多窗口&lt;/h4&gt;&lt;p&gt;在Screen环境下，所有的会话都独立的运行，并拥有各自的编号、输入、输出和窗口缓存。用户可以通过快捷键在不同的窗口下切换，并可以自由的重定向各个窗口的输入和输出。&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="screen" scheme="http://yoursite.com/tags/screen/"/>
    
  </entry>
  
  <entry>
    <title>Ansible基础知识备忘</title>
    <link href="http://yoursite.com/2016/05/20/ansible/"/>
    <id>http://yoursite.com/2016/05/20/ansible/</id>
    <published>2016-05-20T08:25:38.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="一、体系结构"><a href="#一、体系结构" class="headerlink" title="一、体系结构"></a>一、体系结构</h3><p>ansible是一款基于python开发，揉合了众多自动化运维工具功能的轻量级自动化运维工具，目前实现了除系统安装以外的批量系统配置、批量任务执行及批量程序部署等功能。</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/25.png" alt=""></p>
<ul>
<li>Inventory：主机库，定义可控制的主机</li>
<li>Modules：基于模块化设计，通过模块来实现批量部署</li>
<li>playbook：剧本，使用YAML编写的声明性的配置文件</li>
<li>plugins: 插件，完成日志记录、邮件等功能</li>
</ul>
<h3 id="二、-特点"><a href="#二、-特点" class="headerlink" title="二、 特点"></a>二、 特点</h3><ul>
<li>高度模块化，借助模块完成各种任务</li>
<li>agentless，无需在被控制端安装agent</li>
<li>默认基于ssh协议向被控制端发送操作指令<ul>
<li>基于密钥认证</li>
<li>在inventory文件中指定账号和密码</li>
</ul>
</li>
<li>批量任务执行可写成剧本playbook</li>
<li>幂等性：不会重复执行相同操作</li>
</ul>
<h3 id="三、简单使用"><a href="#三、简单使用" class="headerlink" title="三、简单使用"></a>三、简单使用</h3><h4 id="3-1-ssh免密钥登录"><a href="#3-1-ssh免密钥登录" class="headerlink" title="3.1 ssh免密钥登录"></a>3.1 ssh免密钥登录</h4><pre><code># ssh-keygen -t rsa -P &apos;&apos;  
# ssh-copy-id  -i /root/.ssh/id_rsa.pub  10.249.6.64
# ssh-copy-id  -i /root/.ssh/id_rsa.pub  10.48.156.8
</code></pre><h4 id="3-2-常用命令"><a href="#3-2-常用命令" class="headerlink" title="3.2 常用命令"></a>3.2 常用命令</h4><p>ansible-doc</p>
<pre><code>Options:

-l, --list            List available modules  //列出所有模块
-s, --snippet         Show playbook snippet for specified module(s) //查看指定模块用法

更多信息请参考manual手册
</code></pre><p>ansible</p>
<p> ansible <host-pattern>  [-f forks][-m module_name] [-a args] [options]</host-pattern></p>
<pre><code>Options:

  -a MODULE_ARGS, --args=MODULE_ARGS
                    module arguments   // 传递模块参数
  -f FORKS, --forks=FORKS  // 指定并发数
                    specify number of parallel processes to use
                    (default=5)
  -i INVENTORY, --inventory-file=INVENTORY 
                    specify inventory host file
                    (default=/etc/ansible/hosts)    
  -m MODULE_NAME, --module-name=MODULE_NAME
                    module name to execute (default=command)   

 更多信息请参考manual手册        
</code></pre><p>ansible-playbook  </p>
<p>ansible-playbook <filename.yml> … [options]             </filename.yml></p>
<h3 id="四、模块"><a href="#四、模块" class="headerlink" title="四、模块"></a>四、模块</h3><h4 id="command"><a href="#command" class="headerlink" title="command"></a>command</h4><p>命令模块: ansible默认模块，用于在远程执行命令，command模块并不支持shell变量和管道等，若想使用shell来执行，应使用shell模块。</p>
<pre><code># ansible-doc -l | grep ^command
command              Executes a command on a remote node                        

# ansible 10.249.6.64 -m command -a &quot;date&quot;
10.249.6.64 | success | rc=0 &gt;&gt;
Wed May 11 21:21:35 CST 2016                        
</code></pre><h4 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h4><p>ping模块：测试指定主机是否能连接</p>
<pre><code># ansible-doc -l | grep  -w ^ping
ping                 Try to connect to host and return `pong&apos; on success.                  

# ansible 10.249.6.64 -m ping
10.249.6.64 | success &gt;&gt; {
    &quot;changed&quot;: false,
    &quot;ping&quot;: &quot;pong&quot;
}
</code></pre><h4 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h4><p>计划任务模块 ：管理计划任务</p>
<pre><code># ansible-doc -l | grep  ^cron
cron                 Manage cron.d and crontab entries.

# ansible-doc  -s cron
- name: Manage cron.d and crontab entries.
action: cron
  backup                 # If set, create a backup of the crontab before it is modified. The location of the backup is returned in the `backup&apos; variable by this module.
  cron_file              # If specified, uses this file in cron.d instead of an individual user&apos;s crontab.
  day                    # Day of the month the job should run ( 1-31, *, */2, etc )
  hour                   # Hour when the job should run ( 0-23, *, */2, etc )
  job                    # The command to execute. Required if state=present.
  minute                 # Minute when the job should run ( 0-59, *, */2, etc )
  month                  # Month of the year the job should run ( 1-12, *, */2, etc )
  name                   # Description of a crontab entry.
  reboot                 # If the job should be run at reboot. This option is deprecated. Users should use special_time.
  special_time           # Special time specification nickname.
  state                  # Whether to ensure the job is present or absent.
  user                   # The specific user who&apos;s crontab should be modified.
  weekday                # Day of the week that the job should run ( 0-7 for Sunday - Saturday, *, etc )        

# ansible 10.249.6.64 -m cron -a &apos;name=&quot;sync time&quot; minute=&quot;*/10&quot; \ 
job=&quot;/usr/sbin/ntpdate 0.centos.pool.ntp.org &amp;&amp; hwclock -w&quot; &apos;

10.249.6.64 | success &gt;&gt; {
    &quot;changed&quot;: true,
    &quot;jobs&quot;: [
    &quot;sync time&quot;
    ]
}                   
</code></pre><h4 id="user"><a href="#user" class="headerlink" title="user"></a>user</h4><p>用户模块：管理用户账户</p>
<pre><code># ansible-doc -l | grep ^user
user                 Manage user accounts  

# ansible 10.249.6.64 -m user -a &apos;name=work shell=/bin/bash home=/home/www&apos;   //添加用户
10.249.6.64 | success &gt;&gt; {
&quot;changed&quot;: true,
&quot;comment&quot;: &quot;&quot;,
&quot;createhome&quot;: true,
&quot;group&quot;: 500,
&quot;home&quot;: &quot;/home/www&quot;,
&quot;name&quot;: &quot;work&quot;,
&quot;shell&quot;: &quot;/bin/bash&quot;,
&quot;state&quot;: &quot;present&quot;,
&quot;system&quot;: false,
&quot;uid&quot;: 500
}        

# ansible 10.249.6.64 -m user -a &apos;name=work state=absent&apos;  // 删除用户
10.249.6.64 | success &gt;&gt; {
&quot;changed&quot;: true,
&quot;force&quot;: false,
&quot;name&quot;: &quot;work&quot;,
&quot;remove&quot;: false,
&quot;state&quot;: &quot;absent&quot;
}             
</code></pre><h4 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h4><p>copy模块：文件复制</p>
<pre><code>#  ansible-doc -l | grep ^copy
copy                 Copies files to remote locations. 

# ansible-doc -s copy
- name: Copies files to remote locations.
action: copy
  backup                 # Create a backup file including the timestamp information so you can get the original file back if you somehow clobbered it incorrectly.
  content                # When used instead of &apos;src&apos;, sets the contents of a file directly to the specified value.
  dest=                  # Remote absolute path where the file should be copied to. If src is a directory, this must be a directory too.
  directory_mode         # When doing a recursive copy set the mode for the directories. If this is not set we will default the system defaults.
  force                  # the default is `yes&apos;, which will replace the remote file when contents are different than the source.  If `no&apos;, the file will only be transferred if the destination does not exist.
  src                    # Local path to a file to copy to the remote server; can be absolute or relative. If path is a directory, it is copied recursively. In this case, if path ends with &quot;/&quot;, only inside contents of that directory are copied to destination. Otherwise, if it does not end with &quot;/&quot;, the directory itself with all contents is copied. This behavior is similar to Rsync.
  validate               # The validation command to run before copying into place.  The path to the file to validate is passed in via &apos;%s&apos; which must be present as in the visudo example below. The command is passed securely so shell features like expansion and pipes won&apos;t work.

# ansible 10.249.6.64 -m copy -a &quot;src=/root/test.txt dest=/tmp/&quot;
10.249.6.64 | success &gt;&gt; {
&quot;changed&quot;: true,
&quot;dest&quot;: &quot;/tmp/test.txt&quot;,
&quot;gid&quot;: 0,
&quot;group&quot;: &quot;root&quot;,
&quot;md5sum&quot;: &quot;d41d8cd98f00b204e9800998ecf8427e&quot;,
&quot;mode&quot;: &quot;0644&quot;,
&quot;owner&quot;: &quot;root&quot;,
&quot;size&quot;: 0,
&quot;src&quot;: &quot;/root/.ansible/tmp/ansible-tmp-1463662606.99-26627840524349/source&quot;,
&quot;state&quot;: &quot;file&quot;,
&quot;uid&quot;: 0
}   
# ansible 10.249.6.64 -m copy -a &quot;content=&apos;hello world&apos; dest=/tmp/test.txt&quot;
# ansible 10.249.6.64 -m copy -a &apos;src=/root/test.txt dest=/tmp/test.txt owner=evans group=evans mode=600 backup=yes&apos;
</code></pre><h4 id="file"><a href="#file" class="headerlink" title="file"></a>file</h4><p>file模块：文件模块，设置文件属性</p>
<pre><code># ansible-doc -l | grep -w ^file
file                 Sets attributes of files   
# ansible 10.249.6.64 -m file -a &quot;src=/tmp/test.txt path=/tmp/test.link state=link&quot;
# ansible 10.249.6.64 -m file -a &quot;owner=evans group=evans mode=600 path=/tmp/test.txt&quot;
</code></pre><h4 id="service"><a href="#service" class="headerlink" title="service"></a>service</h4><p>service模块： 服务模块，管理系统服务</p>
<pre><code># ansible-doc -l | grep ^service
service              Manage services.
# ansible-doc -s service
 - name: Manage services.
 action: service
  arguments              # Additional arguments provided on the command line
  enabled                # Whether the service should start on boot. *At least one of state and enabled are required.*
  name=                  # Name of the service.
  pattern                # If the service does not respond to the status command, name a substring to look for as would be found in the output of the `ps&apos; command as a stand-in for a status result.  If the string is found, the service will be assumed to be running.
  runlevel               # For OpenRC init scripts (ex: Gentoo) only.  The runlevel that this service belongs to.
  sleep                  # If the service is being `restarted&apos; then sleep this many seconds between the stop and start command. This helps to workaround badly behaving init scripts that exit immediately after signaling a process to stop.
  state                  # `started&apos;/`stopped&apos; are idempotent actions that will not run commands unless necessary.  `restarted&apos; will always bounce the service.  `reloaded&apos; will always reload. *At least one of state and enabled are required.*
  # ansible 10.249.6.64 -m service -a &quot;name=mysqld state=restarted enabled=true&quot;  //重启mysql服务并设置开机自启动
</code></pre><h4 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h4><p>shell模块：远程执行命令</p>
<pre><code># ansible 10.249.6.64 -m shell -a &apos;date&apos;
10.249.6.64 | success | rc=0 &gt;&gt;
Thu May 19 21:20:51 CST 2016    
</code></pre><h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><p>script模块：脚本模块，远程主机运行脚本</p>
<pre><code># ansible-doc  -l | grep ^script
script               Runs a local script on a remote node after transferring it..
# ansible 10.249.6.64 -m script -a &apos;/root/test.sh&apos;  //在远程主机上运行脚本，并没有拷贝到指定目录
10.249.6.64 | success &gt;&gt; {
&quot;changed&quot;: true,
&quot;rc&quot;: 0,
&quot;stderr&quot;: &quot;&quot;,
&quot;stdout&quot;: &quot;&quot;
}   
</code></pre><h4 id="yum、apt"><a href="#yum、apt" class="headerlink" title="yum、apt"></a>yum、apt</h4><p>yum模块和apt模块：包管理模块</p>
<pre><code>yum                  Manages packages with the `yum&apos; package manager
apt                  Manages apt-packages
# ansible 10.249.6.64 -m yum -a &quot;name=tree state=present&quot;
# ansible 10.249.6.43 -m apt -a &quot;name=tree state=present&quot;
# ansible 10.249.6.43 -m apt -a &quot;name=tree state=absent&quot;
</code></pre><blockquote>
<p> state<br> Whether to install (<code>present&#39;,</code>latest’), or remove (`absent’) a package.</p>
</blockquote>
<h4 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h4><p>setup模块：收集主机信息，playbook运行时，会自动调用setup模块收集远程主机的相关信息（称为facts，如操作系统版本、ip地址、cpu数量等），这些信息保存于变量中，可在playbook中引用</p>
<pre><code># ansible-doc -l | grep  setup
setup                Gathers facts about remote hosts
# ansible-doc -s setup
- name: Gathers facts about remote hosts
 action: setup
  fact_path              # path used for local ansible facts (*.fact) - files in this dir will be run (if executable) and their results be added to ansible_local facts if a file is not executable it is read. File/results format can be json or ini-format
  filter                 # if supplied, only return facts that match this shell-style (fnmatch) wildcard.
# ansible 10.249.6.43 -m setup
# ansible 10.249.6.43 -m setup -a &apos;filter=ansible_eth0&apos;   //过滤信息
# ansible 10.249.6.64 -m setup --tree /tmp/test.txt  //将收集的信息输出到本地文件
</code></pre><p>更多模块信息请查看：<a href="http://docs.ansible.com/ansible/list_of_all_modules.html" target="_blank" rel="external">官方文档</a></p>
<h3 id="五、playbook"><a href="#五、playbook" class="headerlink" title="五、playbook"></a>五、playbook</h3><h4 id="5-1-YAML"><a href="#5-1-YAML" class="headerlink" title="5.1 YAML"></a>5.1 YAML</h4><p>YAML是一种可读性高的用来表达资料序列的语言，其语法和其他高阶语言类似，并且可以简单表达清单、散列表、标量等数据结构。</p>
<p>所有的yaml文件都以”—“开头表示开始一个document，所有的列表元素以”-“开头，键值对用”:”，后面必须有空格。YAML文件扩展名通常为.yaml或.yml</p>
<h4 id="5-2-playbook简介"><a href="#5-2-playbook简介" class="headerlink" title="5.2 playbook简介"></a>5.2 playbook简介</h4><p>playbook是ansible管理配置、部署应用和编排的文件，可用来描述在远程主机上执行的策略或一组任务。</p>
<p>一个playbook文件由一个或多个play组成，每个play定义了在一个或多个远程主机上执行的一系列的task，其中每个task一般就是调用一个ansible的模块。</p>
<p>playbook使用YAML语言编写，文件名以.yaml或.yml结尾。此外playbook和模板文件（template）还可使用jinja2语法语法实现高级功能。</p>
<p>5.2.1 playbook的基本组成</p>
<ul>
<li>targets：指定要执行playbook的远程主机组</li>
<li>variables：定义playbook运行时需要使用的变量</li>
<li>tasks：要执行的任务</li>
<li>handlers：处理器，在某些条件下被触发的操作</li>
</ul>
<p>简单playbook示例：</p>
<pre><code># cat nginx.yml
---
- hosts: 10.249.6.43
  user: root
  vars:
    remote_conffile_path: /etc/nginx/sites-enabled/mirror.conf
  tasks:
  - name: install nginx
    apt: name=nginx state=latest
    when: ansible_distribution == &apos;Ubuntu&apos;

  - name: configration file
    tags: conf
    copy: src=/root/mirror.conf dest={{remote_conffile_path}}
    notify: restart nginx

  - name: start nginx
    service: name=nginx enabled=yes state=started

  handlers:
  - name: restart nginx
    service: name=nginx state=restarted
# ansible-playbook  nginx.yml   // 执行playbook
</code></pre><ul>
<li>hosts、user</li>
</ul>
<p>hosts用于指定要执行指定任务的主机，其可以是一个或多个由逗号分隔主机组；user则用于指定远程主机上的执行任务的用户，还能使用sudo</p>
<ul>
<li>task list、action</li>
</ul>
<p>task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后再开始第二个。如果中途发生错误，所有已执行任务都将回滚，因此，在更正playbook后重新执行一次即可。</p>
<p> task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致。</p>
<p> 每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤。如果未提供name，则action的结果将用于输出。</p>
<p>定义task的可以使用“action: module options”或“module: options”的格式，推荐使用后者以实现向后兼容例如：</p>
<pre><code>tasks:
- name: make sure apache is running
  service: name=httpd state=running
</code></pre><p> 在众多模块中，只有command和shell模块仅需要给定一个列表而无需使用“key=value”格式，例如：</p>
<pre><code>tasks:
- name: disable selinux
  command: /sbin/setenforce 0
</code></pre><p>shell模块执行多条命令       </p>
<pre><code>---
- name: update zabbix agent conf
shell: |     
   sed  -i &quot;/Hostname/d&quot; /usr/local/zabbix-agent-ops/etc/zabbix_agentd.conf
   wget -O /tmp/hostinfo.txt http://10.126.93.2/bak/hostinfo.txt
   IP=`ifconfig | egrep -A1 eth[0-9] | egrep  -o  addr:[0-9]+.[0-9]+.[0-9]+.[0-9]+ | awk -F: &apos;{print $2}&apos;`
   USE=`egrep -w  $IP /tmp/hostinfo.txt | awk &apos;{print $2}&apos;| uniq`
   HOST=`hostname | awk -F . &apos;{print $1}&apos;`
   echo &quot;Hostname=${USE}${HOST}&quot; &gt;&gt; /usr/local/zabbix-agent-ops/etc/zabbix_agentd.conf   
</code></pre><p>如果模块执行返回值不为零，即表示执行失败，任务会立即中止，后续任务不再执行。可以使用ignore_errors来忽略错误信息确保后续任务的执行。</p>
<pre><code>tasks:
   - name: run this command and ignore the result
     shell: /usr/bin/somecommand
     ignore_errors: yes
</code></pre><ul>
<li>handlers</li>
</ul>
<p>当关注的资源发生变化时触发一定的操作。handler是task列表，这些task与前述的task并没有本质上的不同。</p>
<p>“notify”这个action可用于在每个play的最后被触发，这样可以避免多次有改变发生时每次都执行指定的操作，取而代之，仅在所有的变化发生完成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作。       </p>
<pre><code>- name: template configuration file
  template: src=/root/template.conf dest=/etc/template.conf

notify:
  - restart memcached
  - restart apache

handlers:
- name: restart memcached
  service: name=memcached state=restarted
- name: restart apache
  service: name=apache state=restarted
</code></pre><ul>
<li>vars</li>
</ul>
<p>变量名仅能由字母、数字和下划线组成，且只能以字母开头  </p>
<ul>
<li>when </li>
</ul>
<p>条件判断：如果需要根据变量、facts或此前任务的执行结果来做为某task执行与否的前提，这时就要用到条件判断。</p>
<pre><code>when: ansible_distribution == &apos;Debian&apos; or ansible_distribution == &apos;Ubuntu&apos;

when: ansible_distribution == &apos;CentOS&apos; or ansible_distribution == &apos;RedHat&apos; and ansible_distribution_version|int &gt;=6
</code></pre><p>忽略此前某语句的错误并基于其结果（failed或者sucess）运行后面指定的语句:</p>
<pre><code>---
- hosts: 10.249.6.64
  user: root
  tasks:
    - name: false test
      command: /bin/false
      register: result
      ignore_errors: yes
    - name: when false  to do
      command: touch /tmp/1.txt
      when: result | failed
    - name: when success to do
      command: touch /tmp/2.txt
      when: result | success
    - name: when skip to do
      command: touch /tmp/3.txt
      when: result | skipped
</code></pre><ul>
<li>item</li>
</ul>
<p>item 迭代：当有需要重复性执行的任务时，可以使用迭代机制。其使用格式为将需要迭代的内容定义为item变量引用，并通过with_items语句来指明迭代的元素列表即可</p>
<pre><code>- name: install base software
  apt: pkg={{ item }} state=present force=yes
  with_items:
    - gcc
    - g++
    - mysql-client-5.5
    - libmcrypt-dev
    - libmysqlclient-dev
    - libgmp10
    - vim
    - openssh-client
    - ethtool
when: ansible_distribution == &apos;Debian&apos; or ansible_distribution == &apos;Ubuntu&apos;
</code></pre><ul>
<li>tag</li>
</ul>
<p>tag标签：让用户选择运行playbook中的某个或某些任务。虽然ansible具有幂等性，会跳过没有变化的部分，有些代码为测试其确实没有发生变化，也会耗费很长时间。我们将playbook中的指定任务打上标签，在运行playbook时指定标签名称，这样就不用运行全部代码了。</p>
<pre><code>---
- hosts: 10.249.6.43
  user: root
  vars:
    remote_conffile_path: /etc/nginx/sites-enabled/mirror.conf
  tasks:
  - name: install nginx
    apt: name=nginx state=latest
    when: ansible_distribution == &apos;Ubuntu&apos;

  - name: configration file
    tags: conf
    copy: src=/root/mirror.conf dest={{remote_conffile_path}}
    notify: restart nginx

  - name: start nginx
    service: name=nginx enabled=yes state=started
  handlers:
  - name: restart nginx
    service: name=nginx state=restarted
    # ansible-playbook nginx.yml -t conf   // 只执行tags部分
</code></pre><h3 id="六、roles"><a href="#六、roles" class="headerlink" title="六、roles"></a>六、roles</h3><p>roles 用于层次性、结构化地组织playbook。</p>
<p>roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。</p>
<pre><code># ls
deploy_hosts  deploy.yml  roles  run.sh
# cat deploy_hosts   //主机或主机组列表
[web]
10.126.83.30
10.126.93.83
[db]
10.126.87.150
10.126.92.89
# cat deploy.yml  // 总的playbook 调用roles
---
- name: init for os
  hosts: web
  user: root
  gather_facts: True
  roles:
    - init
    - raid
- name: init for os
  hosts: db
  user: root
  gather_facts: True
  roles:
    - init
    - raid
    - db_init

# cat run.sh  // 运行playbook脚本
#!/bin/bash
/usr/bin/ansible-playbook -i ./deploy_hosts deploy.yml
# ls roles/
db_init   init    raid 
</code></pre><p>在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录，用不到的目录可以创建为空目录，也可以不创建。</p>
<p>role内各目录中可用的文件:</p>
<ul>
<li><p>tasks目录：至少应该包含一个名为main.yml的文件，其定义了此角色的任务列表；此文件可以使用include包含其它的位于此目录中的task文件</p>
</li>
<li><p>files目录：存放由copy或script等模块调用的静态文件</p>
</li>
<li><p>templates目录：template模块会自动在此目录中寻找Jinja2模板文件</p>
</li>
<li><p>handlers目录：此目录中应当包含一个main.yml文件，用于定义此角色用到的各handler；此文件可以使用include包含其它的位于此目录中的handler文件</p>
</li>
<li><p>vars目录：至少有一个main.yml文件，用于定义此角色用到的变量</p>
</li>
<li><p>meta目录：至少有一个main.yml文件，用于定义此角色的特殊设定及其依赖关系；ansible 1.3及其以后的版本才支持</p>
</li>
<li><p>default目录：为当前角色设定默认变量时使用此目录；应当包含一个main.yml文件</p>
</li>
</ul>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="http://9124573.blog.51cto.com/9114573/1769887" target="_blank" rel="external">轻量级自动化运维工具ansible</a></p>
<p><a href="http://docs.ansible.com/ansible/intro.html" target="_blank" rel="external">ansible doc</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;一、体系结构&quot;&gt;&lt;a href=&quot;#一、体系结构&quot; class=&quot;headerlink&quot; title=&quot;一、体系结构&quot;&gt;&lt;/a&gt;一、体系结构&lt;/h3&gt;&lt;p&gt;ansible是一款基于python开发，揉合了众多自动化运维工具功能的轻量级自动化运维工具，目前实现了除系
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="ansible" scheme="http://yoursite.com/tags/ansible/"/>
    
  </entry>
  
  <entry>
    <title>nc小知识</title>
    <link href="http://yoursite.com/2016/05/05/nc/"/>
    <id>http://yoursite.com/2016/05/05/nc/</id>
    <published>2016-05-05T13:18:40.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="远程拷贝文件"><a href="#远程拷贝文件" class="headerlink" title="远程拷贝文件"></a>远程拷贝文件</h3><p>server1: 10.48.156.8</p>
<p>server2: 10.249.6.43</p>
<p><strong>从server1拷贝文件到server2</strong></p>
<p>先在server2上激活监听：</p>
<pre><code># nc -lp 1234 &gt; file.txt
</code></pre><blockquote>
<p>-l：使用监听模式，监控传入的资料</p>
<p>-p &lt;通信端口&gt;：设置本地主机使用的通信端口</p>
</blockquote>
<p>然后server1上运行：</p>
<pre><code># ll file.txt
-rw-r--r-- 1 root root 35 May  5 20:43 file.txt
# nc 10.249.6.43  1234 &lt; file.txt
</code></pre><h3 id="传输目录"><a href="#传输目录" class="headerlink" title="传输目录"></a>传输目录</h3><p><strong>从server1拷贝MySQL-python-1.2.3目录内容到server2上</strong></p>
<p>先在server2上激活监听：</p>
<pre><code># nc -l 1234 | tar xzvf -
</code></pre><p>然后server1上运行：</p>
<pre><code># ll -d MySQL-python-1.2.3
drwxrwxr-x 3 500 500 4096 Jan  3 18:13 MySQL-python-1.2.3
# tar czvf - MySQL-python-1.2.3 | nc 10.249.6.43 1234
</code></pre><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><pre><code># nc localhost -z 22   //扫描本机端口
Connection to localhost 22 port [tcp/ssh] succeeded!
# nc 10.126.93.2 -z 80  //扫描远程机器端口
Connection to 10.126.93.2 80 port [tcp/http] succeeded!
# nc -v 10.126.93.2 -z 1-100  //指示扫描过程    
</code></pre><blockquote>
<p>-v：显示指令执行过程</p>
<p>-z：使用0输入/输出模式，只在扫描通信端口时使用</p>
<p>-w &lt;超时秒数&gt;：设置等待连线的时间</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;远程拷贝文件&quot;&gt;&lt;a href=&quot;#远程拷贝文件&quot; class=&quot;headerlink&quot; title=&quot;远程拷贝文件&quot;&gt;&lt;/a&gt;远程拷贝文件&lt;/h3&gt;&lt;p&gt;server1: 10.48.156.8&lt;/p&gt;
&lt;p&gt;server2: 10.249.6.43&lt;/p&gt;
&lt;
    
    </summary>
    
      <category term="Cmd" scheme="http://yoursite.com/categories/Cmd/"/>
    
    
      <category term="nc" scheme="http://yoursite.com/tags/nc/"/>
    
  </entry>
  
  <entry>
    <title>Create A .deb Package Repository</title>
    <link href="http://yoursite.com/2016/03/08/Create-A-deb-Package-Repository/"/>
    <id>http://yoursite.com/2016/03/08/Create-A-deb-Package-Repository/</id>
    <published>2016-03-08T06:22:22.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Install-Reprepro-and-Generate-Key"><a href="#Install-Reprepro-and-Generate-Key" class="headerlink" title="Install Reprepro and Generate Key"></a>Install Reprepro and Generate Key</h3><p>安装软件包并生成密钥</p>
<pre><code># sudo apt-get  install reprepro gnupg -y
</code></pre><p>创建gpg key需要大量的随机操作，使用rng-tools产生大量随机操作    </p>
<pre><code># apt-get install rng-tools -y

# vim /etc/default/rng-tools   

[...]

HRNGDEVICE=/dev/urandom

[...]

# /etc/init.d/rng-tools start
</code></pre><p>Generate a gpg key using gnupg  </p>
<pre><code># gpg --gen-key
......
Please select what kind of key you want:
(1) RSA and RSA (default)
(2) DSA and Elgamal
(3) DSA (sign only)
(4) RSA (sign only)
Your selection? 4
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
        0 = key does not expire
    &lt;n&gt;  = key expires in n days
    &lt;n&gt;w = key expires in n weeks
    &lt;n&gt;m = key expires in n months
    &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y

You need a user ID to identify your key; the software constructs the user ID
from the Real Name, Comment and Email Address in this form:
 &quot;Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;&quot;

Real name: Mr-zhao
Email address: zhifanzhao@gmail.com
Comment: ops deb
Enter passphrase:****
You selected this USER-ID:
    &quot;Mr-zhao (ops deb) &lt;zhifanzhao@gmail.com&gt;&quot;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
You need a Passphrase to protect your secret key.

You don&apos;t want a passphrase - this is probably a *bad* idea!
I will do it anyway.  You can change your passphrase at any time,
using this program with the option &quot;--edit-key&quot;.

We need to generate a lot of random bytes.
 It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy.

......
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key D94F748F marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   4096R/D94F748F 2016-03-08
    Key fingerprint = 7D96 2419 19C6 B7C3 7F97  F4BB 63BF 6A4F D94F 748F
uid                  Mr-zhao (ops deb) &lt;zhifanzhao@gmail.com&gt;

Note that this key cannot be used for encryption.  You may want to use
the command &quot;--edit-key&quot; to generate a subkey for this purpose. 
</code></pre><p>查看和修改 gpg key</p>
<pre><code># gpg --list-keys
/root/.gnupg/pubring.gpg
------------------------
pub   4096R/D94F748F 2016-03-08
uid                  Mr-zhao (ops deb) &lt;zhifanzhao@gmail.com&gt;

# gpg --edit-key
usage: gpg [options] --edit-key user-id [commands]
</code></pre><h3 id="Create-a-Package-Repository-and-Export-Key"><a href="#Create-a-Package-Repository-and-Export-Key" class="headerlink" title="Create a Package Repository and Export Key"></a>Create a Package Repository and Export Key</h3><pre><code># cd /data
# mkdir apt
# mkdir -p ./apt/conf

#vim  ./apt/conf/distributions
Origin:        ops-ubuntu
Label:         ops-ubuntu
Suite:         trusty
Codename:      trusty
Version:       14.04
Architectures: amd64 i386
Components:    main restricted multiverse universe
Description:   private main deb repository for trusty
SignWith: yes

#vim ./apt/conf/options   //reprepro --options命令的集合
verbose
basedir  .
ask-passphrase
distdir  /data/apt/repos/dists   //dist文件的输出位置
outdir   /data/apt/repos    //pool输出的位置
</code></pre><p>Create the repository tree</p>
<pre><code># reprepro --ask-passphrase -Vb /data/apt/ export
</code></pre><p>Export Key</p>
<pre><code># gpg --armor --export Mr-zhao zhifanzhao@gmail.com &gt;&gt; ./repos/public.key
</code></pre><h3 id="Add-Packages-to-Newly-Created-Repository"><a href="#Add-Packages-to-Newly-Created-Repository" class="headerlink" title="Add Packages to Newly Created Repository"></a>Add Packages to Newly Created Repository</h3><pre><code>#reprepro -b . -C main includedeb trusty /tmp/packages.deb  //add

#reprepro remove trusty packages   //remove 
</code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.tecmint.com/create-deb-pacakge-repository-in-ubuntu/" target="_blank" rel="external">Create A .deb Package Repository</a><br><a href="https://wikitech.wikimedia.org/wiki/Reprepro" target="_blank" rel="external">wiki reprepro</a><br><a href="https://wiki.debian.org/SecureApt" target="_blank" rel="external">SecureApt)</a><br><a href="http://irtfweb.ifa.hawaii.edu/~lockhart/gpg/" target="_blank" rel="external">gpg-cheat</a><br><a href="http://www.ruanyifeng.com/blog/2013/07/gpg.html" target="_blank" rel="external">gpg</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Install-Reprepro-and-Generate-Key&quot;&gt;&lt;a href=&quot;#Install-Reprepro-and-Generate-Key&quot; class=&quot;headerlink&quot; title=&quot;Install Reprepro and Gener
    
    </summary>
    
      <category term="Ops" scheme="http://yoursite.com/categories/Ops/"/>
    
    
      <category term="deb" scheme="http://yoursite.com/tags/deb/"/>
    
      <category term="reprepro" scheme="http://yoursite.com/tags/reprepro/"/>
    
  </entry>
  
  <entry>
    <title>free查看内存相关信息</title>
    <link href="http://yoursite.com/2016/03/03/free/"/>
    <id>http://yoursite.com/2016/03/03/free/</id>
    <published>2016-03-03T11:02:23.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><h4 id="manual-description"><a href="#manual-description" class="headerlink" title="manual description"></a>manual description</h4><blockquote>
<p>free  displays  the total amount of free and used physical and swap memory in the system, as well as the buffers used bythe kernel.</p>
<p>The shared memory column represents either the MemShared value (2.4 series kernels) or the Shmem value (2.6 series kernels and later) taken from the /proc/meminfo file. The value is zero if none of the entries is exported by the kernel.</p>
</blockquote>
<h4 id="buffers-and-cached"><a href="#buffers-and-cached" class="headerlink" title="buffers and cached"></a>buffers and cached</h4><blockquote>
<p><strong>What is the difference between buffers and Cache?</strong></p>
<p>A buffer is a temporary location to store data for a particular application and this data is not used by any other application. This is similar to bandwidth concept. When you try to send burst of data through network, if your network card is capable of sending less data, it will keep these huge amounts of data in buffer so that it can send data constantly in lesser speeds. In other hand Cache is a memory location to store frequently used data for faster access. Other difference between a buffer and a cache is that cache can be used multiple times where as buffer is used single time. And both are temporary store for your data processing.</p>
</blockquote>
<ul>
<li>A buffer is something that has yet to be “written” to disk.</li>
<li>A cache is something that has been “read” from the disk and stored for later use.</li>
</ul>
<p>buffer是用于存放要输出到disk（块设备）的数据的，而cache是存放从disk上读出的数据。   这二者是为了提高IO性能的。为了提高IO read的性能，总是要多cache一些数据，这也就是为什么cached memor比较大，而比较小的原因。</p>
<pre><code>root@Mr-zhao:~# free -m
             total       used       free     shared    buffers     cached
Mem:          2001        979       1021          0         58        774
-/+ buffers/cache:        146       1854
Swap:         4092          0       4092
</code></pre><p>当我们第一次读一个大文件时耗时可能会比第二次长，原因就是第二次读取时已有cache数据。</p>
<ul>
<li><p>-/+ buffers/cache(used): 表示一个应用程序认为系统被用掉多少内存；</p>
<p>  -/+ buffers/cache(used) = Mem(used) – Mem(buffers) – Mem(cached)</p>
</li>
<li><p>-/+ buffers/cache(free)，表示一个应用程序认为系统还有多少内存；</p>
<p>  -/+ buffers/cache(free) = Mem(free) + Mem(buffers) + Mem(cached)</p>
</li>
</ul>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="http://www.cnblogs.com/coldplayerest/archive/2010/02/20/1669949.html" target="_blank" rel="external">Linux上的free命令详解</a><br><a href="http://www.freelinuxconsole.info/understanding-free-command-in-linuxunix-2/" target="_blank" rel="external">Understanding free command in Linux/Unix</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;free&quot;&gt;&lt;a href=&quot;#free&quot; class=&quot;headerlink&quot; title=&quot;free&quot;&gt;&lt;/a&gt;free&lt;/h3&gt;&lt;h4 id=&quot;manual-description&quot;&gt;&lt;a href=&quot;#manual-description&quot; class=&quot;
    
    </summary>
    
      <category term="Cmd" scheme="http://yoursite.com/categories/Cmd/"/>
    
    
      <category term="free" scheme="http://yoursite.com/tags/free/"/>
    
  </entry>
  
  <entry>
    <title>minicom的使用</title>
    <link href="http://yoursite.com/2016/02/28/minicom/"/>
    <id>http://yoursite.com/2016/02/28/minicom/</id>
    <published>2016-02-28T13:21:34.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="minicom的介绍"><a href="#minicom的介绍" class="headerlink" title="minicom的介绍"></a>minicom的介绍</h3><p>Linux下的Minicom的功能与Windows下的超级终端功能相似，<strong>可以通过串口控制外部的硬件设备</strong>，适于在linux通过超级终端对嵌入式设备行管理。</p>
<h3 id="minicom的安装配置和使用"><a href="#minicom的安装配置和使用" class="headerlink" title="minicom的安装配置和使用"></a>minicom的安装配置和使用</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><pre><code># apt-get install minicom
</code></pre><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p> 实际案例：交换机的consle转usb口连接到服务器，通过minicom对交换机进行配置</p>
<pre><code># lsusb   //查看USB的状态
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 002 Device 002: ID 0e0f:0003 VMware, Inc. Virtual Mouse
Bus 002 Device 003: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 002 Device 004: ID 0e0f:0008 VMware, Inc.
Bus 002 Device 005: ID 067b:2303 Prolific Technology, Inc. PL2303 Serial Port

# dmesg |grep ttyUSB  //USB已经连接
[11991.918691] usb 2-2.2: pl2303 converter now attached to ttyUSB0

# minicom -s   //进行配置

+-----[configuration]------+
| Filenames and paths      |
| File transfer protocols  |
| Serial port setup        |
| Modem and dialing        |
| Screen and keyboard      |
| Save setup as dfl        |
| Save setup as..          |
| Exit                     |
| Exit from Minicom        |
+--------------------------+

#选择进入Serial port setup，按照之前查看的信息进行配置

+-----------------------------------------------------------------------+
| A -    Serial Device      : /dev/ttyUSB0                              |
| B - Lockfile Location     : /var/lock                                 |
| C -   Callin Program      :                                           |
| D -  Callout Program      :                                           |
| E -    Bps/Par/Bits       : 115200 8N1                                |
| F - Hardware Flow Control : Yes                                       |
| G - Software Flow Control : No                                        |
|                                                                       |
|    Change which setting?                                              |
+-----------------------------------------------------------------------+
    | Screen and keyboard      |
    | Save setup as dfl        |
    | Save setup as..          |
    | Exit                     |
    | Exit from Minicom        |
    +--------------------------+

#Enter退出，选择Save setup as dfl  保存为默认配置
</code></pre><p>  然后进入终端输入minicom 就能连接进入交换机配置</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;minicom的介绍&quot;&gt;&lt;a href=&quot;#minicom的介绍&quot; class=&quot;headerlink&quot; title=&quot;minicom的介绍&quot;&gt;&lt;/a&gt;minicom的介绍&lt;/h3&gt;&lt;p&gt;Linux下的Minicom的功能与Windows下的超级终端功能相似，&lt;s
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="minicom" scheme="http://yoursite.com/tags/minicom/"/>
    
  </entry>
  
  <entry>
    <title>ulimit小记</title>
    <link href="http://yoursite.com/2016/02/25/ulimit/"/>
    <id>http://yoursite.com/2016/02/25/ulimit/</id>
    <published>2016-02-25T11:11:45.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ulimit简介"><a href="#ulimit简介" class="headerlink" title="ulimit简介"></a>ulimit简介</h3><p>ulimit 用于限制 shell 启动进程所占用的资源，支持以下各种类型的限制：所创建的内核文件的大小、进程数据块的大小、Shell 进程创建文件的大小、内存锁住的大小、常驻内存集的大小、打开文件描述符的数量、分配堆栈的最大大小、CPU 时间、单个用户的最大线程数、Shell 进程所能使用的最大虚拟内存。同时，它支持硬资源和软资源的限制。</p>
<p>作为临时限制，ulimit 可以作用于通过使用其命令登录的 shell 会话，在会话终止时便结束限制，并不影响于其他 shell 会话。而对于长期的固定限制，ulimit 命令语句又可以被添加到由登录 shell 读取的文件中，作用于特定的 shell 用户。</p>
<h3 id="ulimit的设置"><a href="#ulimit的设置" class="headerlink" title="ulimit的设置"></a>ulimit的设置</h3><pre><code>[root@Mr-zhao ~]# ulimit  -a    //查看当前配置文件ulimit全局系数
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7389
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 10240
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 10240
cpu time               (seconds, -t) unlimited
max user processes              (-u) 10240
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
</code></pre><p>对于线上环境的机器一般要对<code>open files</code>和<code>max user processes</code>进行修改。</p>
<h4 id="临时性的修改，只对当前shell生效。"><a href="#临时性的修改，只对当前shell生效。" class="headerlink" title="临时性的修改，只对当前shell生效。"></a>临时性的修改，只对当前shell生效。</h4><pre><code>ulimit  -n 65535
ulimit  -u 65535
</code></pre><h4 id="想要ulimit的设置永久性生效，需要修改-etc-security-limits-conf文件。"><a href="#想要ulimit的设置永久性生效，需要修改-etc-security-limits-conf文件。" class="headerlink" title="想要ulimit的设置永久性生效，需要修改/etc/security/limits.conf文件。"></a>想要ulimit的设置永久性生效，需要修改/etc/security/limits.conf文件。</h4><p>对于centos系统/etc/security/limits.d/90-nproc.conf文件的优先级高于/etc/security/limits.conf，所以对全局的设定需修改90-nproc.conf文件。对于单个用户的ulimit的设置并不受etc/security/limits.d/90-nproc.conf影响。</p>
<p>对于ubuntu系统，只需对/etc/security/limits.conf文件进行修改，ubuntu系统没有引入90-nproc.conf文件。但是ubuntux系统也会存在一个问题，就是对全局的设置其实对于root用户是没有效果的。所以ubuntu系统下的设置如下：</p>
<pre><code>root@Mr-zhao:~# grep -Ev &quot;^$|^#&quot; /etc/security/limits.conf
root - nofile 65535
root - nproc  65535
* - nofile 65535
* - nproc 65535
</code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/" target="_blank" rel="external">通过 ulimit 改善系统性能</a><br><a href="http://ss64.com/bash/limits.conf.html" target="_blank" rel="external">limits.conf - configuration file</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;ulimit简介&quot;&gt;&lt;a href=&quot;#ulimit简介&quot; class=&quot;headerlink&quot; title=&quot;ulimit简介&quot;&gt;&lt;/a&gt;ulimit简介&lt;/h3&gt;&lt;p&gt;ulimit 用于限制 shell 启动进程所占用的资源，支持以下各种类型的限制：所创建的内
    
    </summary>
    
      <category term="Ops" scheme="http://yoursite.com/categories/Ops/"/>
    
    
      <category term="ulimit" scheme="http://yoursite.com/tags/ulimit/"/>
    
  </entry>
  
  <entry>
    <title>MySQL主从复制备忘</title>
    <link href="http://yoursite.com/2016/01/15/mysql-duplicate/"/>
    <id>http://yoursite.com/2016/01/15/mysql-duplicate/</id>
    <published>2016-01-15T13:43:35.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li><p>Master:10.249.17.38</p>
</li>
<li><p>Slave:10.249.17.45</p>
</li>
</ul>
<h3 id="主从复制的原理"><a href="#主从复制的原理" class="headerlink" title="主从复制的原理"></a>主从复制的原理</h3><ul>
<li>主从复制的步骤</li>
</ul>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/94D51A80-A0DB-4189-8F30-673260AC6FCC.png" alt=""></p>
<p>1.master将改变记录到二进制日志(binary log)</p>
<p>2.slave将master的binary log events(二进制日志事件)拷贝到它的中继日志(relay log)</p>
<p>3.slave重做中继日志中的事件，将改变反映它自己的数据。</p>
<h3 id="主从复制类型"><a href="#主从复制类型" class="headerlink" title="主从复制类型"></a>主从复制类型</h3><ul>
<li>基于语句的复制：</li>
</ul>
<p>在主服务器上执行的SQL语句，在从服务器上执行同样的语句。MySQL默认采用基于语句的复制，效率比较高。一旦发现没法精确复制时，会自动选着基于行的复制。</p>
<ul>
<li>基于行的复制：</li>
</ul>
<p>把改变的内容复制过去，而不是把命令在从服务器上执行一遍. 从mysql5.0开始支持。</p>
<ul>
<li>混合类型的复制:</li>
</ul>
<p>默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制。</p>
<h3 id="配置Master和Slave"><a href="#配置Master和Slave" class="headerlink" title="配置Master和Slave"></a>配置Master和Slave</h3><h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><pre><code>mysqladmin -u root -p password 123  // 修改密码
mysql&gt; grant replication slave,replication client on *.* to  zzf@10.249.17.45 identified by &quot;zzf&quot;;  //建立内部复制用户

编辑/etc/my.cnf 文件
server_id=1
log-bin=mysql-bin

重启服务
</code></pre><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/BAC-9068-D8174D803F18.png" alt=""></p>
<h4 id="Slave"><a href="#Slave" class="headerlink" title="Slave"></a>Slave</h4><pre><code>mysqladmin -u root -p password 123  // 修改密码
编辑/etc/my.cnf 文件
server_id=2
log-bin=mysql-bin
log_slave_updates=1

mysql&gt; change master to master_host=&apos;10.249.17.38&apos;,master_user=&apos;zzf&apos;,master_password=&apos;zzf&apos;,master_log_file=&apos;mysql-bin.000002&apos;,master_log_pos=106;
mysql&gt; start slave;
</code></pre><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/F2D3964D-8081-4F27-ACFF-39ADF603CCDB.png" alt=""></p>
<p>Slave_IO_Running: Yes</p>
<p>Slave_SQL_Running: Yes</p>
<h3 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h3><h4 id="Master-1"><a href="#Master-1" class="headerlink" title="Master"></a>Master</h4><pre><code>mysql&gt;
mysql&gt; create database zzf;
Query OK, 1 row affected (0.01 sec)
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| test               |
| zzf                |
+--------------------+
4 rows in set (0.00 sec)
</code></pre><h4 id="Slave-1"><a href="#Slave-1" class="headerlink" title="Slave"></a>Slave</h4><pre><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| test               |
| zzf                |
+--------------------+
4 rows in set (0.00 sec)
</code></pre><p>已经同步成功</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Master:10.249.17.38&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Slave:10.249.17.45&lt;/p&gt;
&lt;
    
    </summary>
    
      <category term="SQL" scheme="http://yoursite.com/categories/SQL/"/>
    
    
      <category term="MySQL" scheme="http://yoursite.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Create A Local Debian/Ubuntu Mirror With apt-mirror</title>
    <link href="http://yoursite.com/2016/01/09/Create-A-Local-Debian-Ubuntu-Mirror-With-apt-mirror/"/>
    <id>http://yoursite.com/2016/01/09/Create-A-Local-Debian-Ubuntu-Mirror-With-apt-mirror/</id>
    <published>2016-01-09T14:18:45.000Z</published>
    <updated>2016-11-07T05:14:48.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Install-and-Configure-apt-mirror"><a href="#Install-and-Configure-apt-mirror" class="headerlink" title="Install and Configure apt-mirror"></a>Install and Configure apt-mirror</h3><p>Install apt-mirror</p>
<pre><code>$ sudo apt-get install apt-mirror
</code></pre><p>Configure apt-mirror</p>
<p>编辑配置文件/etc/apt/mirror.list，以ubuntu 14.04 为例：</p>
<pre><code>############# config ##################

#

set base_path      /var/spool/apt-mirror

#

set mirror_path    /data/mirror

set skel_path   $base_path/skel

set var_path   $base_path/var

set cleanscript  $var_path/clean.sh      #这个脚本会记录每次同步后那些需要删除的文件

# set defaultarch

# set postmirror_script $var_path/postmirror.sh

# set run_postmirror 0

set nthreads20#用20个线程去wget镜像

set _tilde 0

#

############# end config ##############

deb http://cn.archive.ubuntu.com/ubuntu trusty main restricted universe multiverse

deb http://cn.archive.ubuntu.com/ubuntu trusty-security main restricted universe multiverse

deb http://cn.archive.ubuntu.com/ubuntu trusty-updates main restricted universe multiverse

deb http://cn.archive.ubuntu.com/ubuntu trusty-proposed main restricted universe multiverse

deb http://cn.archive.ubuntu.com/ubuntu trusty-backports main restricted universe multiverse

deb-i386 http://cn.archive.ubuntu.com/ubuntu trusty main restricted universe multiverse

deb-i386 http://cn.archive.ubuntu.com/ubuntu trusty-security main restricted universe multiverse

deb-i386 http://cn.archive.ubuntu.com/ubuntu trusty-updates main restricted universe multiverse

deb-i386 http://cn.archive.ubuntu.com/ubuntu trusty-proposed main restricted universe multiverse

deb-i386 http://cn.archive.ubuntu.com/ubun trustytu-backports main restricted universe multiverse

# 如果这个源是要用来做pxe启动的话需要添加(因为默认没有将这几个文件同步过来)

deb http://cn.archive.ubuntu.com/ubuntu trusty main/debian-installer restricted/debian-installer universe/debian-installer multiverse/debian-installer

deb-i386 ttp://cn.archive.ubuntu.com/ubuntu trusty main/debian-installer restricted/debian-installer universe/debian-installer multiverse/debian-installer
</code></pre><p>镜像官方仓库所有软件</p>
<pre><code>$ sudo apt-mirror          
//apt-mirror成功后会执行/var/spool/apt-mirror/var/clean.sh完成同步后的清理工作
</code></pre><h3 id="源的升级与更新"><a href="#源的升级与更新" class="headerlink" title="源的升级与更新"></a>源的升级与更新</h3><p>日常升级</p>
<pre><code>$ sudo apt-mirror
</code></pre><p>计划任务自动更新</p>
<pre><code>0 4 * * * /usr/bin/apt-mirror &gt;&gt; /var/spool/apt-mirror/var/cron.log
</code></pre><h3 id="使用nginx搭建本地镜像源"><a href="#使用nginx搭建本地镜像源" class="headerlink" title="使用nginx搭建本地镜像源"></a>使用nginx搭建本地镜像源</h3><h4 id="nginx-安装配置"><a href="#nginx-安装配置" class="headerlink" title="nginx 安装配置"></a>nginx 安装配置</h4><p>nginx 安装</p>
<p>参考：<a href="http://nginx.org/en/docs/install.html" target="_blank" rel="external">官方文档</a></p>
<p>nginx 基本配置</p>
<p>编辑配置文件 /usr/local/nginx/conf/sites-enabled/mirror.conf</p>
<pre><code>server {
listen       80;
server_name  _;
root         /data/mirror/web;
autoindex    on;
}
</code></pre><p>在<code>/data/mirror/web</code>目录做一个镜像目录的软连接</p>
<pre><code>$ ln -s /data/mirror/archive.ubuntu.com/ubuntu/ /data/mirror/web/ubuntu
</code></pre><p>启动nginx服务</p>
<pre><code>$ sudo /usr/local/nginx/sbin/nginx -t
$ sudo /usr/local/nginx/sbin/nginx
</code></pre><p>本地测试</p>
<p>在浏览器输入搭建nginx机器IP，也可以配置域名访问</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/26720CDE-B91E-40F3-8D46-CAC92FAE90F2.png" alt=""></p>
<h3 id="客户端使用测试"><a href="#客户端使用测试" class="headerlink" title="客户端使用测试"></a>客户端使用测试</h3><p>编辑配置文件 /etc/apt/sources.list 或在/etc/apt/sources.list.d/ 目录下新建文件，并在文件最前面写入如下字段：</p>
<pre><code>deb http://10.249.17.26/ubuntu precise main universe
</code></pre><p>使用</p>
<pre><code>$ apt-get update
$ apt-get install (packagename)
</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Install-and-Configure-apt-mirror&quot;&gt;&lt;a href=&quot;#Install-and-Configure-apt-mirror&quot; class=&quot;headerlink&quot; title=&quot;Install and Configure apt-mi
    
    </summary>
    
      <category term="Ops" scheme="http://yoursite.com/categories/Ops/"/>
    
    
      <category term="ubuntu" scheme="http://yoursite.com/tags/ubuntu/"/>
    
      <category term="apt" scheme="http://yoursite.com/tags/apt/"/>
    
  </entry>
  
</feed>
