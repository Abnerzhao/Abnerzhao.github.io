<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Abnerzhao"><meta name="description" content="DevOps"><title>Abner</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/page/3/"><link rel="alternate" href="/atom.xml" title="Abner"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?5832f612aff8681e2ee213a3b8d9548b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Abner</a><ul class="nav"><li class="nav-link"><a href="/" class="active">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories/" target="_self">Categories</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><ul class="home"><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/05/05/nc/" class="post-link">nc小知识</a></h2><span class="post-time">May 5, 2016</span><div class="post-content"><h3 id="远程拷贝文件"><a href="#远程拷贝文件" class="headerlink" title="远程拷贝文件"></a>远程拷贝文件</h3><p>server1: 10.48.156.8</p>
<p>server2: 10.249.6.43</p>
<p><strong>从server1拷贝文件到server2</strong></p>
<p>先在server2上激活监听：</p>
<pre><code># nc -lp 1234 &gt; file.txt
</code></pre><blockquote>
<p>-l：使用监听模式，监控传入的资料</p>
<p>-p &lt;通信端口&gt;：设置本地主机使用的通信端口</p>
</blockquote>
<p>然后server1上运行：</p>
<pre><code># ll file.txt
-rw-r--r-- 1 root root 35 May  5 20:43 file.txt
# nc 10.249.6.43  1234 &lt; file.txt
</code></pre><h3 id="传输目录"><a href="#传输目录" class="headerlink" title="传输目录"></a>传输目录</h3><p><strong>从server1拷贝MySQL-python-1.2.3目录内容到server2上</strong></p>
<p>先在server2上激活监听：</p>
<pre><code># nc -l 1234 | tar xzvf -
</code></pre><p>然后server1上运行：</p>
<pre><code># ll -d MySQL-python-1.2.3
drwxrwxr-x 3 500 500 4096 Jan  3 18:13 MySQL-python-1.2.3
# tar czvf - MySQL-python-1.2.3 | nc 10.249.6.43 1234
</code></pre><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><pre><code># nc localhost -z 22   //扫描本机端口
Connection to localhost 22 port [tcp/ssh] succeeded!
# nc 10.126.93.2 -z 80  //扫描远程机器端口
Connection to 10.126.93.2 80 port [tcp/http] succeeded!
# nc -v 10.126.93.2 -z 1-100  //指示扫描过程    
</code></pre><blockquote>
<p>-v：显示指令执行过程</p>
<p>-z：使用0输入/输出模式，只在扫描通信端口时使用</p>
<p>-w &lt;超时秒数&gt;：设置等待连线的时间</p>
</blockquote>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/04/23/opennebula/" class="post-link">OpenNebula 4.14 快速入门</a></h2><span class="post-time">Apr 23, 2016</span><div class="post-content"><h3 id="一、OpenNebula简介"><a href="#一、OpenNebula简介" class="headerlink" title="一、OpenNebula简介"></a>一、OpenNebula简介</h3><ul>
<li>1.1 云管理平台的选择</li>
<li>1.2 OpenNebula体系结构</li>
<li>1.3 OpenNebula组件介绍</li>
</ul>
<h3 id="二、OpenNebula安装配置"><a href="#二、OpenNebula安装配置" class="headerlink" title="二、OpenNebula安装配置"></a>二、OpenNebula安装配置</h3><ul>
<li>2.1 环境说明</li>
<li>2.2 软件包组成</li>
<li>2.3 Server端安装和配置</li>
<li>2.4 节点端安装配置</li>
</ul>
<h3 id="三、节点添加"><a href="#三、节点添加" class="headerlink" title="三、节点添加"></a>三、节点添加</h3><ul>
<li>3.1 web界面添加主机</li>
<li>3.2 命令行添加主机<ul>
<li>3.2.1 onehost 命令</li>
</ul>
</li>
</ul>
<h3 id="四、制作系统镜像"><a href="#四、制作系统镜像" class="headerlink" title="四、制作系统镜像"></a>四、制作系统镜像</h3><ul>
<li>4.1 qemu-img命令</li>
<li>4.2 qemu-kvm（ kvm ）命令</li>
<li>4.3 系统优化</li>
</ul>
<h3 id="五、导入镜像"><a href="#五、导入镜像" class="headerlink" title="五、导入镜像"></a>五、导入镜像</h3><ul>
<li>5.1 web界面导入映像</li>
<li>5.2 命令行导入映像<ul>
<li>5.2.1 oneimg 命令</li>
</ul>
</li>
</ul>
<h3 id="六、虚拟网络"><a href="#六、虚拟网络" class="headerlink" title="六、虚拟网络"></a>六、虚拟网络</h3><ul>
<li>6.1 web界面添加虚拟网络</li>
<li>6.2 命令行添加虚拟网络<ul>
<li>6.2.1 onevnet 命令</li>
</ul>
</li>
</ul>
<h3 id="七、制作模板"><a href="#七、制作模板" class="headerlink" title="七、制作模板"></a>七、制作模板</h3><ul>
<li>7.1 web 界面制作模板</li>
<li>7.2 Context初始化功能<ul>
<li>7.2.1 修改母盘镜像</li>
</ul>
</li>
</ul>
<h3 id="八、创建虚拟机"><a href="#八、创建虚拟机" class="headerlink" title="八、创建虚拟机"></a>八、创建虚拟机</h3><ul>
<li>8.1 web界面创建虚拟机 </li>
</ul>
<h2 id="一、OpenNebula简介-1"><a href="#一、OpenNebula简介-1" class="headerlink" title="一、OpenNebula简介"></a>一、OpenNebula简介</h2><h3 id="1-1-云管理平台的选择"><a href="#1-1-云管理平台的选择" class="headerlink" title="1.1 云管理平台的选择"></a>1.1 云管理平台的选择</h3><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/5BA41662-3FBA-42C6-928C-4EB8B665BD4C.png" alt=""></p>
<p><strong>OpenNebula</strong></p>
<p>OpenNebula是一款功能丰富且灵活性非常强的解决方案，用于构建和管理企业云及数据中心虚拟化。OpenNebula支持Xen、KVM、VMware ESX虚拟化引擎，可以一起混合建立和管理私有云，同时还提供了Deltacloud适配器和Amazon EC2的API兼容。官方网站 <a href="http://opennebula.org/。" target="_blank" rel="external">http://opennebula.org/。</a></p>
<h3 id="1-2-OpenNebula体系结构"><a href="#1-2-OpenNebula体系结构" class="headerlink" title="1.2 OpenNebula体系结构"></a>1.2 OpenNebula体系结构</h3><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/039ED6D4-843B-4C7C-827E-88D680082A58.png" alt=""></p>
<h3 id="1-3-OpenNebula组件介绍"><a href="#1-3-OpenNebula组件介绍" class="headerlink" title="1.3 OpenNebula组件介绍"></a>1.3 OpenNebula组件介绍</h3><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/C7012638-A918-4D89-815C-15BAEAB2E735.png" alt=""></p>
<p><strong>Front-End（前端）</strong></p>
<p>用于运行OpenNebula服务。包含了诸多功能组件，如OpenNebula管理进程oned、调度器mm_sched、一个Web接口服务sunstone-server。</p>
<p><strong>Host（宿主机）</strong></p>
<p>用于运行所有虚拟机</p>
<p><strong>Datastores（数据存储）</strong></p>
<p>用于实际存放虚拟机的硬盘，可以是任意一种存储介质，NAS（网络附加存储）、SAN（存储区域网络）、直连存储设备（宿主机本地硬盘）。<br>数据存储可以细分为三大类：</p>
<ul>
<li>系统数据存储</li>
<li>镜像数据存储</li>
<li>文件数据存储</li>
</ul>
<p><strong>Network（网络）</strong></p>
<h2 id="二、OpenNebula安装配置-1"><a href="#二、OpenNebula安装配置-1" class="headerlink" title="二、OpenNebula安装配置"></a>二、OpenNebula安装配置</h2><h3 id="2-1-环境说明"><a href="#2-1-环境说明" class="headerlink" title="2.1 环境说明"></a>2.1 环境说明</h3><p>系统环境：ubuntu 14.04</p>
<p>OpenNebula版本：4.14</p>
<h3 id="2-2-软件包组成"><a href="#2-2-软件包组成" class="headerlink" title="2.2 软件包组成"></a>2.2 软件包组成</h3><p>从官网下载源码包或使用OpenNebula源，添加 OpenNebula 源方法如下:</p>
<pre><code># wget -q -O- http://downloads.opennebula.org/repo/Ubuntu/repo.key | apt-key add -
# echo &quot;deb http://downloads.opennebula.org/repo/4.14/Ubuntu/14.04/ stable opennebula&quot; \
&gt; /etc/apt/sources.list.d/opennebula.list
</code></pre><p>OpenNebula主要由以下软件包组成：</p>
<ul>
<li>opennebula-common  Provides the user and common files</li>
<li>ruby-opennebula: All ruby libraries</li>
<li>opennebula-node: Prepares a node as an opennebula-node</li>
<li>opennebula-sunstone: OpenNebula Sunstone Web Interface</li>
<li>opennebula-tools: Command Line interface</li>
<li>opennebula-gate: Gate server that enables communication between VMs and OpenNebula</li>
<li>opennebula-flow: Manages services and elasticity</li>
<li>libopennebula-java: Java Language bindings for OpenNebula API</li>
<li>opennebula: OpenNebula Daemon</li>
<li>libopennebula-java: Java Language bindings for OpenNebula API</li>
</ul>
<h3 id="2-3-Server端安装和配置"><a href="#2-3-Server端安装和配置" class="headerlink" title="2.3 Server端安装和配置"></a>2.3 Server端安装和配置</h3><p>上文已经配置好了OpenNebula 的源,安装方法如下:</p>
<pre><code># apt-get install opennebula opennebula-sunstone -y
</code></pre><p>安装完成之后检查创建的用户以及目录文件：</p>
<pre><code># grep oneadmin /etc/passwd
oneadmin:x:9869:9869::/var/lib/one:/bin/bash
# ls -ld /etc/one/
drwxr-xr-x 8 root root 4096 Apr 23 16:22 /etc/one/
# ls /etc/init.d/opennebula*
/etc/init.d/opennebula        /etc/init.d/opennebula-novnc
/etc/init.d/opennebula-econe  /etc/init.d/opennebula-sunstone
# ls -ld /var/log/one/
drwxr-xr-x 2 oneadmin oneadmin 4096 Apr 23 16:22 /var/log/one/
</code></pre><p>默认 OpenNebula 使用数据库为sqlite,如果需要使用 MySQL,则需要做如下操作:</p>
<p>1.创建opennebula数据库</p>
<pre><code>mysql&gt; create database opennebula;
Query OK, 1 row affected (0.00 sec)

mysql&gt; grant all privileges on opennebula.* to oneadmin@&apos;localhost&apos; identified by &apos;oneadmin&apos;;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)
</code></pre><p>2.修改配置文件</p>
<pre><code># vi /etc/one/oned.conf
......
#DB = [ backend = &quot;sqlite&quot; ]
# Sample configuration for MySQL 

DB = [ backend = &quot;mysql&quot;,
   server  = &quot;localhost&quot;,
   port    = 3306,
   user    = &quot;oneadmin&quot;,
   passwd  = &quot;oneadmin&quot;,
   db_name = &quot;opennebula&quot; ]
......
</code></pre><p>修改 sunstone 默认监听 IP:</p>
<pre><code># grep &apos;:host&apos; /etc/one/sunstone-server.conf
:host: 127.0.0.1
# sed -i &apos;/:host/s/127.0.0.1/10.249.7.247/g&apos; /etc/one/sunstone-server.conf
# grep &apos;:host&apos; /etc/one/sunstone-server.conf
:host: 10.249.7.247
</code></pre><p>启动相关服务:</p>
<pre><code># /etc/init.d/opennebula start
# /etc/init.d/opennebula-sunstone  start
# lsof -i:9869
COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
ruby    15387 oneadmin    8u  IPv4  50024      0t0  TCP 10.249.7.247:9869 (LISTEN)
</code></pre><p>修改datastore：</p>
<p>OpenNebula 默认用的是 Shared Transfer Driver,这种模式比较适合快速部署和热迁移,但是要配置网络文件系统。由于我们这里并没有配置网络文件系统,暂时也无法做热迁移,那么可以换成 SSH Transfer Driver 测试部署。</p>
<pre><code># onedatastore list
ID NAME                SIZE AVAIL CLUSTER      IMAGES TYPE DS      TM      STAT
0 system                0M -     -                 0 sys  -       shared  on
1 default             2.6T 95%   -                 0 img  fs      shared  on
2 files               2.6T 95%   -                 0 fil  fs      ssh     on
# onedatastore update 1
BASE_PATH=&quot;/var/lib/one//datastores/&quot;
CLONE_TARGET=&quot;SYSTEM&quot;
DISK_TYPE=&quot;FILE&quot;
DS_MAD=&quot;fs&quot;
LN_TARGET=&quot;SYSTEM&quot;
TM_MAD=&quot;ssh&quot;
TYPE=&quot;IMAGE_DS&quot;
# onedatastore list
ID NAME                SIZE AVAIL CLUSTER      IMAGES TYPE DS      TM      STAT
0 system                0M -     -                 0 sys  -       shared  on
1 default             2.6T 95%   -                 0 img  fs      ssh     on
2 files               2.6T 95%   -                 0 fil  fs      ssh     on
</code></pre><p>浏览器登陆测试: </p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/03030E96-598A-479F-9043-722559F20579.png" alt=""></p>
<p>用户名和密码通过以下方式获得:</p>
<pre><code># cat /var/lib/one/.one/one_auth
oneadmin:EcvubryacOv9
</code></pre><h3 id="2-4-节点端安装配置"><a href="#2-4-节点端安装配置" class="headerlink" title="2.4 节点端安装配置"></a>2.4 节点端安装配置</h3><p>opennebula的源的配置见Server端安装配置章节，节点端软件包安装如下：</p>
<pre><code># apt-get install opennebula-node  bridge-utils -y
</code></pre><p>安装过程同时会安装虚拟化相关组件,包括 bridge-utils、libvirt、 kvm、qemu-img 等。</p>
<p>网络配置：</p>
<p>eth0 为管理网口，eth1 为trunk口用作虚拟机通信，需要创建桥接网口。官方文档中提示需要手动创建桥接网络，但是本人在实际使用中通过web管理平台的虚拟网络可以实现自动绑定br0 到eth1网卡上。</p>
<pre><code># cat /etc/network/interfaces
auto lo
iface lo inet loopback
auto eth0
iface eth0 inet static
address 10.249.7.247
netmask 255.255.255.0
gateway 10.249.7.254
auto eth1
iface eth1 inet manual
# brctl show
bridge name bridge id       STP enabled interfaces
virbr0      8000.000000000000   yes
</code></pre><p>查看qemu的配置：</p>
<pre><code># cat /etc/libvirt/qemu.conf
user  = &quot;oneadmin&quot;
group = &quot;oneadmin&quot;
dynamic_ownership = 0
</code></pre><p>启动libvirt服务：</p>
<pre><code># service libvirt-bin restart
</code></pre><p>ssh 无密码登陆:</p>
<p>管理端：</p>
<pre><code># su - oneadmin
$ cat &lt;&lt; EOT &gt; ~/.ssh/config    //不询问直接添加主机到known_hosts文件
Host *
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
EOT
$ chmod 600 ~/.ssh/config
</code></pre><p>节点端：</p>
<pre><code>￼# su - oneadmin
$ vim  ~/.ssh/authorized_key   //把管理端ssh公钥加入节点.ssh/authorized_keys文件
$ chmod 400 .ssh/authorized_keys
</code></pre><h2 id="三、节点添加-1"><a href="#三、节点添加-1" class="headerlink" title="三、节点添加"></a>三、节点添加</h2><p>节点配置完成之后便可以在 Server 端添加了,可以使用web 添加,也可以在命令行中添加。</p>
<h3 id="3-1-web界面添加主机"><a href="#3-1-web界面添加主机" class="headerlink" title="3.1 web界面添加主机"></a>3.1 web界面添加主机</h3><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/907F38A5-3CA1-4424-8867-BA815E3EE4D6.png" alt=""></p>
<p>创建主机,主机名一栏可以是IP也可以是可以解析的主机域名,这里使用的是IP</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/7250BDBA-1EAE-4750-9C93-5BD3D29A7263.png" alt=""></p>
<p>如上图选择完之后,点击创建按钮就可以出现如下主机,状态为初始化</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/02DF2945-100E-4846-8D66-297B86D3A8BD.png" alt=""></p>
<p>如果一切正常,等待片刻则状态就会变为开机,也会显示主机CPU和内存信息,如下图:</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/44D05DBE-D2D4-450B-BFC0-61E48606F944.png" alt=""></p>
<p>可以看到当前运行的VM数量是0，点击目标主机，可以查看主机的详细信息，如下图：</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/826BEA35-1853-4B62-A1B6-61F082DAD23F.png" alt=""></p>
<h3 id="3-2-命令行添加主机"><a href="#3-2-命令行添加主机" class="headerlink" title="3.2 命令行添加主机"></a>3.2 命令行添加主机</h3><h4 id="3-2-1-onehost-命令"><a href="#3-2-1-onehost-命令" class="headerlink" title="3.2.1  onehost 命令"></a>3.2.1  onehost 命令</h4><p>使用 onehost 命令删除之前 web 创建的主机,如下:</p>
<pre><code># su - oneadmin
$ onehost list
ID NAME            CLUSTER   RVM      ALLOCATED_CPU      ALLOCATED_MEM STAT
1 10.249.7.247    -           0      0 / 3200 (0%)   0K / 125.7G (0%) on
$ onehost delete 1
$ onehost list
ID NAME            CLUSTER   RVM      ALLOCATED_CPU      ALLOCATED_MEM STAT
</code></pre><p> 然后我们再使用 onehost 命令创建主机：</p>
<pre><code>$ onehost create   10.249.7.247 --im kvm --vm kvm --net dummy
ID: 2
$ onehost list
ID NAME            CLUSTER   RVM      ALLOCATED_CPU      ALLOCATED_MEM STAT
2 10.249.7.247    -           0                  -                  - init
$ onehost list
ID NAME            CLUSTER   RVM      ALLOCATED_CPU      ALLOCATED_MEM STAT
2 10.249.7.247    -           0      0 / 3200 (0%)   0K / 125.7G (0%) on
</code></pre><ul>
<li>-i, –im im_mad           Set the information driver for the host   //信息管理 driver. 可选: kvm, xen, vmware, ec2, ganglia, dummy.</li>
<li>-v, –vm vmm_mad          Set the virtualization driver for the host //虚拟化管理 driver. 可选: kvm, xen, vmware, ec2, dummy.</li>
<li>-n, –net vnet_mad        Set the network driver for the host  //虚拟网络driver.可选：802.1Q,dummy,ebtables,fw,ovswitch,vmware.</li>
</ul>
<p>了解更多 onehost 命令用法请查看man手册。</p>
<h2 id="四、制作系统镜像-1"><a href="#四、制作系统镜像-1" class="headerlink" title="四、制作系统镜像"></a>四、制作系统镜像</h2><p>虚拟机有多种镜像格式可供选择,常见的有如 raw、vdi、 qcow2、vmdk、qed、vhd 等格式。</p>
<p>虚拟机镜像和服务器之间的关系如下图所示：</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/2533DDFD-5676-437A-9788-B173ECE01179.png" alt=""></p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/4B51B99B-FF41-4806-839A-8927817F314C.png" alt=""></p>
<h3 id="4-1-qemu-img命令"><a href="#4-1-qemu-img命令" class="headerlink" title="4.1 qemu-img命令"></a>4.1 qemu-img命令</h3><p>qemu-img 是 QEMU 的磁盘管理工具,支持多种虚拟镜像格式。</p>
<pre><code># qemu-img  -h | grep Supported
Supported formats: vvfat vpc vmdk vhdx vdi sheepdog sheepdog sheepdog rbd raw host_cdrom host_floppy host_device file qed qcow2 qcow parallels nbd nbd nbd dmg tftp ftps ftp https http cow cloop bochs blkverify blkdebug
</code></pre><p>qemu-img 默认创建的格式是 raw，常用的格式为 raw、qcow2等。qemu-img常用的命令有：</p>
<pre><code># qemu-img check [-f fmt]  filename    //对磁盘镜像文件进行一致性检查,查找镜像文件中的错误,目前仅支持对“qcow2”、“qed”、“vdi”格式文件的检查。
# qemu-img create [-f fmt] filename [size]   //创建一个格式为 fmt 大小为 size 文件名为filename 的镜像文件。
# qemu-img info [-f fmt] filename  //显示 filename 镜像文件的信息。
</code></pre><p>这里我们使用 qemu-img 命令创建一个 50G 大小格式为 qcow2 的系统镜像：</p>
<pre><code># qemu-img  create -f qcow2 ubuntu14.04.qcow2 50G
</code></pre><p>关于 qemu-img 的更多高级用法可以参考 man 手册。</p>
<h3 id="4-2-qemu-kvm（-kvm-）命令"><a href="#4-2-qemu-kvm（-kvm-）命令" class="headerlink" title="4.2 qemu-kvm（ kvm ）命令"></a>4.2 qemu-kvm（ kvm ）命令</h3><p>在centos中该命令为 qemu-kvm, 而在ubuntu的系统中该命令为kvm，由于我的测试机为ubuntu的系统所以后面会使用到 kvm 命令。</p>
<p>安装系统：</p>
<pre><code># kvm -m 1024 -cdrom /work-space/ubuntu-14.04.3-server-amd64.iso \ 
-drive file=/work-space/ubuntu14.04.qcow2,if=virtio -net nic,model=virtio \
-net tap,script=no -boot d -nographic -vnc :0
</code></pre><p>以上参数释义如下，更多 kvm 的参数使用说明请参考 man 手册：</p>
<ul>
<li>-m  指定内存大小</li>
<li>-cdrom   指定系统 iso 镜像</li>
<li>-drive file=xx,if=xx   指定硬盘镜像,file=镜像文件名,if=镜像格式类型 </li>
<li>-net nic,model=xx   表示网卡配置,model=模拟网卡类型,默认 rt18139</li>
<li>-net tap,script=no   虚拟设备,桥接网络,script 表启动虚拟机自动执行网络配置脚本,<br>如果不需要启动,则写 no </li>
<li>-boot d  系统启动顺序,d表示表示cdrom </li>
<li>-nographic  关闭图形输出</li>
<li>-vnc:0 开启vnc监听</li>
</ul>
<p>输入以上命令之后,通过 VNC 客户端连接按照正常的安装流程安装系统即可：</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/E2156E2D-BF0F-4EFD-A37D-9E685DA900FD.png" alt=""></p>
<h3 id="4-3-系统优化"><a href="#4-3-系统优化" class="headerlink" title="4.3 系统优化"></a>4.3 系统优化</h3><p>在母盘上装好系统之后，可以进行一些优化如 selinux、iptables、软件源、相关服务等，这样后面使用该母盘创建的虚拟机就可以省去优化的步骤。</p>
<pre><code># kvm -m 1024  -drive file=/work-space/ubuntu14.04.qcow2,if=virtio \
-net nic,model=virtio -net tap,script=no  -nographic -vnc :0
</code></pre><p>输入以上命令之后,通过 VNC 客户端连接就能进入刚装好的系统。</p>
<h2 id="五、导入镜像-1"><a href="#五、导入镜像-1" class="headerlink" title="五、导入镜像"></a>五、导入镜像</h2><p>添加主机可以使用 web 页面添加,也可以使用命令添加,导入镜像 web 和命令也都可以实现。</p>
<h3 id="5-1-web界面导入映像"><a href="#5-1-web界面导入映像" class="headerlink" title="5.1 web界面导入映像"></a>5.1 web界面导入映像</h3><p>1.选择映像管理—&gt; 添加<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/A408EEF7-7ADC-4B3F-86EB-FACB978093B4.png" alt=""></p>
<p>2.点击添加之后出现如下弹框,根据实际填写<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/C32678CF-1D95-4AB6-B56A-7F31FFEB8297.png" alt=""></p>
<p>持久性:如果您在虚拟机模板中使用了持久性的磁盘映像,你只能够基于该模板创建一个正在运行的虚拟机。这是因为一个持久型的磁盘映像只能够同时被应用到一台正在运行的虚拟机上。如果您在虚拟机模板中使用的是临时性的磁盘映像,则可以同时基于该模板创建 多个虚拟机。</p>
<p>3.导入后初始状态为锁定<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/49406625-17E8-4914-834B-4967587B66D1.png" alt=""></p>
<p>4.导入完成之后就会显示就绪状态<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/F08296E6-2554-462C-9215-62D4F4938FF0.png" alt=""></p>
<h3 id="5-2-命令行导入映像"><a href="#5-2-命令行导入映像" class="headerlink" title="5.2 命令行导入映像"></a>5.2 命令行导入映像</h3><h4 id="5-2-1-oneimg-命令"><a href="#5-2-1-oneimg-命令" class="headerlink" title="5.2.1 oneimg 命令"></a>5.2.1 oneimg 命令</h4><pre><code># su - oneadmin
$ oneimage list
ID USER       GROUP      NAME            DATASTORE     SIZE TYPE PER STAT RVMS
1 oneadmin   oneadmin   ubuntu14.04_50G default        50G OS    No rdy     0
</code></pre><p>使用 oneimg 导入系统映像 </p>
<pre><code>$ cat ubuntu14.04_test.one   //创建相关配置文件
NAME    = &quot;ubuntu14.04_test&quot;
PATH    = /work-space/ubuntu14.04.qcow2
TYPE    = OS
DESCRIPTION = &quot;ubuntu14.04_test&quot;
DRIVER  = qcow2
$ onedatastore list  //选择数据仓库,这里选择default
ID NAME                SIZE AVAIL CLUSTER      IMAGES TYPE DS      TM      STAT
0 system              2.6T 95%   -                 0 sys  -       shared  on
1 default             2.6T 95%   -                 1 img  fs      ssh     on
2 files               2.6T 95%   -                 0 fil  fs      ssh     on
$ oneimage create ubuntu14.04_test.one  --datastore default
ID: 2
$ oneimage list   //初始状态 lock
ID USER       GROUP      NAME            DATASTORE     SIZE TYPE PER STAT RVMS
1 oneadmin   oneadmin   ubuntu14.04_50G default        50G OS    No rdy     0
2 oneadmin   oneadmin   ubuntu14.04_tes default        50G OS    No lock    0
$ oneimage list  //再次查看状态变为 rdy
ID USER       GROUP      NAME            DATASTORE     SIZE TYPE PER STAT RVMS
1 oneadmin   oneadmin   ubuntu14.04_50G default        50G OS    No rdy     0
2 oneadmin   oneadmin   ubuntu14.04_tes default        50G OS    No rdy     0
</code></pre><p>使用 oneimage 命令和创建 ubuntu14.04_test.one 文件在web 页面创建映像的高级模式中同样能实现：</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/CF777085-1F87-484F-AD7E-F8B0B966688B.png" alt=""></p>
<p>克隆镜像：oneimage clone  \<imageid>  \<name></name></imageid></p>
<p>有时需要修改某个镜像,在修改之前我们可以通过克隆的方式备份这个镜像</p>
<pre><code>$ oneimage list
ID USER       GROUP      NAME            DATASTORE     SIZE TYPE PER STAT RVMS
1 oneadmin   oneadmin   ubuntu14.04_50G default        50G OS    No rdy     0
2 oneadmin   oneadmin   ubuntu14.04_tes default        50G OS    No rdy     0
$ oneimage  clone 1  ubuntu14.04_bak  // 指定克隆的映像id
ID: 3
$ oneimage list
ID USER       GROUP      NAME            DATASTORE     SIZE TYPE PER STAT RVMS
1 oneadmin   oneadmin   ubuntu14.04_50G default        50G OS    No rdy     0
2 oneadmin   oneadmin   ubuntu14.04_tes default        50G OS    No rdy     0
3 oneadmin   oneadmin   ubuntu14.04_bak default        50G OS    No rdy     0
</code></pre><p>删除镜像 :  oneimage delete \<imageid |="" imagename=""></imageid></p>
<p>查看镜像详细信息：oneimage show</p>
<pre><code>$ oneimage show 1
IMAGE 1 INFORMATION
ID             : 1
NAME           : ubuntu14.04_50G
USER           : oneadmin
GROUP          : oneadmin
DATASTORE      : default
TYPE           : OS
REGISTER TIME  : 04/24 12:18:33
PERSISTENT     : No
SOURCE         : /var/lib/one//datastores/1/06f1f1d5f87d7aa92a528800b61e5983
PATH           : /work-space/ubuntu14.04.qcow2
SIZE           : 50G
STATE          : rdy
RUNNING_VMS    : 0

PERMISSIONS
OWNER          : um-
GROUP          : ---
OTHER          : ---

IMAGE TEMPLATE
DESCRIPTION=&quot;ubuntu14.04_50G&quot;
DEV_PREFIX=&quot;hd&quot;
DRIVER=&quot;qcow2&quot;

VIRTUAL MACHINES
</code></pre><h2 id="六、虚拟网络-1"><a href="#六、虚拟网络-1" class="headerlink" title="六、虚拟网络"></a>六、虚拟网络</h2><ul>
<li>eth0 为管理网口</li>
<li>eth1 为trunk口用作虚拟机通信，通过桥接br0</li>
</ul>
<h3 id="6-1-web界面添加虚拟网络"><a href="#6-1-web界面添加虚拟网络" class="headerlink" title="6.1 web界面添加虚拟网络"></a>6.1 web界面添加虚拟网络</h3><p>1.选择虚拟网络—&gt; 添加<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/6A422EA5-D7E3-4934-BEEF-A2DD5DA5D5B7.png" alt=""></p>
<p>2.点击添加之后出现如下弹框,根据实际填写<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/ADDF280D-B87F-4490-9A4E-85B6EE2D301B.png" alt=""><br>3.将网桥br0绑定到eth1 (网络模式和vlan概念还有点疑惑)<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/E2758C26-77CA-46EB-9441-EE923BFB3E69.png" alt=""><br>4.添加地址范围<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/726A4927-11ED-4726-A2F8-12A904BEED02.png" alt=""></p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/8717FB7C-97F4-4BC8-8505-DAD4C363A946.png" alt=""><br>5.完成其他相关配置，点击创建<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/EFFC8DC0-7B4B-4F0F-B1DF-F6878E731AAE.png" alt=""></p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/DAF058BB-9617-4D6C-A32F-225788F98BCD.png" alt=""></p>
<h3 id="6-2-命令行添加虚拟网络"><a href="#6-2-命令行添加虚拟网络" class="headerlink" title="6.2 命令行添加虚拟网络"></a>6.2 命令行添加虚拟网络</h3><h4 id="6-2-1-onevnet-命令"><a href="#6-2-1-onevnet-命令" class="headerlink" title="6.2.1 onevnet 命令"></a>6.2.1 onevnet 命令</h4><pre><code>$ onevnet list    //显示当前的虚拟网络
ID USER            GROUP        NAME                CLUSTER    BRIDGE   LEASES
0 oneadmin        oneadmin     test-network        -          br0           0
</code></pre><p>添加虚拟网络:</p>
<pre><code>$ cat onevnet_test.net
NAME    = &quot;onevnet_test&quot;
TYPE    = RANGED
BRIDGE = br0
NETWORK_ADDRESS = 10.249.6.0/24
IP_START        = 10.249.6.105
IP_END          = 10.249.6.107

GATEWAY = 10.249.6.254
DNS     = 10.249.6.100
$ onevnet create onevnet_test.net     // 添加虚拟网络
ID: 1
$ onevnet list
ID USER            GROUP        NAME                CLUSTER    BRIDGE   LEASES
0 oneadmin        oneadmin     test-network        -          br0           0
1 oneadmin        oneadmin     onevnet_test        -          br0           0
</code></pre><p>以上.net 文件中的内容可以直接输入到 web 创建虚拟网络的高级模式中创建。</p>
<p>删除虚拟网络:</p>
<pre><code>$ onevnet  delete 1
</code></pre><p>查看虚拟网络详细信息:</p>
<pre><code>$ onevnet  show 0
VIRTUAL NETWORK 0 INFORMATION
ID             : 0
NAME           : test-network
USER           : oneadmin
GROUP          : oneadmin
CLUSTER        : -
BRIDGE         : br0
VLAN           : Yes
PHYSICAL DEVICE: eth1
VLAN ID        : 6
USED LEASES    : 0

......
VIRTUAL NETWORK TEMPLATE
BRIDGE=&quot;br0&quot;
DESCRIPTION=&quot;test-network&quot;
DNS=&quot;10.249.6.100&quot;
GATEWAY=&quot;10.249.6.254&quot;
NETWORK_ADDRESS=&quot;10.249.6.0&quot;
NETWORK_MASK=&quot;255.255.255.0&quot;
PHYDEV=&quot;eth1&quot;
SECURITY_GROUPS=&quot;0&quot;
VLAN=&quot;YES&quot;
VLAN_ID=&quot;6&quot;
......
</code></pre><h2 id="七、制作模板-1"><a href="#七、制作模板-1" class="headerlink" title="七、制作模板"></a>七、制作模板</h2><p>模板就是包括创建虚拟机时使用到的系统镜像、以及各种配置的一个定义。</p>
<h3 id="7-1-web-界面制作模板"><a href="#7-1-web-界面制作模板" class="headerlink" title="7.1  web 界面制作模板"></a>7.1  web 界面制作模板</h3><p>1.选择模板管理—&gt; 添加<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/F02F53A0-473C-4F70-93E0-98B2B22F7191.png" alt=""><br>2.点击添加之后出现如下弹框,根据实际填写</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/3837A134-D0C5-4EE3-9E8D-83CD18693A85.png" alt=""><br>3.存储<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/87F81732-EEC1-4429-9868-2B6BD3D36382.png" alt=""><br>4.网络<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/80FA24E1-7D22-48F8-A57C-41AACBF326AC.png" alt=""><br>5.引导<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/3B448D17-02A9-4355-BA30-04407A83CDE0.png" alt=""><br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/9BEAEBE4-C0EA-4605-8727-6081260085BB.png" alt=""><br>6.输入输出<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/7AAABE0F-E3A1-4754-83B6-6C7E0D63C1E8.png" alt=""><br>7.Context功能<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/634670E1-53E7-4084-B0BF-84E639726AE7.png" alt=""><br>8.其他几个保持默认就行，填写完点击创建即可。</p>
<h3 id="7-2-Context初始化功能"><a href="#7-2-Context初始化功能" class="headerlink" title="7.2  Context初始化功能"></a>7.2  Context初始化功能</h3><p>Context原理图如下：</p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/34977BFC-C6FE-4E0B-B3F1-2DCA0CDA56C9.png" alt=""></p>
<p>Context 通过 ISO 镜像的方式配置新启动的虚拟机,即创建虚拟机的时候 Server 管理端 会把相关的配置文件和脚本打包生成到一个 ISO 文件中,新启动的虚拟机会挂载该 ISO 镜像 并执行其中的脚本以达到自动初始化虚拟机的目的。</p>
<h4 id="7-2-1-修改母盘镜像"><a href="#7-2-1-修改母盘镜像" class="headerlink" title="7.2.1 修改母盘镜像"></a>7.2.1 修改母盘镜像</h4><pre><code># oneimage show ubuntu14.04_50G  | grep SOURCE   //获取之前创建镜像位置
SOURCE         : /var/lib/one//datastores/1/06f1f1d5f87d7aa92a528800b61e5983
# kvm -m 1024  -drive file=/var/lib/one//datastores/1/06f1f1d5f87d7aa92a528800b61e5983,if=virtio \
-net nic,model=virtio -net tap,script=no  -nographic -vnc :0
</code></pre><p>通过 VNC View 连接,登陆系统,新建 context 脚本:</p>
<pre><code># chmod +x  /etc/init.d/vmcontext
# cat  /etc/init.d/vmcontext
#!/bin/bash
if [ ! -d /mnt/cdrom ]; then
        mkdir /mnt/cdrom
fi
    mount /dev/cdrom /mnt/cdrom
if [ -f /mnt/cdrom/context.sh ]; then
        bash /mnt/cdrom/context.sh
        bash /mnt/cdrom/init.sh

fi
umount /mnt/cdrom
</code></pre><p>加入开机启动执行,在rc.local中加入: bash  /etc/init.d/vmcontext</p>
<p>这里有两个文件：</p>
<p><strong>/mnt/cdrom/context.sh</strong>   //Context variables generated by OpenNebula,开通虚拟机时从平台里获取到的变量，如网卡相关的配置信息等。</p>
<p><strong>/mnt/cdrom/init.sh</strong>    //自己编写放置在Server端的脚本，主要功能就是让虚拟机能自动配置上context.sh中的变量</p>
<pre><code>$ pwd
/var/lib/one/context
$ ls
centos  ubuntu  windows
$ cd ubuntu/
$ ls
init.sh
$ cat init.sh    // init.sh 脚本内容，简单实例
#!/bin/bash

INTERFACE=&quot;/etc/network/interfaces&quot;
. /mnt/cdrom/context.sh
if [ $HOSTNAME ]; then
    hostname $HOSTNAME
    echo &quot;$HOSTNAME&quot; &gt; /etc/hostname
fi

echo -ne &quot;auto lo\n&quot; &gt; $INTERFACE
echo -ne &quot;iface lo inet loopback\n&quot; &gt;&gt; $INTERFACE

for i in 0 1 2 3; do
    grep &quot;ETH${i}_IP&quot; /mnt/cdrom/context.sh &gt;&gt; /dev/null 2&gt;&amp;1

if [ $? -eq 0 ]; then
    echo -ne &quot;\nauto eth$i\n&quot;               &gt;&gt; $INTERFACE
    echo -ne &quot;iface eth$i inet static\n&quot;    &gt;&gt; $INTERFACE
    echo -ne &quot;address &quot;                     &gt;&gt; $INTERFACE
    eval echo \$ETH${i}_IP                  &gt;&gt; $INTERFACE
    echo -ne &quot;netmask &quot;                     &gt;&gt; $INTERFACE
    eval echo \$ETH${i}_MASK                &gt;&gt; $INTERFACE
    echo -ne &quot;gateway &quot;                     &gt;&gt; $INTERFACE
    eval echo \$ETH${i}_GATEWAY             &gt;&gt; $INTERFACE

    if [ $i -eq 0 ]; then
        echo -ne &quot;dns-nameservers &quot; &gt;&gt; $INTERFACE
        eval echo \$ETH${i}_DNS &gt;&gt; $INTERFACE
        echo -ne &quot;dns-search i.ajkdns.com\n&quot; &gt;&gt; $INTERFACE
    fi
fi
done

/sbin/ifdown eth0
/sbin/ifup eth0
rm -rf /etc/init.d/vmcontext
sed  -i &apos;/vmcontext/d&apos; /etc/rc.local
ifconfig eth0 &gt;/dev/null 2&gt;1
    if [ &quot;$?&quot; != &quot;0&quot; ]; then
    rm -f /etc/udev/rules.d/70-persistent-net.rules
fi
reboot
</code></pre><h2 id="八、创建虚拟机-1"><a href="#八、创建虚拟机-1" class="headerlink" title="八、创建虚拟机"></a>八、创建虚拟机</h2><h3 id="8-1-web界面创建虚拟机"><a href="#8-1-web界面创建虚拟机" class="headerlink" title="8.1 web界面创建虚拟机"></a>8.1 web界面创建虚拟机</h3><p>1.选择虚机管理—&gt; 添加<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/88C9F701-7418-4948-96D3-703EE759FA40.png" alt=""></p>
<p>2.点击添加选择模板，设置主机名<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/OpenNebula%20Sunstone%20%20Cloud%20Operations%20Center.png" alt=""></p>
<p>3.点击创建后，主机初始状态为PENDING<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/2C3C8F5B-A2EA-4AB6-ADC7-0A981D27A7E4.png" alt=""></p>
<p>4.勾选主机并部署<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/4116E61F-F971-430F-A572-D3E0506E5033.png" alt=""></p>
<p>5.部署到主机<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/C816CFBA-4A02-4D39-9CDB-F8FCBF392883.png" alt=""></p>
<p>6.部署完毕后，如果一切正常，虚拟机的状态为PROLOG—&gt; BOOT —&gt; 运行，后面即可ssh登录<br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/C3182977-E4C6-481A-ADEE-B4DBA7880D2E.png" alt=""><br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/3C0DC59D-C31E-4DDE-8467-2D5AAB680C15.png" alt=""></p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/03/08/Create-A-deb-Package-Repository/" class="post-link">Create A .deb Package Repository</a></h2><span class="post-time">Mar 8, 2016</span><div class="post-content"><h3 id="Install-Reprepro-and-Generate-Key"><a href="#Install-Reprepro-and-Generate-Key" class="headerlink" title="Install Reprepro and Generate Key"></a>Install Reprepro and Generate Key</h3><p>安装软件包并生成密钥</p>
<pre><code># sudo apt-get  install reprepro gnupg -y
</code></pre><p>创建gpg key需要大量的随机操作，使用rng-tools产生大量随机操作    </p>
<pre><code># apt-get install rng-tools -y

# vim /etc/default/rng-tools   

[...]

HRNGDEVICE=/dev/urandom

[...]

# /etc/init.d/rng-tools start
</code></pre><p>Generate a gpg key using gnupg  </p>
<pre><code># gpg --gen-key
......
Please select what kind of key you want:
(1) RSA and RSA (default)
(2) DSA and Elgamal
(3) DSA (sign only)
(4) RSA (sign only)
Your selection? 4
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
        0 = key does not expire
    &lt;n&gt;  = key expires in n days
    &lt;n&gt;w = key expires in n weeks
    &lt;n&gt;m = key expires in n months
    &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y

You need a user ID to identify your key; the software constructs the user ID
from the Real Name, Comment and Email Address in this form:
 &quot;Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;&quot;

Real name: Mr-zhao
Email address: zhifanzhao@gmail.com
Comment: ops deb
Enter passphrase:****
You selected this USER-ID:
    &quot;Mr-zhao (ops deb) &lt;zhifanzhao@gmail.com&gt;&quot;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
You need a Passphrase to protect your secret key.

You don&apos;t want a passphrase - this is probably a *bad* idea!
I will do it anyway.  You can change your passphrase at any time,
using this program with the option &quot;--edit-key&quot;.

We need to generate a lot of random bytes.
 It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy.

......
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key D94F748F marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   4096R/D94F748F 2016-03-08
    Key fingerprint = 7D96 2419 19C6 B7C3 7F97  F4BB 63BF 6A4F D94F 748F
uid                  Mr-zhao (ops deb) &lt;zhifanzhao@gmail.com&gt;

Note that this key cannot be used for encryption.  You may want to use
the command &quot;--edit-key&quot; to generate a subkey for this purpose. 
</code></pre><p>查看和修改 gpg key</p>
<pre><code># gpg --list-keys
/root/.gnupg/pubring.gpg
------------------------
pub   4096R/D94F748F 2016-03-08
uid                  Mr-zhao (ops deb) &lt;zhifanzhao@gmail.com&gt;

# gpg --edit-key
usage: gpg [options] --edit-key user-id [commands]
</code></pre><h3 id="Create-a-Package-Repository-and-Export-Key"><a href="#Create-a-Package-Repository-and-Export-Key" class="headerlink" title="Create a Package Repository and Export Key"></a>Create a Package Repository and Export Key</h3><pre><code># cd /data
# mkdir apt
# mkdir -p ./apt/conf

#vim  ./apt/conf/distributions
Origin:        ops-ubuntu
Label:         ops-ubuntu
Suite:         trusty
Codename:      trusty
Version:       14.04
Architectures: amd64 i386
Components:    main restricted multiverse universe
Description:   private main deb repository for trusty
SignWith: yes

#vim ./apt/conf/options   //reprepro --options命令的集合
verbose
basedir  .
ask-passphrase
distdir  /data/apt/repos/dists   //dist文件的输出位置
outdir   /data/apt/repos    //pool输出的位置
</code></pre><p>Create the repository tree</p>
<pre><code># reprepro --ask-passphrase -Vb /data/apt/ export
</code></pre><p>Export Key</p>
<pre><code># gpg --armor --export Mr-zhao zhifanzhao@gmail.com &gt;&gt; ./repos/public.key
</code></pre><h3 id="Add-Packages-to-Newly-Created-Repository"><a href="#Add-Packages-to-Newly-Created-Repository" class="headerlink" title="Add Packages to Newly Created Repository"></a>Add Packages to Newly Created Repository</h3><pre><code>#reprepro -b . -C main includedeb trusty /tmp/packages.deb  //add

#reprepro remove trusty packages   //remove 
</code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.tecmint.com/create-deb-pacakge-repository-in-ubuntu/" target="_blank" rel="external">Create A .deb Package Repository</a><br><a href="https://wikitech.wikimedia.org/wiki/Reprepro" target="_blank" rel="external">wiki reprepro</a><br><a href="https://wiki.debian.org/SecureApt" target="_blank" rel="external">SecureApt)</a><br><a href="http://irtfweb.ifa.hawaii.edu/~lockhart/gpg/" target="_blank" rel="external">gpg-cheat</a><br><a href="http://www.ruanyifeng.com/blog/2013/07/gpg.html" target="_blank" rel="external">gpg</a></p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/03/05/Feb_tips/" class="post-link">Work Tips</a></h2><span class="post-time">Mar 5, 2016</span><div class="post-content"><h3 id="1-无交互修改系统密码"><a href="#1-无交互修改系统密码" class="headerlink" title="1.无交互修改系统密码"></a><u>1.无交互修改系统密码</u></h3><p>CentOS</p>
<pre><code>echo 123456 |  passwd --stdin root
</code></pre><p>Ubuntu</p>
<pre><code>echo &quot;root:123456&quot; | chpasswd   //ubuntu是BSD 非标准的不能用
</code></pre><p>CentOS和Ubuntu还有一个地方要注意，CentOS默认新建的普通用户是没有sudo权限的，需要在/etc/sudoers文件中加入用户和权限才能执行sudo，而Ubuntu执行sudo 默认输入当前用户密码即可执行。</p>
<h3 id="2-deb包的字段含义"><a href="#2-deb包的字段含义" class="headerlink" title="2.deb包的字段含义"></a><u>2.deb包的字段含义</u></h3><pre><code>root@Mr-zhao:~# aptitude search node
p   ansible-node-fireball                           - Ansible fireball transport support for nodes
p   ax25-node                                       - Amateur Packet Radio Node program
p   ax25-node:i386                                  - Amateur Packet Radio Node program
p   knode                                           - graphical news reader
p   knode:i386                                      - graphical news reader
p   leafnode                                        - NNTP server for small sites
p   leafnode:i386                                   - NNTP server for small sites
p   libjs-node-uuid                                 - simple, fast generation of RFC4122 UUIDs - JavaScript libr
v   libnode-node-expat                              -
v   libnode-node-expat:i386                         -
</code></pre><blockquote>
<p>current state of the package: <code>the most common states are p, meaning that no trace of the packageexists on the system, c, meaning that the package was deleted but its configuration files remain on the system, i, meaning that the package is installed, and v, meaning that the package is virtual.</code> ( man aptitude )</p>
</blockquote>
<h3 id="3-apt-get-update-NO-PUBKEY"><a href="#3-apt-get-update-NO-PUBKEY" class="headerlink" title="3.apt-get update NO_PUBKEY"></a><u>3.apt-get update NO_PUBKEY</u></h3><p>将私有镜像仓库的key添加到本地trusted数据库</p>
<pre><code># curl -l http://mirrors.corp.ops.com/ops/public.key|apt-key add -
</code></pre><p>如果还有报错，则使用以下命令：</p>
<pre><code># apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 3B4FE6ACC0B21F32

# apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 40976EAF437D05B5
</code></pre><h3 id="4-Cacti-weathermap-插件-editor-php-的安全性设置"><a href="#4-Cacti-weathermap-插件-editor-php-的安全性设置" class="headerlink" title="4.Cacti weathermap 插件 editor.php 的安全性设置"></a><u>4.Cacti weathermap 插件 editor.php 的安全性设置</u></h3><p>Cacti weathermap采用.htaccess的验证方法</p>
<p>首先在/var/www/html/plugins/weathermap下创建一个验证文件</p>
<pre><code>#htpasswd -cb /var/www/html/plugins/weathermap/.htpasswd cacti catiuser
//cacti是用户名，cactiuser是密码
</code></pre><p>创建好验证文件后，在apache的配置文件末尾加上如下的代码</p>
<pre><code>&lt;Directory/var/www/html/plugins/weathermap&gt;
&lt;Files editor.php&gt;
AuthType Basic
AuthName &quot;Please input your username and password.&quot;
AuthUserFile /var/www/html/plugins/weathermap/.htpasswd
require valid-user
&lt;/Files&gt;
&lt;/Directory&gt;
</code></pre><h3 id="5-SSD磁盘分区4K对齐检测"><a href="#5-SSD磁盘分区4K对齐检测" class="headerlink" title="5.SSD磁盘分区4K对齐检测"></a><u>5.SSD磁盘分区4K对齐检测</u></h3><p>使用fdisk分区，则查看start能否被8整除</p>
<pre><code>fdisk -lu |awk &apos;$1==&quot;/dev/sdb1&quot; {print $2/8}&apos;
</code></pre><p>使用parted分区</p>
<pre><code>root@Mr-zhao:~# parted /dev/sdb
GNU Parted 2.1
Using /dev/sdb
Welcome to GNU Parted! Type &apos;help&apos; to view a list of commands.
(parted) print
Model: DELL PERC H730P Mini (scsi)
Disk /dev/sdb: 1439GB
Sector size (logical/physical): 512B/4096B
Partition Table: gpt

Number  Start   End     Size    File system  Name     Flags
1      1049kB  1439GB  1439GB  xfs          primary

(parted) align-check opt 1
1 aligned   #返回aligned，即对齐
(parted)
</code></pre><h3 id="6-drop-caches"><a href="#6-drop-caches" class="headerlink" title="6.drop caches"></a><u>6.drop caches</u></h3><p>Writing to this will cause the kernel to drop clean caches, dentries and inodes from memory, causing thatmemory to become free.</p>
<p>To free pagecache:</p>
<pre><code>echo 1 &gt; /proc/sys/vm/drop_caches
</code></pre><p>To free dentries and inodes:</p>
<pre><code>echo 2 &gt; /proc/sys/vm/drop_caches
</code></pre><p>To free pagecache, dentries andinodes:</p>
<pre><code>echo 3 &gt; /proc/sys/vm/drop_caches
</code></pre><p>As this is a non-destructiveoperation and dirty objects are not freeable, the user should run sync first.</p>
<h3 id="7-系统快速求援"><a href="#7-系统快速求援" class="headerlink" title="7.系统快速求援"></a><u>7.系统快速求援</u></h3><blockquote>
<ul>
<li>at the grub prompt,hit a to append options</li>
<li>add init=/bin/bash to the kernel command line</li>
<li>mount -o remount,rw /</li>
<li>vim /etc/fstab</li>
<li>reboot</li>
</ul>
</blockquote>
<h3 id="8-修改网卡规则（设置显示为eth0）"><a href="#8-修改网卡规则（设置显示为eth0）" class="headerlink" title="8.修改网卡规则（设置显示为eth0）"></a><u>8.修改网卡规则（设置显示为eth0）</u></h3><pre><code>编辑 /etc/udev/rules.d/70-persistent-net.rules  修改网卡规则
</code></pre><h3 id="9-重启网卡失败：device-eth0-does-not-seem-to-be-present-delaying-initialization"><a href="#9-重启网卡失败：device-eth0-does-not-seem-to-be-present-delaying-initialization" class="headerlink" title="9.重启网卡失败：device eth0 does not seem to be present, delaying initialization"></a><u>9.重启网卡失败：device eth0 does not seem to be present, delaying initialization</u></h3><pre><code>/etc/udev/rules.d/70-persistent-net.rules 删除后重启机器
</code></pre><h3 id="10-查看磁盘的rebuild-进度"><a href="#10-查看磁盘的rebuild-进度" class="headerlink" title="10.查看磁盘的rebuild 进度"></a><u>10.查看磁盘的rebuild 进度</u></h3><pre><code># MegaCli -PDRbld -ShowProg -PhysDrv [32:3] -a0
Rebuild Progress on Device at Enclosure 32, Slot 3 Completed 95% in 50 Minutes.
</code></pre><h3 id="11-sed-i-破坏链接文件属性"><a href="#11-sed-i-破坏链接文件属性" class="headerlink" title="11.sed -i  破坏链接文件属性"></a><u>11.sed -i  破坏链接文件属性</u></h3><pre><code>--follow-symlinks

          follow symlinks when processing in place; hard links will still be broken.

-i[SUFFIX], --in-place[=SUFFIX]

          edit  files in place (makes backup if extension supplied).  The default operation mode
          is to break symbolic and hard links.  This can be changed with  --follow-symlinks  and
          --copy.

-c, --copy

          use  copy  instead  of  rename when shuffling files in -i mode.  While this will avoid
          breaking links (symbolic or hard), the resulting  editing  operation  is  not  atomic.
          This  is  rarely the desired mode; --follow-symlinks is usually enough, and it is both
          faster and more secure.
</code></pre><p> mannul中释义 -i选项对软链接和硬链接都会破坏，加上 –follow-symlinks选项只对软链接有效，硬链接还是会被破坏，加上 -c选项则软硬链接都不会遭到破坏。</p>
<h3 id="12-文本内容操作，合并去重"><a href="#12-文本内容操作，合并去重" class="headerlink" title="12.文本内容操作，合并去重"></a><u>12.文本内容操作，合并去重</u></h3><pre><code>cat /etc/rc.local  /etc/rc.d/rc.local |  awk &apos;!a[$0]++&apos;
</code></pre><h3 id="13-ssh登陆信息显示-etc-motd"><a href="#13-ssh登陆信息显示-etc-motd" class="headerlink" title="13.ssh登陆信息显示 /etc/motd"></a><u>13.ssh登陆信息显示 /etc/motd</u></h3><p>/etc/motd/etc/motd即messageoftoday（布告栏信息），每次用户登录时，/etc/motd文件的内容会显示在用户的终端,如果用户登录系统是图形界面，这些信息则不会显示。</p>
<h3 id="14-SSD磁盘型号与系列"><a href="#14-SSD磁盘型号与系列" class="headerlink" title="14.SSD磁盘型号与系列"></a><u>14.SSD磁盘型号与系列</u></h3><pre><code>SSDSC2BB480G4   属于S3500系列
SSDSC2BA800G4   属于S3710系列
SSDSC2BA800G3   属于S3700系列
SSDSC2BX800G4   属于S3610系列
800、480表示磁盘容量
</code></pre><p>  <a href="http://ark.intel.com/ZH-CN#@SolidStateDrives" target="_blank" rel="external">Intel SSD 官网查询</a>  </p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/03/03/free/" class="post-link">free查看内存相关信息</a></h2><span class="post-time">Mar 3, 2016</span><div class="post-content"><h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><h4 id="manual-description"><a href="#manual-description" class="headerlink" title="manual description"></a>manual description</h4><blockquote>
<p>free  displays  the total amount of free and used physical and swap memory in the system, as well as the buffers used bythe kernel.</p>
<p>The shared memory column represents either the MemShared value (2.4 series kernels) or the Shmem value (2.6 series kernels and later) taken from the /proc/meminfo file. The value is zero if none of the entries is exported by the kernel.</p>
</blockquote>
<h4 id="buffers-and-cached"><a href="#buffers-and-cached" class="headerlink" title="buffers and cached"></a>buffers and cached</h4><blockquote>
<p><strong>What is the difference between buffers and Cache?</strong></p>
<p>A buffer is a temporary location to store data for a particular application and this data is not used by any other application. This is similar to bandwidth concept. When you try to send burst of data through network, if your network card is capable of sending less data, it will keep these huge amounts of data in buffer so that it can send data constantly in lesser speeds. In other hand Cache is a memory location to store frequently used data for faster access. Other difference between a buffer and a cache is that cache can be used multiple times where as buffer is used single time. And both are temporary store for your data processing.</p>
</blockquote>
<ul>
<li>A buffer is something that has yet to be “written” to disk.</li>
<li>A cache is something that has been “read” from the disk and stored for later use.</li>
</ul>
<p>buffer是用于存放要输出到disk（块设备）的数据的，而cache是存放从disk上读出的数据。   这二者是为了提高IO性能的。为了提高IO read的性能，总是要多cache一些数据，这也就是为什么cached memor比较大，而比较小的原因。</p>
<pre><code>root@Mr-zhao:~# free -m
             total       used       free     shared    buffers     cached
Mem:          2001        979       1021          0         58        774
-/+ buffers/cache:        146       1854
Swap:         4092          0       4092
</code></pre><p>当我们第一次读一个大文件时耗时可能会比第二次长，原因就是第二次读取时已有cache数据。</p>
<ul>
<li><p>-/+ buffers/cache(used): 表示一个应用程序认为系统被用掉多少内存；</p>
<p>  -/+ buffers/cache(used) = Mem(used) – Mem(buffers) – Mem(cached)</p>
</li>
<li><p>-/+ buffers/cache(free)，表示一个应用程序认为系统还有多少内存；</p>
<p>  -/+ buffers/cache(free) = Mem(free) + Mem(buffers) + Mem(cached)</p>
</li>
</ul>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="http://www.cnblogs.com/coldplayerest/archive/2010/02/20/1669949.html" target="_blank" rel="external">Linux上的free命令详解</a><br><a href="http://www.freelinuxconsole.info/understanding-free-command-in-linuxunix-2/" target="_blank" rel="external">Understanding free command in Linux/Unix</a></p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/02/28/minicom/" class="post-link">minicom的使用</a></h2><span class="post-time">Feb 28, 2016</span><div class="post-content"><h3 id="minicom的介绍"><a href="#minicom的介绍" class="headerlink" title="minicom的介绍"></a>minicom的介绍</h3><p>Linux下的Minicom的功能与Windows下的超级终端功能相似，<strong>可以通过串口控制外部的硬件设备</strong>，适于在linux通过超级终端对嵌入式设备行管理。</p>
<h3 id="minicom的安装配置和使用"><a href="#minicom的安装配置和使用" class="headerlink" title="minicom的安装配置和使用"></a>minicom的安装配置和使用</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><pre><code># apt-get install minicom
</code></pre><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p> 实际案例：交换机的consle转usb口连接到服务器，通过minicom对交换机进行配置</p>
<pre><code># lsusb   //查看USB的状态
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
Bus 002 Device 002: ID 0e0f:0003 VMware, Inc. Virtual Mouse
Bus 002 Device 003: ID 0e0f:0002 VMware, Inc. Virtual USB Hub
Bus 002 Device 004: ID 0e0f:0008 VMware, Inc.
Bus 002 Device 005: ID 067b:2303 Prolific Technology, Inc. PL2303 Serial Port

# dmesg |grep ttyUSB  //USB已经连接
[11991.918691] usb 2-2.2: pl2303 converter now attached to ttyUSB0

# minicom -s   //进行配置

+-----[configuration]------+
| Filenames and paths      |
| File transfer protocols  |
| Serial port setup        |
| Modem and dialing        |
| Screen and keyboard      |
| Save setup as dfl        |
| Save setup as..          |
| Exit                     |
| Exit from Minicom        |
+--------------------------+

#选择进入Serial port setup，按照之前查看的信息进行配置

+-----------------------------------------------------------------------+
| A -    Serial Device      : /dev/ttyUSB0                              |
| B - Lockfile Location     : /var/lock                                 |
| C -   Callin Program      :                                           |
| D -  Callout Program      :                                           |
| E -    Bps/Par/Bits       : 115200 8N1                                |
| F - Hardware Flow Control : Yes                                       |
| G - Software Flow Control : No                                        |
|                                                                       |
|    Change which setting?                                              |
+-----------------------------------------------------------------------+
    | Screen and keyboard      |
    | Save setup as dfl        |
    | Save setup as..          |
    | Exit                     |
    | Exit from Minicom        |
    +--------------------------+

#Enter退出，选择Save setup as dfl  保存为默认配置
</code></pre><p>  然后进入终端输入minicom 就能连接进入交换机配置</p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/02/25/ulimit/" class="post-link">ulimit小记</a></h2><span class="post-time">Feb 25, 2016</span><div class="post-content"><h3 id="ulimit简介"><a href="#ulimit简介" class="headerlink" title="ulimit简介"></a>ulimit简介</h3><p>ulimit 用于限制 shell 启动进程所占用的资源，支持以下各种类型的限制：所创建的内核文件的大小、进程数据块的大小、Shell 进程创建文件的大小、内存锁住的大小、常驻内存集的大小、打开文件描述符的数量、分配堆栈的最大大小、CPU 时间、单个用户的最大线程数、Shell 进程所能使用的最大虚拟内存。同时，它支持硬资源和软资源的限制。</p>
<p>作为临时限制，ulimit 可以作用于通过使用其命令登录的 shell 会话，在会话终止时便结束限制，并不影响于其他 shell 会话。而对于长期的固定限制，ulimit 命令语句又可以被添加到由登录 shell 读取的文件中，作用于特定的 shell 用户。</p>
<h3 id="ulimit的设置"><a href="#ulimit的设置" class="headerlink" title="ulimit的设置"></a>ulimit的设置</h3><pre><code>[root@Mr-zhao ~]# ulimit  -a    //查看当前配置文件ulimit全局系数
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7389
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 10240
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 10240
cpu time               (seconds, -t) unlimited
max user processes              (-u) 10240
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
</code></pre><p>对于线上环境的机器一般要对<code>open files</code>和<code>max user processes</code>进行修改。</p>
<h4 id="临时性的修改，只对当前shell生效。"><a href="#临时性的修改，只对当前shell生效。" class="headerlink" title="临时性的修改，只对当前shell生效。"></a>临时性的修改，只对当前shell生效。</h4><pre><code>ulimit  -n 65535
ulimit  -u 65535
</code></pre><h4 id="想要ulimit的设置永久性生效，需要修改-etc-security-limits-conf文件。"><a href="#想要ulimit的设置永久性生效，需要修改-etc-security-limits-conf文件。" class="headerlink" title="想要ulimit的设置永久性生效，需要修改/etc/security/limits.conf文件。"></a>想要ulimit的设置永久性生效，需要修改/etc/security/limits.conf文件。</h4><p>对于centos系统/etc/security/limits.d/90-nproc.conf文件的优先级高于/etc/security/limits.conf，所以对全局的设定需修改90-nproc.conf文件。对于单个用户的ulimit的设置并不受etc/security/limits.d/90-nproc.conf影响。</p>
<p>对于ubuntu系统，只需对/etc/security/limits.conf文件进行修改，ubuntu系统没有引入90-nproc.conf文件。但是ubuntux系统也会存在一个问题，就是对全局的设置其实对于root用户是没有效果的。所以ubuntu系统下的设置如下：</p>
<pre><code>root@Mr-zhao:~# grep -Ev &quot;^$|^#&quot; /etc/security/limits.conf
root - nofile 65535
root - nproc  65535
* - nofile 65535
* - nproc 65535
</code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/" target="_blank" rel="external">通过 ulimit 改善系统性能</a><br><a href="http://ss64.com/bash/limits.conf.html" target="_blank" rel="external">limits.conf - configuration file</a></p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/02/24/network-command/" class="post-link">网络相关命令备忘</a></h2><span class="post-time">Feb 24, 2016</span><div class="post-content"><h3 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h3><p>查看网络连接状态接口等信息。</p>
<h4 id="常用的命令选项："><a href="#常用的命令选项：" class="headerlink" title="常用的命令选项："></a>常用的命令选项：</h4><ul>
<li>a : 显示所有活动连接</li>
<li>n：以数字的形式显示（不使用主机名与服务名称，使用 IP 与 port number ）</li>
<li>p：显示进程名和PID</li>
<li>t：查看TCP协议相关信息</li>
<li>u：查看UDP协议相关信息</li>
<li>l：显示正在监听的进程</li>
</ul>
<p>netstat 的输出主要分为两大部分，分别是 TCP/IP 的网络接口部分，以及传统的 Unix socket 部分:</p>
<pre><code>[root@Mr-zhao ~]# netstat -ntpl
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address               Foreign Address             State       PID/Program name
tcp        0      0 0.0.0.0:8080                0.0.0.0:*                   LISTEN      9356/nginx
tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      9356/nginx
tcp        0      0 0.0.0.0:8081                0.0.0.0:*                   LISTEN      9356/nginx
tcp        0      0 10.48.156.8:60020           0.0.0.0:*                   LISTEN      12371/./gseAgent
tcp        0      0 0.0.0.0:22                  0.0.0.0:*                   LISTEN      16594/sshd
tcp        0      0 :::22                       :::*                        LISTEN      16594/sshd
</code></pre><p><strong>字段含义：</strong></p>
<ul>
<li>proto  协议</li>
<li>Recv-Q 接受数据</li>
<li>Send-Q 发送数据</li>
<li>Local Address 本地地址和端口号</li>
<li>Foreign Addredd  外部地址和端口号</li>
<li>State 状态</li>
<li>PID/Program name  PID和进程名称</li>
</ul>
<p>在 port 22 的接口中，使用的 :::22 就是针对 IPv6 的显示，事实上他就等同于 0.0.0.0:22</p>
<p><strong> State状态（tcp三次握手）：</strong></p>
<ul>
<li>ESTABLISED：已建立连接的状态；</li>
<li>SYN_SENT：发出主动连接 (SYN 标志) 的连接封包；</li>
<li>SYN_RECV：接收到一个要求连接的主动连接封包；</li>
<li>FIN_WAIT1：该插槽服务(socket)已中断，该联机正在断线当中；</li>
<li>FIN_WAIT2：该连接已挂断，但正在等待对方主机响应断线确认的封包；</li>
<li>TIME_WAIT：该连接已挂断，但 socket 还在网络上等待结束；</li>
<li>LISTEN：通常用在服务的监听 port ！可使用『 -l 』参数查阅。</li>
</ul>
<p>查看目前已经启动的网络服务</p>
<pre><code>netstat -tupln
</code></pre><p>查看本机上所有的网络连接状态</p>
<pre><code>netstat -atunp
</code></pre><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><p>网络端口扫描命令</p>
<h4 id="常用的扫描类型："><a href="#常用的扫描类型：" class="headerlink" title="常用的扫描类型："></a>常用的扫描类型：</h4><ul>
<li>-sT : TCP连接扫描</li>
<li>-sU：UDP扫描</li>
<li>-sP：ICMP扫描</li>
<li>-A：扫描操作系统类型</li>
<li>-p: 扫描端口</li>
<li>-n ：禁止反向解析</li>
</ul>
<p>检测10.0.2.0/16 网段有那些存活的主机</p>
<pre><code>nmap -n -sP 10.0.2.0/16
</code></pre><p>检测ip地址 10.0.2.100-200 间的存活的主机</p>
<pre><code>nmap -n -sP 10.0.2.100-200
</code></pre><p>检测主机10.0.2.253的tcp连接情况</p>
<pre><code>nmap -n  -sT 10.0.2.253
</code></pre><p> 检测所用操作系统和主机的基本信息</p>
<pre><code>nmap -A  www.baidu.com
nmap -A  10.0.2.253
</code></pre><h3 id="tcpdump-命令行抓包工具"><a href="#tcpdump-命令行抓包工具" class="headerlink" title="tcpdump 命令行抓包工具"></a>tcpdump 命令行抓包工具</h3><p>用途：不间断监控网络通信数据包</p>
<h4 id="常用选项"><a href="#常用选项" class="headerlink" title="常用选项"></a>常用选项</h4><ul>
<li><p>-qnn 可简化输出</p>
</li>
<li><p>-v -vv -vvv  指显示信息的详细程度</p>
</li>
</ul>
<h4 id="过滤条件"><a href="#过滤条件" class="headerlink" title="过滤条件"></a>过滤条件</h4><p>过滤主机</p>
<ul>
<li><p>host 源ip或者目标ip</p>
</li>
<li><p>src host 源ip</p>
</li>
<li><p>dst host 目标ip</p>
</li>
<li><p>ether host 源或者目标MAC地址</p>
</li>
</ul>
<p>过滤端口</p>
<ul>
<li>port 源端口或者目标端口，同样可以搭配 src、dst</li>
</ul>
<p>过滤协议</p>
<ul>
<li>arp | tcp | udp | icmp</li>
</ul>
<p>过滤网络</p>
<ul>
<li>net 网络地址，同样可以搭配 src、dst</li>
</ul>
<h4 id="连接符"><a href="#连接符" class="headerlink" title="连接符"></a>连接符</h4><p>and（&amp;&amp;）、or （||）、not（!）</p>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><pre><code>tcpdump -i eth0 -nn prot 22 and src host 192.168.1.6

tcpdump -i eth0 icmp and ether dst host 00:11:22:33:44:55

tcpdump -i eth0 tcp and dst net 172.18 and not dst host 192.168.1.100

tcpdump -i eth0 -nn -vv port 67 and udp

tcpdump -i eth0 -q -n arp         //监控eth0 的arp 协议 （ping）

tcpdump -i eth0 -v -n icmp and host 10.0.2.232

tcpdump -i eth0 -q -n arp -w /tmp/arp   //将结果输入到文本

tcpdump -r /tmp/arp   // 读出结果
</code></pre><h3 id="route"><a href="#route" class="headerlink" title="route"></a>route</h3><p>用于操作基于内核ip路由表，它的主要作用是创建一个静态路由让指定一个主机或者一个网络通过一个网络接口。</p>
<p><strong>直接在命令行下执行route命令来添加路由，不会永久保存，当网卡重启或者机器重启之后，该路由就失效了.</strong>可以在/etc/rc.local中添加route命令来保证该路由设置永久有效。</p>
<h4 id="参数注解"><a href="#参数注解" class="headerlink" title="参数注解"></a>参数注解</h4><pre><code>[root@localhost ~]# route -n  // -n 表示不解析名字,列出速度会比route 快
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.120.0   0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.0.0     192.168.120.1   255.255.0.0     UG    0      0        0 eth0
10.0.0.0        192.168.120.1   255.0.0.0       UG    0      0        0 eth0
0.0.0.0         192.168.120.240 0.0.0.0         UG    0      0        0 eth0
</code></pre><ul>
<li><p>第一行表示主机所在网络的地址为192.168.120.0，若数据传送目标是在本局域网内通信，则可直接通过eth0转发数据包;</p>
</li>
<li><p>第四行表示数据传送目的是访问Internet，则由接口eth0，将数据包发送到网关192.168.120.240</p>
</li>
<li><p>其中Flags为路由标志，标记当前网络节点的状态。</p>
<p>  Flags标志说明：</p>
<ul>
<li><p>U Up表示此路由当前为启动状态</p>
</li>
<li><p>H Host，表示此网关为一主机</p>
</li>
<li><p>G Gateway，表示此网关为一路由器</p>
</li>
<li><p>R Reinstate Route，使用动态路由重新初始化的路由</p>
</li>
<li><p>D Dynamically,此路由是动态性地写入</p>
</li>
<li><p>M Modified，此路由是由路由守护程序或导向器动态修改</p>
</li>
<li><p>! 表示此路由当前为关闭状态</p>
</li>
</ul>
</li>
</ul>
<h4 id="添加和删除路由："><a href="#添加和删除路由：" class="headerlink" title="添加和删除路由："></a>添加和删除路由：</h4><pre><code>route add -net 10.10.0.0 netmask 255.255.0.0 gw 10.10.3.1

route add -net 10.20.0.0 netmask 255.255.0.0 gw 10.10.3.1

route add -net 10.249.0.0 netmask 255.255.0.0 gw 10.10.3.1

route add -net 192.168.0.0 netmask 255.255.0.0 gw 10.10.3.1

route add default gw 10.10.3.252      //添加默认网关，默认网关只能有一条！多块网卡默认网关也只能有一个！

route del default gw 10.10.3.1   // 删除默认网关
</code></pre><p><strong>指定网卡</strong></p>
<pre><code>route add -net 10.249.0.0 netmask 255.255.0.0 gw 10.10.3.1 dev eth0
</code></pre></div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/02/23/cacit/" class="post-link">Cacti监控快速入门</a></h2><span class="post-time">Feb 23, 2016</span><div class="post-content"><h3 id="Cacti简介"><a href="#Cacti简介" class="headerlink" title="Cacti简介"></a>Cacti简介</h3><p>   Cacti 是一套基于 PHP,MySQL,SNMP 及 RRDTool 开发的网络流量监测图形分析工具,它本身并不是监控工具,通俗的讲只是个 php 的网站,但 Cacti 可以利用 snmp 服务获取数据, 然后用 rrdtool 储存和更新数据,当用户需要查看数据的时候用 rrdtool 生成图表呈现给用户。 因此,snmp 和 rrdtool 是 cacti 的关键。snmp 关系着数据的收集,rrdtool 关系着数据存储和图表的生成。除了基本的 snmp 流量跟系统资讯监控外,Cacti 也可外挂 Scripts 及加上 Templates 来作出各式各样的监控图。</p>
<h3 id="Cacti工作原理"><a href="#Cacti工作原理" class="headerlink" title="Cacti工作原理"></a>Cacti工作原理</h3><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/26" alt=""></p>
<h3 id="Cacti工作过程"><a href="#Cacti工作过程" class="headerlink" title="Cacti工作过程"></a>Cacti工作过程</h3><ul>
<li>Cacti 通过 net-snmp 定时采集被监控端的参数</li>
<li>Cacti 使用 RRDTool 采集到的数据储存到 rrd 文件中</li>
<li>当用户要查看某台设备的流量时,点击 Cacti 页面上的这个设备</li>
<li>Cacti 会去 Mysql 中调用该设备对应的 rrd 文件名称</li>
<li>Cacti 通过对找到的 rrd 文件,运行命令让 RRDTool 进行绘图</li>
</ul>
<p>Mysql 配合 PHP 程序存储一些变量数据并对变量数据进行调用,如:主机名、主机 ip、snmp 团体名、端口号、模板信息等变量,并不包括从设备采集过来的数据。</p>
<p>snmp 抓到数据存储在 rrdtool 生成的 rrd 文件中(在 cacti 根目录的 rra 文件夹下)。rrdtool 对数据的更新和存储就是对 rrd 文件的处理,rrd 文件是大小固定的档案文件,它能够存储 的数据笔数在创建时就已经定义。</p>
<h3 id="Cacti安装"><a href="#Cacti安装" class="headerlink" title="Cacti安装"></a>Cacti安装</h3><p>搭建LAMP架构</p>
<pre><code># yum install httpd mysql mysql-server mysql-devel net-snmp net-snmp-devel net-snmp-utils rrdtool  -y
# yum install php*  -y    //安装 php 的软件包
</code></pre><p>配置MySQL</p>
<pre><code># service mysqld restart
# mysqladmin -u root password 123      //为管理员设置密码
# mysqladmin -u root -p create cacti   //创建数据库名称为 cacti
Enter password:
# mysql -u root -p -e &quot;GRANT ALL ON cacti.* TO mike@localhost IDENTIFIED BY &apos;123&apos;&quot;
Enter password:
//创建用户mike、密码 123,并把所有权限给数据库 cacti。
//mysql -e 可以在 shell 中直接运行 mysql 中的指令。
</code></pre><p>Cacti软件包安装</p>
<p> <a href="http://www.cacti.net/download_cacti.php" target="_blank" rel="external">下载链接</a></p>
<p>安装配置</p>
<pre><code># tar xf cacti-0.8.8a.tar.gz -C /var/www/html/
# cd /var/www/html/
# mv cacti-0.8.8a/ cacti
# adduser cactiuser
# chown -R cactiuser cacti/rra cacti/log          
//注意这两个目录一定要让这个用户具备写入权限,否则后面无法产生图形和日志

# mysql -u cactiuser -p cacti &lt; cacti/cacti.sql
Enter password:
//导入 Cacti 自带的数据库,注意是输入 mysql 用户 mike 的密码

# vi cacti/include/config.php
/* make sure these values refect your actual                 database/host/user/password */

$database_type = &quot;mysql&quot;;
$database_default = &quot;cacti&quot;;
$database_hostname = &quot;localhost&quot;;
$database_username = &quot;mike&quot;;
$database_password = &quot;123&quot;;
$database_port = &quot;3306&quot;;
$database_ssl = false;
//一定要保证这些参数和在 mysql 里配置的一样
# crontab -e -u mike
*/5 * * * * php /var/www/html/cacti/poller.php &amp;&gt; /dev/null
//为 cactiuser 用户配置计划任务每 5 分钟运行 poller.php 轮询脚本
</code></pre><p>启动服务</p>
<pre><code># service httpd restart
# service mysqld restart
# service snmpd restart
# chkconfig httpd on
# chkconfig mysqld on
# chkconfig snmpd on
</code></pre><p>web界面安装</p>
<p>在浏览器里输入 <a href="http://172.16.252.1/cacti" target="_blank" rel="external">http://172.16.252.1/cacti</a> 进行安装</p>
<p>设置好snmp的版本，确保/var/www/html/cacti/rra目录下有rra文件，文件目录权限正确。</p>
<h3 id="WEB基本设置"><a href="#WEB基本设置" class="headerlink" title="WEB基本设置"></a>WEB基本设置</h3><p>采用 Spine 轮询器替换默认轮询引擎,默认使用cmd.php轮询引擎每隔 5 分钟进行轮询。</p>
<p>spine 是一个基于 C 语言的, 非常快速的轮询引擎,它是默认的 cmd.php 的可选替代,主要是为了加快 SNMP 轮询。Spine 可以提高采集数据的效率,适合监控服务器数量比较多的情况,而 cmd.php 适合小型、测试、学习所用。</p>
<p><a href="http://www.cacti.net/spine_download.php" target="_blank" rel="external">下载链接</a></p>
<p><a href="http://www.cacti.net/spine_install_rhlnx.php" target="_blank" rel="external">查看安装需求</a></p>
<pre><code># tar xf cacti-spine-0.8.8f.tar.gz
# cd cacti-spine-0.8.8f
# ./configure    //确保有编译环境gcc gcc-c++

# make &amp;&amp; make install
# cd /usr/local/spine/etc/
# cp spine.conf.dist  spine.conf

# vi spine.conf     //和MySQL中得参数配置一致
DB_Host         localhost
DB_Database     cacti
DB_User         zhao
DB_Pass         123
DB_Port         3306

# cd bin/
# ./spine
SPINE: Using spine config file [../etc/spine.conf]
SPINE: Version 0.8.8f starting
SPINE: Time: 4.9910 s, Threads: 1, Hosts: 2
</code></pre><p>  web设置</p>
<p> console–&gt;settings-Paths–&gt;Spine Poller File Path–&gt;/usr/local/spine/bin/spine–&gt;save</p>
<p> poller–&gt;Poller Type–&gt;spine</p>
<p>更多插件</p>
<p><a href="http://docs.cacti.net/plugins" target="_blank" rel="external">下载地址</a></p>
<p>只需将下载的插件解压到 cacti 的插件目录(/var/www/html/cacti/plugins)即可</p>
<ul>
<li>settings</li>
</ul>
<p>Cacti 的插件架构提供常见的基础插件服务,许多插件都需要安装 settings 插件才 能工作,提供邮件 API,根据触发条件生成邮件并发送邮件给管理员。此插件安装后即 可,无需额外操作。</p>
<ul>
<li>thold</li>
</ul>
<p>利用 Cacti 的图形生成警告、可设置警告的级别、警告的上下阶等,必须先安装settings 插件。</p>
<ul>
<li>monitor</li>
</ul>
<p>通过此插件,可查看 Cacti 管理下的所有主机状态,并有声音警告;显示状态(正常、正在重启中、报警、宕机)。</p>
<ul>
<li>clog</li>
</ul>
<p>在 cacti 的页面上新建一个链接,这个链接上就可以直接查看 cacti 的日志。</p>
<ul>
<li>realtime</li>
</ul>
<p>查看实时绘图</p>
<ul>
<li>Weathermap</li>
</ul>
<p>根据被监控的设备,画出网络拓扑图</p>
<h3 id="CactiEZ简介"><a href="#CactiEZ简介" class="headerlink" title="CactiEZ简介"></a>CactiEZ简介</h3><p>CactiEZ中文版是最简单有效的Cacti中文解决方案，整合Spine，RRDTool和美化字体。集成Thold，Monitor，Syslog，Weathermap，Realtime，Errorimage，Mobile，Aggregate以及Apache，Squid，F5，Nginx，MySQL等模板。支持多种硬盘控制器和阵列卡，基于CentOS6，启动速度更快，支持EXT4文件系统，原生rsyslog更稳定。全中文页面，中文图形，支持邮件报警，支持声音报警，安装方便使用简单。</p>
<ul>
<li>更多信息：<a href="http://cactiez.cactiusers.org/" target="_blank" rel="external">CactiEZ官网</a></li>
</ul>
<h3 id="CactiEZ安装"><a href="#CactiEZ安装" class="headerlink" title="CactiEZ安装"></a>CactiEZ安装</h3><ul>
<li><p>CactiEZ ISO文件下载</p>
<p>  32位操作系统：<a href="http://pan.baidu.com/s/1dD0iZCX" target="_blank" rel="external">CactiEZ-10.1-i386.iso</a></p>
<p>  64位操作系统：<a href="http://pan.baidu.com/s/1c0BGvQS" target="_blank" rel="external">CactiEZ-10.1-x86_64.iso</a></p>
</li>
<li><p>利用CactiEZ ISO 引导如同光盘安装操作系统一样，安装完成重启后CactiEZ就安装完成</p>
<p>这种方法的缺点：CactiEZ是一个完整的操作系统，需要专门一台机器才能安装使用</p>
</li>
<li><p>通过拷贝ISO文件在已有linux操作系统上搭建</p>
</li>
</ul>
<p>快速自动安装脚本：<a href="https://github.com/Abnerzhao/CactiEZ/tree/master/doc" target="_blank" rel="external">install.sh</a></p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/01/15/mysql-duplicate/" class="post-link">MySQL主从复制备忘</a></h2><span class="post-time">Jan 15, 2016</span><div class="post-content"><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><ul>
<li><p>Master:10.249.17.38</p>
</li>
<li><p>Slave:10.249.17.45</p>
</li>
</ul>
<h3 id="主从复制的原理"><a href="#主从复制的原理" class="headerlink" title="主从复制的原理"></a>主从复制的原理</h3><ul>
<li>主从复制的步骤</li>
</ul>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/94D51A80-A0DB-4189-8F30-673260AC6FCC.png" alt=""></p>
<p>1.master将改变记录到二进制日志(binary log)</p>
<p>2.slave将master的binary log events(二进制日志事件)拷贝到它的中继日志(relay log)</p>
<p>3.slave重做中继日志中的事件，将改变反映它自己的数据。</p>
<h3 id="主从复制类型"><a href="#主从复制类型" class="headerlink" title="主从复制类型"></a>主从复制类型</h3><ul>
<li>基于语句的复制：</li>
</ul>
<p>在主服务器上执行的SQL语句，在从服务器上执行同样的语句。MySQL默认采用基于语句的复制，效率比较高。一旦发现没法精确复制时，会自动选着基于行的复制。</p>
<ul>
<li>基于行的复制：</li>
</ul>
<p>把改变的内容复制过去，而不是把命令在从服务器上执行一遍. 从mysql5.0开始支持。</p>
<ul>
<li>混合类型的复制:</li>
</ul>
<p>默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制。</p>
<h3 id="配置Master和Slave"><a href="#配置Master和Slave" class="headerlink" title="配置Master和Slave"></a>配置Master和Slave</h3><h4 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h4><pre><code>mysqladmin -u root -p password 123  // 修改密码
mysql&gt; grant replication slave,replication client on *.* to  zzf@10.249.17.45 identified by &quot;zzf&quot;;  //建立内部复制用户

编辑/etc/my.cnf 文件
server_id=1
log-bin=mysql-bin

重启服务
</code></pre><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/BAC-9068-D8174D803F18.png" alt=""></p>
<h4 id="Slave"><a href="#Slave" class="headerlink" title="Slave"></a>Slave</h4><pre><code>mysqladmin -u root -p password 123  // 修改密码
编辑/etc/my.cnf 文件
server_id=2
log-bin=mysql-bin
log_slave_updates=1

mysql&gt; change master to master_host=&apos;10.249.17.38&apos;,master_user=&apos;zzf&apos;,master_password=&apos;zzf&apos;,master_log_file=&apos;mysql-bin.000002&apos;,master_log_pos=106;
mysql&gt; start slave;
</code></pre><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/F2D3964D-8081-4F27-ACFF-39ADF603CCDB.png" alt=""></p>
<p>Slave_IO_Running: Yes</p>
<p>Slave_SQL_Running: Yes</p>
<h3 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h3><h4 id="Master-1"><a href="#Master-1" class="headerlink" title="Master"></a>Master</h4><pre><code>mysql&gt;
mysql&gt; create database zzf;
Query OK, 1 row affected (0.01 sec)
mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| test               |
| zzf                |
+--------------------+
4 rows in set (0.00 sec)
</code></pre><h4 id="Slave-1"><a href="#Slave-1" class="headerlink" title="Slave"></a>Slave</h4><pre><code>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| test               |
| zzf                |
+--------------------+
4 rows in set (0.00 sec)
</code></pre><p>已经同步成功</p>
</div></article></li></ul><div class="paginator"><a href="/page/2/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a><a href="/page/4/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="social"><a href="https://github.com/Abnerzhao" title="github" class="iconfont icon-github"></a><a href="mailto:opsabnerzhao@gmail.com" title="email" class="iconfont icon-email"></a><a href="http://weibo.com/2863179107/profile?topnav=1&amp;wvr=6&amp;is_all=1" title="weibo" class="iconfont icon-weibo"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2015-2017<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Abnerzhao</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>