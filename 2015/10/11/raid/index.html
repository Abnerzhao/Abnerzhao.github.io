<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RAID阵列卡系列命令备忘 · Abnerzhao</title><meta name="description" content="RAID阵列卡系列命令备忘 - Abnerzhao"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Abnerzhao"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://abnerzhao.readthedocs.io/" target="_blank" class="nav-list-link">WIKI</a></li><li class="nav-list-item"><a href="https://github.com/Abnerzhao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">RAID阵列卡系列命令备忘</h1><div class="post-info">Oct 11, 2015</div><div class="post-content"><h2 id="阵列卡类型"><a href="#阵列卡类型" class="headerlink" title="阵列卡类型"></a>阵列卡类型</h2><h3 id="查看阵列卡的类型"><a href="#查看阵列卡的类型" class="headerlink" title="查看阵列卡的类型"></a>查看阵列卡的类型</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ lspci | grep -i raid</div></pre></td></tr></table></figure>
<p>一般有LSI和HP的两种，对应的管理命令为 MegaCli 和 hpssacli</p>
<p>LSI官方网站和驱动下载： <a href="http://www.avagotech.com" target="_blank" rel="external">avagotech</a></p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="LSI的MegaSAS-RAID卡系列命令"><a href="#LSI的MegaSAS-RAID卡系列命令" class="headerlink" title="LSI的MegaSAS RAID卡系列命令"></a>LSI的MegaSAS RAID卡系列命令</h3><h4 id="显示所有逻辑磁盘组信息"><a href="#显示所有逻辑磁盘组信息" class="headerlink" title="显示所有逻辑磁盘组信息"></a>显示所有逻辑磁盘组信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -LDInfo -Lall -aALL</div><div class="line">$ MegaCli -LDInfo -Lall -aALL | grep State</div><div class="line">// 过滤State， 正常情况为：&quot;State : Optimal&quot;，否则为异常，例如 &quot;State : Degraded&quot;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="查看所有物理磁盘信息"><a href="#查看所有物理磁盘信息" class="headerlink" title="查看所有物理磁盘信息"></a>查看所有物理磁盘信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -PDList -aAll -NoLog</div><div class="line">$ MegaCli -PDList -aAll -NoLog | grep   &quot;Firmware state&quot;</div><div class="line">//如果 &quot;Firmware state&quot; 显示为非 Online，则表示该磁盘有问题。</div></pre></td></tr></table></figure>
<h4 id="显示-RAID-卡型号，RAID-设置及物理磁盘的相关信息"><a href="#显示-RAID-卡型号，RAID-设置及物理磁盘的相关信息" class="headerlink" title="显示 RAID 卡型号，RAID 设置及物理磁盘的相关信息"></a>显示 RAID 卡型号，RAID 设置及物理磁盘的相关信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -cfgdsply -aALL -NoLog</div></pre></td></tr></table></figure>
<h4 id="查看磁盘总数和磁盘类型"><a href="#查看磁盘总数和磁盘类型" class="headerlink" title="查看磁盘总数和磁盘类型"></a>查看磁盘总数和磁盘类型</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -cfgdsply -aALL -NoLog | grep &quot;Media Type:&quot;</div></pre></td></tr></table></figure>
<h4 id="查看磁盘的rebuild-进度"><a href="#查看磁盘的rebuild-进度" class="headerlink" title="查看磁盘的rebuild 进度"></a>查看磁盘的rebuild 进度</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -PDRbld -ShowProg -PhysDrv [32:3] -a0</div><div class="line">Rebuild Progress on Device at Enclosure 32, Slot 3 Completed 95% in 50 Minutes.</div></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># 显示 RAID 卡信息</div><div class="line">$ MegaCli -AdpAllInfo -aALL -NoLog</div><div class="line"></div><div class="line"># 查看 RAID 卡日志</div><div class="line">$ MegaCli -FwTermLog -Dsply -aALL -NoLog</div><div class="line"></div><div class="line"># 查看电池信息</div><div class="line">$ MegaCli -AdpBbuCmd -aAll -NoLog</div><div class="line"></div><div class="line"># 显示适配器个数</div><div class="line">$ MegaCli -adpCount -NoLog</div><div class="line"></div><div class="line">#显示适配器时间</div><div class="line">$ MegaCli -AdpGetTime –aALL -NoLog</div></pre></td></tr></table></figure>
<h4 id="初始化设置"><a href="#初始化设置" class="headerlink" title="初始化设置"></a>初始化设置</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -LDSetProp WB -LALL -aALL</div><div class="line">$ MegaCli -LDSetProp ADRA -LALL-aALL</div><div class="line">$ MegaCli -LDSetProp disDskCache -LALL-aALL</div><div class="line">$ MegaCli -LDSetProp CachedBadBBU -Lall -aALL</div></pre></td></tr></table></figure>
<h3 id="HP-Smart-Array-CLI-命令"><a href="#HP-Smart-Array-CLI-命令" class="headerlink" title="HP Smart Array CLI 命令"></a>HP Smart Array CLI 命令</h3><h4 id="显示raid卡信息"><a href="#显示raid卡信息" class="headerlink" title="显示raid卡信息"></a>显示raid卡信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl all show  config</div><div class="line">$ hpssacli ctrl all show detail config   //查看raid卡详细信息</div></pre></td></tr></table></figure>
<h4 id="显示所有物理磁盘信息"><a href="#显示所有物理磁盘信息" class="headerlink" title="显示所有物理磁盘信息"></a>显示所有物理磁盘信息</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl slot=0 pd all show status</div><div class="line">$ hpssacli ctrl slot=0 pd all show detail   //查看所有物理磁盘详细信息</div><div class="line">$ hpssacli ctrl all show config | grep physicaldrive  //查看磁盘总数和磁盘类型</div></pre></td></tr></table></figure>
<h4 id="查看电池状态"><a href="#查看电池状态" class="headerlink" title="查看电池状态"></a>查看电池状态</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl all show status | grep Battery</div></pre></td></tr></table></figure>
<h4 id="查看raid缓存策略"><a href="#查看raid缓存策略" class="headerlink" title="查看raid缓存策略"></a>查看raid缓存策略</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl all show detail config | grep &quot;Drive Write Cache:&quot;</div><div class="line">Drive Write Cache: Enabled</div><div class="line">// Drive Write Cache 有两种状态：Disable和Enable。</div><div class="line">// Disable代表将数据直接写入磁盘，Enable代表先将数据写入缓存然后在写入磁盘。</div></pre></td></tr></table></figure>
<h4 id="常见设置"><a href="#常见设置" class="headerlink" title="常见设置"></a>常见设置</h4><p>开启阵列逻辑盘cache加速策略</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl slot=1 logicaldrive 1 modify arrayaccelerator=enable</div></pre></td></tr></table></figure>
<p>没有电池的情况下开启raid写缓存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl slot=1 modify nobatterywritecache=enable forced</div></pre></td></tr></table></figure>
<p>启用物理磁盘cache功能</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl slot=1 modify drivewritecache=enable</div></pre></td></tr></table></figure>
<p>设置读写百分比</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ hpssacli ctrl slot=1 modify cacheratio=25/75</div></pre></td></tr></table></figure>
<h2 id="raid电池策略"><a href="#raid电池策略" class="headerlink" title="raid电池策略"></a>raid电池策略</h2><h3 id="电池作用"><a href="#电池作用" class="headerlink" title="电池作用"></a>电池作用</h3><p>保护数据：当服务器掉电时，raid电池提供电量保证raid卡缓存的数据写入磁盘。</p>
<h3 id="电池的充放电"><a href="#电池的充放电" class="headerlink" title="电池的充放电"></a>电池的充放电</h3><p>由于电池是可充电电池，在空闲时候会有微弱的放电。当电量低于一定的阀值，raid卡程序会进行一次放电，将剩余电量放掉然后再充电。在充放电的过程，raid的缓存策略会发生改变，当电池电量低于阀值时，raid卡程序会认为电池不可用，从而禁用了缓存策略，这时数据会直接写入磁盘，raid IO性能会下降，系统的IO的负载会升高。对于高IO的应用，IO性能下降的影响还是比较大。</p>
<h3 id="电池充放电对IO影响的解决方案"><a href="#电池充放电对IO影响的解决方案" class="headerlink" title="电池充放电对IO影响的解决方案"></a>电池充放电对IO影响的解决方案</h3><p>1.检测电池的状态，掌握电池充放电的周期，在机器负载低的情况下手动强制放电。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -AdpBbuCmd -BbuLearn -aALL</div></pre></td></tr></table></figure>
<p>电池在放电过程策略会从WriteBack变成WriteThrough</p>
<p>2.强制改变raid策略，使其在充放电过程不禁用raid卡缓存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ MegaCli -LDSetProp CachedBadBBU -lall -a0</div></pre></td></tr></table></figure>
<p>raid缓存策略从No Write Cache if Bad BBU变成Write Cache OK if Bad BBU，这样在充放电的过程IO性能也不下降。</p>
<h3 id="简单介绍四种raid-cache策略"><a href="#简单介绍四种raid-cache策略" class="headerlink" title="简单介绍四种raid cache策略"></a>简单介绍四种raid cache策略</h3><ul>
<li>WriteBack</li>
</ul>
<p>进行写操作时，将数据写入RAID卡缓存，并直接返回，RAID卡控制器将在系统负载低或者Cache满了的情况下把数据写入硬盘。该设置会大大提升RAID卡写性能，绝大多数的情况下会降低系统IO负载。数据的可靠性由RAID卡的BBU(Battery Backup Unit)进行保证。</p>
<ul>
<li>WriteThrough</li>
</ul>
<p>数据写操作不使用缓存，数据直接写入磁盘。RAID卡写性能下降，在大多数情况下该设置会造成系统IO负载上升。</p>
<ul>
<li>No Write Cache if Bad BBU</li>
</ul>
<p>如果BBU出问题，则关闭Write Cache。由WriteBack自动切换到WriteThrough模式。如果没有特殊要求，强烈建议采用该设置，以确保数据的安全。</p>
<ul>
<li>Write Cache OK if Bad BBU</li>
</ul>
<p>如果BBU出问题，依然启用Write Cache. 这是不推荐的设置，BBU出问题将无法保证断电情况下数据的正常，如果此时依然采用WriteBack模式，遇到断电将发生数据丢失。除非有UPS作额外保证，不然不推荐采用这个设置。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.inetmail.ca/Wiki/index.php/HP_Smart_Array_CLI_commands_on_ESXi" target="_blank" rel="external">HP_Smart_Array_CLI_commands</a><br><a href="http://zh.community.dell.com/techcenter/b/weblog/archive/2013/03/07/megacli-command-share" target="_blank" rel="external">MegaCli常用管理命令汇总</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2015/10/21/dmidecode/" class="prev">PREV</a><a href="/2015/09/15/ipmitool/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">Abnerzhao</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>