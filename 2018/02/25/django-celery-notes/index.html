<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Django Celery 定时任务笔记 · Abnerzhao</title><meta name="description" content="Django Celery 定时任务笔记 - Abnerzhao"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Abnerzhao"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Abnerzhao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Django Celery 定时任务笔记</h1><div class="post-info">Feb 25, 2018</div><div class="post-content"><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>Python 2.7</li>
<li>Djang 1.10</li>
<li>celery 4.1.0</li>
<li>RabbitMQ 3.2.4</li>
</ul>
<h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><h4 id="创建虚拟环境，构建-Django-项目"><a href="#创建虚拟环境，构建-Django-项目" class="headerlink" title="创建虚拟环境，构建 Django 项目"></a>创建虚拟环境，构建 Django 项目</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ virtualenv django-exp</div><div class="line">$ source django-exp/bin/activate</div><div class="line">$ pip intall django==1.10</div><div class="line">$ django-admin startproject myproject</div><div class="line">$ cd myproject/</div><div class="line">$ django-admin startapp myapp</div><div class="line">$ tree</div><div class="line">.</div><div class="line">├── manage.py</div><div class="line">├── myapp</div><div class="line">│   ├── admin.py</div><div class="line">│   ├── apps.py</div><div class="line">│   ├── __init__.py</div><div class="line">│   ├── migrations</div><div class="line">│   │   └── __init__.py</div><div class="line">│   ├── models.py</div><div class="line">│   ├── tests.py</div><div class="line">│   └── views.py</div><div class="line">└── myproject</div><div class="line">    ├── __init__.py</div><div class="line">    ├── settings.py</div><div class="line">    ├── urls.py</div><div class="line">    └── wsgi.py</div><div class="line">$ pip install celery</div><div class="line">$ pip install pysqlite</div><div class="line">$ sudo apt-get install rabbitmq-server</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="配置-Celery"><a href="#配置-Celery" class="headerlink" title="配置 Celery"></a>配置 Celery</h4><ul>
<li><code>myproject/celery.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myproject/celery.py</div><div class="line">from __future__ import absolute_import, unicode_literals</div><div class="line">import os</div><div class="line">from celery import Celery</div><div class="line">from django.conf import settings</div><div class="line"></div><div class="line"># set the default Django settings module for the &apos;celery&apos; program.</div><div class="line">os.environ.setdefault(&apos;DJANGO_SETTINGS_MODULE&apos;, &apos;myproject.settings&apos;)</div><div class="line"></div><div class="line">app = Celery(&apos;myproject&apos;)</div><div class="line"></div><div class="line"># Using a string here means the worker don&apos;t have to serialize</div><div class="line"># the configuration object to child processes.</div><div class="line"># - namespace=&apos;CELERY&apos; means all celery-related configuration keys</div><div class="line">#   should have a `CELERY_` prefix.</div><div class="line">app.config_from_object(&apos;django.conf:settings&apos;)</div><div class="line"></div><div class="line"># Load task modules from all registered Django app configs.</div><div class="line">app.autodiscover_tasks(lambda: settings.INSTALLED_APPS)</div><div class="line"></div><div class="line"></div><div class="line">@app.task(bind=True)</div><div class="line">def debug_task(self):</div><div class="line">    print(&apos;Request: &#123;0!r&#125;&apos;.format(self.request))</div></pre></td></tr></table></figure>
<ul>
<li><code>myproject/__init__.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myproject/__init__.py</div><div class="line">from __future__ import absolute_import, unicode_literals</div><div class="line"></div><div class="line"># This will make sure the app is always imported when</div><div class="line"># Django starts so that shared_task will use this app.</div><div class="line">from .celery import app as celery_app</div><div class="line"></div><div class="line">__all__ = [&apos;celery_app&apos;]</div></pre></td></tr></table></figure>
<ul>
<li><code>myapp/tasks.py</code> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myapp/tasks.py</div><div class="line">from __future__ import absolute_import, unicode_literals</div><div class="line">from celery.task.schedules import crontab</div><div class="line">from celery.decorators import periodic_task</div><div class="line"></div><div class="line">@periodic_task(run_every=(crontab(minute=&quot;*/1&quot;))) # 每隔一分钟写入 hello world</div><div class="line">def hello_world():</div><div class="line">    with open(&quot;/tmp/output.txt&quot;, &quot;a&quot;) as f:</div><div class="line">        f.write(&quot;hello world&quot;)</div><div class="line">        f.write(&quot;\n&quot;)</div></pre></td></tr></table></figure>
<ul>
<li><code>myproject/setting.py</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat myproject/setting.py</div><div class="line">...</div><div class="line">CELERY_BROKER_URL = &apos;amqp://localhost&apos;</div><div class="line">CELERY_ACCEPT_CONTENT = [&apos;application/json&apos;]</div><div class="line">CELERY_RESULT_SERIALIZER = &apos;json&apos;</div><div class="line">CELERY_TASK_SERIALIZER = &apos;json&apos;</div><div class="line"></div><div class="line">INSTALLED_APPS = [</div><div class="line">    &apos;django.contrib.admin&apos;,</div><div class="line">    &apos;django.contrib.auth&apos;,</div><div class="line">    &apos;django.contrib.contenttypes&apos;,</div><div class="line">    &apos;django.contrib.sessions&apos;,</div><div class="line">    &apos;django.contrib.messages&apos;,</div><div class="line">    &apos;django.contrib.staticfiles&apos;,</div><div class="line">    &apos;myapp&apos;,</div><div class="line">]</div><div class="line">...</div><div class="line">LANGUAGE_CODE = &apos;en-us&apos;</div><div class="line">TIME_ZONE = &apos;Asia/Shanghai&apos;</div><div class="line">USE_I18N = True</div><div class="line">USE_L10N = True</div><div class="line">USE_TZ = False</div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="同步数据库"><a href="#同步数据库" class="headerlink" title="同步数据库"></a>同步数据库</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ python manage.py makemigrations</div><div class="line">$ python manage.py migrate</div></pre></td></tr></table></figure>
<h4 id="启动-worker-和-beat"><a href="#启动-worker-和-beat" class="headerlink" title="启动 worker 和 beat"></a>启动 worker 和 beat</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ celery -A myproject worker -l info -B</div><div class="line">...</div><div class="line">[2018-02-25 16:59:00,000: INFO/Beat] Scheduler: Sending due task myapp.tasks.hello_world (myapp.tasks.hello_world)</div><div class="line">[2018-02-25 16:59:00,008: INFO/MainProcess] Received task: myapp.tasks.hello_world[e1aa8b70-586d-4a2b-b598-64c322b211a7]</div><div class="line">[2018-02-25 16:59:00,010: INFO/MainProcess] Task myapp.tasks.hello_world[e1aa8b70-586d-4a2b-b598-64c322b211a7] succeeded in 0.00109826028347s: None</div><div class="line">[2018-02-25 17:00:00,056: INFO/Beat] Scheduler: Sending due task myapp.tasks.hello_world (myapp.tasks.hello_world)</div><div class="line">[2018-02-25 17:00:00,058: INFO/MainProcess] Received task: myapp.tasks.hello_world[78ec725f-61b7-4fe6-a1c1-b2c60fb9ffed]</div><div class="line">[2018-02-25 17:00:00,060: INFO/MainProcess] Task myapp.tasks.hello_world[78ec725f-61b7-4fe6-a1c1-b2c60fb9ffed] succeeded in 0.000685669481754s: None</div><div class="line">$ tail /tmp/output.txt</div><div class="line">hello world</div><div class="line">hello world</div><div class="line">hello world</div><div class="line">hello world</div><div class="line">hello world</div></pre></td></tr></table></figure>
<p>除了使用该方法，我们还可以通过 admin 后台设置计划任务，不过需要安装 <code>django-celery</code> 并设置 Database-backed，具体请参考官方文档。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://docs.celeryproject.org/en/v4.0.2/django/first-steps-with-django.html" target="_blank" rel="external">Using Celery with Django</a></p>
<p><a href="http://www.marinamele.com/2014/02/how-to-install-celery-on-django-and.html" target="_blank" rel="external">How to install Celery on Django and Create a Periodic Task</a></p>
<p><a href="https://medium.com/@yehandjoe/celery-4-periodic-task-in-django-9f6b5a8c21c7" target="_blank" rel="external">Celery 4 Periodic Task in Django</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/03/25/celery-background/" class="prev">PREV</a><a href="/2017/12/02/2017年11月读书总结/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">Abnerzhao</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>