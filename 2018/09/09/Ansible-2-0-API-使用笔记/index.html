<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Ansible 2.0 API 使用笔记 · Abnerzhao</title><meta name="description" content="Ansible 2.0 API 使用笔记 - Abnerzhao"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Abnerzhao"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Abnerzhao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Ansible 2.0 API 使用笔记</h1><div class="post-info">Sep 9, 2018</div><div class="post-content"><p>Ansible 2.0 较 1.0 变化还是比较大的，通过阅读 Changelog 简单梳理一下变化较大的点：</p>
<ul>
<li>block/rescue/always 指令可以创建任务块并引入了类似 Python 中 try/except/finally 异常处理结构</li>
<li>Playbook 解析、错误报告和动态执行 include 任务</li>
<li>新增 Execution Strategy Plugins（执行策略插件）</li>
<li>新增一些模块，包括 OpenStack 管理模块、扩展了对 AWS、VMware、Windows环境的支持，同时对 Docker 模块和连接插件进行了改进</li>
<li>许多插件 API 都发生了变化，新的 API 更易于使用和测试</li>
</ul>
<h3 id="Ansible-2-0-API-使用"><a href="#Ansible-2-0-API-使用" class="headerlink" title="Ansible 2.0 API 使用"></a>Ansible 2.0 API 使用</h3><h4 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h4><a id="more"></a>
<p>exp1.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</div><div class="line"><span class="keyword">from</span> ansible.inventory <span class="keyword">import</span> Inventory</div><div class="line"><span class="keyword">from</span> ansible.inventory.group <span class="keyword">import</span> Group</div><div class="line"><span class="keyword">from</span> ansible.inventory.host <span class="keyword">import</span> Host</div><div class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</div><div class="line"><span class="keyword">from</span> ansible.playbook.play <span class="keyword">import</span> Play</div><div class="line"><span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</div><div class="line"><span class="keyword">from</span> ansible.vars <span class="keyword">import</span> VariableManager</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallbackModule</span><span class="params">(CallbackBase)</span>:</span></div><div class="line"></div><div class="line">    CALLBACK_VERSION = <span class="number">2.0</span></div><div class="line">    CALLBACK_TYPE = <span class="string">'stored'</span></div><div class="line">    CALLBACK_NAME = <span class="string">'database'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        super(CallbackModule, self).__init__()</div><div class="line">        self.state = <span class="keyword">None</span></div><div class="line">        self.result = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_failed</span><span class="params">(self, result, ignore_errors=False)</span>:</span></div><div class="line">        self.state = <span class="string">'failed'</span></div><div class="line">        self.result = result._result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_ok</span><span class="params">(self, result)</span>:</span></div><div class="line">        self.result = result._result</div><div class="line">        self.state = <span class="string">'ok'</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_skipped</span><span class="params">(self, result)</span>:</span></div><div class="line">        self.state = <span class="string">'skipped'</span></div><div class="line">        self.result = result._result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_no_hosts</span><span class="params">(self, task)</span>:</span></div><div class="line">        print(<span class="string">'skipping: no hosts matched'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_playbook_on_task_start</span><span class="params">(self, task, is_conditional)</span>:</span></div><div class="line">        print(<span class="string">"TASK [%s]"</span> % task.get_name().strip())</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_playbook_on_play_start</span><span class="params">(self, play)</span>:</span></div><div class="line">        name = play.get_name().strip()</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name:</div><div class="line">            msg = <span class="string">"PLAY"</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            msg = <span class="string">"PLAY [%s]"</span> % name</div><div class="line">        print(msg)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_playbook_on_stats</span><span class="params">(self, stats)</span>:</span></div><div class="line">        hosts = sorted(stats.processed.keys())</div><div class="line">        <span class="keyword">for</span> h <span class="keyword">in</span> hosts:</div><div class="line">            t = stats.summarize(h)</div><div class="line"></div><div class="line">            msg = <span class="string">"PLAY RECAP [%s] : %s %s %s %s %s"</span> % (</div><div class="line">                h,</div><div class="line">                <span class="string">"ok: %s"</span> % (t[<span class="string">'ok'</span>]),</div><div class="line">                <span class="string">"changed: %s"</span> % (t[<span class="string">'changed'</span>]),</div><div class="line">                <span class="string">"unreachable: %s"</span> % (t[<span class="string">'unreachable'</span>]),</div><div class="line">                <span class="string">"skipped: %s"</span> % (t[<span class="string">'skipped'</span>]),</div><div class="line">                <span class="string">"failed: %s"</span> % (t[<span class="string">'failures'</span>]),</div><div class="line">            )</div><div class="line">        print(msg)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInventory</span><span class="params">(Inventory)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, resource, loader, variable_manager, host_list=[])</span>:</span></div><div class="line">        super(MyInventory, self).__init__(loader=loader, variable_manager=variable_manager, host_list=host_list)</div><div class="line">        self.resource = resource</div><div class="line">        self.gen_inventory()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_add_group</span><span class="params">(self, hosts, groupname, groupvars=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        add hosts to a group</div><div class="line">        """</div><div class="line">        my_group = Group(name=groupname)</div><div class="line"></div><div class="line">        <span class="comment"># if group variables exists, add them to group</span></div><div class="line">        <span class="keyword">if</span> groupvars:</div><div class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> groupvars.items():</div><div class="line">                my_group.set_variable(key, value)</div><div class="line"></div><div class="line">        <span class="comment"># add hosts to group</span></div><div class="line">        <span class="keyword">for</span> host <span class="keyword">in</span> hosts:</div><div class="line">            <span class="comment"># set connection variables</span></div><div class="line">            hostname = host.get(<span class="string">"hostname"</span>)</div><div class="line">            hostip = host.get(<span class="string">'ip'</span>, hostname)</div><div class="line">            hostport = host.get(<span class="string">"port"</span>)</div><div class="line">            username = host.get(<span class="string">"username"</span>)</div><div class="line">            password = host.get(<span class="string">"password"</span>)</div><div class="line">            ssh_key = host.get(<span class="string">"ssh_key"</span>)</div><div class="line">            my_host = Host(name=hostname, port=hostport)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_host'</span>, hostip)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_port'</span>, hostport)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_user'</span>, username)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_pass'</span>, password)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_private_key_file'</span>, ssh_key)</div><div class="line"></div><div class="line">            <span class="comment"># set other variables</span></div><div class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> host.items():</div><div class="line">                <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"hostname"</span>, <span class="string">"port"</span>, <span class="string">"username"</span>, <span class="string">"password"</span>]:</div><div class="line">                    my_host.set_variable(key, value)</div><div class="line">            <span class="comment"># add to group</span></div><div class="line">            my_group.add_host(my_host)</div><div class="line"></div><div class="line">        self.add_group(my_group)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gen_inventory</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        add hosts to inventory.</div><div class="line">        """</div><div class="line">        <span class="keyword">if</span> isinstance(self.resource, list):</div><div class="line">            self.my_add_group(self.resource, <span class="string">'default_group'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">elif</span> isinstance(self.resource, dict):</div><div class="line">            <span class="keyword">for</span> groupname, hosts_and_vars <span class="keyword">in</span> self.resource.iteritems():</div><div class="line">                self.my_add_group(hosts_and_vars.get(<span class="string">"hosts"</span>), groupname, hosts_and_vars.get(<span class="string">"vars"</span>))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Options</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Options class to replace Ansible OptParser</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, verbosity=None, inventory=None, listhosts=None, subset=None, module_paths=None, extra_vars=None,</span></span></div><div class="line">                 forks=None, ask_vault_pass=None, vault_password_files=None, new_vault_password_file=None,</div><div class="line">                 output_file=None, tags=<span class="string">''</span>, skip_tags=<span class="string">''</span>, one_line=None, tree=None, ask_sudo_pass=None, ask_su_pass=None,</div><div class="line">                 sudo=None, sudo_user=None, become=None, become_method=None, become_user=None, become_ask_pass=None,</div><div class="line">                 ask_pass=None, private_key_file=None, remote_user=None, connection=None, timeout=None, ssh_common_args=None,</div><div class="line">                 sftp_extra_args=None, scp_extra_args=None, ssh_extra_args=None, poll_interval=None, seconds=None, check=None,</div><div class="line">                 syntax=None, diff=None, force_handlers=None, flush_cache=None, listtasks=None, listtags=None, module_path=None):</div><div class="line">        self.verbosity = verbosity</div><div class="line">        self.inventory = inventory</div><div class="line">        self.listhosts = listhosts</div><div class="line">        self.subset = subset</div><div class="line">        self.module_paths = module_paths</div><div class="line">        self.extra_vars = extra_vars</div><div class="line">        self.forks = forks</div><div class="line">        self.ask_vault_pass = ask_vault_pass</div><div class="line">        self.vault_password_files = vault_password_files</div><div class="line">        self.new_vault_password_file = new_vault_password_file</div><div class="line">        self.output_file = output_file</div><div class="line">        self.tags = tags</div><div class="line">        self.skip_tags = skip_tags</div><div class="line">        self.one_line = one_line</div><div class="line">        self.tree = tree</div><div class="line">        self.ask_sudo_pass = ask_sudo_pass</div><div class="line">        self.ask_su_pass = ask_su_pass</div><div class="line">        self.sudo = sudo</div><div class="line">        self.sudo_user = sudo_user</div><div class="line">        self.become = become</div><div class="line">        self.become_method = become_method</div><div class="line">        self.become_user = become_user</div><div class="line">        self.become_ask_pass = become_ask_pass</div><div class="line">        self.ask_pass = ask_pass</div><div class="line">        self.private_key_file = private_key_file</div><div class="line">        self.remote_user = remote_user</div><div class="line">        self.connection = connection</div><div class="line">        self.timeout = timeout</div><div class="line">        self.ssh_common_args = ssh_common_args</div><div class="line">        self.sftp_extra_args = sftp_extra_args</div><div class="line">        self.scp_extra_args = scp_extra_args</div><div class="line">        self.ssh_extra_args = ssh_extra_args</div><div class="line">        self.poll_interval = poll_interval</div><div class="line">        self.seconds = seconds</div><div class="line">        self.check = check</div><div class="line">        self.syntax = syntax</div><div class="line">        self.diff = diff</div><div class="line">        self.force_handlers = force_handlers</div><div class="line">        self.flush_cache = flush_cache</div><div class="line">        self.listtasks = listtasks</div><div class="line">        self.listtags = listtags</div><div class="line">        self.module_path = module_path</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Runner</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, resource)</span>:</span></div><div class="line"></div><div class="line">        self.options = Options()</div><div class="line">        self.options.connection = <span class="string">'ssh'</span>  <span class="comment"># Need a connection type "smart" or "ssh"</span></div><div class="line">        self.options.become = <span class="keyword">True</span></div><div class="line">        self.options.become_method = <span class="string">'sudo'</span></div><div class="line">        self.options.become_user = <span class="string">'root'</span></div><div class="line"></div><div class="line">        <span class="comment"># Become Pass Needed if not logging in as user root (do not support now)</span></div><div class="line">        passwords = &#123;<span class="string">'become_pass'</span>: <span class="string">''</span>&#125;</div><div class="line"></div><div class="line">        <span class="comment"># Gets data from YAML/JSON files</span></div><div class="line">        self.loader = DataLoader()</div><div class="line"></div><div class="line">        <span class="comment"># All the variables from all the various places</span></div><div class="line">        self.variable_manager = VariableManager()</div><div class="line"></div><div class="line">        <span class="comment"># Set inventory, using most of above objects</span></div><div class="line">        self.inventory = MyInventory(resource=resource, loader=self.loader, variable_manager=self.variable_manager)</div><div class="line">        self.variable_manager.set_inventory(self.inventory)</div><div class="line"></div><div class="line">        <span class="comment"># set callback object</span></div><div class="line">        self.results_callback = CallbackModule()</div><div class="line"></div><div class="line">        <span class="comment"># playbook</span></div><div class="line">        self.tqm = TaskQueueManager(</div><div class="line">            inventory=self.inventory,</div><div class="line">            variable_manager=self.variable_manager,</div><div class="line">            loader=self.loader,</div><div class="line">            options=self.options,</div><div class="line">            passwords=passwords,</div><div class="line">            stdout_callback=self.results_callback,</div><div class="line">        )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self, module_name=<span class="string">'shell'</span>, module_args=<span class="string">''</span>,)</span>:</span></div><div class="line">        play_source = dict(</div><div class="line">            name=<span class="string">'Ansible Play'</span>,</div><div class="line">            hosts=<span class="string">'*'</span>,</div><div class="line">            gather_facts=<span class="string">'no'</span>,</div><div class="line">            tasks=[</div><div class="line">                dict(action=dict(module=module_name, args=module_args)),</div><div class="line">            ]</div><div class="line">        )</div><div class="line"></div><div class="line">        self.play = Play().load(play_source, variable_manager=self.variable_manager, loader=self.loader)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            ret = self.tqm.run(self.play)</div><div class="line">            <span class="comment"># print(ret)</span></div><div class="line">            <span class="keyword">return</span> ret, self.results_callback.result</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            self.tqm.cleanup()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    res = [&#123;<span class="string">"hostname"</span>: <span class="string">"localhost"</span>&#125;]</div><div class="line">    tqm = Runner(res)</div><div class="line">    ret, result = tqm.run(module_args=<span class="string">'uptime'</span>)</div><div class="line">    print(json.dumps(result, indent=<span class="number">4</span>))</div><div class="line"></div><div class="line"><span class="comment"># 执行结果</span></div><div class="line">PLAY [Ansible Play]</div><div class="line">TASK [command]</div><div class="line">&#123;</div><div class="line">    <span class="string">"changed"</span>: true,</div><div class="line">    <span class="string">"end"</span>: <span class="string">"2018-09-09 18:57:36.888527"</span>,</div><div class="line">    <span class="string">"stdout"</span>: <span class="string">" 18:57:36 up 11 days, 11:34,  3 users,  load average: 0.00, 0.00, 0.00"</span>,</div><div class="line">    <span class="string">"cmd"</span>: <span class="string">"uptime"</span>,</div><div class="line">    <span class="string">"rc"</span>: <span class="number">0</span>,</div><div class="line">    <span class="string">"start"</span>: <span class="string">"2018-09-09 18:57:36.878191"</span>,</div><div class="line">    <span class="string">"stderr"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"delta"</span>: <span class="string">"0:00:00.010336"</span>,</div><div class="line">    <span class="string">"invocation"</span>: &#123;</div><div class="line">        <span class="string">"module_args"</span>: &#123;</div><div class="line">            <span class="string">"warn"</span>: true,</div><div class="line">            <span class="string">"executable"</span>: null,</div><div class="line">            <span class="string">"_uses_shell"</span>: true,</div><div class="line">            <span class="string">"_raw_params"</span>: <span class="string">"uptime"</span>,</div><div class="line">            <span class="string">"removes"</span>: null,</div><div class="line">            <span class="string">"creates"</span>: null,</div><div class="line">            <span class="string">"chdir"</span>: null</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"_ansible_parsed"</span>: true,</div><div class="line">    <span class="string">"stdout_lines"</span>: [</div><div class="line">        <span class="string">" 18:57:36 up 11 days, 11:34,  3 users,  load average: 0.00, 0.00, 0.00"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"stderr_lines"</span>: [],</div><div class="line">    <span class="string">"_ansible_no_log"</span>: false</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="运行-Playbook"><a href="#运行-Playbook" class="headerlink" title="运行 Playbook"></a>运行 Playbook</h4><p>exp2.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line"></div><div class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</div><div class="line"><span class="keyword">from</span> ansible.vars <span class="keyword">import</span> VariableManager</div><div class="line"><span class="keyword">from</span> ansible.inventory <span class="keyword">import</span> Inventory</div><div class="line"><span class="keyword">from</span> ansible.executor.playbook_executor <span class="keyword">import</span> PlaybookExecutor</div><div class="line"></div><div class="line">variable_manager = VariableManager()</div><div class="line">loader = DataLoader()</div><div class="line"></div><div class="line">inventory = Inventory(loader=loader, variable_manager=variable_manager,  host_list=<span class="string">'/home/vagrant/scripts/ansible_api/hosts'</span>)</div><div class="line">playbook_path = <span class="string">'/home/vagrant/scripts/ansible_api/test.yml'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(playbook_path):</div><div class="line">    print(<span class="string">'[INFO] The playbook does not exist'</span>)</div><div class="line">    sys.exit()</div><div class="line"></div><div class="line">Options = namedtuple(<span class="string">'Options'</span>, [<span class="string">'listtags'</span>, <span class="string">'listtasks'</span>, <span class="string">'listhosts'</span>, <span class="string">'syntax'</span>, <span class="string">'connection'</span>,<span class="string">'module_path'</span>, <span class="string">'forks'</span>, <span class="string">'remote_user'</span>, <span class="string">'private_key_file'</span>, <span class="string">'ssh_common_args'</span>, <span class="string">'ssh_extra_args'</span>, <span class="string">'sftp_extra_args'</span>, <span class="string">'scp_extra_args'</span>, <span class="string">'become'</span>, <span class="string">'become_method'</span>, <span class="string">'become_user'</span>, <span class="string">'verbosity'</span>, <span class="string">'check'</span>])</div><div class="line"></div><div class="line">options = Options(listtags=<span class="keyword">False</span>, listtasks=<span class="keyword">False</span>, listhosts=<span class="keyword">False</span>, syntax=<span class="keyword">False</span>, connection=<span class="string">'local'</span>, module_path=<span class="keyword">None</span>, forks=<span class="number">100</span>, remote_user=<span class="string">'stephen'</span>, private_key_file=<span class="keyword">None</span>, ssh_common_args=<span class="keyword">None</span>, ssh_extra_args=<span class="keyword">None</span>, sftp_extra_args=<span class="keyword">None</span>, scp_extra_args=<span class="keyword">None</span>, become=<span class="keyword">False</span>, become_method=<span class="keyword">None</span>, become_user=<span class="string">'root'</span>, verbosity=<span class="keyword">None</span>, check=<span class="keyword">False</span>)</div><div class="line"></div><div class="line">variable_manager.extra_vars = &#123;<span class="string">'hosts'</span>: <span class="string">'localhost'</span>&#125;</div><div class="line"></div><div class="line">passwords = &#123;&#125;</div><div class="line"></div><div class="line">pbex = PlaybookExecutor(playbooks=[playbook_path], inventory=inventory, variable_manager=variable_manager, loader=loader, options=options, passwords=passwords)</div><div class="line"></div><div class="line">results = pbex.run()</div><div class="line"></div><div class="line"><span class="comment"># 执行结果</span></div><div class="line">PLAY [default_group] ***********************************************************************************************************************************************************************************************</div><div class="line"></div><div class="line">TASK [kernel release info] *****************************************************************************************************************************************************************************************</div><div class="line">changed: [localhost]</div><div class="line"></div><div class="line">TASK [memory info] *************************************************************************************************************************************************************************************************</div><div class="line">changed: [localhost]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************************************************************************************************************************************************</div><div class="line">localhost                  : ok=<span class="number">2</span>    changed=<span class="number">2</span>    unreachable=<span class="number">0</span>    failed=<span class="number">0</span></div></pre></td></tr></table></figure>
<p>exp3.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> ansible.inventory <span class="keyword">import</span> Inventory</div><div class="line"><span class="keyword">from</span> ansible.inventory.group <span class="keyword">import</span> Group</div><div class="line"><span class="keyword">from</span> ansible.inventory.host <span class="keyword">import</span> Host</div><div class="line"><span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</div><div class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</div><div class="line"><span class="keyword">from</span> ansible.vars <span class="keyword">import</span> VariableManager</div><div class="line"><span class="keyword">from</span> ansible.executor.playbook_executor <span class="keyword">import</span> PlaybookExecutor</div><div class="line"><span class="keyword">from</span> ansible <span class="keyword">import</span> constants <span class="keyword">as</span> C</div><div class="line"><span class="keyword">from</span> ansible.utils.ssh_functions <span class="keyword">import</span> check_for_controlpersist</div><div class="line"><span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallBackPlaybookExecutor</span><span class="params">(PlaybookExecutor)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    封装 PlaybookExecutor， 添加 stdout_callback 回调方法</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, playbooks, inventory, variable_manager, loader, options, passwords, stdout_callback=None)</span>:</span></div><div class="line">        self._playbooks = playbooks</div><div class="line">        self._inventory = inventory</div><div class="line">        self._variable_manager = variable_manager</div><div class="line">        self._loader = loader</div><div class="line">        self._options = options</div><div class="line">        self.passwords = passwords</div><div class="line">        self._unreachable_hosts = dict()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> options.listhosts <span class="keyword">or</span> options.listtasks <span class="keyword">or</span> options.listtags <span class="keyword">or</span> options.syntax:</div><div class="line">            self._tqm = <span class="keyword">None</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._tqm = TaskQueueManager(</div><div class="line">                inventory=inventory,</div><div class="line">                variable_manager=variable_manager,</div><div class="line">                loader=loader,</div><div class="line">                options=options,</div><div class="line">                passwords=self.passwords,</div><div class="line">                stdout_callback=stdout_callback)</div><div class="line"></div><div class="line">        check_for_controlpersist(C.ANSIBLE_SSH_EXECUTABLE)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyInventory</span><span class="params">(Inventory)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    动态添加主机和主机组</div><div class="line"></div><div class="line">    resource 数据格式：</div><div class="line">        &#123;</div><div class="line">            group1": &#123;</div><div class="line">                "hosts": [&#123;"hostname": "x.x.x.x", "port": "22", "username": "test", "password": "pass"&#125;, ...],</div><div class="line">                "vars": &#123;"var1": value1, "var2": value2, ...&#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        如果你只传入1个列表，这默认该列表内的所有主机属于 default_group 组,比如</div><div class="line">        [&#123;"hostname": "x.x.x.x", "port": "22", "username": "test", "password": "pass"&#125;, ...]</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, resource, loader, variable_manager, host_list=[])</span>:</span></div><div class="line">        super(MyInventory, self).__init__(loader=loader, variable_manager=variable_manager, host_list=host_list)</div><div class="line">        self.resource = resource</div><div class="line">        self.gen_inventory()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_add_group</span><span class="params">(self, hosts, groupname, groupvars=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        add hosts to a group</div><div class="line">        """</div><div class="line">        my_group = Group(name=groupname)</div><div class="line"></div><div class="line">        <span class="comment"># if group variables exists, add them to group</span></div><div class="line">        <span class="keyword">if</span> groupvars:</div><div class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> groupvars.items():</div><div class="line">                my_group.set_variable(key, value)</div><div class="line"></div><div class="line">        <span class="comment"># add hosts to group</span></div><div class="line">        <span class="keyword">for</span> host <span class="keyword">in</span> hosts:</div><div class="line">            <span class="comment"># set connection variables</span></div><div class="line">            hostname = host.get(<span class="string">"hostname"</span>)</div><div class="line">            hostip = host.get(<span class="string">'ip'</span>, hostname)</div><div class="line">            hostport = host.get(<span class="string">"port"</span>)</div><div class="line">            username = host.get(<span class="string">"username"</span>)</div><div class="line">            password = host.get(<span class="string">"password"</span>)</div><div class="line">            ssh_key = host.get(<span class="string">"ssh_key"</span>)</div><div class="line">            my_host = Host(name=hostname, port=hostport)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_host'</span>, hostip)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_port'</span>, hostport)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_user'</span>, username)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_pass'</span>, password)</div><div class="line">            my_host.set_variable(<span class="string">'ansible_ssh_private_key_file'</span>, ssh_key)</div><div class="line"></div><div class="line">            <span class="comment"># set other variables</span></div><div class="line">            <span class="keyword">for</span> key, value <span class="keyword">in</span> host.items():</div><div class="line">                <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"hostname"</span>, <span class="string">"port"</span>, <span class="string">"username"</span>, <span class="string">"password"</span>]:</div><div class="line">                    my_host.set_variable(key, value)</div><div class="line">            <span class="comment"># add to group</span></div><div class="line">            my_group.add_host(my_host)</div><div class="line"></div><div class="line">        self.add_group(my_group)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">gen_inventory</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        add hosts to inventory.</div><div class="line">        """</div><div class="line">        <span class="keyword">if</span> isinstance(self.resource, list):</div><div class="line">            self.my_add_group(self.resource, <span class="string">'default_group'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">elif</span> isinstance(self.resource, dict):</div><div class="line">            <span class="keyword">for</span> groupname, hosts_and_vars <span class="keyword">in</span> self.resource.iteritems():</div><div class="line">                self.my_add_group(hosts_and_vars.get(<span class="string">"hosts"</span>), groupname, hosts_and_vars.get(<span class="string">"vars"</span>))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultsCollector</span><span class="params">(CallbackBase)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">        super(ResultsCollector, self).__init__(*args, **kwargs)</div><div class="line">        self.results = &#123;<span class="string">'success'</span>: &#123;&#125;, <span class="string">'failed'</span>: &#123;&#125;, <span class="string">'unreachable'</span>: &#123;&#125;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_unreachable</span><span class="params">(self, result)</span>:</span></div><div class="line">        self.results[<span class="string">'unreachable'</span>][result._host.get_name()] = result._result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_ok</span><span class="params">(self, result, *args, **kwargs)</span>:</span></div><div class="line">        self.results[<span class="string">'success'</span>][result._host.get_name()] = result._result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_failed</span><span class="params">(self, result, *args, **kwargs)</span>:</span></div><div class="line">        self.results[<span class="string">'failed'</span>][result._host.get_name()] = result._result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_playbook_on_stats</span><span class="params">(self, stats)</span>:</span></div><div class="line">        print(json.dumps(&#123;host: stats.summarize(host) <span class="keyword">for</span> host <span class="keyword">in</span> stats.processed.keys()&#125;, indent=<span class="number">4</span>))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Options</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Options class to replace Ansible OptParser</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, verbosity=None, inventory=None, listhosts=None, subset=None, module_paths=None, extra_vars=None,</span></span></div><div class="line">                 forks=None, ask_vault_pass=None, vault_password_files=None, new_vault_password_file=None,</div><div class="line">                 output_file=None, tags=<span class="string">''</span>, skip_tags=<span class="string">''</span>, one_line=None, tree=None, ask_sudo_pass=None, ask_su_pass=None,</div><div class="line">                 sudo=None, sudo_user=None, become=None, become_method=None, become_user=None, become_ask_pass=None,</div><div class="line">                 ask_pass=None, private_key_file=None, remote_user=None, connection=None, timeout=None, ssh_common_args=None,</div><div class="line">                 sftp_extra_args=None, scp_extra_args=None, ssh_extra_args=None, poll_interval=None, seconds=None, check=None,</div><div class="line">                 syntax=None, diff=None, force_handlers=None, flush_cache=None, listtasks=None, listtags=None, module_path=None):</div><div class="line">        self.verbosity = verbosity</div><div class="line">        self.inventory = inventory</div><div class="line">        self.listhosts = listhosts</div><div class="line">        self.subset = subset</div><div class="line">        self.module_paths = module_paths</div><div class="line">        self.extra_vars = extra_vars</div><div class="line">        self.forks = forks</div><div class="line">        self.ask_vault_pass = ask_vault_pass</div><div class="line">        self.vault_password_files = vault_password_files</div><div class="line">        self.new_vault_password_file = new_vault_password_file</div><div class="line">        self.output_file = output_file</div><div class="line">        self.tags = tags</div><div class="line">        self.skip_tags = skip_tags</div><div class="line">        self.one_line = one_line</div><div class="line">        self.tree = tree</div><div class="line">        self.ask_sudo_pass = ask_sudo_pass</div><div class="line">        self.ask_su_pass = ask_su_pass</div><div class="line">        self.sudo = sudo</div><div class="line">        self.sudo_user = sudo_user</div><div class="line">        self.become = become</div><div class="line">        self.become_method = become_method</div><div class="line">        self.become_user = become_user</div><div class="line">        self.become_ask_pass = become_ask_pass</div><div class="line">        self.ask_pass = ask_pass</div><div class="line">        self.private_key_file = private_key_file</div><div class="line">        self.remote_user = remote_user</div><div class="line">        self.connection = connection</div><div class="line">        self.timeout = timeout</div><div class="line">        self.ssh_common_args = ssh_common_args</div><div class="line">        self.sftp_extra_args = sftp_extra_args</div><div class="line">        self.scp_extra_args = scp_extra_args</div><div class="line">        self.ssh_extra_args = ssh_extra_args</div><div class="line">        self.poll_interval = poll_interval</div><div class="line">        self.seconds = seconds</div><div class="line">        self.check = check</div><div class="line">        self.syntax = syntax</div><div class="line">        self.diff = diff</div><div class="line">        self.force_handlers = force_handlers</div><div class="line">        self.flush_cache = flush_cache</div><div class="line">        self.listtasks = listtasks</div><div class="line">        self.listtags = listtags</div><div class="line">        self.module_path = module_path</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayBook</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Ansible PlayBook 工具类</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, resource, *args, **kwargs)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        初始化</div><div class="line">        """</div><div class="line">        self.inventory = <span class="keyword">None</span></div><div class="line">        self.variable_manager = <span class="keyword">None</span></div><div class="line">        self.loader = <span class="keyword">None</span></div><div class="line">        self.options = <span class="keyword">None</span></div><div class="line">        self.results_callback = <span class="keyword">None</span></div><div class="line">        self.passwords = <span class="keyword">None</span></div><div class="line">        self.playbook = <span class="keyword">None</span></div><div class="line">        self.res = <span class="keyword">None</span></div><div class="line">        self.__initialize_data(resource)</div><div class="line">        self.results_callback = ResultsCollector()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__initialize_data</span><span class="params">(self, resource)</span>:</span></div><div class="line">        self.loader = DataLoader()</div><div class="line">        self.variable_manager = VariableManager()</div><div class="line">        self.options = Options()</div><div class="line">        self.options.connection = <span class="string">'ssh'</span></div><div class="line">        self.options.forks = <span class="number">2</span></div><div class="line">        self.inventory = MyInventory(resource=resource, loader=self.loader, variable_manager=self.variable_manager)</div><div class="line">        self.variable_manager.set_inventory(self.inventory)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init_playbook</span><span class="params">(self, files, extra_vars_dict=&#123;&#125;)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        初始化 playbook 并获取执行实例</div><div class="line">        """</div><div class="line">        <span class="keyword">if</span> extra_vars_dict:</div><div class="line">            self.variable_manager.extra_vars = extra_vars_dict</div><div class="line">        self.playbook = CallBackPlaybookExecutor(</div><div class="line">            playbooks=files,</div><div class="line">            inventory=self.inventory,</div><div class="line">            variable_manager=self.variable_manager,</div><div class="line">            loader=self.loader,</div><div class="line">            options=self.options,</div><div class="line">            passwords=self.passwords,</div><div class="line">            stdout_callback=self.results_callback</div><div class="line">        )</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        self.playbook.run()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    resource = [&#123;<span class="string">'hostname'</span>: <span class="string">'localhost'</span>&#125;]</div><div class="line">    pb = PlayBook(resource)</div><div class="line">    pb.init_playbook(files=[<span class="string">'/home/vagrant/scripts/ansible_api/test.yml'</span>], extra_vars_dict=&#123;<span class="string">'dirname'</span>: <span class="string">'/tmp/zzf'</span>&#125;)</div><div class="line">    pb.run()</div><div class="line"></div><div class="line"><span class="comment"># 执行结果</span></div><div class="line">&#123;</div><div class="line">    <span class="string">"localhost"</span>: &#123;</div><div class="line">        <span class="string">"ok"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"failures"</span>: <span class="number">0</span>,</div><div class="line">        <span class="string">"unreachable"</span>: <span class="number">0</span>,</div><div class="line">        <span class="string">"changed"</span>: <span class="number">1</span>,</div><div class="line">        <span class="string">"skipped"</span>: <span class="number">0</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由上面的例子我们可以发现 Ansible 2.0 的回调插件使用起来更加方便了，直接导入 CallbackBase 并重写一个类继承 CallbackBase 就可以实现我们自定义的回调方法。</p>
<p>对于 API 的具体使用就通过代码的实现简单介绍了一下，代码也是在网上参考其他人的进行简单地修改和测试。想要了解更多，建议看一遍文档和源代码。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://raw.githubusercontent.com/ansible/ansible/stable-2.0/CHANGELOG.md" target="_blank" rel="external">Ansible 2.0 Changelog</a></p>
<p><a href="https://serversforhackers.com/c/running-ansible-2-programmatically" target="_blank" rel="external">Running Ansible 2 Programmatically</a></p>
<p><a href="https://gist.github.com/choldrim/3211f1660291f871739379082f204c83" target="_blank" rel="external">ansible 2.0 api example</a></p>
<p><a href="https://segmentfault.com/a/1190000008009639" target="_blank" rel="external">Ansible 2.0 Api 运维应用</a></p>
<p><a href="https://www.mindg.cn/?p=2004" target="_blank" rel="external">Ansible 2.0+ 版本 api 使用</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/09/08/学习之道/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">Abnerzhao</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>