<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Celery 后台执行方法 · Abnerzhao</title><meta name="description" content="Celery 后台执行方法 - Abnerzhao"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Abnerzhao"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/abnerzhao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/book/" target="_self" class="nav-list-link">BOOK</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Celery 后台执行方法</h1><div class="post-info">Mar 25, 2018</div><div class="post-content"><h3 id="init-script"><a href="#init-script" class="headerlink" title="init-script"></a>init-script</h3><p>1.先下载两个脚本文件 <a href="https://github.com/celery/celery/tree/3.1/extra/generic-init.d/" target="_blank" rel="external">generic-init.d</a>，我的项目里有定时任务，所以两个都需要用到</p>
<p>2.创建配置文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/default/celeryd</div><div class="line"># Names of nodes to start</div><div class="line">#   most people will only start one node:</div><div class="line"></div><div class="line">CELERYD_NODES=&quot;worker1&quot; # work 任务节点</div><div class="line"></div><div class="line">#   but you can also start multiple and configure settings</div><div class="line">#   for each in CELERYD_OPTS</div><div class="line">#CELERYD_NODES=&quot;worker1 worker2 worker3&quot;</div><div class="line">#   alternatively, you can specify the number of nodes to start:</div><div class="line">#CELERYD_NODES=10</div><div class="line"></div><div class="line"># Absolute or relative path to the &apos;celery&apos; command:</div><div class="line"></div><div class="line">CELERY_BIN=&quot;/home/prod/softwares/python/bin/celery&quot; # celery 命令的绝对路径</div><div class="line"></div><div class="line"># App instance to use</div><div class="line"># comment out this line if you don&apos;t use an app</div><div class="line"></div><div class="line">CELERY_APP=&quot;wfstar&quot; # 应用实例</div><div class="line"></div><div class="line"># or fully qualified:</div><div class="line">#CELERY_APP=&quot;proj.tasks:app&quot;</div><div class="line"></div><div class="line"># Where to chdir at start.</div><div class="line">CELERYD_CHDIR=&quot;/home/prod/deploys/wfstar&quot; # 项目目录</div><div class="line"></div><div class="line"># Extra command-line arguments to the worker</div><div class="line"></div><div class="line">CELERYD_OPTS=&quot;--time-limit=300 --concurrency=8&quot; # 命令行参数，更多请参考 man 手册 </div><div class="line"></div><div class="line"># Configure node-specific settings by appending node name to arguments:</div><div class="line">#CELERYD_OPTS=&quot;--time-limit=300 -c 8 -c:worker2 4 -c:worker3 2 -Ofair:worker1&quot;</div><div class="line"># Set logging level to DEBUG</div><div class="line">#CELERYD_LOG_LEVEL=&quot;DEBUG&quot;</div><div class="line"></div><div class="line"># %n will be replaced with the first part of the nodename</div><div class="line"></div><div class="line">CELERYD_LOG_FILE=&quot;/var/log/celery/%n%I.log&quot;</div><div class="line">CELERYD_PID_FILE=&quot;/var/run/celery/%n.pid&quot;</div><div class="line"></div><div class="line"># Workers should run as an unprivileged user.</div><div class="line">#   You need to create this user manually (or you can choose</div><div class="line">#   a user/group combination that already exists (e.g., nobody).</div><div class="line"></div><div class="line">CELERYD_USER=&quot;prod&quot;</div><div class="line">CELERYD_GROUP=&quot;prod&quot;</div><div class="line"></div><div class="line"># If enabled pid and log directories will be created if missing,</div><div class="line"># and owned by the userid/group configured.</div><div class="line">CELERY_CREATE_DIRS=1  # 自动创建日志和 pid 文件</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>3.将下载的 <code>celeryd</code> 和 <code>celerybeat</code> 拷贝到 /etc/init.d 目录并赋予可执行权限</p>
<blockquote>
<p>注意部分内容的修改，如执行用户</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/init.d/celeryd</div><div class="line">...</div><div class="line">DEFAULT_USER=&quot;prod&quot;</div><div class="line">DEFAULT_PID_FILE=&quot;/var/run/celery/%n.pid&quot;</div><div class="line">DEFAULT_LOG_FILE=&quot;/var/log/celery/%n.log&quot;</div><div class="line">DEFAULT_LOG_LEVEL=&quot;INFO&quot;</div><div class="line">DEFAULT_NODES=&quot;celery&quot;</div><div class="line">DEFAULT_CELERYD=&quot;-m celery worker --detach&quot;</div><div class="line">...</div><div class="line">$ cat /etc/init.d/celerybeat</div><div class="line">...</div><div class="line">CELERY_BIN=$&#123;CELERY_BIN:-&quot;celery&quot;&#125;</div><div class="line">DEFAULT_USER=&quot;prod&quot;</div><div class="line">DEFAULT_PID_FILE=&quot;/var/run/celery/beat.pid&quot;</div><div class="line">DEFAULT_LOG_FILE=&quot;/var/log/celery/beat.log&quot;</div><div class="line">DEFAULT_LOG_LEVEL=&quot;INFO&quot;</div><div class="line">DEFAULT_CELERYBEAT=&quot;$CELERY_BIN beat&quot;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>4.启动 work 和 beat</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo /etc/init.d/celeryd start</div><div class="line">$ sudo /etc/init.d/celerybeat start</div></pre></td></tr></table></figure>
<h3 id="supervisord"><a href="#supervisord" class="headerlink" title="supervisord"></a>supervisord</h3><p>1.安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo apt-get install supervisor # 因为我这里的项目用的是 Python3，所以没有使用 pip 安装</div></pre></td></tr></table></figure>
<p>2.配置</p>
<p>在 <code>/etc/supervisor/conf.d</code> 新建配置文件 <code>celery_wfstar_worker.conf</code> 和 <code>celery_wfstar_beat.conf</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat /etc/supervisor/conf.d/celery_wfstar_worker.conf</div><div class="line">[program:wfstar_worker] </div><div class="line">command=/home/prod/deploys/wfstart_env/bin/celery -A wfstar worker -l info # 执行命令</div><div class="line">directory=/home/prod/deploys/wfstar  # 运行目录</div><div class="line">user=prod  # 执行用户</div><div class="line">numprocs=1 # 启动进程数</div><div class="line">stdout_logfile=/home/prod/deploys/wfstar/logs/celery.log # 标准输出日志</div><div class="line">redirect_stderr=true # 将 stderr 的日志会写入 stdout 日志文件中</div><div class="line">autostart=true # supervisor 启动，程序自动启动</div><div class="line">autorestart=true # 自动重启</div><div class="line">startsecs=10 # 进程启动 10s 后，状态为 running 则为启动成功</div><div class="line">stopwaitsecs = 600 </div><div class="line">killasgroup=true</div><div class="line">priority=998 # 优先级</div><div class="line">stopsignal=QUIT # 停止信号</div><div class="line"></div><div class="line">$ cat /etc/supervisor/conf.d/celery_wfstar_beat.conf</div><div class="line">[program:wfstar_beat]</div><div class="line">command=/home/prod/deploys/wfstart_env/bin/celery -A wfstar beat -l info</div><div class="line">directory=/home/prod/deploys/wfstar</div><div class="line">user=prod</div><div class="line">numprocs=1</div><div class="line">stdout_logfile=/home/prod/deploys/wfstar/logs/celerybeat.log</div><div class="line">redirect_stderr=true</div><div class="line">autostart=true</div><div class="line">autorestart=true</div><div class="line">startsecs=10</div><div class="line">stopwaitsecs = 600</div><div class="line">killasgroup=true</div><div class="line">priority=999</div><div class="line">stopsignal=QUIT</div></pre></td></tr></table></figure>
<p>配置文件可参考 <a href="https://github.com/celery/celery/tree/master/extra/supervisord" target="_blank" rel="external">github celery supervisord configure</a></p>
<p>3.启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo supervisorctl reread</div><div class="line">$ sudo supervisorctl update</div><div class="line">$ sudo supervisorctl start all</div><div class="line">$ sudo supervisorctl status</div><div class="line">wfstar_beat                      RUNNING   pid 16752, uptime 0:00:34</div><div class="line">wfstar_worker                    RUNNING   pid 16751, uptime 0:00:34</div></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://pythad.github.io/articles/2016-12/how-to-run-celery-as-a-daemon-in-production" target="_blank" rel="external">How to run celery as a daemon</a></p>
<p><a href="https://yangchy.com/2018/01/17/Celery-%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C/" target="_blank" rel="external">Celery 后台运行</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/05/douban-spider/" class="prev">PREV</a><a href="/2018/02/25/django-celery-notes/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://yoursite.com">Abnerzhao</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>