<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Django REST framework 缓存 · Abnerzhao</title><meta name="description" content="Django REST framework 缓存 - Abnerzhao"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Abnerzhao"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Abnerzhao" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Django REST framework 缓存</h1><div class="post-info">Aug 6, 2019</div><div class="post-content"><p>最近对 DRF 的接口进行监控，发现部分高频访问的接口性能不佳，响应比较慢，于是想通过缓存将接口性能优化。</p>
<p>常用的解决方案如下：</p>
<ul>
<li><a href="http://chibisov.github.io/drf-extensions/docs/#caching" target="_blank" rel="external">drf-extensions</a></li>
<li><a href="https://drf-cached-instances.readthedocs.io/en/latest/" target="_blank" rel="external">drf-cached-instances</a></li>
<li><a href="https://github.com/Onyo/django-rest-framework-cache" target="_blank" rel="external">django-rest-framework-cache</a></li>
<li><a href="https://www.django-rest-framework.org/api-guide/caching/#using-cache-with-apiview-and-viewsets" target="_blank" rel="external">django cache decorators</a></li>
</ul>
<blockquote>
<p>参考：<a href="https://stackoverflow.com/questions/38320008/how-to-cache-django-rest-framework-api-calls" target="_blank" rel="external">How to cache Django Rest Framework API calls</a></p>
</blockquote>
<a id="more"></a>
<p>可行的方案有很多，可以通过组件实现也可以通过 django 内置的装饰器来实现。这里以 <code>django-rest-framework-cache</code> 为例。</p>
<h3 id="django-rest-framework-cache"><a href="#django-rest-framework-cache" class="headerlink" title="django-rest-framework-cache"></a>django-rest-framework-cache</h3><p><code>django-rest-framework-cache</code> 是通过重写 <code>Serializer</code> 的 <code>to_representation</code> 方法来实现缓存的，所以它是一个嵌入到序列化层缓存数据的工具。<code>django-rest-framework-cache</code> 安装配置比较简单，能够快速上手。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pip install rest-framework-cache</div></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>缓存配置可以参考 <a href="https://docs.djangoproject.com/en/1.11/topics/cache/#setting-up-the-cache" target="_blank" rel="external">Django 官方文档</a>，Django 原生默认支持 Memcached，不过我们需要先安装 <code>python-memcached</code> 和 <code>memcached</code> 等软件包。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ pip install python-memcached</div><div class="line">$ sudo yum install -y memcached </div><div class="line">$ cat /etc/sysconfig/memcached</div><div class="line">PORT=&quot;11211&quot;</div><div class="line">USER=&quot;memcached&quot;</div><div class="line">MAXCONN=&quot;2000&quot;</div><div class="line">CACHESIZE=&quot;1024&quot;</div><div class="line">OPTIONS=&quot;&quot;</div><div class="line">$ systemctl start memcached</div><div class="line">$ systemctl enable memcached</div></pre></td></tr></table></figure>
<p><strong>settings.py</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">INSTALLED_APPS = (</div><div class="line">    ...</div><div class="line">    &apos;rest_framework_cache&apos;,</div><div class="line">)</div><div class="line"></div><div class="line"># 缓存源</div><div class="line">CACHES = &#123;</div><div class="line">    &apos;default&apos;: &#123;</div><div class="line">        &apos;BACKEND&apos;: &apos;django.core.cache.backends.memcached.MemcachedCache&apos;,</div><div class="line">        &apos;LOCATION&apos;: &apos;127.0.0.1:11211&apos;,</div><div class="line">    &#125;,</div><div class="line">    &apos;rest_backend&apos;: &#123;</div><div class="line">        &apos;BACKEND&apos;: &apos;django.core.cache.backends.locmem.LocMemCache&apos;,</div><div class="line">        &apos;LOCATION&apos;: &apos;unique-snowflake&apos;,</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">REST_FRAMEWORK_CACHE = &#123;</div><div class="line">    &apos;DEFAULT_CACHE_BACKEND&apos;: &apos;rest_backend&apos;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 全局超时时间</div><div class="line">REST_FRAMEWORK_CACHE = &#123;</div><div class="line">    &apos;DEFAULT_CACHE_TIMEOUT&apos;: 86400, # Default is 1 day</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>urls.py</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">from rest_framework_cache.registry import cache_registry</div><div class="line"></div><div class="line">cache_registry.autodiscover()</div></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p><code>django-rest-framework-cache</code> 是在序列化层进行缓存，所以将要缓存的序列化类注册到缓存中，同时需要使序列化类继承于 <code>CachedSerializerMixin</code>。</p>
<p>官方使用示例如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">from rest_framework import serializers</div><div class="line"></div><div class="line"># You must import the CachedSerializerMixin and cache_registry</div><div class="line">from rest_framework_cache.serializers import CachedSerializerMixin</div><div class="line">from rest_framework_cache.registry import cache_registry</div><div class="line"></div><div class="line">from .models import Comment</div><div class="line"></div><div class="line"></div><div class="line">class CommentSerializer(serializers.ModelSerializer, CachedSerializerMixin):</div><div class="line"></div><div class="line">    class Meta:</div><div class="line">        model = Comment</div><div class="line"></div><div class="line"></div><div class="line">cache_registry.register(CommentSerializer)</div></pre></td></tr></table></figure>
<p>按照官方配置会报错：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">TypeError: Error when calling the metaclass bases</div><div class="line">    Cannot create a consistent method resolution</div><div class="line">order (MRO) for bases CachedSerializerMixin, ModelSerializer</div></pre></td></tr></table></figure>
<p>stackoverflow 上给的解答是因为 Python 类继承的 MRO 算法导致。 由于 <code>CachedSerializerMixin</code> 是继承于 <code>serializers.ModelSerializer</code>, 必须先继承底层的类，再继承高层的类。这里因为 <code>serializers.ModelSerializer</code> 出现在 <code>CachedSerializerMixin</code> 之前导致报错。有兴趣可以了解一下 Python 多重继承的 <code>C3 线性化算法与 MRO</code>。</p>
<blockquote>
<p>参考：<a href="https://stackoverflow.com/questions/29214888/typeerror-cannot-create-a-consistent-method-resolution-order-mro" target="_blank" rel="external">TypeError: Cannot create a consistent method resolution order (MRO) </a></p>
</blockquote>
<p>将两者交换顺序即可：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">class CommentSerializer(CachedSerializerMixin, serializers.ModelSerializer):</div></pre></td></tr></table></figure>
<p><code>django-rest-framework-cache</code> 存在一个问题就是对于嵌套的外键和多对多的模型，数据修改之后不会生效，因为缓存的是 <code>Serializer</code> 信息，只在该 <code>Serializer</code> 对应的 <code>Model</code> 实例被修改后才会刷新。不过这个问题已经有人改写了插件 <a href="https://github.com/yinkh/django-rest-framework-cache" target="_blank" rel="external">django-rest-framework-cache</a>。</p>
<blockquote>
<p>参考：<a href="https://www.yinkh.top/article/62/" target="_blank" rel="external">rest_framework_cache 优化接口访问速度</a></p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2019/08/12/kong-api-gateway/" class="prev">PREV</a><a href="/2019/01/19/vue-cli-create-project/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">Abnerzhao</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>