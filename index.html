<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Abnerzhao"><meta name="description" content="DevOps"><title>Abner</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/"><link rel="alternate" href="/atom.xml" title="Abner"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?5832f612aff8681e2ee213a3b8d9548b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">Abner</a><ul class="nav"><li class="nav-link"><a href="/" class="active">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories/" target="_self">Categories</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><ul class="home"><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2017/01/11/Zabbix-Low-level-discovery/" class="post-link">Zabbix Low-level discovery</a></h2><span class="post-time">Jan 11, 2017</span><div class="post-content"><blockquote>
<p>Low-level discovery provides a way to automatically create items, triggers, and graphs for different entities on a computer. For instance, Zabbix can automatically start monitoring file systems or network interfaces on your machine, without the need to create items for each file system or network interface manually. </p>
<p>In Zabbix, four types of item discovery are supported out of the box:</p>
<ul>
<li>discovery of file systems;</li>
<li>discovery of network interfaces;</li>
<li>discovery of CPUs and CPU cores;</li>
<li>discovery of SNMP OIDs.</li>
</ul>
<p>A user can define their own types of discovery, provided they follow a particular JSON protocol.</p>
</blockquote>
<p>简而言之，zabbix的低水平发现就是减少我们的重复操作，能够根据不同的监控实例自动添加监控项、触发器和图形。<br><code>vfs.fs.discovery</code>和<code>net.if.discovery</code>就是zabbix自带的自动发现键值，能够自动识别agent端的文件挂载情况和网卡信息。还有基于SNMP OID的自动发现键值，能够自动识别交换机的所有端口信息。<br>当我们的一个服务有多个端口需要监控时，我通常是先在agent端写好监控脚本，定义键值，然后再为每个端口新建监控项、触发器和图形（当然你可以直接克隆），但还是免不了一些重复操作。下面就通过一个例子看一下Low-level discovery是如何工作的：</p>
<h3 id="监控需求："><a href="#监控需求：" class="headerlink" title="监控需求："></a>监控需求：</h3><p>监控udp端口12222-12229的端口状态</p>
<h3 id="实现步骤："><a href="#实现步骤：" class="headerlink" title="实现步骤："></a>实现步骤：</h3><h4 id="1-以json格式自定义发现类型"><a href="#1-以json格式自定义发现类型" class="headerlink" title="1.以json格式自定义发现类型"></a>1.以json格式自定义发现类型</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udpport_discovery.py</div><div class="line">#!/usr/bin/env python</div><div class="line">import sys,datetime,socket</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    zbxkey = sys.argv[1]</div><div class="line">    zbx_d = &#123;&#125;</div><div class="line">    zbx_d[&quot;data&quot;] = []</div><div class="line">    host_name = socket.gethostname().lower()</div><div class="line"></div><div class="line">    res = [&apos;12222&apos;, &apos;12223&apos;, &apos;12224&apos;, &apos;12225&apos;, &apos;12226&apos;, &apos;12227&apos;, &apos;12228&apos;, &apos;12229&apos;]</div><div class="line">    for line in res:</div><div class="line">        d = &#123;&#125;</div><div class="line">        d[&quot;&#123;#%s&#125;&quot; % zbxkey] = line</div><div class="line">        zbx_d[&quot;data&quot;].append(d)</div><div class="line">    print str(zbx_d).replace(&quot;&apos;&quot;,&apos;&quot;&apos;)</div></pre></td></tr></table></figure>
<h4 id="2-定义配置文件"><a href="#2-定义配置文件" class="headerlink" title="2.定义配置文件"></a>2.定义配置文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udp_port.conf</div><div class="line">#############Template_Udp#############</div><div class="line">UserParameter=status[*],/home/prod/softwares/zabbix/etc/zabbix_agentd.conf.d/udp_port.sh $1</div><div class="line">UserParameter=discovery.udpport,/home/prod/softwares/zabbix/etc/zabbix_agentd.conf.d/udpport_discovery.py PORT</div></pre></td></tr></table></figure>
<h4 id="3-检测自定义键值"><a href="#3-检测自定义键值" class="headerlink" title="3.检测自定义键值"></a>3.检测自定义键值</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ python udpport_discovery.py PORT</div><div class="line">&#123;&quot;data&quot;: [&#123;&quot;&#123;#PORT&#125;&quot;: &quot;12222&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12223&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12224&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12225&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12226&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12227&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12228&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12229&quot;&#125;]&#125;</div></pre></td></tr></table></figure>
<p>zabbix server端测试：<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ ./zabbix_get -s 10.0.0.206 -k discovery.udpport</div><div class="line">&#123;&quot;data&quot;: [&#123;&quot;&#123;#PORT&#125;&quot;: &quot;12222&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12223&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12224&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12225&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12226&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12227&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12228&quot;&#125;, &#123;&quot;&#123;#PORT&#125;&quot;: &quot;12229&quot;&#125;]&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-编写监控脚本"><a href="#4-编写监控脚本" class="headerlink" title="4.编写监控脚本"></a>4.编写监控脚本</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ cat udp_port.sh</div><div class="line">Port=$1</div><div class="line">case $Port in</div><div class="line">        12222)   netstat -nupl | grep 12222 |wc -l;;</div><div class="line">        12223)   netstat -nupl | grep 12223 |wc -l;;</div><div class="line">        12224)   netstat -nupl | grep 12224 |wc -l;;</div><div class="line">        12225)   netstat -nupl | grep 12225 |wc -l;;</div><div class="line">        12226)   netstat -nupl | grep 12226 |wc -l;;</div><div class="line">        12227)   netstat -nupl | grep 12227 |wc -l;;</div><div class="line">        12228)   netstat -nupl | grep 12228 |wc -l;;</div><div class="line">        12229)   netstat -nupl | grep 12229 |wc -l;;</div><div class="line">        *) echo Error; exit 1;;</div><div class="line">esac</div></pre></td></tr></table></figure>
<h4 id="5-web添加模板"><a href="#5-web添加模板" class="headerlink" title="5.web添加模板"></a>5.web添加模板</h4><p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/01256527-8987-40C4-9C65-2FC6D1D8610F.png" alt=""></p>
<p><img src="http://7vzmp5.com1.z0.glb.clouddn.com/E604037B-096A-4789-9AB3-A47B14020FB2.png" alt=""></p>
<h4 id="6-将模板关联对对应机器"><a href="#6-将模板关联对对应机器" class="headerlink" title="6.将模板关联对对应机器"></a>6.将模板关联对对应机器</h4><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.zabbix.com/documentation/2.4/manual/discovery/low_level_discovery" target="_blank" rel="external">LDD官方文档</a></p>
</div></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/12/29/2016小结/" class="post-link">2016小结</a></h2><span class="post-time">Dec 29, 2016</span><div class="post-content"><h4 id="叹惜"><a href="#叹惜" class="headerlink" title="叹惜"></a>叹惜</h4><p>感叹时间飞逝、惋惜计划破碎、哀怨进步迟缓，每次写总结首先想到的总是这些，感觉像是一个无法挣脱的怪圈。</p>
<p>长大以后时间之所以过得很快是因为<strong>新奇的经历减少</strong>。小时候觉得一学期过得很慢，寒暑假总是那么遥远。课间休息虽然只有十分钟，但感觉那时的十分钟也很长，足够去小超市买零食，课间操时间还能爬爬后山。如今，电脑一开一关一天就过去了。曾经的那个课间操时间都不够现在发个呆。而那个炎热慵懒又漫长的暑假总是让我更加期待，因为能到不同的城市去生活，陌生城市的一切对于我都是新鲜的。</p>
<p>第二个原因是<strong>现在更专注</strong>。对于IT运维狗而言，工作内容基本都是发现问题和解决问题，然后发现问题越来越多。一天的时间就被这些问题所吞噬，时间流逝地速度让你觉得可怕。小时候日子过得很散漫，无忧无虑。总是惦记着家里的零食，追着各种武侠剧，还有那一群嬉闹的玩伴。</p></div><a href="/2016/12/29/2016小结/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/27/python-excel/" class="post-link">Python xlrd和xlwt对excel表格处理</a></h2><span class="post-time">Nov 27, 2016</span><div class="post-content"><h2 id="表格处理模块"><a href="#表格处理模块" class="headerlink" title="表格处理模块"></a>表格处理模块</h2><ul>
<li>xlwt (writing xls files)</li>
<li>xlrd (reading xls/xlsx files)</li>
<li>openpyxl (reading/writing xlsx files)</li>
<li>xlsxwriter (writing xlsx files)</li>
</ul>
<h2 id="xlrd"><a href="#xlrd" class="headerlink" title="xlrd"></a>xlrd</h2><h3 id="excel表格示例"><a href="#excel表格示例" class="headerlink" title="excel表格示例"></a>excel表格示例</h3><p>示例表格2016-11-27.xlsx 内容如下：</p></div><a href="/2016/11/27/python-excel/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/20/django-web-framework/" class="post-link">Django笔记</a></h2><span class="post-time">Nov 20, 2016</span><div class="post-content"><blockquote>
<p>本文主要内容为<a href="http://djangobook.py3k.cn/2.0/">The Django Book</a>笔记摘录<br>(书有点老但是很多知识点还是值得一看，结合官方文档一起下饭)</p>
</blockquote>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><blockquote>
<p>Django提供了通用Web开发模式的高度抽象，提供了频繁进行的编程作业的快速解决方法，以及为“如何解决问题”提供了清晰明了的约定</p>
</blockquote>
<p>Web框架为应用程序提供了一套程序框架，可以让程序员专注于编写清晰、易维护的代码</p>
<h3 id="MVC设计模式"><a href="#MVC设计模式" class="headerlink" title="MVC设计模式"></a>MVC设计模式</h3><p><code>模型-视图-控制器(MVC)</code>：MVC是一种软件开发的方法，它把代码的定义和数据访问的方法（模型）与请求逻辑（控制器）还有用户接口（视图）分开来</p>
<p>任何一个通过django实现的功能都会包含一下几个文件：</p></div><a href="/2016/11/20/django-web-framework/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/16/python-datetime/" class="post-link">Python datetime时间那点事</a></h2><span class="post-time">Nov 16, 2016</span><div class="post-content"><p>关于datetime时间操作在日常工作中也没有经常用到，但是每次要用时却又想不起来，与其重复查文档不如总结一下备忘。本文只简单记录了常用的一些方法，不同类型格式之间的转换(如时间对象类型、字符串、timestamp、time tuple类型）以及时区问题等暂未深入了解。</p>
<h2 id="datetime模块"><a href="#datetime模块" class="headerlink" title="datetime模块"></a>datetime模块</h2><p>datetime 模块主要用来操作日期和时间</p>
<h3 id="date日期对象"><a href="#date日期对象" class="headerlink" title="date日期对象"></a>date日期对象</h3><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> datetime</div><div class="line"></div><div class="line"><span class="keyword">print</span> datetime.date.today()  //返回当前本地日期</div><div class="line"><span class="keyword">print</span> datetime.date(<span class="number">2016</span>,<span class="number">11</span>,<span class="number">16</span>) //生成日期对象</div><div class="line"></div><div class="line">//stdout</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span></div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-16</span></div></pre></td></tr></table></figure></div><a href="/2016/11/16/python-datetime/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/13/hangzhou/" class="post-link">单人旅途之杭州</a></h2><span class="post-time">Nov 13, 2016</span><div class="post-content"><h3 id="Day1-南宋御街、清河坊、灵隐寺"><a href="#Day1-南宋御街、清河坊、灵隐寺" class="headerlink" title="Day1: 南宋御街、清河坊、灵隐寺"></a>Day1: 南宋御街、清河坊、灵隐寺</h3><p>上海早上九点的动车十点就到达杭州东，拥挤的杭州东地铁站被一条条排队买票的长龙分隔成好多格像是一座人墙迷宫。穿过拥挤的人群拿着排了十几分钟买到的地铁票进站去往定安路。</p>
<p>定安路附近的景点就是南宋御街和清河坊，感觉也没什么看的就是一条商业街和一条小吃街，差评！</p>
<p><em>摄于南宋御街</em><br><img src="http://7vzmp5.com1.z0.glb.clouddn.com/IMG_2472%2820161112-202653%29.jpg" alt="摄于南宋御街"></p></div><a href="/2016/11/13/hangzhou/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/11/pdb/" class="post-link">pdb代码调试</a></h2><span class="post-time">Nov 11, 2016</span><div class="post-content"><h3 id="简单调试示例"><a href="#简单调试示例" class="headerlink" title="简单调试示例"></a>简单调试示例</h3><pre><code>$ python -m pdb exp.py  #停在脚本第一行等待调试
&gt; /Users/Mr-zhao/work_space/scripts/exp.py(3)&lt;module&gt;()
-&gt; a = 1
(Pdb) l    #list列出当前代码所在行
    1   #!/usr/bin/env python
    2
    3  -&gt;   a = 1
    4   b = 2
    5   c = 3
    6   d = a+b+c
    7   print d
[EOF]
(Pdb) n #next执行下一行
&gt; /Users/Mr-zhao/work_space/scripts/exp.py(4)&lt;module&gt;()
-&gt; b = 2
(Pdb) p a  #打印变量值，pp和print都可以
1
(Pdb) c  #continue继续执行程序，遇到断点则停止
6    #由于脚本没有设置断点，则直接运行完成输出结果
The program finished and will be restarted
&gt; /Users/Mr-zhao/work_space/scripts/exp.py(3)&lt;module&gt;()
-&gt; a = 1
(Pdb) q  # exit退出
</code></pre></div><a href="/2016/11/11/pdb/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/04/ansible-python-api/" class="post-link">小试Ansible Python API</a></h2><span class="post-time">Nov 4, 2016</span><div class="post-content"><h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// ping 模块</div><div class="line">$ ansible localhost -m ping</div><div class="line">localhost | success &gt;&gt; &#123;</div><div class="line">    &quot;changed&quot;: false,</div><div class="line">    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">&#125;</div><div class="line">// shell 模块</div><div class="line">$ ansible localhost -m shell -a &apos;uptime&apos;</div><div class="line">localhost | success | rc=0 &gt;&gt;</div><div class="line">11:00:11 up 66 days, 23:34,  1 user,  load average: 0.00, 0.01, 0.05</div></pre></td></tr></table></figure>
<h3 id="Python-API"><a href="#Python-API" class="headerlink" title="Python API"></a>Python API</h3><p>通过ansible.runner模块来实现</p></div><a href="/2016/11/04/ansible-python-api/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/11/01/svn-code-transfer/" class="post-link">跨仓库转移SVN代码目录</a></h2><span class="post-time">Nov 1, 2016</span><div class="post-content"><p>由于公司先前代码管理比较混乱，不同部门之间的代码有放在同一个仓库的，抽空转移了部分并记录备忘。</p>
<p><strong>project项目位于dev仓库的主分支，现需要将他转移到ops仓库主分支</strong></p>
<blockquote>
<p>old svn: <a href="http://svnserver/svn/dev/trunk/project/">http://svnserver/svn/dev/trunk/project/</a></p>
<p>new svn:<a href="http://svnserver/svn/ops/trunk/">http://svnserver/svn/ops/trunk/</a></p>
</blockquote>
<p><strong>直接svn move 报错：</strong></p>
<pre><code>$ svn move  http://svnserver/svn/dev/trunk/project/  http://svnserver/svn/ops/trunk/
svn: E200007: Source and destination URLs appear not to point to the same repository.
</code></pre><blockquote>
<p>svn: E200007: Source and destination URLs appear not to point to the same repository. </p>
<p>不同的仓库之间无法直接move或cp项目代码</p>
</blockquote></div><a href="/2016/11/01/svn-code-transfer/" class="read-more">Read more..</a></article></li><li class="post-item"><article class="post"><h2 class="post-title"><a href="/2016/10/29/Python-code-style/" class="post-link">Python编码风格</a></h2><span class="post-time">Oct 29, 2016</span><div class="post-content"><h3 id="标记"><a href="#标记" class="headerlink" title="#!标记"></a>#!标记</h3><blockquote>
<p>大部分.py文件不必以#!作为文件的开始。 程序的main文件应该以 #!/usr/bin/python2或者 #!/usr/bin/python3开始。 (<code>#!先用于帮助内核找到Python解释器, 但是在导入模块时, 将会被忽略。因此只有被直接执行的文件中才有必要加入#!</code>)</p>
</blockquote>
<h3 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h3><blockquote>
<p>不要在行尾加分号, 也不要用分号将两条命令放在同一行.</p>
</blockquote>
<h3 id="行长度"><a href="#行长度" class="headerlink" title="行长度"></a>行长度</h3><blockquote>
<p>每行不超过80个字符</p>
</blockquote></div><a href="/2016/10/29/Python-code-style/" class="read-more">Read more..</a></article></li></ul><div class="paginator"><a href="/page/2/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div></section><footer><div class="social"><a href="https://github.com/Abnerzhao" title="github" class="iconfont icon-github"></a><a href="mailto:opsabnerzhao@gmail.com" title="email" class="iconfont icon-email"></a><a href="http://weibo.com/2863179107/profile?topnav=1&amp;wvr=6&amp;is_all=1" title="weibo" class="iconfont icon-weibo"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2015-2017<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Abnerzhao</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>